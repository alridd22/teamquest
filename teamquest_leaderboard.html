<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terry's Treasure Quest - Live Leaderboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #d4691a, #f4a261);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .treasure-container {
            background: linear-gradient(145deg, #f5e6d3, #e8d5b8);
            border-radius: 25px;
            border: 5px solid #8b4513;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 900px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .treasure-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .trophy {
            font-size: 48px;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .title {
            font-size: 2.5em;
            color: #8b4513;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .subtitle {
            font-size: 1.2em;
            color: #a0522d;
            margin-bottom: 20px;
        }

        .timer-display {
            background: linear-gradient(145deg, #ff8c00, #ffa500);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.4em;
            font-weight: bold;
            text-align: center;
            margin: 20px auto;
            max-width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 3px solid #8b4513;
        }

        .timer-icon {
            margin-right: 10px;
        }

        /* Final Results Banner */
        .final-results-banner {
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            color: #8b4513;
            padding: 20px 30px;
            border-radius: 25px;
            font-size: 1.6em;
            font-weight: bold;
            text-align: center;
            margin: 20px auto;
            max-width: 500px;
            box-shadow: 0 8px 25px rgba(255,215,0,0.4);
            border: 4px solid #b8860b;
            display: none;
            animation: finalGlow 2s ease-in-out infinite alternate;
        }

        @keyframes finalGlow {
            from { box-shadow: 0 8px 25px rgba(255,215,0,0.4); }
            to { box-shadow: 0 8px 35px rgba(255,215,0,0.7); }
        }

        .leaderboard-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
            border: 2px solid #d2691e;
            position: relative;
            z-index: 1;
        }

        .team-entry {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(145deg, #fff8dc, #f5f5dc);
            border-radius: 12px;
            border: 2px solid #daa520;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .team-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .rank {
            font-size: 1.8em;
            font-weight: bold;
            color: #8b4513;
            margin-right: 20px;
            min-width: 40px;
        }

        .rank.first { color: #ffd700; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .rank.second { color: #c0c0c0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .rank.third { color: #cd7f32; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

        .team-info {
            flex-grow: 1;
        }

        .team-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 5px;
        }

        .team-activities {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 5px;
        }

        .activity {
            background: #f0e68c;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.9em;
            border: 1px solid #daa520;
        }

        .total-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #8b4513;
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            padding: 10px 15px;
            border-radius: 25px;
            border: 2px solid #b8860b;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .doubloons {
            font-size: 0.8em;
            color: #8b4513;
        }

        /* Freeze Screen Styles */
        .freeze-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(139,69,19,0.95), rgba(160,82,45,0.95));
            border-radius: 25px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(3px);
        }

        .freeze-content {
            text-align: center;
            color: white;
            padding: 40px;
        }

        .freeze-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .freeze-title {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .freeze-message {
            font-size: 1.3em;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .freeze-timer {
            background: rgba(255,140,0,0.9);
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .freeze-details {
            font-size: 1em;
            opacity: 0.8;
            line-height: 1.5;
            max-width: 500px;
        }

        .status-bar {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            font-size: 0.9em;
            color: #8b4513;
            position: relative;
            z-index: 1;
        }

        .auto-refresh-icon {
            margin-right: 5px;
        }

        .error-container {
            background: #ffe6e6;
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #d63031;
            text-align: center;
        }

        .retry-btn {
            background: #ff8c00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .retry-btn:hover {
            background: #ff7700;
        }

        @media (max-width: 768px) {
            .treasure-container {
                padding: 20px;
                margin: 10px;
            }
            
            .title {
                font-size: 2em;
            }
            
            .team-activities {
                gap: 8px;
            }
            
            .activity {
                font-size: 0.8em;
                padding: 3px 6px;
            }

            .freeze-title {
                font-size: 2em;
            }

            .freeze-message {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="treasure-container">
        <div class="header">
            <div class="trophy">üèÜ</div>
            <h1 class="title">Terry's Treasure Leaderboard</h1>
            <p class="subtitle">Live treasure hunting standings</p>
            
            <div class="timer-display" id="timerDisplay">
                <span class="timer-icon">‚è∞</span>
                <span id="timer">Loading...</span>
            </div>

            <!-- Final Results Banner -->
            <div class="final-results-banner" id="finalResultsBanner">
                üèÜ Adventure Complete - Final Results! üèÜ
            </div>
        </div>

        <div class="leaderboard-container">
            <div id="leaderboard">
                <div style="text-align: center; padding: 20px; color: #8b4513;">
                    üè¥‚Äç‚ò†Ô∏è Loading treasure standings... üè¥‚Äç‚ò†Ô∏è
                </div>
            </div>
        </div>

        <div class="status-bar">
            <span class="auto-refresh-icon">üîÑ</span>
            Auto-refreshes every 30 seconds | Last updated: <span id="lastUpdated">Never</span>
        </div>

        <!-- Freeze Overlay -->
        <div class="freeze-overlay" id="freezeOverlay">
            <div class="freeze-content">
                <div class="freeze-icon">üîí</div>
                <h2 class="freeze-title">Adventure Complete!</h2>
                <p class="freeze-message">The treasure hunt has ended and results are being finalized...</p>
                <div class="freeze-timer" id="freezeTimer">Competition Ended</div>
                <p class="freeze-details">
                    The final standings will be revealed once Terry has finished counting all the treasure!<br>
                    Results will be published shortly by the adventure organizers.
                </p>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;
        let timerInterval;
        let competitionEndTime = null;
        let isFrozen = false;
        let resultsPublished = false;

        // Safe property access helper
        function safeGet(obj, path, defaultValue = 0) {
            try {
                const keys = path.split('.');
                let result = obj;
                for (const key of keys) {
                    if (result === null || result === undefined) {
                        return defaultValue;
                    }
                    result = result[key];
                }
                return result !== undefined ? result : defaultValue;
            } catch (e) {
                console.warn('Error accessing property:', path, e);
                return defaultValue;
            }
        }

        function displayError(message) {
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = `
                <div class="error-container">
                    ‚ùå ${message}
                    <button class="retry-btn" onclick="loadLeaderboard()">Retry</button>
                </div>
            `;
        }

        function displayLeaderboard(teams) {
            console.log('Displaying teams:', teams);
            const leaderboard = document.getElementById('leaderboard');
            
            if (!teams || !Array.isArray(teams) || teams.length === 0) {
                leaderboard.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8b4513;">
                        üè¥‚Äç‚ò†Ô∏è No treasure hunters have set sail yet! üè¥‚Äç‚ò†Ô∏è
                    </div>
                `;
                return;
            }

            const sortedTeams = teams.sort((a, b) => (safeGet(b, 'totalScore', 0) || 0) - (safeGet(a, 'totalScore', 0) || 0));
            
            let html = '';

            // Add congratulations message if results are published
            if (resultsPublished) {
                html += `
                    <div style="text-align: center; padding: 15px; margin-bottom: 20px; background: linear-gradient(145deg, #ffd700, #ffed4e); border-radius: 15px; border: 3px solid #daa520; color: #8b4513; font-weight: bold; font-size: 1.2em;">
                        üéâ Congratulations to all brave treasure hunters! üéâ<br>
                        <span style="font-size: 0.9em; margin-top: 5px; display: block;">The adventure has concluded - these are the final standings!</span>
                    </div>
                `;
            }
            
            sortedTeams.forEach((team, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'first' : rank === 2 ? 'second' : rank === 3 ? 'third' : '';
                
                const teamName = safeGet(team, 'teamName', 'Unknown Crew') || `Team ${safeGet(team, 'teamCode', rank)}`;
                const totalScore = safeGet(team, 'totalScore', 0);
                
                const registration = safeGet(team, 'activities.registration', 0) || safeGet(team, 'registration', 0);
                const clueHunt = safeGet(team, 'activities.clueHunt', 0) || safeGet(team, 'clueHunt', 0) || safeGet(team, 'activities.clue_hunt', 0);
                const quiz = safeGet(team, 'activities.quiz', 0) || safeGet(team, 'quiz', 0);
                const kindness = safeGet(team, 'activities.kindness', 0) || safeGet(team, 'kindness', 0);
                const scavenger = safeGet(team, 'activities.scavenger', 0) || safeGet(team, 'scavenger', 0);
                const limerick = safeGet(team, 'activities.limerick', 0) || safeGet(team, 'limerick', 0);

                // Add crown for winner if results are published
                const winnerCrown = (resultsPublished && rank === 1) ? ' üëë' : '';

                html += `
                    <div class="team-entry">
                        <div class="rank ${rankClass}">${rank}</div>
                        <div class="team-info">
                            <div class="team-name">üè¥‚Äç‚ò†Ô∏è ${teamName}${winnerCrown}</div>
                            <div class="team-activities">
                                ${registration > 0 ? `<span class="activity">‚öì Registration: ${registration}</span>` : ''}
                                ${clueHunt > 0 ? `<span class="activity">üó∫Ô∏è Clue Hunt: ${clueHunt}</span>` : ''}
                                ${quiz > 0 ? `<span class="activity">üß≠ Quiz: ${quiz}</span>` : ''}
                                ${kindness > 0 ? `<span class="activity">üíô Kindness: ${kindness}</span>` : ''}
                                ${scavenger > 0 ? `<span class="activity">üîç Scavenger: ${scavenger}</span>` : ''}
                                ${limerick > 0 ? `<span class="activity">üìú Limerick: ${limerick}</span>` : ''}
                            </div>
                        </div>
                        <div class="total-score">
                            ${totalScore} <span class="doubloons">doubloons</span>
                        </div>
                    </div>
                `;
            });

            leaderboard.innerHTML = html;
        }

        function updateTimer() {
            if (!competitionEndTime) return;

            const now = new Date().getTime();
            const timeLeft = competitionEndTime - now;

            if (timeLeft <= 0) {
                document.getElementById('timer').textContent = 'Adventure Complete!';
                clearInterval(timerInterval);
                
                // Show freeze overlay if results not published
                if (!resultsPublished) {
                    showFreezeOverlay();
                }
                return;
            }

            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            // Check if 20 minutes or less remaining
            const totalMinutesLeft = Math.floor(timeLeft / (1000 * 60));
            
            if (totalMinutesLeft <= 20 && !resultsPublished) {
                // Freeze the leaderboard
                showFreezeOverlay();
                document.getElementById('freezeTimer').textContent = 
                    `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} remaining`;
            } else {
                // Normal timer display
                document.getElementById('timer').textContent = 
                    `Adventure Timer: ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function showFreezeOverlay() {
            if (!isFrozen) {
                isFrozen = true;
                document.getElementById('freezeOverlay').style.display = 'flex';
                console.log('Leaderboard frozen - 20 minutes or less remaining');
            }
        }

        function hideFreezeOverlay() {
            if (isFrozen) {
                isFrozen = false;
                document.getElementById('freezeOverlay').style.display = 'none';
                console.log('Leaderboard unfrozen - results published');
            }
        }

        async function loadLeaderboard() {
            try {
                console.log('Loading leaderboard data...');
                const response = await fetch('/.netlify/functions/get_leaderboard_function');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Raw API response:', data);

                if (!data || !data.success) {
                    throw new Error(data?.error || 'Invalid response from server');
                }

                // Check if results are published
                resultsPublished = data.resultsPublished || false;
                console.log('Results published:', resultsPublished);

                // Show/hide final results banner and update status
                if (resultsPublished) {
                    // Show final results banner, hide timer
                    document.getElementById('finalResultsBanner').style.display = 'block';
                    document.getElementById('timerDisplay').style.display = 'none';
                    
                    // Hide freeze overlay
                    hideFreezeOverlay();
                    
                    // Stop auto-refresh since results are final
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                } else {
                    // Hide final results banner, show timer
                    document.getElementById('finalResultsBanner').style.display = 'none';
                    document.getElementById('timerDisplay').style.display = 'block';
                }

                // Handle competition timer
                if (data.competitionStartTime && data.competitionDuration && !resultsPublished) {
                    const startTime = new Date(data.competitionStartTime).getTime();
                    const duration = data.competitionDuration * 60 * 1000;
                    competitionEndTime = startTime + duration;
                    
                    if (!timerInterval) {
                        timerInterval = setInterval(updateTimer, 1000);
                    }
                    updateTimer();
                } else if (!resultsPublished) {
                    document.getElementById('timer').textContent = 'Timer not active';
                }

                // Handle leaderboard data
                let teams = null;
                
                if (data.leaderboard && Array.isArray(data.leaderboard)) {
                    teams = data.leaderboard;
                    console.log('Using data.leaderboard:', teams);
                } else if (data.teams && Array.isArray(data.teams)) {
                    teams = data.teams;
                    console.log('Using data.teams:', teams);
                } else {
                    console.warn('No teams found in response. Full data:', data);
                }

                if (teams && teams.length > 0) {
                    console.log('Number of crews loaded:', teams.length);
                    displayLeaderboard(teams);
                } else {
                    displayLeaderboard([]);
                }

                // Update last updated time
                const now = new Date();
                const timeString = now.toTimeString().split(' ')[0];
                document.getElementById('lastUpdated').textContent = timeString;

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                displayError(error.message);
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Leaderboard page loaded');
            loadLeaderboard();
            
            // Set up auto-refresh
            refreshInterval = setInterval(loadLeaderboard, 30000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) clearInterval(refreshInterval);
            if (timerInterval) clearInterval(timerInterval);
        });
    </script>
</body>
</html>
