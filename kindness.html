<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest – Terry’s Kind Acts</title>
  <style>
    /* ————— NAV ————— */
    .treasure-nav{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:1000;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;height:80px}
    .nav-container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 20px;height:100%}
    .nav-logo{text-decoration:none;transition:.3s;display:flex;align-items:center}
    .nav-logo:hover{transform:scale(1.05)}
    .nav-logo img{height:50px;width:auto;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5));transition:.3s}
    .nav-logo:hover img{filter:drop-shadow(2px 2px 8px rgba(255,215,0,.6))}
    .nav-menu{display:flex;list-style:none;margin:0;padding:0;gap:30px}
    .nav-item{position:relative}
    .nav-link{color:#F5DEB3;text-decoration:none;font-size:1rem;font-weight:bold;padding:12px 18px;border-radius:8px;transition:.3s;display:block;text-shadow:1px 1px 2px rgba(0,0,0,.7);background:rgba(101,67,33,.3);border:2px solid rgba(218,165,32,.4);white-space:nowrap}
    .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(218,165,32,.4);border-color:#DAA520}
    .nav-dropdown{position:absolute;top:100%;left:0;background:linear-gradient(135deg,#654321 0%,#8B4513 100%);border:2px solid #DAA520;border-radius:8px;min-width:180px;opacity:0;visibility:hidden;transform:translateY(-10px);transition:.3s;box-shadow:0 8px 20px rgba(0,0,0,.3)}
    .nav-item:hover .nav-dropdown{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-link{display:block;color:#F5DEB3;text-decoration:none;padding:12px 18px;font-size:.95rem;border-bottom:1px solid rgba(218,165,32,.2);transition:.3s;background:rgba(101,67,33,.2);margin:2px;border-radius:6px;font-weight:600}
    .dropdown-link:last-child{border-bottom:none}
    .dropdown-link:hover{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;padding-left:25px;transform:translateX(5px);box-shadow:0 2px 8px rgba(255,140,0,.3)}
    .nav-toggle{display:none;background:none;border:none;color:#DAA520;font-size:1.8rem;cursor:pointer}
    @media (max-width:768px){
      .treasure-nav{height:120px}
      .nav-container{justify-content:center;position:relative}
      .nav-logo{position:absolute;left:50%;transform:translateX(-50%)}
      .nav-logo img{height:85px!important}
      .nav-toggle{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:block}
      .nav-menu{position:fixed;top:120px;left:-100%;width:100%;height:calc(100vh - 120px);background:linear-gradient(135deg,#8B4513 0%,#654321 100%);flex-direction:column;align-items:center;padding-top:30px;gap:20px;transition:left .3s;overflow-y:auto}
      .nav-menu.active{left:0}
      .nav-link{font-size:1.1rem;padding:15px 25px;width:280px;text-align:center;background:linear-gradient(135deg,rgba(101,67,33,.8),rgba(139,69,19,.6));border:2px solid #DAA520;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);transform:translateY(-3px);box-shadow:0 6px 15px rgba(218,165,32,.4)}
      .nav-dropdown{position:static;opacity:1;visibility:visible;transform:none;background:rgba(101,67,33,.9);border:2px solid #DAA520;border-radius:12px;margin-top:10px;width:280px;box-shadow:0 8px 20px rgba(0,0,0,.4)}
      .dropdown-link{padding:12px 20px;font-size:1rem;margin:4px;border-radius:8px;text-align:center;background:rgba(139,69,19,.4);border:1px solid rgba(218,165,32,.3)}
      .dropdown-link:hover{background:linear-gradient(135deg,#FF8C00,#DAA520);padding-left:20px;transform:translateY(-2px)}
    }

    /* ————— PAGE ————— */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;padding-top:100px!important;position:relative}
    @media (max-width:768px){body{padding-top:140px!important}}
    body::before{content:'';position:fixed;inset:0;background:
      radial-gradient(circle at 20% 20%,rgba(255,215,0,.1) 0%,transparent 50%),
      radial-gradient(circle at 80% 80%,rgba(255,140,0,.1) 0%,transparent 50%),
      radial-gradient(circle at 40% 60%,rgba(255,182,193,.15) 0%,transparent 50%)}
    .container{background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border-radius:25px;padding:34px;box-shadow:0 20px 40px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.3);max-width:720px;width:100%;position:relative;overflow:hidden;z-index:1;border:3px solid #8B4513}
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#FFD700,#FF8C00,#FFB6C1,#DAA520,#FFD700)}
    .container::after{content:'';position:absolute;top:15px;left:15px;right:15px;bottom:15px;border:2px solid #DAA520;border-radius:20px;pointer-events:none}
    .logo{text-align:center;margin-bottom:16px;position:relative;z-index:2}
    .heart-icon{font-size:44px;margin-bottom:10px;animation:heartbeat 2s infinite;filter:drop-shadow(2px 2px 4px rgba(139,69,19,.3))}
    @keyframes heartbeat{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    h1{color:#8B4513;text-align:center;margin-bottom:6px;font-size:2.1em;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .subtitle{text-align:center;color:#A0522D;margin-bottom:16px;font-size:1.05em;font-weight:600}

    .status-banner{display:none;margin:12px 0 18px;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:2px solid #DAA520;border-left:6px solid #FF8C00;border-radius:10px;padding:12px 14px;color:#654321;font-weight:600}
    .status-banner.paused{border-left-color:#DAA520}
    .status-banner.ended{border-left-color:#8B0000}
    .status-banner.published{border-left-color:#32CD32}

    .team-info{background:linear-gradient(135deg,#8B4513,#A0522D);color:#fff;padding:14px;border-radius:14px;text-align:center;font-size:1.05em;font-weight:700;margin-bottom:16px;box-shadow:0 5px 15px rgba(139,69,19,.3);border:2px solid #DAA520}
    .terry-greeting{display:flex;gap:16px;margin:12px 0;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-radius:16px;padding:18px;border:3px solid #DAA520;box-shadow:0 5px 15px rgba(139,69,19,.2)}
    .terry-character img{width:100px;height:100px;border-radius:12px;border:4px solid #DAA520;box-shadow:0 4px 12px rgba(139,69,19,.3);object-fit:cover;background:linear-gradient(135deg,#8B4513,#A0522D);display:block}
    .terry-note{background:linear-gradient(135deg,#FFB6C1 0%,#FFC0CB 100%);color:#8B4513;padding:16px;border-radius:12px;border:3px solid #DAA520;font-weight:600;line-height:1.5;box-shadow:0 5px 15px rgba(255,182,193,.3)}
    .scoring-rules-btn{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-size:.95em;font-weight:800;cursor:pointer;transition:.2s;margin-top:10px;border:2px solid #8B4513;display:inline-flex;align-items:center;gap:6px}
    .scoring-rules-btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(255,140,0,.3)}

    .instructions{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-left:6px solid #DAA520;padding:16px;margin:14px 0 18px;border-radius:0 12px 12px 0;box-shadow:0 4px 12px rgba(139,69,19,.1);border:2px solid #DAA520;border-left:6px solid #FF8C00}
    .instructions h3{color:#8B4513;margin-bottom:8px;display:flex;align-items:center;gap:8px;font-size:1.1em;font-weight:800}
    .instructions ul{margin-left:18px;color:#654321;line-height:1.65}

    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:8px;color:#8B4513;font-weight:700;font-size:1.02em}
    input[type="text"], textarea{width:100%;padding:14px;border:3px solid #DAA520;border-radius:12px;font-size:16px;transition:.2s;background:linear-gradient(145deg,#fff 0%,#FFF8DC 100%);font-family:inherit}
    input[type="text"]:focus, textarea:focus{outline:none;border-color:#FF8C00;background:#fff;box-shadow:0 0 0 3px rgba(255,140,0,.2);transform:translateY(-1px)}
    textarea{min-height:120px;resize:vertical;line-height:1.5}
    .char-count{text-align:right;font-size:.9em;color:#8B4513;margin-top:5px;font-weight:600}

    .file-upload{position:relative;display:inline-block;width:100%}
    .file-input{display:none}
    .file-upload-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:18px;border:3px dashed #DAA520;border-radius:12px;background:linear-gradient(145deg,#FFF8DC 0%,#F5E6D3 100%);cursor:pointer;transition:.2s;color:#8B4513;font-weight:800;font-size:1em}
    .file-upload-btn:hover{background:linear-gradient(145deg,#FFD700 0%,#FFA500 100%);border-color:#FF8C00;transform:translateY(-1px);box-shadow:0 8px 20px rgba(255,140,0,.2)}
    .file-preview{margin-top:14px;text-align:center;display:none}
    .file-preview img{max-width:100%;max-height:220px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.2);border:3px solid #32CD32}
    .file-info{margin-top:12px;padding:12px;background:linear-gradient(135deg,#F0FFF0 0%,#E6FFE6 100%);border-radius:10px;font-size:.95em;color:#654321;border:2px solid #32CD32}

    .submit-btn{width:100%;background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:none;padding:16px;border-radius:14px;font-size:1.1em;font-weight:900;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:10px;border:3px solid #8B4513;text-shadow:1px 1px 2px rgba(0,0,0,.2)}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 12px 25px rgba(255,140,0,.3);background:linear-gradient(135deg,#FFB347,#F0C814)}
    .submit-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;background:linear-gradient(135deg,#A0522D,#8B4513)}
    .spinner{width:16px;height:16px;border:3px solid rgba(255,255,255,.5);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .message{padding:16px;border-radius:14px;margin:16px 0;text-align:center;display:none;border:3px solid;font-weight:700}
    .success-message{background:linear-gradient(135deg,#90EE90 0%,#98FB98 100%);border-color:#32CD32;color:#064b06}
    .error-message{background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);border-color:#DC143C;color:#8B0000}
    .loading{display:none;text-align:center;margin-top:12px;color:#8B4513;font-weight:800;font-size:1.02em}

    .auth-block{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:2px dashed #DAA520;border-radius:12px;padding:16px;text-align:center;color:#654321;font-weight:700}
    .auth-actions{margin-top:8px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .small-btn{background:#8B4513;color:#fff;border:2px solid #DAA520;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .small-btn:hover{background:#A0522D}

    @media (max-width:600px){
      .container{padding:26px 18px}
      h1{font-size:1.8em}
      .terry-greeting{flex-direction:column;align-items:center;text-align:center}
    }

    /* ——— Modal (kept, shorter) ——— */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:2000;padding:20px}
    .modal-overlay.active{display:flex}
    .modal-content{background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border-radius:20px;padding:28px;max-width:720px;width:100%;max-height:90vh;overflow-y:auto;border:4px solid #8B4513;box-shadow:0 20px 40px rgba(0,0,0,.3);position:relative}
    .modal-content::before{content:'';position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#FFD700,#FF8C00,#FFB6C1,#DAA520,#FFD700);border-radius:20px 20px 0 0}
    .close-btn{position:absolute;top:12px;right:16px;background:none;border:none;font-size:22px;color:#8B4513;cursor:pointer;padding:5px;border-radius:50%;transition:.2s}
    .close-btn:hover{background:rgba(255,140,0,.2);transform:scale(1.06)}
    .modal-title{color:#8B4513;font-size:1.6em;font-weight:800;margin-bottom:6px;text-align:center}
    .modal-subtitle{color:#A0522D;text-align:center;margin-bottom:14px;font-weight:700}
    .scoring-grid{display:grid;gap:12px}
    .scoring-card{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:3px solid #DAA520;border-radius:12px;padding:14px}
    .scoring-card h4{margin:0 0 6px;color:#8B4513}
    .scoring-card p{margin:0;color:#654321}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo" aria-label="TeamQuest Home">
        <img src="/Team Quest Logo-01.png" alt="TeamQuest Logo">
      </a>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link">🎯 Activities ▼</a>
          <div class="nav-dropdown" role="menu">
            <a href="https://theteamquest.netlify.app/clue_hunt_challenge" class="dropdown-link" role="menuitem">💎 The Treasure Hunt</a>
            <a href="https://theteamquest.netlify.app/scavenger_hunt" class="dropdown-link" role="menuitem">🔍 The Scavenger Hunt</a>
            <a href="https://theteamquest.netlify.app/quiz_challenge" class="dropdown-link" role="menuitem">⏰ The Timed Quiz</a>
            <a href="https://theteamquest.netlify.app/limerick_challenge_page" class="dropdown-link" role="menuitem">📝 The Limerick Challenge</a>
          </div>
        </li>
        <li class="nav-item"><a href="https://theteamquest.netlify.app/teamquest_leaderboard" class="nav-link">🏆 The Leaderboard</a></li>
        <li class="nav-item"><a href="https://theteamquest.netlify.app/teamquest_gallery" class="nav-link">📸 The Gallery</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle menu">☰</button>
    </div>
  </nav>

  <!-- Scoring Modal -->
  <div class="modal-overlay" id="scoringModal" aria-modal="true" role="dialog" aria-labelledby="scoringTitle">
    <div class="modal-content">
      <button class="close-btn" id="closeModalBtn" aria-label="Close">✕</button>
      <div class="modal-title" id="scoringTitle">💖 Heart Treasure Scoring</div>
      <div class="modal-subtitle">Creativity • Effort • Impact (max 60 doubloons)</div>
      <div class="scoring-grid">
        <div class="scoring-card"><h4>✨ Creativity (20)</h4><p>Original, thoughtful, personalised acts beat ordinary gestures.</p></div>
        <div class="scoring-card"><h4>💪 Effort (20)</h4><p>Prep, time, and going the extra mile show commitment.</p></div>
        <div class="scoring-card"><h4>💝 Impact (20)</h4><p>Clear benefit to someone or your community = big treasure.</p></div>
      </div>
    </div>
  </div>

  <div class="container" id="app">
    <div class="logo">
      <div class="heart-icon">💖</div>
      <h1>Terry’s Kind Acts</h1>
      <p class="subtitle">Do good. Snap it. Tell us. Earn doubloons.</p>
    </div>

    <div id="stateBanner" class="status-banner" role="status" aria-live="polite"></div>

    <div class="team-info" id="teamInfo">Crew: loading…</div>

    <div id="authGate" class="auth-block" style="display:none;">
      You’re not signed in for this event.
      <div class="auth-actions">
        <a class="small-btn" href="/">⬅️ Team start page</a>
        <button class="small-btn" id="retryAuth">🔄 Retry</button>
      </div>
    </div>

    <div class="terry-greeting">
      <div class="terry-character">
        <img src="/terry-thinking.png" alt="Terry, your Quest guide">
      </div>
      <p class="terry-note">
        Ahoy! These are the rarest treasures—kindness gems! Share one great deed with a photo and a short tale. Terry’s magical AI will weigh it for doubloons. 💛
        <br/>
        <button class="scoring-rules-btn" id="scoringRulesBtn">💖 View scoring</button>
      </p>
    </div>

    <div class="instructions">
      <h3>💎 How to submit</h3>
      <ul>
        <li>Do a genuine act of kindness.</li>
        <li>Take a clear photo of the deed or outcome.</li>
        <li>Tell us briefly what you did and the impact.</li>
      </ul>
    </div>

    <form id="kindnessForm" aria-describedby="formHelp">
      <div class="form-group">
        <label for="photoUpload">📸 Photo of your kind act</label>
        <div class="file-upload">
          <input type="file" id="photoUpload" class="file-input" accept="image/*" required aria-required="true">
          <label for="photoUpload" class="file-upload-btn">📷 Upload photo</label>
        </div>
        <div class="file-preview" id="filePreview">
          <img id="previewImage" alt="Selected photo preview">
          <div class="file-info" id="fileInfo"></div>
        </div>
      </div>

      <div class="form-group">
        <label for="kindnessDescription">✍️ What happened?</label>
        <textarea id="kindnessDescription" maxlength="500" placeholder="What did you do? Who did it help? Any results or reactions?" required aria-required="true"></textarea>
        <div class="char-count"><span id="charCount">500</span> characters remaining</div>
      </div>

      <div class="form-group">
        <label for="location">📍 Where? (optional)</label>
        <input type="text" id="location" placeholder="e.g., High Street, community centre">
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        <span class="btn-label">💎 Submit Heart Treasure</span>
      </button>

      <p id="formHelp" style="margin-top:8px;color:#654321;font-weight:600">One submission per team is scored. Be honest and keep it kind.</p>
    </form>

    <div class="loading" id="loading"><span class="spinner" aria-hidden="true"></span> Uploading & submitting…</div>

    <div class="message" id="feedback" role="status" aria-live="polite"></div>
  </div>

  <script>
    // ——— Query + Local Storage ———
    const qs = new URLSearchParams(location.search);
    const EVENT_ID   = qs.get('event') || qs.get('eventId') || '';
    const TEAM_CODE  = localStorage.getItem('teamCode')  || '';
    const TEAM_NAME  = localStorage.getItem('teamName')  || '';
    const TEAM_TOKEN = localStorage.getItem('teamToken') || '';

    // ——— Fetch helper with JWT ———
    async function callFn(path, payload){
      const res = await fetch(`/.netlify/functions/${path}`,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          ...(TEAM_TOKEN ? {'Authorization':`Bearer ${TEAM_TOKEN}`} : {})
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || data.success === false) throw new Error(data.message || `Request failed (${res.status})`);
      return data;
    }

    // ——— UI helpers ———
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu');
    if(navToggle && navMenu){
      navToggle.addEventListener('click', ()=> {
        navMenu.classList.toggle('active');
        navToggle.textContent = navMenu.classList.contains('active') ? '✕' : '☰';
      });
      document.addEventListener('click', (e)=>{
        const inside = navToggle.contains(e.target) || navMenu.contains(e.target);
        if(!inside && navMenu.classList.contains('active')){ navMenu.classList.remove('active'); navToggle.textContent='☰'; }
      });
    }

    const stateBanner = document.getElementById('stateBanner');
    const teamInfo    = document.getElementById('teamInfo');
    const authGate    = document.getElementById('authGate');
    const retryAuth   = document.getElementById('retryAuth');
    const form        = document.getElementById('kindnessForm');
    const submitBtn   = document.getElementById('submitBtn');
    const loadingEl   = document.getElementById('loading');
    const feedbackEl  = document.getElementById('feedback');
    const descEl      = document.getElementById('kindnessDescription');
    const countEl     = document.getElementById('charCount');
    const locEl       = document.getElementById('location');
    const fileInput   = document.getElementById('photoUpload');
    const filePreview = document.getElementById('filePreview');
    const previewImage= document.getElementById('previewImage');
    const fileInfo    = document.getElementById('fileInfo');

    function setFeedback(msg,type){
      feedbackEl.innerHTML = msg;
      feedbackEl.className = `message ${type==='error'?'error-message':'success-message'}`;
      feedbackEl.style.display='block';
    }
    function clearFeedback(){
      feedbackEl.textContent='';
      feedbackEl.style.display='none';
    }
    function setSubmitting(on){
      submitBtn.disabled = on;
      loadingEl.style.display = on ? 'block':'none';
      submitBtn.innerHTML = on ? `<span class="spinner" aria-hidden="true"></span> Submitting…` : `<span class="btn-label">💎 Submit Heart Treasure</span>`;
    }
    function disableForm(disabled, reason=''){
      [...form.elements].forEach(el=>el.disabled = disabled);
      if(disabled && reason){ setFeedback(reason,'error'); }
    }

    // ——— Draft persistence ———
    const draftKey = ()=> `kindnessDraft:${EVENT_ID}:${TEAM_CODE}`;
    function saveDraft(){
      const d = { description: descEl.value || '', location: locEl.value || '' };
      localStorage.setItem(draftKey(), JSON.stringify(d));
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(draftKey());
        if(!raw) return;
        const d = JSON.parse(raw);
        if(d.description) descEl.value = d.description;
        if(d.location) locEl.value = d.location;
        updateCharCount();
      }catch{}
    }
    function clearDraft(){ localStorage.removeItem(draftKey()); }

    // ——— Event state ———
    async function refreshEventState(){
      if(!EVENT_ID){
        stateBanner.textContent = 'Missing eventId in the URL (?event=...).';
        stateBanner.className = 'status-banner ended';
        stateBanner.style.display='block';
        disableForm(true,'Open this page from your Team link so we know your event.');
        return 'UNKNOWN';
      }
      try{
        const { state } = await callFn('get_event_state', { eventId: EVENT_ID });
        let text = '';
        let cls = 'status-banner';
        let lock = false;
        if(state === 'NOT_STARTED'){ text='Event not started yet. You’ll be able to submit when it begins.'; cls+=' paused'; lock=true; }
        if(state === 'PAUSED'){ text='Event paused — submissions temporarily closed.'; cls+=' paused'; lock=true; }
        if(state === 'RUNNING'){ text='Event running — submit your kindness when ready.'; cls='status-banner'; lock=false; }
        if(state === 'ENDED'){ text='Event ended — submissions are closed.'; cls+=' ended'; lock=true; }
        if(state === 'PUBLISHED'){ text='Results published! Check the Gallery to see entries.'; cls+=' published'; lock=true; }
        stateBanner.textContent = text;
        stateBanner.className = cls;
        stateBanner.style.display = text ? 'block':'none';
        disableForm(lock);
        return state;
      }catch{
        stateBanner.textContent = 'Could not verify event state. You may still try to submit.';
        stateBanner.className = 'status-banner';
        stateBanner.style.display='block';
        return 'UNKNOWN';
      }
    }

    // ——— Auth gate ———
    function checkAuth(){
      teamInfo.textContent = TEAM_NAME ? `Crew: ${TEAM_NAME}` : (TEAM_CODE ? `Crew code: ${TEAM_CODE}` : 'Crew: unknown');
      const authed = Boolean(TEAM_TOKEN && EVENT_ID && TEAM_CODE);
      authGate.style.display = authed ? 'none' : 'block';
      form.style.display = authed ? 'block' : 'none';
      return authed;
    }

    if(retryAuth){ retryAuth.addEventListener('click', ()=> { location.reload(); }); }

    // ——— Scoring Modal ———
    const scoringRulesBtn = document.getElementById('scoringRulesBtn');
    const scoringModal = document.getElementById('scoringModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    if(scoringRulesBtn){ scoringRulesBtn.addEventListener('click', ()=> scoringModal.classList.add('active')); }
    if(closeModalBtn){ closeModalBtn.addEventListener('click', ()=> scoringModal.classList.remove('active')); }
    if(scoringModal){ scoringModal.addEventListener('click', (e)=>{ if(e.target===scoringModal) scoringModal.classList.remove('active'); }); }

    // ——— Character counter ———
    function updateCharCount(){
      const remaining = 500 - (descEl.value?.length || 0);
      countEl.textContent = remaining;
      countEl.style.color = remaining < 50 ? '#DC143C' : '#8B4513';
    }
    descEl.addEventListener('input', ()=>{ updateCharCount(); saveDraft(); });
    locEl.addEventListener('input', saveDraft);

    // ——— File preview ———
    fileInput.addEventListener('change', (e)=>{
      clearFeedback();
      const file = e.target.files[0];
      if(!file){ filePreview.style.display='none'; return; }
      if(file.size > 5*1024*1024){ setFeedback('Image must be under 5MB.','error'); fileInput.value=''; filePreview.style.display='none'; return;}
      if(!file.type.startsWith('image/')){ setFeedback('Please upload an image file.','error'); fileInput.value=''; filePreview.style.display='none'; return;}
      const reader = new FileReader();
      reader.onload = ev => { previewImage.src = ev.target.result; filePreview.style.display='block'; };
      reader.readAsDataURL(file);
      fileInfo.innerHTML = `<strong>File:</strong> ${file.name}<br><strong>Size:</strong> ${(file.size/1024/1024).toFixed(2)} MB<br><strong>Type:</strong> ${file.type}`;
    });

    // ——— Uploadcare (simple direct) ———
    async function uploadToUploadcare(file){
      const uploadcarePublicKey = 'e060d7b73e9b8e15de28';
      const fd = new FormData();
      fd.append('UPLOADCARE_PUB_KEY', uploadcarePublicKey);
      fd.append('file', file);
      const res = await fetch('https://upload.uploadcare.com/base/', { method:'POST', body: fd });
      if(!res.ok) throw new Error(`Upload failed (${res.status})`);
      const json = await res.json();
      if(!json.file) throw new Error('No file ID returned.');
      return `https://ucarecdn.com/${json.file}/`;
    }

    // ——— Submit ———
    async function doSubmit(){
      clearFeedback();

      if(!TEAM_TOKEN || !TEAM_CODE || !EVENT_ID){
        setFeedback('Missing team or event info. Reload from your Team link.','error');
        return;
      }

      // re-check event is RUNNING
      try{
        const { state } = await callFn('get_event_state', { eventId: EVENT_ID });
        if(state !== 'RUNNING'){
          setFeedback(`Submissions are closed (state: ${state}).`,'error');
          return;
        }
      }catch{
        // allow attempt if state unknown
      }

      const photoFile = fileInput.files[0];
      const description = descEl.value.trim();
      const locationVal = locEl.value.trim();

      if(!photoFile){ setFeedback('Please upload a photo of your kindness.','error'); return; }
      if(description.length < 20){ setFeedback('Tell us a little more (min 20 characters).','error'); return; }

      setSubmitting(true);

      try{
        const photoUrl = await uploadToUploadcare(photoFile);

        const payload = {
          eventId: EVENT_ID,
          teamCode: TEAM_CODE,
          token: TEAM_TOKEN,
          description,
          location: locationVal,
          photoUrl
        };

        await callFn('submit_kindness_function', payload);

        // Success — celebrate, lock form, clear draft
        setFeedback('🎉 Submitted! Your kindness is in Terry’s vault. Check the leaderboard/gallery soon.', 'success');
        clearDraft();
        [...form.elements].forEach(el=>el.disabled = true);
        form.style.opacity = '0.6';

      }catch(err){
        setFeedback(`Couldn’t submit. ${err.message || 'Please try again.'} <br><br><button class="small-btn" id="retryBtn">🔁 Retry</button>`, 'error');
        const btn = document.getElementById('retryBtn');
        if(btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); doSubmit(); });
      }finally{
        setSubmitting(false);
      }
    }

    document.getElementById('kindnessForm').addEventListener('submit', (e)=>{ e.preventDefault(); doSubmit(); });

    // ——— Init ———
    (async function init(){
      // Nav close on link click (mobile)
      const navLinks = document.querySelectorAll('.nav-link, .dropdown-link');
      navLinks.forEach(link => link.addEventListener('click', ()=> {
        navMenu.classList.remove('active'); navToggle.textContent='☰';
      }));

      updateCharCount();
      loadDraft();
      const authed = checkAuth();
      await refreshEventState();
      if(!authed) return;
    })();
  </script>
</body>
</html>
