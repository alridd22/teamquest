<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest – Terry’s Kind Acts</title>
  <style>
    /* ————— NAV ————— */
    .treasure-nav{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:1000;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;height:80px}
    .nav-container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 20px;height:100%}
    .nav-logo{text-decoration:none;transition:.3s;display:flex;align-items:center}
    .nav-logo:hover{transform:scale(1.05)}
    .nav-logo img{height:50px;width:auto;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5));transition:.3s}
    .nav-logo:hover img{filter:drop-shadow(2px 2px 8px rgba(255,215,0,.6))}
    .nav-menu{display:flex;list-style:none;margin:0;padding:0;gap:30px}
    .nav-item{position:relative}
    .nav-link{color:#F5DEB3;text-decoration:none;font-size:1rem;font-weight:bold;padding:12px 18px;border-radius:8px;transition:.3s;display:block;text-shadow:1px 1px 2px rgba(0,0,0,.7);background:rgba(101,67,33,.3);border:2px solid rgba(218,165,32,.4);white-space:nowrap}
    .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(218,165,32,.4);border-color:#DAA520}
    .nav-dropdown{position:absolute;top:100%;left:0;background:linear-gradient(135deg,#654321 0%,#8B4513 100%);border:2px solid #DAA520;border-radius:8px;min-width:180px;opacity:0;visibility:hidden;transform:translateY(-10px);transition:.3s;box-shadow:0 8px 20px rgba(0,0,0,.3)}
    .nav-item:hover .nav-dropdown{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-link{display:block;color:#F5DEB3;text-decoration:none;padding:12px 18px;font-size:.95rem;border-bottom:1px solid rgba(218,165,32,.2);transition:.3s;background:rgba(101,67,33,.2);margin:2px;border-radius:6px;font-weight:600}
    .dropdown-link:last-child{border-bottom:none}
    .dropdown-link:hover{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;padding-left:25px;transform:translateX(5px);box-shadow:0 2px 8px rgba(255,140,0,.3)}
    .nav-toggle{display:none;background:none;border:none;color:#DAA520;font-size:1.8rem;cursor:pointer}
    @media (max-width:768px){
      .treasure-nav{height:120px}
      .nav-container{justify-content:center;position:relative}
      .nav-logo{position:absolute;left:50%;transform:translateX(-50%)}
      .nav-logo img{height:85px!important}
      .nav-toggle{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:block}
      .nav-menu{position:fixed;top:120px;left:-100%;width:100%;height:calc(100vh - 120px);background:linear-gradient(135deg,#8B4513 0%,#654321 100%);flex-direction:column;align-items:center;padding-top:30px;gap:20px;transition:left .3s;overflow-y:auto}
      .nav-menu.active{left:0}
      .nav-link{font-size:1.1rem;padding:15px 25px;width:280px;text-align:center;background:linear-gradient(135deg,rgba(101,67,33,.8),rgba(139,69,19,.6));border:2px solid #DAA520;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);transform:translateY(-3px);box-shadow:0 6px 15px rgba(218,165,32,.4)}
      .nav-dropdown{position:static;opacity:1;visibility:visible;transform:none;background:rgba(101,67,33,.9);border:2px solid #DAA520;border-radius:12px;margin-top:10px;width:280px;box-shadow:0 8px 20px rgba(0,0,0,.4)}
      .dropdown-link{padding:12px 20px;font-size:1rem;margin:4px;border-radius:8px;text-align:center;background:rgba(139,69,19,.4);border:1px solid rgba(218,165,32,.3)}
      .dropdown-link:hover{background:linear-gradient(135deg,#FF8C00,#DAA520);padding-left:20px;transform:translateY(-2px)}
    }

    /* ————— PAGE ————— */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;padding-top:100px!important;position:relative}
    @media (max-width:768px){body{padding-top:140px!important}}
    body::before{content:'';position:fixed;inset:0;background:
      radial-gradient(circle at 20% 20%,rgba(255,215,0,.1) 0%,transparent 50%),
      radial-gradient(circle at 80% 80%,rgba(255,140,0,.1) 0%,transparent 50%),
      radial-gradient(circle at 40% 60%,rgba(255,182,193,.15) 0%,transparent 50%)}
    .container{background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border-radius:25px;padding:34px;box-shadow:0 20px 40px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.3);max-width:720px;width:100%;position:relative;overflow:hidden;z-index:1;border:3px solid #8B4513}
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#FFD700,#FF8C00,#FFB6C1,#DAA520,#FFD700)}
    .container::after{content:'';position:absolute;top:15px;left:15px;right:15px;bottom:15px;border:2px solid #DAA520;border-radius:20px;pointer-events:none}
    .logo{text-align:center;margin-bottom:16px;position:relative;z-index:2}
    .heart-icon{font-size:44px;margin-bottom:10px;animation:heartbeat 2s infinite;filter:drop-shadow(2px 2px 4px rgba(139,69,19,.3))}
    @keyframes heartbeat{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    h1{color:#8B4513;text-align:center;margin-bottom:6px;font-size:2.1em;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .subtitle{text-align:center;color:#A0522D;margin-bottom:16px;font-size:1.05em;font-weight:600}

    .status-banner{display:none;margin:12px 0 18px;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:2px solid #DAA520;border-left:6px solid #FF8C00;border-radius:10px;padding:12px 14px;color:#654321;font-weight:600}
    .status-banner.paused{border-left-color:#DAA520}
    .status-banner.ended{border-left-color:#8B0000}
    .status-banner.published{border-left-color:#32CD32}

    .team-info{background:linear-gradient(135deg,#8B4513,#A0522D);color:#fff;padding:14px;border-radius:14px;text-align:center;font-size:1.05em;font-weight:700;margin-bottom:12px;box-shadow:0 5px 15px rgba(139,69,19,.3);border:2px solid #DAA520}
    .auth-card{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:3px dashed #DAA520;border-radius:14px;padding:16px;margin:10px 0}
    .auth-grid{display:grid;grid-template-columns:1fr 160px;gap:10px}
    @media (max-width:560px){.auth-grid{grid-template-columns:1fr}}
    .auth-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .small-btn{background:#8B4513;color:#fff;border:2px solid #DAA520;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .small-btn:hover{background:#A0522D}

    .terry-greeting{display:flex;gap:16px;margin:12px 0;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-radius:16px;padding:18px;border:3px solid #DAA520;box-shadow:0 5px 15px rgba(139,69,19,.2)}
    .terry-character img{width:100px;height:100px;border-radius:12px;border:4px solid #DAA520;box-shadow:0 4px 12px rgba(139,69,19,.3);object-fit:cover;background:linear-gradient(135deg,#8B4513,#A0522D);display:block}
    .terry-note{background:linear-gradient(135deg,#FFB6C1 0%,#FFC0CB 100%);color:#8B4513;padding:16px;border-radius:12px;border:3px solid #DAA520;font-weight:600;line-height:1.5;box-shadow:0 5px 15px rgba(255,182,193,.3)}
    .scoring-rules-btn{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-size:.95em;font-weight:800;cursor:pointer;transition:.2s;margin-top:10px;border:2px solid #8B4513;display:inline-flex;align-items:center;gap:6px}
    .scoring-rules-btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(255,140,0,.3)}

    .instructions{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-left:6px solid #DAA520;padding:16px;margin:14px 0 18px;border-radius:0 12px 12px 0;box-shadow:0 4px 12px rgba(139,69,19,.1);border:2px solid #DAA520;border-left:6px solid #FF8C00}
    .instructions h3{color:#8B4513;margin-bottom:8px;display:flex;align-items:center;gap:8px;font-size:1.1em;font-weight:800}
    .instructions ul{margin-left:18px;color:#654321;line-height:1.65}

    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:8px;color:#8B4513;font-weight:700;font-size:1.02em}
    select,input[type="text"],input[type="number"],textarea{width:100%;padding:14px;border:3px solid #DAA520;border-radius:12px;font-size:16px;transition:.2s;background:linear-gradient(145deg,#fff 0%,#FFF8DC 100%);font-family:inherit}
    select:focus,input[type="text"]:focus,input[type="number"]:focus,textarea:focus{outline:none;border-color:#FF8C00;background:#fff;box-shadow:0 0 0 3px rgba(255,140,0,.2);transform:translateY(-1px)}
    .pin{font-weight:800;letter-spacing:2px;text-align:center}
    textarea{min-height:120px;resize:vertical;line-height:1.5}
    .char-count{text-align:right;font-size:.9em;color:#8B4513;margin-top:5px;font-weight:600}

    .file-upload{position:relative;display:inline-block;width:100%}
    .file-input{display:none}
    .file-upload-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:18px;border:3px dashed #DAA520;border-radius:12px;background:linear-gradient(145deg,#FFF8DC 0%,#F5E6D3 100%);cursor:pointer;transition:.2s;color:#8B4513;font-weight:800;font-size:1em}
    .file-upload-btn:hover{background:linear-gradient(145deg,#FFD700 0%,#FFA500 100%);border-color:#FF8C00;transform:translateY(-1px);box-shadow:0 8px 20px rgba(255,140,0,.2)}
    .file-preview{margin-top:14px;text-align:center;display:none}
    .file-preview img{max-width:100%;max-height:220px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.2);border:3px solid #32CD32}
    .file-info{margin-top:12px;padding:12px;background:linear-gradient(135deg,#F0FFF0 0%,#E6FFE6 100%);border-radius:10px;font-size:.95em;color:#654321;border:2px solid #32CD32}

    .submit-btn{width:100%;background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:none;padding:16px;border-radius:14px;font-size:1.1em;font-weight:900;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:10px;border:3px solid #8B4513;text-shadow:1px 1px 2px rgba(0,0,0,.2)}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 12px 25px rgba(255,140,0,.3);background:linear-gradient(135deg,#FFB347,#F0C814)}
    .submit-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;background:linear-gradient(135deg,#A0522D,#8B4513)}
    .spinner{width:16px;height:16px;border:3px solid rgba(255,255,255,.5);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .message{padding:16px;border-radius:14px;margin:16px 0;text-align:center;display:none;border:3px solid;font-weight:700}
    .success-message{background:linear-gradient(135deg,#90EE90 0%,#98FB98 100%);border-color:#32CD32;color:#064b06}
    .error-message{background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);border-color:#DC143C;color:#8B0000}
    .loading{display:none;text-align:center;margin-top:12px;color:#8B4513;font-weight:800;font-size:1.02em}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo" aria-label="TeamQuest Home">
        <img src="/Team Quest Logo-01.png" alt="TeamQuest Logo">
      </a>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link">🎯 Activities ▼</a>
          <div class="nav-dropdown" role="menu">
            <a href="https://theteamquest.netlify.app/clue_hunt_challenge" class="dropdown-link" role="menuitem">💎 The Treasure Hunt</a>
            <a href="https://theteamquest.netlify.app/scavenger_hunt" class="dropdown-link" role="menuitem">🔍 The Scavenger Hunt</a>
            <a href="https://theteamquest.netlify.app/quiz_challenge" class="dropdown-link" role="menuitem">⏰ The Timed Quiz</a>
            <a href="https://theteamquest.netlify.app/limerick_challenge_page" class="dropdown-link" role="menuitem">📝 The Limerick Challenge</a>
          </div>
        </li>
        <li class="nav-item"><a href="https://theteamquest.netlify.app/teamquest_leaderboard" class="nav-link">🏆 The Leaderboard</a></li>
        <li class="nav-item"><a href="https://theteamquest.netlify.app/teamquest_gallery" class="nav-link">📸 The Gallery</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle menu">☰</button>
    </div>
  </nav>

  <div class="container" id="app">
    <div class="logo">
      <div class="heart-icon">💖</div>
      <h1>Terry’s Kind Acts</h1>
      <p class="subtitle">Do good. Snap it. Tell us. Earn doubloons.</p>
    </div>

    <div id="stateBanner" class="status-banner" role="status" aria-live="polite"></div>

    <div class="team-info" id="teamInfo">Crew: unknown</div>

    <!-- Sign-in block (team dropdown + PIN) -->
    <div class="auth-card" id="signinCard" aria-live="polite">
      <div class="auth-grid">
        <div>
          <label for="teamSelect">Choose your crew</label>
          <select id="teamSelect" aria-label="Team list">
            <option value="">Loading teams…</option>
          </select>
        </div>
        <div>
          <label for="teamPin">Crew PIN</label>
          <input id="teamPin" class="pin" type="number" inputmode="numeric" min="0000" max="9999" placeholder="1234" />
        </div>
      </div>
      <div class="auth-actions">
        <button class="small-btn" id="signinBtn">🔓 Unlock Kindness</button>
        <button class="small-btn" id="clearBtn" title="Forget local team info">🗑️ Clear local data</button>
      </div>
      <div class="message" id="signinMsg"></div>
    </div>

    <!-- Terry intro -->
    <div class="terry-greeting">
      <div class="terry-character">
        <img src="/terry-thinking.png" alt="Terry, your Quest guide">
      </div>
      <p class="terry-note">
        Ahoy! These are the rarest treasures—kindness gems! Share one great deed with a photo and a short tale. Terry’s magical AI will weigh it for doubloons. 💛
        <br/>
        <button class="scoring-rules-btn" id="scoringRulesBtn">💖 View scoring</button>
      </p>
    </div>

    <div class="instructions">
      <h3>💎 How to submit</h3>
      <ul>
        <li>Do a genuine act of kindness.</li>
        <li>Take a clear photo of the deed or outcome.</li>
        <li>Tell us briefly what you did and the impact.</li>
      </ul>
    </div>

    <!-- Submission form -->
    <form id="kindnessForm" aria-describedby="formHelp" style="display:none;">
      <div class="form-group">
        <label for="photoUpload">📸 Photo of your kind act</label>
        <div class="file-upload">
          <input type="file" id="photoUpload" class="file-input" accept="image/*" required aria-required="true">
          <label for="photoUpload" class="file-upload-btn">📷 Upload photo</label>
        </div>
        <div class="file-preview" id="filePreview">
          <img id="previewImage" alt="Selected photo preview">
          <div class="file-info" id="fileInfo"></div>
        </div>
      </div>

      <div class="form-group">
        <label for="kindnessDescription">✍️ What happened?</label>
        <textarea id="kindnessDescription" maxlength="500" placeholder="What did you do? Who did it help? Any results or reactions?" required aria-required="true"></textarea>
        <div class="char-count"><span id="charCount">500</span> characters remaining</div>
      </div>

      <div class="form-group">
        <label for="location">📍 Where? (optional)</label>
        <input type="text" id="location" placeholder="e.g., High Street, community centre">
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        <span class="btn-label">💎 Submit Heart Treasure</span>
      </button>

      <p id="formHelp" style="margin-top:8px;color:#654321;font-weight:600">One submission per team is scored. Be honest and keep it kind.</p>
    </form>

    <div class="loading" id="loading"><span class="spinner" aria-hidden="true"></span> Uploading & submitting…</div>

    <div class="message" id="feedback" role="status" aria-live="polite"></div>
  </div>

  <script>
    // ——— URL + Storage ———
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event') || qs.get('eventId') || '';

    function token(){ return localStorage.getItem('teamToken') || ''; }
    function teamCode(){ return localStorage.getItem('teamCode') || ''; }
    function teamName(){ return localStorage.getItem('teamName') || ''; }

    // ——— Fetch helper (reads token on each call) ———
    async function callFn(path, payload){
      const res = await fetch(`/.netlify/functions/${path}`,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          ...(token() ? {'Authorization':`Bearer ${token()}`} : {})
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || data.success === false) throw new Error(data.message || `Request failed (${res.status})`);
      return data;
    }

    // ——— Elements ———
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu');
    if(navToggle && navMenu){
      navToggle.addEventListener('click', ()=> {
        navMenu.classList.toggle('active');
        navToggle.textContent = navMenu.classList.contains('active') ? '✕' : '☰';
      });
      document.addEventListener('click', (e)=>{
        const inside = navToggle.contains(e.target) || navMenu.contains(e.target);
        if(!inside && navMenu.classList.contains('active')){ navMenu.classList.remove('active'); navToggle.textContent='☰'; }
      });
    }

    const stateBanner = document.getElementById('stateBanner');
    const teamInfo = document.getElementById('teamInfo');
    const signinCard = document.getElementById('signinCard');
    const signinBtn = document.getElementById('signinBtn');
    const clearBtn = document.getElementById('clearBtn');
    const signinMsg = document.getElementById('signinMsg');
    const teamSelect = document.getElementById('teamSelect');
    const teamPin = document.getElementById('teamPin');

    const form = document.getElementById('kindnessForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingEl = document.getElementById('loading');
    const feedbackEl = document.getElementById('feedback');
    const descEl = document.getElementById('kindnessDescription');
    const countEl = document.getElementById('charCount');
    const locEl = document.getElementById('location');
    const fileInput = document.getElementById('photoUpload');
    const filePreview = document.getElementById('filePreview');
    const previewImage = document.getElementById('previewImage');
    const fileInfo = document.getElementById('fileInfo');

    // ——— Small UI helpers ———
    function setFeedback(msg,type){ feedbackEl.innerHTML = msg; feedbackEl.className = `message ${type==='error'?'error-message':'success-message'}`; feedbackEl.style.display='block'; }
    function clearFeedback(){ feedbackEl.textContent=''; feedbackEl.style.display='none'; }
    function setSigninMsg(msg,type='error'){ signinMsg.textContent = msg; signinMsg.className = `message ${type==='error'?'error-message':'success-message'}`; signinMsg.style.display='block'; }
    function clearSigninMsg(){ signinMsg.textContent=''; signinMsg.style.display='none'; }
    function setSubmitting(on){ submitBtn.disabled = on; loadingEl.style.display = on ? 'block':'none'; submitBtn.innerHTML = on ? `<span class="spinner" aria-hidden="true"></span> Submitting…` : `<span class="btn-label">💎 Submit Heart Treasure</span>`; }
    function disableForm(disabled){ [...form.elements].forEach(el=>el.disabled = disabled); }

    // ——— Draft persistence ———
    const draftKey = ()=> `kindnessDraft:${EVENT_ID}:${teamCode()}`;
    function saveDraft(){ localStorage.setItem(draftKey(), JSON.stringify({ description: descEl.value||'', location: locEl.value||'' })); }
    function loadDraft(){ try{ const raw = localStorage.getItem(draftKey()); if(raw){ const d=JSON.parse(raw); if(d.description) descEl.value=d.description; if(d.location) locEl.value=d.location; updateCharCount(); } }catch{} }
    function clearDraft(){ localStorage.removeItem(draftKey()); }

    // ——— Event state ———
    async function refreshEventState(){
      if(!EVENT_ID){
        stateBanner.textContent = 'Missing eventId in the URL (?event=...).';
        stateBanner.className = 'status-banner ended';
        stateBanner.style.display='block';
        disableForm(true);
        return 'UNKNOWN';
      }
      try{
        const { state } = await callFn('get_event_state', { eventId: EVENT_ID });
        let text = '', cls = 'status-banner', lock = false;
        if(state === 'NOT_STARTED'){ text='Event not started yet.'; cls+=' paused'; lock=true; }
        if(state === 'PAUSED'){ text='Event paused — submissions temporarily closed.'; cls+=' paused'; lock=true; }
        if(state === 'RUNNING'){ text='Event running — submit your kindness when ready.'; cls='status-banner'; lock=false; }
        if(state === 'ENDED'){ text='Event ended — submissions are closed.'; cls+=' ended'; lock=true; }
        if(state === 'PUBLISHED'){ text='Results published! Check the Gallery.'; cls+=' published'; lock=true; }
        stateBanner.textContent = text; stateBanner.className = cls; stateBanner.style.display = text ? 'block':'none';
        disableForm(lock);
        return state;
      }catch{
        stateBanner.textContent = 'Could not verify event state.'; stateBanner.className='status-banner'; stateBanner.style.display='block'; return 'UNKNOWN';
      }
    }

    // ——— Auth (dropdown + PIN) ———
    function updateCrewLabel(){ teamInfo.textContent = teamName() ? `Crew: ${teamName()}` : (teamCode() ? `Crew code: ${teamCode()}` : 'Crew: unknown'); }

    async function loadTeams(){
      try{
        const data = await callFn('get_leaderboard', { eventId: EVENT_ID });
        const teams = Array.isArray(data.teams) ? data.teams : [];
        teams.sort((a,b)=> (a.teamName||'').localeCompare(b.teamName||''));
        teamSelect.innerHTML = `<option value="">Choose your crew…</option>` + teams.map(t=>`<option value="${t.teamCode}">${t.teamName}</option>`).join('');
      }catch(e){
        teamSelect.innerHTML = `<option value="">Couldn’t load teams</option>`;
        setSigninMsg('Couldn’t load team list. Try again or refresh.', 'error');
      }
    }

    async function signIn(){
      clearSigninMsg(); clearFeedback();
      const code = teamSelect.value;
      const pin = (teamPin.value || '').trim();
      if(!code){ setSigninMsg('Pick your crew from the list.'); return; }
      if(!/^\d{4}$/.test(pin)){ setSigninMsg('Enter your 4-digit PIN.'); return; }

      try{
        const res = await callFn('verify_team_pin_function', { eventId: EVENT_ID, teamCode: code, pin });
        // expected: { success:true, valid:true, token?:string, teamName?:string }
        if(!res.valid){ setSigninMsg('That PIN doesn’t match this crew.'); return; }
        if(res.token) localStorage.setItem('teamToken', res.token);
        localStorage.setItem('teamCode', code);
        if(res.teamName){
          localStorage.setItem('teamName', res.teamName);
        } else {
          const opt = teamSelect.options[teamSelect.selectedIndex]; localStorage.setItem('teamName', opt ? opt.textContent : '');
        }
        updateCrewLabel();
        setSigninMsg('Signed in. You can submit now!', 'success');
        form.style.display = 'block';
      }catch(err){
        if(String(err.message).includes('404')){
          setSigninMsg('Sign-in service is off. Ask the host to enable verify_team_pin_function.', 'error');
        }else{
          setSigninMsg(err.message || 'Could not sign you in. Try again.', 'error');
        }
      }
    }

    // ——— Character counter ———
    function updateCharCount(){ const remaining = 500 - (descEl.value?.length || 0); countEl.textContent = remaining; countEl.style.color = remaining < 50 ? '#DC143C' : '#8B4513'; }
    descEl?.addEventListener('input', ()=>{ updateCharCount(); saveDraft(); });
    locEl?.addEventListener('input', saveDraft);

    // ——— File preview ———
    fileInput?.addEventListener('change', (e)=>{
      clearFeedback(); const file = e.target.files[0];
      if(!file){ filePreview.style.display='none'; return; }
      if(file.size > 5*1024*1024){ setFeedback('Image must be under 5MB.','error'); fileInput.value=''; filePreview.style.display='none'; return;}
      if(!file.type.startsWith('image/')){ setFeedback('Please upload an image file.','error'); fileInput.value=''; filePreview.style.display='none'; return;}
      const reader = new FileReader();
      reader.onload = ev => { previewImage.src = ev.target.result; filePreview.style.display='block'; };
      reader.readAsDataURL(file);
      fileInfo.innerHTML = `<strong>File:</strong> ${file.name}<br><strong>Size:</strong> ${(file.size/1024/1024).toFixed(2)} MB<br><strong>Type:</strong> ${file.type}`;
    });

    // ——— Uploadcare ———
    async function uploadToUploadcare(file){
      const uploadcarePublicKey = 'e060d7b73e9b8e15de28';
      const fd = new FormData();
      fd.append('UPLOADCARE_PUB_KEY', uploadcarePublicKey);
      fd.append('file', file);
      const res = await fetch('https://upload.uploadcare.com/base/', { method:'POST', body: fd });
      if(!res.ok) throw new Error(`Upload failed (${res.status})`);
      const json = await res.json();
      if(!json.file) throw new Error('No file ID returned.');
      return `https://ucarecdn.com/${json.file}/`;
    }

    // ——— Submit ———
    async function doSubmit(){
      clearFeedback();

      if(!teamCode()){ setFeedback('Sign in with your crew and PIN first.','error'); return; }
      if(!EVENT_ID){ setFeedback('Missing eventId in the URL.','error'); return; }

      try{
        const { state } = await callFn('get_event_state', { eventId: EVENT_ID });
        if(state !== 'RUNNING'){ setFeedback(`Submissions are closed (state: ${state}).`,'error'); return; }
      }catch{ /* allow attempt if unknown */ }

      const photoFile = fileInput.files[0];
      const description = (descEl.value||'').trim();
      const locationVal = (locEl.value||'').trim();
      if(!photoFile){ setFeedback('Please upload a photo of your kindness.','error'); return; }
      if(description.length < 20){ setFeedback('Tell us a little more (min 20 characters).','error'); return; }

      setSubmitting(true);
      try{
        const photoUrl = await uploadToUploadcare(photoFile);
        await callFn('submit_kindness_function', {
          eventId: EVENT_ID,
          teamCode: teamCode(),
          token: token(),          // passed if available
          description,
          location: locationVal,
          photoUrl
        });
        setFeedback('🎉 Submitted! Your kindness is in Terry’s vault. Check the leaderboard/gallery soon.', 'success');
        clearDraft();
        [...form.elements].forEach(el=>el.disabled = true);
        form.style.opacity = '0.6';
      }catch(err){
        setFeedback(`Couldn’t submit. ${err.message || 'Please try again.'} <br><br><button class="small-btn" id="retryBtn">🔁 Retry</button>`, 'error');
        const btn = document.getElementById('retryBtn'); if(btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); doSubmit(); });
      }finally{
        setSubmitting(false);
      }
    }

    // ——— Modal ———
    const scoringRulesBtn = document.getElementById('scoringRulesBtn');
    scoringRulesBtn?.addEventListener('click', ()=>{
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.innerHTML = `<div class="modal-content">
        <button class="close-btn" aria-label="Close">✕</button>
        <div class="modal-title">💖 Heart Treasure Scoring</div>
        <div class="modal-subtitle">Creativity • Effort • Impact (max 60 doubloons)</div>
        <div class="scoring-card"><h4>✨ Creativity (20)</h4><p>Original, thoughtful, personalised acts beat ordinary gestures.</p></div>
        <div class="scoring-card" style="margin-top:10px"><h4>💪 Effort (20)</h4><p>Prep, time, and going the extra mile show commitment.</p></div>
        <div class="scoring-card" style="margin-top:10px"><h4>💝 Impact (20)</h4><p>Clear benefit to someone or your community = big treasure.</p></div>
      </div>`;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e)=>{ if(e.target===modal || e.target.classList.contains('close-btn')) modal.remove(); });
    });

    // ——— Wire up ———
    document.getElementById('kindnessForm')?.addEventListener('submit', (e)=>{ e.preventDefault(); doSubmit(); });
    signinBtn?.addEventListener('click', signIn);
    clearBtn?.addEventListener('click', ()=>{
      localStorage.removeItem('teamToken');
      localStorage.removeItem('teamCode');
      localStorage.removeItem('teamName');
      updateCrewLabel();
      form.style.display='none';
      setSigninMsg('Local team info cleared.', 'success');
    });

    // ——— Init ———
    (async function init(){
      // Close mobile menu when clicking links
      const navLinks = document.querySelectorAll('.nav-link, .dropdown-link');
      navLinks.forEach(link => link.addEventListener('click', ()=> { navMenu.classList.remove('active'); navToggle.textContent='☰'; }));

      updateCrewLabel();
      updateCharCount();
      await refreshEventState();
      await loadTeams();

      if(teamCode()){ form.style.display='block'; } // already signed in on this device
      loadDraft();
    })();
  </script>
</body>
</html>
