<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest - The Quiz Challenge</title>
  <style>
    /* --- Trimmed styling (same look/feel as before) --- */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:20px; padding-top:110px;
    }
    nav{position:fixed;left:0;right:0;top:0;z-index:10;background:linear-gradient(135deg,#8B4513,#654321);border-bottom:3px solid #DAA520;height:80px}
    .nav-container{max-width:1200px;margin:0 auto;height:100%;display:flex;align-items:center;justify-content:space-between;padding:0 16px}
    .nav-logo img{height:50px}
    .nav-menu{display:flex;gap:18px;list-style:none}
    .nav-link{color:#F5DEB3;text-decoration:none;font-weight:700;padding:10px 14px;border-radius:8px;background:rgba(101,67,33,.35);border:2px solid rgba(218,165,32,.4)}
    .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff}
    .container{
      background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);
      border-radius:24px;border:3px solid #8B4513; padding:28px; max-width:900px; width:100%;
      box-shadow:0 20px 40px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.3); position:relative
    }
    .container::before{content:"";position:absolute;left:0;right:0;top:0;height:8px;background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}
    h1{color:#8B4513;text-align:center;margin:6px 0 16px;font-size:2.2rem}
    .subtitle{color:#A0522D;text-align:center;margin-bottom:18px}
    .team-info{background:linear-gradient(135deg,#8B4513,#A0522D);color:#fff;border:2px solid #DAA520;padding:14px;border-radius:12px;font-weight:700;text-align:center;margin-bottom:18px}
    .section{display:none}
    .section.active{display:block}
    .panel{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:2px solid #DAA520;border-radius:14px;padding:18px;margin:14px 0}
    label{color:#8B4513;font-weight:600;margin:8px 0 6px;display:block}
    select,input[type="number"],input[type="text"]{
      width:100%;padding:12px;border:3px solid #DAA520;border-radius:10px;background:linear-gradient(145deg,#fff 0%,#FFF8DC 100%);font-size:16px
    }
    .btn{
      width:100%;background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:2px solid #8B4513;
      padding:16px;border-radius:12px;font-weight:800;margin-top:14px;cursor:pointer
    }
    .btn:hover{box-shadow:0 8px 16px rgba(255,140,0,.35)}
    .msg{display:none;margin-top:12px;padding:12px;border-radius:10px;border:2px solid}
    .msg.error{display:block;background:linear-gradient(135deg,#FFB6C1,#FFA0B4);border-color:#DC143C;color:#7a0015}
    .msg.ok{display:block;background:linear-gradient(135deg,#98FB98,#90EE90);border-color:#32CD32;color:#064d06}
    .quiz-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .timer-circle{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid #8B4513;font-weight:800}
    .question{background:#fff;border:3px solid #DAA520;border-radius:16px;padding:22px;margin:18px 0}
    .options{display:grid;gap:12px}
    .opt{padding:14px;border:3px solid #DAA520;border-radius:12px;background:linear-gradient(135deg,#FFF8DC,#F5E6D3);cursor:pointer}
    .opt.selected{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff}
    .opt.correct{background:linear-gradient(135deg,#2fb12f,#157915);color:#fff}
    .opt.incorrect{background:linear-gradient(135deg,#d3193b,#8b0b23);color:#fff}
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo"><img src="/Team Quest Logo-01.png" alt="TeamQuest"></a>
      <ul class="nav-menu">
        <li><a class="nav-link" href="https://theteamquest.netlify.app/clue_hunt_challenge">üíé Treasure Hunt</a></li>
        <li><a class="nav-link" href="https://theteamquest.netlify.app/scavenger_hunt">üîç Scavenger</a></li>
        <li><a class="nav-link" href="https://theteamquest.netlify.app/kindness_challenge_page">‚ù§Ô∏è Kindness</a></li>
        <li><a class="nav-link" href="https://theteamquest.netlify.app/limerick_challenge_page">üìù Limerick</a></li>
        <li><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_leaderboard">üèÜ Leaderboard</a></li>
        <li><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_gallery">üì∏ Gallery</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <!-- Login -->
    <section id="login" class="section active">
      <h1>The Quiz Challenge</h1>
      <p class="subtitle">10 riddles from Terry‚Äôs archives! Prove your wit and win doubloons.</p>

      <div class="panel">
        <h3 style="color:#8B4513;margin-bottom:10px">üìú Challenge Rules</h3>
        <ul style="color:#5b3b1a;line-height:1.8;margin-left:18px">
          <li>10 riddles ‚Äî 15 seconds each</li>
          <li>Some include audio ‚Äî check your volume</li>
          <li>Choose once ‚Äî no changes</li>
          <li>Up to 100 doubloons for perfection</li>
        </ul>
      </div>

      <div class="panel">
        <label for="teamSelect">Select Your Crew</label>
        <select id="teamSelect">
          <option value="">Choose your treasure hunting crew...</option>
        </select>

        <label for="teamPin" style="margin-top:12px">Enter Your Crew‚Äôs Secret Code</label>
        <input id="teamPin" type="number" inputmode="numeric" placeholder="1234" />

        <button id="beginBtn" class="btn">üéì Begin the Knowledge Trial</button>
        <div id="loginMessage" class="msg"></div>
      </div>
    </section>

    <!-- Ready -->
    <section id="ready" class="section">
      <div id="readyTeam" class="team-info">Crew: ‚Ä¶</div>
      <div class="panel">
        <h3 style="color:#8B4513">‚ö° Ready to roll?</h3>
        <ul style="color:#5b3b1a;line-height:1.8;margin-left:18px">
          <li>15 seconds per riddle</li>
          <li>Choose carefully ‚Äî no changes</li>
          <li>Audio clues may appear</li>
        </ul>
      </div>
      <button id="acceptBtn" class="btn">üí• Accept the challenge</button>
      <div id="readyMessage" class="msg"></div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="section">
      <div id="quizTeam" class="team-info">Crew: ‚Ä¶</div>

      <div class="quiz-header panel">
        <div id="qCounter" style="font-weight:800;color:#8B4513">Riddle 1 of 10</div>
        <div style="display:flex;align-items:center;gap:10px">
          <div id="timer" class="timer-circle">15</div>
          <div style="color:#8B4513;font-weight:700">seconds</div>
        </div>
      </div>

      <div id="questionCard" class="question"></div>
    </section>

    <!-- Results -->
    <section id="results" class="section">
      <div id="resultsTeam" class="team-info">Crew: ‚Ä¶</div>
      <div class="panel">
        <h2 style="color:#8B4513;margin-bottom:8px">üéâ Trial Complete!</h2>
        <div id="finalScore" style="font-size:2.2rem;color:#FF8C00;font-weight:800;margin:6px 0">0/10</div>
        <div> Doubloons earned: <span id="doubloons" style="font-weight:800;color:#FF8C00">0</span> ü™ô</div>
      </div>
      <div id="breakdown" class="panel"></div>
      <button class="btn" onclick="location.href='/teamquest_leaderboard'">üó∫Ô∏è View Treasure Map</button>
      <div id="submitMessage" class="msg" style="margin-top:10px"></div>
    </section>
  </div>

  <script>
    /* ------------ State ------------ */
    let allTeams = [];
    let currentTeam = null;
    let quizStartTime = null;
    let currentIndex = 0;
    let timeLeft = 15;
    let tick = null;
    let answers = [];

    /* ------------ Questions (same as before) ------------ */
    const quizQuestions = [
      {id:1,type:'multiple_choice',question:'What 3 letter animal makes this noise?',audioUrl:'/animal-sound',options:[{letter:'A',text:'Pig'},{letter:'B',text:'Cow'},{letter:'C',text:'Yak'},{letter:'D',text:'Elk'}],correctAnswer:'C',doubloons:10},
      {id:2,type:'multiple_choice',question:'What is the meaning of the word: Gambado?',options:[{letter:'A',text:'Colourful Hat'},{letter:'B',text:'Native of Gambia'},{letter:'C',text:'Prank'},{letter:'D',text:'Foolish bet'}],correctAnswer:'C',doubloons:10},
      {id:3,type:'multiple_choice',question:'Which UK island has its own railway, currency, and parliament, but is not part of the United Kingdom?',options:[{letter:'A',text:'Isle of Man'},{letter:'B',text:'Isle of Skye'},{letter:'C',text:'Isle of Wight'},{letter:'D',text:'Isles of Scilly'}],correctAnswer:'A',doubloons:10},
      {id:4,type:'multiple_choice',question:'Answer this riddle: What gets wetter the more it dries?',options:[{letter:'A',text:'___s_'},{letter:'B',text:'__w__'},{letter:'C',text:'___t'},{letter:'D',text:'_a__'}],correctAnswer:'B',explanation:'Answer: Towel',doubloons:10},
      {id:5,type:'text_input',question:'Name the one-word sport depicted in this image?',imageUrl:'/tennis-sport.png',correctAnswer:'tennis',acceptableAnswers:['tennis','Tennis','TENNIS'],doubloons:10},
      {id:6,type:'multiple_choice',question:'Who is this talking in this clip?',audioUrl:'/voice-clip.mp3',options:[{letter:'A',text:'Ed Sheeran'},{letter:'B',text:'Harry Styles'},{letter:'C',text:'Tom Holland'},{letter:'D',text:'Taron Egerton'}],correctAnswer:'C',doubloons:10},
      {id:7,type:'text_input',question:'What is the number of the only other month, after August (8), for Augustus, to be named after a mortal man?',correctAnswer:'7',acceptableAnswers:['7','seven','Seven','SEVEN','july','July','JULY','Jul','jul','JUL'],explanation:'Answer: 7 (July)',doubloons:10},
      {id:8,type:'text_input',question:'Which one-word car manufacturer uses this logo?',imageUrl:'/smart-logo.png',correctAnswer:'smart',acceptableAnswers:['smart','Smart','SMART','SmArt','sMaRt'],doubloons:10},
      {id:9,type:'multiple_choice',question:'Listen to this intro. Which band had a huge hit with this song?',audioUrl:'/song-intro.mp3',options:[{letter:'A',text:'Red Hot Chili Peppers'},{letter:'B',text:'The Killers'},{letter:'C',text:'The Foo Fighters'},{letter:'D',text:'Kings of Leon'}],correctAnswer:'B',doubloons:10},
      {id:10,type:'multiple_choice',question:'Five friends are waiting in line to get coffee. Ross is behind Joey but not last. Chandler is behind Monica, who is in front of both Ross and Joey. Rachel is second. Who is at the front of the line?',options:[{letter:'A',text:'Ross'},{letter:'B',text:'Joey'},{letter:'C',text:'Chandler'},{letter:'D',text:'Monica'},{letter:'E',text:'Rachel'}],correctAnswer:'D',doubloons:10}
    ];

    /* ------------ Helpers ------------ */
    const qs = (s)=>document.querySelector(s);
    function show(id){qs('#'+id).classList.add('active')}
    function hide(id){qs('#'+id).classList.remove('active')}
    function toast(id,msg,type){const el=qs('#'+id);el.textContent=msg;el.className='msg ' + (type==='error'?'error':'ok');}

    /* ------------ Same team-loading code as other activities ------------ */
    async function loadTeamsList(){
      try{
        const r = await fetch('/.netlify/functions/get_leaderboard');
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        if(data && data.success && Array.isArray(data.teams)){
          allTeams = data.teams;
          populateTeamDropdown(allTeams);
          return;
        }
        throw new Error('Invalid response');
      }catch(e){
        console.error('load teams Error:', e);
        toast('loginMessage','Unable to load crew list. Please refresh.','error');
      }
    }

    function populateTeamDropdown(teams){
      const sel = qs('#teamSelect');
      sel.innerHTML = '<option value="">Choose your treasure hunting crew...</option>';
      teams.sort((a,b)=>a.teamName.localeCompare(b.teamName)).forEach(t=>{
        const o = document.createElement('option'); o.value=t.teamCode; o.textContent=t.teamName; sel.appendChild(o);
      });
    }

    /* ------------ Verify PIN (same endpoint as others) ------------ */
    async function verifyTeamAndPin(teamCode,pin){
      try{
        const r = await fetch('/.netlify/functions/verify_team_pin_function',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({teamCode,pin})
        });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        return !!(j && j.success && j.valid);
      }catch(e){ console.error(e); return false; }
    }

    /* ------------ Quiz status check ------------ */
    async function checkQuizStatus(teamCode){
      try{
        const r = await fetch('/.netlify/functions/check_quiz_status_function',{
          method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({teamCode})
        });
        if(!r.ok) return {started:false,completed:false};
        const j = await r.json();
        return {started:!!j.started,completed:!!j.completed};
      }catch(e){ return {started:false,completed:false}; }
    }

    /* ------------ Start quiz gate ------------ */
    async function acceptChallenge(){
      try{
        const r = await fetch('/.netlify/functions/start_quiz_function',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({teamCode:currentTeam.teamCode,teamName:currentTeam.teamName,quizStartTime:new Date().toISOString()})
        });
        if(!r.ok){ throw new Error('HTTP '+r.status); }
        const j = await r.json();
        if(!j.success) throw new Error(j.error||'Start failed');
        startCountdown();
      }catch(e){
        console.error(e);
        toast('readyMessage','Couldn‚Äôt start the quiz. Please try again.','error');
      }
    }

    /* ------------ UI flow ------------ */
    qs('#beginBtn').addEventListener('click', async ()=>{
      const teamCode = qs('#teamSelect').value.trim();
      const pin = String(qs('#teamPin').value||'').trim();
      if(!teamCode){ toast('loginMessage','Please pick your crew.','error'); return; }
      if(!/^\d{4}$/.test(pin)){ toast('loginMessage','Enter a valid 4-digit code.','error'); return; }

      // If already started/completed, stop here
      const st = await checkQuizStatus(teamCode);
      if(st.completed){ toast('loginMessage','This crew has already completed the quiz.','error'); return; }
      if(st.started){ toast('loginMessage','This crew has already started the quiz.','error'); return; }

      const ok = await verifyTeamAndPin(teamCode,pin);
      if(!ok){ toast('loginMessage','Wrong code for this crew.','error'); return; }

      currentTeam = allTeams.find(t=>t.teamCode===teamCode);
      qs('#readyTeam').textContent = 'Crew: ' + currentTeam.teamName;
      hide('login'); show('ready');
    });

    qs('#acceptBtn').addEventListener('click', acceptChallenge);

    function startCountdown(){
      const panel = document.createElement('div');
      panel.className='panel'; panel.style.textAlign='center';
      panel.innerHTML = '<div style="font-size:56px;color:#FF8C00;font-weight:900" id="cd">3</div><div>Starting‚Ä¶</div>';
      const readySec = qs('#ready'); readySec.appendChild(panel);
      let n=3; const t = setInterval(()=>{ n--; qs('#cd').textContent = n>0?n:'GO!'; if(n<0){clearInterval(t); beginQuiz();}},1000);
    }

    function beginQuiz(){
      quizStartTime = new Date();
      currentIndex = 0; answers = [];
      qs('#quizTeam').textContent = 'Crew: ' + currentTeam.teamName;
      hide('ready'); show('quiz'); renderQuestion();
    }

    function renderQuestion(){
      const q = quizQuestions[currentIndex];
      qs('#qCounter').textContent = `Riddle ${currentIndex+1} of ${quizQuestions.length}`;
      timeLeft = 15; updateTimer(); if(tick) clearInterval(tick);
      tick = setInterval(()=>{ timeLeft--; updateTimer(); if(timeLeft<=0) submit(''); },1000);

      let html = `<div style="color:#8B4513;font-weight:700;margin-bottom:8px">Riddle ${currentIndex+1}</div>`;
      html += `<div style="font-size:1.15rem;color:#5b3b1a;margin-bottom:14px">${q.question}</div>`;
      if(q.audioUrl){ html += `<audio controls preload="auto" style="width:100%;margin:10px 0"><source src="${q.audioUrl}" type="audio/mpeg"></audio>`; }
      if(q.imageUrl){ html += `<img src="${q.imageUrl}" alt="" style="max-width:100%;max-height:300px;border:3px solid #DAA520;border-radius:12px;margin:10px 0">`; }
      if(q.type==='multiple_choice'){
        html += `<div class="options">` + q.options.map(o=>`<div class="opt" data-letter="${o.letter}"><strong>${o.letter}.</strong> ${o.text}</div>`).join('') + `</div>`;
      }else{
        html += `<input id="textAnswer" class="panel" type="text" placeholder="Type your answer‚Ä¶">`;
        html += `<button class="btn" id="submitText">Submit</button>`;
      }
      qs('#questionCard').innerHTML = html;

      if(q.type==='multiple_choice'){
        qs('#questionCard').querySelectorAll('.opt').forEach(el=>{
          el.addEventListener('click',()=>{ qs('#questionCard').querySelectorAll('.opt').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); submit(el.dataset.letter); });
        });
      }else{
        qs('#submitText').addEventListener('click',()=>submit(qs('#textAnswer').value.trim()));
        document.addEventListener('keydown', onEnterOnce);
        function onEnterOnce(e){ if(e.key==='Enter'){ document.removeEventListener('keydown', onEnterOnce); submit(qs('#textAnswer').value.trim()); } }
      }
    }

    function updateTimer(){
      const t = qs('#timer'); t.textContent = timeLeft;
      const deg = Math.max(0, Math.min(360, (timeLeft/15)*360));
      let base = '#DAA520', bg = '#F5E6D3';
      if(timeLeft<=5) base = '#FF8C00';
      if(timeLeft<=3) base = '#DC143C';
      t.style.background = `conic-gradient(${base} ${deg}deg, ${bg} ${deg}deg)`;
    }

    function normalize(s){ return (s||'').toLowerCase().trim().replace(/[^\w\s]/g,'').replace(/\s+/g,'').trim(); }

    function submit(ans){
      clearInterval(tick);
      const q = quizQuestions[currentIndex];
      let ok = false;
      if(q.type==='multiple_choice'){ ok = ans === q.correctAnswer; }
      else{
        const n = normalize(ans);
        ok = q.acceptableAnswers ? q.acceptableAnswers.some(a=>normalize(a)===n) : normalize(q.correctAnswer)===n;
      }
      answers.push({questionId:q.id,userAnswer:ans,correctAnswer:q.correctAnswer,isCorrect:ok,doubloons:ok?q.doubloons:0,timeLeft});
      // feedback
      if(q.type==='multiple_choice'){
        qs('#questionCard').querySelectorAll('.opt').forEach(el=>{
          const letter = el.dataset.letter;
          if(letter===q.correctAnswer) el.classList.add('correct');
          if(letter!==q.correctAnswer && el.classList.contains('selected')) el.classList.add('incorrect');
          el.style.pointerEvents='none';
        });
      }
      if(q.explanation){ const box=document.createElement('div'); box.className='panel'; box.style.fontWeight='700'; box.textContent=q.explanation; qs('#questionCard').appendChild(box); }
      setTimeout(()=>{ currentIndex < quizQuestions.length-1 ? (currentIndex++, renderQuestion()) : finish(); }, 1400);
    }

    async function finish(){
      hide('quiz'); show('results');
      const correct = answers.filter(a=>a.isCorrect).length;
      const total = answers.reduce((s,a)=>s+a.doubloons,0);
      qs('#resultsTeam').textContent = 'Crew: ' + currentTeam.teamName;
      qs('#finalScore').textContent = `${correct}/${quizQuestions.length}`;
      qs('#doubloons').textContent = total;

      // Breakdown
      qs('#breakdown').innerHTML = answers.map((a,i)=>{
        const q = quizQuestions[i];
        const good = a.isCorrect ? `+${a.doubloons} ü™ô` : '0 ü™ô';
        const col = a.isCorrect ? '#2fb12f' : '#d3193b';
        return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #DAA520">
          <div>Riddle ${i+1}: ${q.question.slice(0,60)}${q.question.length>60?'‚Ä¶':''}</div>
          <div style="font-weight:800;color:${col}">${good}</div>
        </div>`;
      }).join('');

      // Persist score
      try{
        const r = await fetch('/.netlify/functions/submit_quiz_function',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            teamCode:currentTeam.teamCode,teamName:currentTeam.teamName,totalScore:total,
            questionsCorrect:correct,totalQuestions:quizQuestions.length,
            completionTime:new Date().toISOString(),quizStartTime:quizStartTime?.toISOString?.()||new Date().toISOString(),
            answers
          })
        });
        const j = await r.json();
        if(!r.ok || !j.success){ throw new Error(j.error||('HTTP '+r.status)); }
        toast('submitMessage','üéâ Doubloons recorded successfully!','ok');
      }catch(e){
        console.error(e);
        toast('submitMessage','Could not record doubloons, but your score is shown above.','error');
      }
    }

    /* ------------ Boot ------------ */
    document.addEventListener('DOMContentLoaded', loadTeamsList);
  </script>
</body>
</html>
