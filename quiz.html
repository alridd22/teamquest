<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest ‚Äì The Quiz Challenge</title>
  <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">
  <style>
    :root{ --nav-h:64px; }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      min-height:100vh;
      background:
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.35)),
        url("/TQ%20Web%20background-100.jpg") center/cover fixed no-repeat;
      display:flex;align-items:center;justify-content:center;padding:24px; padding-top:calc(var(--nav-h) + 24px);
    }

    /* OPAQUE NAV */
    .nav{
      position:fixed; top:0; left:0; right:0; height:var(--nav-h); z-index:2000;
      backdrop-filter:saturate(120%) blur(6px);
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      border-bottom:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; padding:0 12px;
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none}
    .brand img{height:40px; width:auto; display:block; filter:drop-shadow(0 3px 10px rgba(0,0,0,.6))}
    .menu-btn{background:none;border:none;color:#F7EED8;font-size:1.6rem;cursor:pointer;margin-left:auto}
    .navlinks{
      position:fixed; top:var(--nav-h); left:-100%; width:100%;
      height:calc(100vh - var(--nav-h)); z-index:2500;
      display:flex; flex-direction:column; align-items:center; gap:14px; padding:18px 14px; transition:left .25s;
      background:rgba(18,12,8,.90);
    }
    .navlinks.active{left:0}
    .navlinks.active::before{content:""; position:fixed; inset:var(--nav-h) 0 0 0; z-index:-1; background:rgba(0,0,0,.35)}
    .pill{
      display:block; width:92%; max-width:360px; text-align:center; text-decoration:none;
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color:#2E2114; font-weight:900; padding:12px 14px; border-radius:16px;
      background:rgba(247,238,216,.98); border:2px solid #CBA64C;
      box-shadow:0 8px 18px rgba(0,0,0,.35);
    }
    .pill:hover{background:linear-gradient(90deg,#F7E0A2,#F0C433)}
    .pill.disabled{opacity:.5; pointer-events:none}

    .wrap{max-width:900px;width:100%;background:linear-gradient(145deg,#F5E6D3,#E8D7C3);
      border:3px solid #8B4513;border-radius:24px;box-shadow:0 18px 36px rgba(0,0,0,.2);padding:28px}
    h1{font-size:2.2rem;color:#8B4513;text-align:center;margin-bottom:8px}
    .rules{border:2px solid #DAA520;border-radius:14px;padding:18px;background:#fff9ee;margin:18px 0}
    .row{margin:14px 0}
    label{display:block;font-weight:600;color:#8B4513;margin-bottom:6px}
    select,input[type="text"]{width:100%;padding:14px;border:3px solid #DAA520;border-radius:12px;font-size:16px;background:linear-gradient(145deg,#fff,#FFF8DC)}
    .btn{width:100%;padding:16px;border:2px solid #8B4513;border-radius:12px;
      background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .msg{margin-top:12px;border:2px solid;border-radius:11px;padding:12px;display:none;text-align:center}
    .msg.error{display:block;background:#ffd6db;border-color:#d22;color:#8b0000}
    .msg.ok{display:block;background:#ddffe3;border-color:#1e8f3e;color:#0c5e24}
    .section{display:none}
    .section.active{display:block}
    .team-pill{background:linear-gradient(135deg,#8B4513,#A0522D);color:#fff;border:2px solid #DAA520;border-radius:12px;padding:10px 14px;margin-bottom:16px;text-align:center;font-weight:700}
    .quiz-head{display:flex;justify-content:space-between;gap:16px;align-items:center;border:2px solid #DAA520;background:#fff9ee;border-radius:14px;padding:16px;margin-bottom:16px}
    .timer{width:60px;height:60px;border-radius:50%;border:3px solid #8B4513;display:flex;align-items:center;justify-content:center;font-weight:800;color:#8B4513;background:conic-gradient(#DAA520 0deg,#F5E6D3 0deg)}
    .qcard{border:3px solid #DAA520;background:linear-gradient(145deg,#fff,#FFF8DC);border-radius:18px;padding:22px}
    .opt{border:3px solid #DAA520;border-radius:14px;padding:14px;background:#fff9ee;cursor:pointer;margin-top:10px}
    .opt:hover{background:#ffeec9}
    .opt.sel{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border-color:#8B4513}
    .opt.good{background:linear-gradient(135deg,#29c74a,#17983a);color:#fff;border-color:#0b6f27}
    .opt.bad{background:linear-gradient(135deg,#d11,#a00909);color:#fff;border-color:#6b0000}
    .textAnswer{width:100%;padding:14px;border:3px solid #DAA520;border-radius:12px;font-size:18px;background:#fff}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <a class="brand" href="/"><img src="/Team Quest Logo-01.png" alt="TeamQuest"></a>
    <button class="menu-btn" id="menu">‚ò∞</button>
  </nav>
  <div class="navlinks" id="sheet">
    <a class="pill" href="/clue_hunt">üíé The Treasure Hunt</a>
    <a class="pill" href="/scavenger">üîç The Scavenger Hunt</a>
    <a class="pill disabled" aria-disabled="true">‚è∞ The Timed Quiz</a>
    <a class="pill" href="/limerick">üìù The Limerick Challenge</a>
    <a class="pill" href="/kindness">üíñ Kindness</a>
    <a class="pill" href="/leaderboard">üèÜ The Leaderboard</a>
    <a class="pill" href="/gallery">üì∏ The Gallery</a>
  </div>

  <div class="wrap">
    <h1>The Quiz Challenge</h1>

    <!-- SIGN IN -->
    <section id="secSign" class="section active">
      <div class="rules">
        <ul>
          <li>10 riddles ‚Äî 15 seconds each</li>
          <li>Some include audio ‚Äî check volume</li>
          <li>Choose once ‚Äî no changes</li>
          <li>Up to 100 doubloons for perfection</li>
        </ul>
      </div>

      <div class="row">
        <label for="teamSelect">Select Your Crew</label>
        <select id="teamSelect">
          <option value="">Choose your treasure hunting crew‚Ä¶</option>
        </select>
      </div>

      <div class="row">
        <label for="teamPin">Enter Your Crew‚Äôs Secret Code</label>
        <input id="teamPin" type="text" inputmode="numeric" autocomplete="one-time-code"
               placeholder="1234" pattern="^\d{4}$" maxlength="4" />
      </div>

      <button class="btn" id="btnSign">üß≠ Begin the Knowledge Trial</button>
      <div id="signMsg" class="msg"></div>
    </section>

    <!-- READY -->
    <section id="secReady" class="section">
      <div class="team-pill" id="readyTeam">Crew: ‚Ä¶</div>
      <div class="rules">
        <strong>‚ö° You‚Äôre good to go!</strong>
        <ul style="margin-top:10px">
          <li>15 seconds per riddle</li>
          <li>No going back</li>
          <li>Volume up for audio prompts</li>
        </ul>
      </div>
      <button class="btn" id="btnAccept">üöÄ Accept the challenge</button>
      <div id="readyMsg" class="msg"></div>
    </section>

    <!-- QUIZ -->
    <section id="secQuiz" class="section">
      <div class="team-pill" id="quizTeam">Crew: ‚Ä¶</div>
      <div class="quiz-head">
        <div id="qCount">Riddle 1 of 10</div>
        <div class="timer" id="timer">15</div>
      </div>
      <div class="qcard" id="qcard"></div>
    </section>

    <!-- RESULTS -->
    <section id="secDone" class="section">
      <div class="team-pill" id="doneTeam">Crew: ‚Ä¶</div>
      <div class="qcard">
        <h2 style="margin-bottom:8px">üéâ Trial Complete!</h2>
        <p id="scoreLine" style="margin-bottom:16px;font-weight:700;color:#8B4513"></p>
        <div id="breakdown"></div>
        <div id="submitMsg" class="msg" style="margin-top:16px"></div>
        <button class="btn" onclick="location.href='/leaderboard'">üèÜ View Leaderboard</button>
      </div>
    </section>
  </div>

  <script>
    // NAV toggle
    const mBtn = document.getElementById('menu');
    const sheet = document.getElementById('sheet');
    mBtn?.addEventListener('click', ()=> sheet.classList.toggle('active'));
    sheet?.addEventListener('click', e => { if(e.target===sheet) sheet.classList.remove('active'); });

    // ====== constants / helpers ======
    const EVENT_ID = new URLSearchParams(location.search).get('event') || '';
    const $ = (id) => document.getElementById(id);
    const teamSelect = $('teamSelect');
    const teamPin    = $('teamPin');
    const signMsg    = $('signMsg');
    const readyMsg   = $('readyMsg');
    const submitMsg  = $('submitMsg');

    function setMsg(el, text, type){ el.textContent = text; el.className = 'msg ' + (type==='error' ? 'error' : 'ok'); el.style.display = 'block'; }
    function clearMsg(el){ el.textContent=''; el.className='msg'; el.style.display='none'; }

    async function callFn(name, payload = {}, method='POST'){
      const url = '/.netlify/functions/'+name + (method==='GET' ? ('?'+new URLSearchParams(payload)) : '');
      const res = await fetch(url, {
        method, headers: { 'Content-Type':'application/json' },
        body: method==='GET' ? undefined : JSON.stringify(payload)
      });
      let data = {};
      try { data = await res.json(); } catch {}
      if (!res.ok) {
        const msg = data && (data.error || data.message) ? (data.error || data.message) : ('HTTP '+res.status);
        throw new Error(msg);
      }
      return data;
    }

    function extractTeams(data){
      if (Array.isArray(data?.teams)) return data.teams;
      if (Array.isArray(data?.leaderboard)) {
        return data.leaderboard
          .map(r => ({ teamCode: r.teamCode || r.code || r.teamId || '', teamName: r.teamName || r.name || '' }))
          .filter(t => t.teamName);
      }
      if (Array.isArray(data?.rows)) {
        return data.rows
          .map(r => ({ teamCode: r.teamCode || r.code || r.teamId || '', teamName: r.teamName || r.name || '' }))
          .filter(t => t.teamName);
      }
      return [];
    }

    async function loadTeams(){
      try{
        let data = await callFn('get_leaderboard', { eventId: EVENT_ID });
        let teams = extractTeams(data);
        if (!teams.length){
          const r = await fetch('/.netlify/functions/get_leaderboard?eventId=' + encodeURIComponent(EVENT_ID));
          if (r.ok){
            data = await r.json();
            teams = extractTeams(data);
          }
        }
        if (!teams.length) throw new Error('No teams returned');

        teams.sort((a,b)=>a.teamName.localeCompare(b.teamName));
        teamSelect.innerHTML = '<option value="">Choose your treasure hunting crew‚Ä¶</option>' +
          teams.map(t => `<option value="${t.teamCode}">${t.teamName}</option>`).join('');
      }catch(e){
        console.error('load teams Error:', e);
        setMsg(signMsg, 'Unable to load crew list. Please refresh.', 'error');
      }
    }

    async function signin(){
      clearMsg(signMsg);
      const code = teamSelect.value;
      const pin  = (teamPin.value || '').trim();
      if (!code){ setMsg(signMsg, 'Pick your crew from the list.', 'error'); return; }
      if (!/^\d{4}$/.test(pin)){ setMsg(signMsg, 'Enter your 4-digit PIN.', 'error'); return; }

      try{
        const res = await callFn('verify_team_pin_function', { eventId: EVENT_ID, teamCode: code, pin });
        if (!res.success || !res.valid){ setMsg(signMsg, 'That PIN doesn‚Äôt match this crew.', 'error'); return; }

        localStorage.setItem('teamToken', res.token);
        localStorage.setItem('teamCode', code);
        localStorage.setItem('teamName', res.teamName || teamSelect.options[teamSelect.selectedIndex]?.textContent || '');

        setMsg(signMsg, 'Signed in. You can start the quiz!', 'ok');
        $('readyTeam').textContent = 'Crew: ' + (localStorage.getItem('teamName') || 'Unknown');
        $('secSign').classList.remove('active');
        $('secReady').classList.add('active');
      }catch(err){
        const msg = (''+err.message).includes('404')
          ? 'Sign-in service is off. Ask the host to enable verify_team_pin_function.'
          : (err.message || 'Could not sign you in. Try again.');
        setMsg(signMsg, msg, 'error');
      }
    }
    $('btnSign').addEventListener('click', signin);

    const quizQuestions = [
      { id:1,type:'multiple_choice',question:'What 3 letter animal makes this noise?',audioUrl:'/animal-sound',options:[
        {letter:'A',text:'Pig'},{letter:'B',text:'Cow'},{letter:'C',text:'Yak'},{letter:'D',text:'Elk'}],correctAnswer:'C',doubloons:10 },
      { id:2,type:'multiple_choice',question:'What is the meaning of the word: Gambado?',options:[
        {letter:'A',text:'Colourful Hat'},{letter:'B',text:'Native of Gambia'},{letter:'C',text:'Prank'},{letter:'D',text:'Foolish bet'}],correctAnswer:'C',doubloons:10 },
      { id:3,type:'multiple_choice',question:'Which UK island has its own railway, currency, and parliament, but is not part of the United Kingdom?',options:[
        {letter:'A',text:'Isle of Man'},{letter:'B',text:'Isle of Skye'},{letter:'C',text:'Isle of Wight'},{letter:'D',text:'Isles of Scilly'}],correctAnswer:'A',doubloons:10 },
      { id:4,type:'multiple_choice',question:'Answer this riddle: What gets wetter the more it dries?',options:[
        {letter:'A',text:'___s_'},{letter:'B',text:'__w__'},{letter:'C',text:'___t'},{letter:'D',text:'_a__'}],correctAnswer:'B',explanation:'Answer: Towel',doubloons:10 },
      { id:5,type:'text_input',question:'Name the one-word sport depicted in this image?',imageUrl:'/tennis-sport.png',
        correctAnswer:'tennis',acceptableAnswers:['tennis','Tennis','TENNIS'],doubloons:10 },
      { id:6,type:'multiple_choice',question:'Who is this talking in this clip?',audioUrl:'/voice-clip.mp3',options:[
        {letter:'A',text:'Ed Sheeran'},{letter:'B',text:'Harry Styles'},{letter:'C',text:'Tom Holland'},{letter:'D',text:'Taron Egerton'}],correctAnswer:'C',doubloons:10 },
      { id:7,type:'text_input',question:'What is the number of the only other month, after August (8), named after a mortal man?',
        correctAnswer:'7',acceptableAnswers:['7','seven','Seven','SEVEN','july','July','JULY','Jul','jul','JUL'],explanation:'Answer: 7 (July)',doubloons:10 },
      { id:8,type:'text_input',question:'Which one-word car manufacturer uses this logo?',imageUrl:'/smart-logo.png',
        correctAnswer:'smart',acceptableAnswers:['smart','Smart','SMART','SmArt','sMaRt'],doubloons:10 },
      { id:9,type:'multiple_choice',question:'Listen to this intro. Which band had a huge hit with this song?',audioUrl:'/song-intro.mp3',options:[
        {letter:'A',text:'Red Hot Chili Peppers'},{letter:'B',text:'The Killers'},{letter:'C',text:'The Foo Fighters'},{letter:'D',text:'Kings of Leon'}],correctAnswer:'B',doubloons:10 },
      { id:10,type:'multiple_choice',question:'Five friends are waiting in line to get coffee‚Ä¶ Who is at the front of the line?',options:[
        {letter:'A',text:'Ross'},{letter:'B',text:'Joey'},{letter:'C',text:'Chandler'},{letter:'D',text:'Monica'},{letter:'E',text:'Rachel'}],correctAnswer:'D',doubloons:10 }
    ];

    let currentTeam = { code:'', name:'' };
    let qIndex = 0, timeLeft = 15, timerId = null;
    const answers = [];

    $('btnAccept').addEventListener('click', startQuizFlow);

    async function startQuizFlow(){
      clearMsg(readyMsg);
      try{
        await callFn('start_quiz_function', {
          eventId: EVENT_ID,
          teamCode: localStorage.getItem('teamCode'),
          teamName: localStorage.getItem('teamName'),
          quizStartTime: new Date().toISOString()
        });
        $('quizTeam').textContent = 'Crew: ' + (localStorage.getItem('teamName') || '');
        document.getElementById('secReady').classList.remove('active');
        document.getElementById('secQuiz').classList.add('active');
        currentTeam = { code: localStorage.getItem('teamCode'), name: localStorage.getItem('teamName') };
        qIndex = 0; answers.length = 0;
        showQuestion();
      }catch(e){
        setMsg(readyMsg, 'Couldn‚Äôt start the quiz. Please try again. ('+ (e.message||'error') +')', 'error');
      }
    }

    function showQuestion(){
      const q = quizQuestions[qIndex];
      $('qCount').textContent = `Riddle ${qIndex+1} of ${quizQuestions.length}`;
      timeLeft = 15; updateTimer(); startTimer();

      let html = `<div style="font-weight:700;color:#654321;margin-bottom:12px">${q.question}</div>`;
      if (q.audioUrl) {
        html += `<audio id="qAud" controls preload="auto" style="width:100%;margin:12px 0">
                  <source src="${q.audioUrl}" type="audio/mpeg">
                </audio>`;
      }
      if (q.imageUrl) html += `<img src="${q.imageUrl}" alt="" style="max-width:100%;border-radius:12px;border:3px solid #DAA520;margin:12px 0">`;

      if (q.type==='multiple_choice'){
        q.options.forEach(o=>{
          html += `<div class="opt" data-letter="${o.letter}"><strong>${o.letter}.</strong> ${o.text}</div>`;
        });
      }else{
        html += `<input id="textAns" class="textAnswer" placeholder="Type your answer‚Ä¶" maxlength="50" />`;
        html += `<button class="btn" style="margin-top:12px" onclick="submitAnswer()">Submit</button>`;
      }
      $('qcard').innerHTML = html;

      document.querySelectorAll('.opt').forEach(el=>{
        el.addEventListener('click', () => {
          document.querySelectorAll('.opt').forEach(x=>x.classList.remove('sel'));
          el.classList.add('sel');
          submitAnswer(el.dataset.letter);
        });
      });
      $('qAud')?.play().catch(()=>{});
    }

    function startTimer(){
      clearInterval(timerId);
      timerId = setInterval(()=>{
        timeLeft--; updateTimer();
        if (timeLeft<=0){ submitAnswer(''); }
      }, 1000);
    }

    function updateTimer(){
      $('timer').textContent = timeLeft;
      const pct = (timeLeft/15)*360;
      $('timer').style.background = `conic-gradient(${timeLeft<=3?'#DC143C':timeLeft<=5?'#FF8C00':'#DAA520'} ${pct}deg, #F5E6D3 ${pct}deg)`;
    }

    function normalize(s){ return (s||'').toLowerCase().trim().replace(/[^\w\s]/g,'').replace(/\s+/g,'').trim(); }

    function submitAnswer(choice){
      clearInterval(timerId);
      const q = quizQuestions[qIndex];

      let correct = false;
      if (q.type==='multiple_choice'){
        correct = (choice === q.correctAnswer);
        document.querySelectorAll('.opt').forEach(el=>{
          const lett = el.dataset.letter;
          if (lett===q.correctAnswer) el.classList.add('good');
          else if (el.classList.contains('sel') && !correct) el.classList.add('bad');
          el.style.pointerEvents='none';
        });
      }else{
        const user = normalize($('textAns')?.value || '');
        if (q.acceptableAnswers?.length) correct = q.acceptableAnswers.some(a=>normalize(a)===user);
        else correct = normalize(q.correctAnswer)===user;
      }

      answers.push({
        questionId: q.id,
        userAnswer: choice || ($('textAns')?.value || ''),
        correctAnswer: q.correctAnswer,
        isCorrect: correct,
        doubloons: correct ? q.doubloons : 0,
        timeLeft
      });

      if (q.explanation){
        $('qcard').insertAdjacentHTML('beforeend',
          `<div style="margin-top:12px;padding:10px;border:2px solid #DAA520;border-radius:10px;background:#fff9ee;font-weight:700">${q.explanation}</div>`);
      }

      setTimeout(()=>{
        if (qIndex < quizQuestions.length-1){ qIndex++; showQuestion(); }
        else finishQuiz();
      }, 1400);
    }

    async function finishQuiz(){
      document.getElementById('secQuiz').classList.remove('active');
      $('doneTeam').textContent = 'Crew: ' + (currentTeam.name || '');
      document.getElementById('secDone').classList.add('active');

      const correct = answers.filter(a=>a.isCorrect).length;
      const doubloons = answers.reduce((s,a)=>s+a.doubloons,0);
      $('scoreLine').textContent = `Score: ${correct}/${quizQuestions.length} ‚Äî Doubloons earned: ${doubloons}`;

      $('breakdown').innerHTML = answers.map((a,i)=>{
        const q = quizQuestions[i];
        return `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #DAA520;padding:8px 0">
                  <div>Riddle ${i+1}: ${q.question.slice(0,60)}‚Ä¶</div>
                  <div style="font-weight:800;color:${a.isCorrect?'#1e8f3e':'#b00020'}">${a.isCorrect?'‚úì +'+a.doubloons:'‚úó 0'}</div>
                </div>`;
      }).join('');

      clearMsg(submitMsg);
      try{
        await callFn('submit_quiz_function', {
          eventId: EVENT_ID,
          teamCode: currentTeam.code,
          teamName: currentTeam.name,
          totalScore: doubloons,
          questionsCorrect: correct,
          totalQuestions: quizQuestions.length,
          completionTime: new Date().toISOString(),
          answers
        });
        setMsg(submitMsg, 'üéâ Doubloons successfully added to your treasure chest!', 'ok');
      }catch(e){
        setMsg(submitMsg, 'Couldn‚Äôt record doubloons. (Saved locally.)', 'error');
      }
    }

    // boot
    loadTeams();
    teamPin.addEventListener('keydown', e => { if (e.key==='Enter') $('btnSign').click(); });
  </script>
</body>
</html>
