<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TeamQuest - The Quiz Challenge</title>
<style>
  :root{
    --brown:#8B4513; --brown2:#654321; --tan:#F5E6D3; --tan2:#E8D7C3; --gold:#DAA520; --gold2:#FF8C00;
    --ink:#3b2412; --ok:#1f7a3a; --err:#8b0000; --okbg:#e9f9ef; --errbg:#ffedf1;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);
    min-height:100dvh; color:var(--ink); padding:20px; padding-top:100px !important;
  }
  @media (max-width:768px){ body{ padding-top:140px !important; } }

  /* Fixed nav */
  .treasure-nav{
    position:fixed; inset:0 0 auto 0; height:80px; z-index:1000;
    background: linear-gradient(135deg,var(--brown) 0%,var(--brown2) 50%,var(--brown) 100%);
    border-bottom:3px solid var(--gold); box-shadow:0 4px 15px rgba(0,0,0,.3);
  }
  .nav-container{ max-width:1200px; margin:0 auto; height:100%; display:flex; align-items:center; justify-content:space-between; padding:0 20px; }
  .nav-logo{ display:flex; align-items:center; text-decoration:none; transition:.2s transform; }
  .nav-logo:hover{ transform:scale(1.05); }
  .nav-logo img{ height:50px; width:auto; filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5)); }
  @media (max-width:768px){ .nav-logo img{ height:85px !important; } }

  .nav-menu{ display:flex; gap:30px; list-style:none; margin:0; padding:0; }
  .nav-item{ position:relative; }
  .nav-link{
    color:#F5DEB3; text-decoration:none; font-weight:700; padding:12px 18px; border-radius:8px;
    background: rgba(101,67,33,.3); border:2px solid rgba(218,165,32,.4); text-shadow:1px 1px 2px rgba(0,0,0,.7);
    display:block; white-space:nowrap; transition:.2s;
  }
  .nav-link:hover{ background: linear-gradient(135deg,var(--gold),var(--gold2)); color:#fff; transform:translateY(-2px); box-shadow:0 4px 12px rgba(218,165,32,.4); border-color:var(--gold); }
  .nav-dropdown{
    position:absolute; top:100%; left:0; min-width:180px; opacity:0; visibility:hidden; transform:translateY(-10px);
    background: linear-gradient(135deg,#654321 0%,#8B4513 100%); border:2px solid var(--gold); border-radius:8px; transition:.2s; box-shadow:0 8px 20px rgba(0,0,0,.3);
  }
  .nav-item:hover .nav-dropdown{ opacity:1; visibility:visible; transform:translateY(0); }
  .dropdown-link{
    display:block; color:#F5DEB3; text-decoration:none; padding:12px 18px; font-weight:600; margin:2px; border-radius:6px;
    background: rgba(101,67,33,.2); border-bottom:1px solid rgba(218,165,32,.2);
  }
  .dropdown-link:hover{ background: linear-gradient(135deg,#FF8C00,#DAA520); color:#fff; padding-left:25px; transform:translateX(5px); box-shadow:0 2px 8px rgba(255,140,0,.3); }
  .nav-toggle{ display:none; background:none; border:none; color:var(--gold); font-size:1.8rem; cursor:pointer; }
  @media (max-width:768px){
    .treasure-nav{ height:120px; }
    .nav-container{ justify-content:center; position:relative; }
    .nav-logo{ position:absolute; left:50%; transform:translateX(-50%); }
    .nav-toggle{ position:absolute; right:20px; top:50%; transform:translateY(-50%); display:block; }
    .nav-menu{
      position:fixed; top:120px; left:-100%; width:100%; height:calc(100vh - 120px);
      background: linear-gradient(135deg,#8B4513 0%,#654321 100%); flex-direction:column; align-items:center; gap:20px; padding-top:30px;
      transition:left .3s ease; overflow-y:auto;
    }
    .nav-menu.active{ left:0; }
    .nav-link{ width:280px; text-align:center; background: linear-gradient(135deg,rgba(101,67,33,.8),rgba(139,69,19,.6)); border:2px solid var(--gold); border-radius:12px; }
    .nav-dropdown{ position:static; opacity:1; visibility:visible; transform:none; width:280px; margin-top:10px; border-radius:12px; }
  }

  /* Shell card */
  .container{
    background: linear-gradient(145deg,var(--tan) 0%,var(--tan2) 100%);
    border-radius:25px; padding:40px; max-width:900px; width:100%;
    box-shadow:0 20px 40px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.3);
    border:3px solid var(--brown); position:relative; overflow:hidden; z-index:1;
  }
  .container::before{ content:""; position:absolute; top:0; left:0; right:0; height:8px; background: linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700); }
  .container::after{ content:""; position:absolute; inset:15px; border:2px solid var(--gold); border-radius:20px; pointer-events:none; }

  .logo{ text-align:center; margin-bottom:30px; }
  .quiz-icon{ font-size:48px; margin-bottom:20px; animation:pulse 2s infinite; filter:drop-shadow(2px 2px 4px rgba(139,69,19,.3)); }
  @keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
  h1{ color:var(--brown); text-align:center; margin-bottom:10px; font-size:2.5em; font-weight:700; text-shadow:2px 2px 4px rgba(0,0,0,.1); }
  .subtitle{ text-align:center; color:#A0522D; margin-bottom:30px; font-weight:500; }

  .team-info{
    background: linear-gradient(135deg,#8B4513,#A0522D); color:#fff; padding:20px; border-radius:15px;
    text-align:center; font-weight:800; margin-bottom:20px; border:2px solid var(--gold); box-shadow:0 5px 15px rgba(139,69,19,.3);
  }
  .section{ display:none; }
  .section.active{ display:block; }

  /* Banner + badges */
  .banner{
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin:6px 0 16px;
    background:#fffdf7; border:2px dashed var(--gold); border-radius:14px; padding:10px 12px;
  }
  .status{ display:inline-flex; align-items:center; gap:8px; border:2px dashed var(--gold); border-radius:999px; padding:8px 12px; background:#fff4d9; font-weight:800; }

  label{ display:block; margin-bottom:8px; color:var(--brown); font-weight:600; }
  .field{
    width:100%; padding:15px; border:3px solid var(--gold); border-radius:12px; font-size:16px;
    background: linear-gradient(145deg,#fff 0%,#FFF8DC 100%);
  }
  .field:focus{ outline:none; border-color:var(--gold2); box-shadow:0 0 0 3px rgba(255,140,0,.2); transform:translateY(-1px); }
  .pin-input{ text-align:center; font-size:1.5em; letter-spacing:3px; font-weight:800; }

  .btn{
    appearance:none; border:none; cursor:pointer; font-weight:800; border-radius:12px; padding:18px; width:100%;
    background: linear-gradient(135deg,var(--gold2),var(--gold)); color:#fff; text-shadow:1px 1px 2px rgba(0,0,0,.2);
    border:2px solid var(--brown); display:flex; align-items:center; justify-content:center; gap:10px; margin-top:12px;
  }
  .btn:hover{ transform:translateY(-2px); box-shadow:0 10px 20px rgba(255,140,0,.3); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
  .btn-ghost{ background: linear-gradient(135deg,#8B4513,#A0522D); }
  .small{ padding:10px 14px; width:auto; }

  .instructions{
    background: linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);
    border-left:6px solid var(--gold2); border:2px solid var(--gold); border-radius:0 15px 15px 0;
    padding:25px; margin-bottom:20px; box-shadow:0 4px 12px rgba(139,69,19,.1);
  }
  .message{ display:none; padding:15px; border-radius:12px; margin:16px 0; text-align:center; border:2px solid }
  .success-message{ display:block; background:linear-gradient(135deg,#98FB98 0%,#90EE90 100%); border-color:#32CD32; color:#006400; }
  .error-message{ display:block; background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%); border-color:#DC143C; color:#8B0000; }

  .quiz-header{
    display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px; padding:16px;
    background: linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%); border:2px solid var(--gold); border-radius:15px;
  }
  .question-card{
    background: linear-gradient(145deg,#fff 0%,#FFF8DC 100%); border:3px solid var(--gold); border-radius:20px; padding:24px; margin-bottom:20px;
    box-shadow:0 10px 25px rgba(139,69,19,.15);
  }
  .options-grid{ display:grid; gap:15px; }
  .option{
    background: linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%); border:3px solid var(--gold); border-radius:15px; padding:20px;
    cursor:pointer; display:flex; align-items:center; gap:15px; font-size:1.1em; transition:.2s;
  }
  .option:hover{ background: linear-gradient(135deg,#FFE4B5 0%,#DDD3C2 100%); transform:translateY(-2px); box-shadow:0 5px 15px rgba(139,69,19,.2); }
  .option.selected{ background: linear-gradient(135deg,#FF8C00,#DAA520); color:#fff; border-color:#8B4513; }
  .option.correct{ background: linear-gradient(135deg,#32CD32,#228B22); color:#fff; border-color:#006400; }
  .option.incorrect{ background: linear-gradient(135deg,#DC143C,#B22222); color:#fff; border-color:#8B0000; }
  .option-letter{ background:#fff; color:#8B4513; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; border:2px solid var(--gold); flex-shrink:0; }

  .timer{ display:flex; align-items:center; gap:10px; }
  .timer-circle{
    width:60px; height:60px; border-radius:50%; border:3px solid var(--brown); display:flex; align-items:center; justify-content:center; font-weight:800;
    background:conic-gradient(var(--gold) 0deg,#F5E6D3 0deg); color:var(--brown); transition:.1s;
  }
  .timer-circle.warning{ background:conic-gradient(#FF8C00 0deg,#FFE4B5 0deg); animation:shake .5s infinite; }
  .timer-circle.danger{ background:conic-gradient(#DC143C 0deg,#FFB6C1 0deg); animation:shake .2s infinite; }
  @keyframes shake{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-2px)} 75%{transform:translateX(2px)} }

  .text-input{ width:100%; padding:15px; border:3px solid var(--gold); border-radius:12px; font-size:1.2em; text-align:center; margin-bottom:20px; background: linear-gradient(145deg,#fff 0%,#FFF8DC 100%); }

  .results-summary{ text-align:center; padding:24px; }
  .final-score{ font-size:3em; color:#FF8C00; font-weight:800; margin-bottom:10px; text-shadow:2px 2px 4px rgba(0,0,0,.1); }
  .score-breakdown{ background: linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%); border:2px solid var(--gold); border-radius:15px; padding:20px; margin:20px 0; }

  @media (max-width:768px){ .quiz-header{flex-direction:column} .timer-circle{ width:50px; height:50px; font-size:1.2em; } }
</style>
</head>
<body>
  <!-- Nav -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a class="nav-logo" href="https://theteamquest.netlify.app/"><img src="/Team Quest Logo-01.png" alt="TeamQuest Logo"></a>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link">🎯 Activities ▼</a>
          <div class="nav-dropdown">
            <a href="https://theteamquest.netlify.app/clue_hunt_challenge" class="dropdown-link">💎 The Treasure Hunt</a>
            <a href="https://theteamquest.netlify.app/scavenger_hunt" class="dropdown-link">🔍 The Scavenger Hunt</a>
            <a href="https://theteamquest.netlify.app/kindness_challenge_page" class="dropdown-link">❤️ The Kindness Task</a>
            <a href="https://theteamquest.netlify.app/limerick_challenge_page" class="dropdown-link">📝 The Limerick Challenge</a>
          </div>
        </li>
        <li class="nav-item"><a href="https://theteamquest.netlify.app/teamquest_leaderboard" class="nav-link">🏆 The Leaderboard</a></li>
        <li class="nav-item"><a href="https://theteamquest.netlify.app/teamquest_gallery" class="nav-link">📸 The Gallery</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle">☰</button>
    </div>
  </nav>

  <div class="container">
    <!-- Event banner -->
    <div class="banner">
      <div id="eventMsg">⛳ Checking event…</div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="eventBadge" class="status">—</span>
        <button id="refreshState" class="btn small">↻ Refresh</button>
      </div>
    </div>

    <!-- Login -->
    <div id="loginSection" class="section active">
      <div class="logo">
        <div class="quiz-icon">🧠</div>
        <h1>The Quiz Challenge</h1>
        <p class="subtitle">10 riddles. 15s each. Nab those doubloons!</p>
      </div>

      <div class="instructions">
        <strong>Quick rules</strong>
        <ul style="margin:10px 0 0 18px; line-height:1.6">
          <li>10 riddles · 15s per question</li>
          <li>One run per crew</li>
          <li>No back button once answered</li>
        </ul>
      </div>

      <form id="loginForm" novalidate>
        <label for="teamSelect">Select your crew</label>
        <select id="teamSelect" class="field">
          <option value="">Loading crews…</option>
        </select>

        <label for="teamPin" style="margin-top:14px">Crew PIN</label>
        <input id="teamPin" class="field pin-input" inputmode="numeric" autocomplete="one-time-code"
               pattern="\\d{4}" maxlength="4" placeholder="1234" />

        <button class="btn" type="submit">🔐 Sign in</button>
      </form>
      <div id="loginMessage" class="message"></div>
    </div>

    <!-- Already started -->
    <div id="alreadyStartedSection" class="section">
      <div id="alreadyStartedTeamInfo" class="team-info">Crew: —</div>
      <div class="logo"><div class="quiz-icon">⚠️</div><h1>Trial already in progress</h1></div>
      <div class="message error-message" style="display:block">
        This crew has already started the quiz. It can’t be restarted.
      </div>
      <button class="btn btn-ghost" onclick="location.href='/teamquest_leaderboard'">🗺️ Back to leaderboard</button>
    </div>

    <!-- Ready -->
    <div id="readySection" class="section">
      <div id="readyTeamInfo" class="team-info">Crew: —</div>
      <div class="logo"><div class="quiz-icon">🧠</div><h1>Ready to roll?</h1></div>
      <div class="instructions">
        <ul style="margin:0 0 0 18px; line-height:1.7">
          <li>15 seconds per riddle</li>
          <li>Choose carefully—no changes</li>
          <li>Audio clues may appear</li>
        </ul>
      </div>
      <div class="message" id="readyMsg"></div>
      <button id="acceptBtn" class="btn" onclick="acceptChallenge()">🚀 Accept the challenge</button>
    </div>

    <!-- Quiz -->
    <div id="quizSection" class="section">
      <div id="teamInfo" class="team-info">Crew: —</div>
      <div class="quiz-header">
        <div id="questionCounter" style="font-weight:800;color:#8B4513">Riddle 1 of 10</div>
        <div class="timer">
          <div id="timerCircle" class="timer-circle">15</div>
          <div style="font-weight:700;color:#8B4513">seconds</div>
        </div>
      </div>
      <div id="questionCard" class="question-card"></div>
      <button id="nextBtn" class="btn" style="display:none" onclick="nextQuestion()">Next riddle →</button>
    </div>

    <!-- Results -->
    <div id="resultsSection" class="section">
      <div id="resultsTeamInfo" class="team-info">Crew: —</div>
      <div class="results-summary">
        <h2>🎉 Trial complete!</h2>
        <div id="finalScore" class="final-score">0/10</div>
        <p style="font-size:1.1em;color:#8B4513;margin:0 0 12px">Doubloons earned: <span id="doubloonsEarned" style="color:#FF8C00;font-weight:800">0</span> 🪙</p>
        <div id="scoreBreakdown" class="score-breakdown"></div>
        <button class="btn btn-ghost" onclick="location.href='/teamquest_leaderboard'">🗺️ View leaderboard</button>
        <div id="submitLoading" class="message" style="display:none">🪙 Recording your doubloons…</div>
        <div id="submitMessage" class="message"></div>
      </div>
    </div>
  </div>

<script>
/* ----------------- NAV ----------------- */
document.addEventListener('DOMContentLoaded', () => {
  const navToggle = document.getElementById('nav-toggle');
  const navMenu = document.getElementById('nav-menu');
  if(navToggle && navMenu){
    navToggle.addEventListener('click',()=>{ navMenu.classList.toggle('active'); navToggle.textContent = navMenu.classList.contains('active') ? '✕':'☰'; });
    document.addEventListener('click', (e)=>{
      const inside = navToggle.contains(e.target) || navMenu.contains(e.target);
      if(!inside && navMenu.classList.contains('active')){ navMenu.classList.remove('active'); navToggle.textContent='☰'; }
    });
  }
});

/* ----------------- QUIZ LOGIC ----------------- */
const state = {
  eventId: "",
  eventState: "RUNNING",
  crews: [],
  currentTeam: null,
  started: false,
  completed: false,

  qi: 0, timeLeft: 15, tmr: null, answers: [], startedAt: null
};

const quizQuestions = [
  { id:1, type:'multiple_choice', question:'What 3 letter animal makes this noise?', audioUrl:'/animal-sound', audioDescription:'Animal sound', options:[
    {letter:'A',text:'Pig'},{letter:'B',text:'Cow'},{letter:'C',text:'Yak'},{letter:'D',text:'Elk'}], correctAnswer:'C', doubloons:10 },
  { id:2, type:'multiple_choice', question:'What is the meaning of the word: Gambado?', options:[
    {letter:'A',text:'Colourful Hat'},{letter:'B',text:'Native of Gambia'},{letter:'C',text:'Prank'},{letter:'D',text:'Foolish bet'}], correctAnswer:'C', doubloons:10 },
  { id:3, type:'multiple_choice', question:'Which UK island has its own railway, currency, and parliament, but is not part of the United Kingdom?', options:[
    {letter:'A',text:'Isle of Man'},{letter:'B',text:'Isle of Skye'},{letter:'C',text:'Isle of Wight'},{letter:'D',text:'Isles of Scilly'}], correctAnswer:'A', doubloons:10 },
  { id:4, type:'multiple_choice', question:'Answer this riddle: What gets wetter the more it dries?', options:[
    {letter:'A',text:'___s_'},{letter:'B',text:'__w__'},{letter:'C',text:'___t'},{letter:'D',text:'_a__'}], correctAnswer:'B', explanation:'Answer: Towel', doubloons:10 },
  { id:5, type:'text_input', question:'Name the one-word sport depicted in this image?', imageUrl:'/tennis-sport.png', imageDescription:'Sports image showing tennis', correctAnswer:'tennis', acceptableAnswers:['tennis','Tennis','TENNIS'], doubloons:10 },
  { id:6, type:'multiple_choice', question:'Who is this talking in this clip?', audioUrl:'/voice-clip.mp3', audioDescription:'Voice identification', options:[
    {letter:'A',text:'Ed Sheeran'},{letter:'B',text:'Harry Styles'},{letter:'C',text:'Tom Holland'},{letter:'D',text:'Taron Egerton'}], correctAnswer:'C', doubloons:10 },
  { id:7, type:'text_input', question:'What is the number of the only other month, after August (8), for Augustus, to be named after a mortal man?', correctAnswer:'7',
    acceptableAnswers:['7','seven','Seven','SEVEN','july','July','JULY','Jul','jul','JUL'], explanation:'Answer: 7 (July)', doubloons:10 },
  { id:8, type:'text_input', question:'Which one-word car manufacturer uses this logo?', imageUrl:'/smart-logo.png', imageDescription:'Smart logo', correctAnswer:'smart',
    acceptableAnswers:['smart','Smart','SMART','SmArt','sMaRt'], doubloons:10 },
  { id:9, type:'multiple_choice', question:'Listen to this intro. Which band had a huge hit with this song?', audioUrl:'/song-intro.mp3', audioDescription:'Song intro', options:[
    {letter:'A',text:'Red Hot Chili Peppers'},{letter:'B',text:'The Killers'},{letter:'C',text:'The Foo Fighters'},{letter:'D',text:'Kings of Leon'}], correctAnswer:'B', doubloons:10 },
  { id:10, type:'multiple_choice', question:'Five friends are waiting in line to get coffee... Who is at the front of the line?', options:[
    {letter:'A',text:'Ross'},{letter:'B',text:'Joey'},{letter:'C',text:'Chandler'},{letter:'D',text:'Monica'},{letter:'E',text:'Rachel'}], correctAnswer:'D', doubloons:10 },
];

function $(sel){ return document.querySelector(sel); }
function showSection(id){ document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }
function badge(text){ $('#eventBadge').textContent = text; }
function banner(text){ $('#eventMsg').textContent = text; }
function showMsg(id, text, type='error'){ const el=$(id); el.textContent=text; el.className = 'message ' + (type==='error'?'error-message':'success-message'); el.style.display='block'; }
function clearMsg(id){ const el=$(id); if(el) el.style.display='none'; }
function getEventId(){ const q=new URLSearchParams(location.search); return q.get('event') || q.get('eventId') || ''; }

async function fetchEventState(){
  try{
    const res = await fetch('/.netlify/functions/get_event_state',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId: state.eventId})});
    const data = await res.json().catch(()=> ({}));
    state.eventState = data?.state || 'RUNNING';
  }catch{ state.eventState='RUNNING'; }
  if(state.eventState==='RUNNING'){ banner('Event running — take the quiz 🧠'); badge('Running'); }
  else if(state.eventState==='PAUSED'){ banner('Event paused — submissions are closed'); badge('Paused'); }
  else if(state.eventState==='ENDED'){ banner('Event ended — submissions are closed'); badge('Ended'); }
  else if(state.eventState==='PUBLISHED'){ banner('Results published — submissions closed'); badge('Published'); }
  // gate the Accept button
  $('#acceptBtn')?.toggleAttribute('disabled', state.eventState!=='RUNNING');
}

async function loadCrews(){
  const sel = $('#teamSelect'); sel.innerHTML = '<option value="">Loading crews…</option>';
  try{
    const res = await fetch('/.netlify/functions/get_leaderboard?eventId='+encodeURIComponent(state.eventId));
    if(!res.ok) throw new Error('bad');
    const data = await res.json();
    const list = (Array.isArray(data.teams)?data.teams:(Array.isArray(data.leaderboard)?data.leaderboard:[]))
      .map(t=>({teamCode:t.teamCode, teamName:t.teamName})).filter(t=>t.teamCode&&t.teamName);
    state.crews = list;
    sel.innerHTML = '<option value="">Choose your treasure hunting crew...</option>' +
      list.sort((a,b)=>a.teamName.localeCompare(b.teamName)).map(t=>`<option value="${t.teamCode}">${t.teamName}</option>`).join('');
  }catch(e){
    sel.innerHTML = '<option value="">—</option>';
    showMsg('#loginMessage',"Couldn't load crews. Refresh and try again.",'error');
  }
}

async function verifyTeamAndPin(teamCode, pin){
  try{
    const res = await fetch('/.netlify/functions/verify_team_pin_function',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ eventId: state.eventId, teamCode, pin })
    });
    if(res.status===404){ showMsg('#loginMessage','Sign-in service unavailable. Try again later.','error'); return false; }
    const result = await res.json();
    if(result.success && result.valid){
      if(result.token) localStorage.setItem('tq.token', result.token);
      return true;
    }
    if(result.success===true && result.valid===false){ showMsg('#loginMessage',"PIN doesn’t match this crew.",'error'); }
    return false;
  }catch{ showMsg('#loginMessage','Sign-in service unavailable. Try again later.','error'); return false; }
}

async function checkQuizStatus(teamCode){
  try{
    const res = await fetch('/.netlify/functions/check_quiz_status_function',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ eventId: state.eventId, teamCode })
    });
    if(!res.ok) return { started:false, completed:false };
    const data = await res.json();
    return { started: !!data.started, completed: !!data.completed };
  }catch{ return { started:false, completed:false }; }
}

/* ---------- Login flow ---------- */
$('#loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault(); clearMsg('#loginMessage');
  const teamCode = $('#teamSelect').value;
  const pin = ($('#teamPin').value || '').replace(/\D/g,'').slice(0,4);
  if(!teamCode){ showMsg('#loginMessage','Please select your crew from the list.','error'); return; }
  if(!/^\d{4}$/.test(pin)){ showMsg('#loginMessage','Please enter a valid 4-digit secret code.','error'); return; }

  const status = await checkQuizStatus(teamCode);
  state.started = status.started; state.completed = status.completed;

  const ok = await verifyTeamAndPin(teamCode, pin);
  if(!ok) return;

  const found = state.crews.find(t=>t.teamCode===teamCode);
  state.currentTeam = found || { teamCode, teamName:"" };
  localStorage.setItem('tq.teamCode', state.currentTeam.teamCode);
  localStorage.setItem('tq.teamName', state.currentTeam.teamName);

  if(state.completed){
    showMsg('#loginMessage','This crew has already completed the quiz.','error');
    return;
  }
  if(state.started && !state.completed){
    $('#alreadyStartedTeamInfo').textContent = 'Crew: ' + state.currentTeam.teamName;
    showSection('#alreadyStartedSection');
    return;
  }

  $('#readyTeamInfo').textContent = 'Crew: ' + state.currentTeam.teamName;
  showSection('#readySection');
  // gate by event RUNNING
  $('#acceptBtn')?.toggleAttribute('disabled', state.eventState!=='RUNNING');
});

/* ---------- Accept & countdown ---------- */
async function acceptChallenge(){
  clearMsg('#readyMsg');
  if(state.eventState!=='RUNNING'){ showMsg('#readyMsg','Submissions are closed.','error'); return; }
  $('#acceptBtn').disabled = true;

  try{
    const res = await fetch('/.netlify/functions/start_quiz_function',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        eventId: state.eventId,
        teamCode: state.currentTeam.teamCode,
        teamName: state.currentTeam.teamName,
        quizStartTime: new Date().toISOString()
      })
    });
    if(!res.ok){ const text = await res.text(); throw new Error(text || ('HTTP '+res.status)); }
    const data = await res.json().catch(()=>({}));
    if(!data.success) throw new Error(data.message || 'Failed to start quiz');

    // Countdown UI
    const rs = document.getElementById('readySection');
    rs.innerHTML = `
      <div class="team-info">Crew: ${state.currentTeam.teamName}</div>
      <div class="logo"><div class="quiz-icon">🧠</div><h1>Prepare yourself!</h1></div>
      <div class="final-score" id="countdownNum" style="margin:10px 0 0">3</div>
      <p style="text-align:center;color:#8B4513;font-weight:700;margin-top:6px">Trial begins in…</p>
    `;
    let n=3; const cEl = document.getElementById('countdownNum');
    const iv = setInterval(()=>{ n--; if(n>0){ cEl.textContent=n; } else if(n===0){ cEl.textContent='GO!'; cEl.style.color='#1f7a3a'; } else { clearInterval(iv); startQuiz(); } },1000);
  }catch(err){
    showMsg('#readyMsg', 'Couldn’t start the quiz. Please try again.', 'error');
    $('#acceptBtn').disabled = false;
  }
}

function startQuiz(){
  state.startedAt = new Date();
  state.qi = 0; state.answers = []; state.timeLeft = 15;
  $('#teamInfo').textContent = 'Crew: ' + state.currentTeam.teamName;
  showSection('#quizSection');
  showQuestion();
}

/* ---------- Q&A ---------- */
function showQuestion(){
  const q = quizQuestions[state.qi];
  $('#questionCounter').textContent = `Riddle ${state.qi+1} of ${quizQuestions.length}`;
  let html = `<div style="color:#FF8C00;font-weight:800;margin-bottom:10px">Riddle ${state.qi+1}</div>
              <div style="font-size:1.2em;color:#654321;margin-bottom:14px">${q.question}</div>`;
  if(q.audioUrl){
    html += `<div style="background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:3px solid var(--gold);border-radius:15px;padding:16px;margin:16px 0;text-align:center">
               <div style="color:#8B4513;font-weight:700;margin-bottom:10px">🎵 Listen:</div>
               <audio controls preload="auto" id="questionAudio"><source src="${q.audioUrl}" type="audio/mpeg">Unsupported.</audio>
             </div>`;
  }
  if(q.imageUrl){
    html += `<img src="${q.imageUrl}" alt="${q.imageDescription||''}" style="max-width:100%;max-height:300px;border-radius:15px;border:3px solid var(--gold);display:block;margin:16px auto">`;
  }
  if(q.type==='multiple_choice'){
    html += `<div class="options-grid">` + q.options.map(o =>
      `<div class="option" data-letter="${o.letter}"><div class="option-letter">${o.letter}</div><div>${o.text}</div></div>`
    ).join('') + `</div>`;
  } else {
    html += `<input id="textAnswer" class="text-input" maxlength="50" placeholder="Type your answer here…">`;
  }
  $('#questionCard').innerHTML = html;

  if(q.type==='multiple_choice'){
    document.querySelectorAll('.option').forEach(el=>{
      el.addEventListener('click', ()=> selectOption(el.getAttribute('data-letter')));
    });
  } else {
    const inp = $('#textAnswer');
    inp?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ submitAnswer(inp.value.trim()); } });
  }

  const audio = document.getElementById('questionAudio'); audio?.play().catch(()=>{});
  state.timeLeft = 15; updateTimer(); startTimer();
}

function selectOption(letter){
  document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
  const el = [...document.querySelectorAll('.option')].find(o=>o.getAttribute('data-letter')===letter);
  el?.classList.add('selected');
  submitAnswer(letter);
}

function normalizeText(s){
  return (s||'').toLowerCase().trim().replace(/[^\w\s]/g,'').replace(/\s+/g,'').trim();
}
function textCorrect(user, q){
  const u = normalizeText(user);
  if(q.acceptableAnswers) return q.acceptableAnswers.some(a => normalizeText(a)===u);
  return normalizeText(q.correctAnswer)===u;
}

function submitAnswer(ans){
  clearInterval(state.tmr);
  const q = quizQuestions[state.qi];
  let correct=false;
  if(q.type==='multiple_choice'){ correct = (ans === q.correctAnswer); }
  else { if(!ans){ ans = $('#textAnswer')?.value.trim() || ''; } correct = textCorrect(ans, q); }

  state.answers.push({ questionId:q.id, userAnswer:ans, correctAnswer:q.correctAnswer, isCorrect:correct, doubloons: correct? q.doubloons:0, timeLeft: state.timeLeft });

  // highlight
  if(q.type==='multiple_choice'){
    document.querySelectorAll('.option').forEach(opt=>{
      const L = opt.getAttribute('data-letter');
      if(L===q.correctAnswer) opt.classList.add('correct');
      else if(opt.classList.contains('selected') && !correct) opt.classList.add('incorrect');
      opt.style.pointerEvents='none';
    });
  }
  if(q.explanation){
    $('#questionCard').insertAdjacentHTML('beforeend',
      `<div style="margin-top:14px;padding:12px;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:2px solid var(--gold);border-radius:12px;color:#8B4513;font-weight:700">${q.explanation}</div>`);
  }

  setTimeout(()=>{ 
    if(state.qi < quizQuestions.length-1){ state.qi++; showQuestion(); }
    else { finishQuiz(); }
  }, 1600);
}

function startTimer(){
  state.tmr = setInterval(()=>{
    state.timeLeft--; updateTimer();
    if(state.timeLeft<=0){ submitAnswer(''); }
  },1000);
}
function updateTimer(){
  const t = $('#timerCircle'); t.textContent = state.timeLeft;
  t.classList.remove('warning','danger');
  if(state.timeLeft<=3) t.classList.add('danger'); else if(state.timeLeft<=5) t.classList.add('warning');
  const deg = (Math.max(state.timeLeft,0)/15)*360;
  if(state.timeLeft<=3) t.style.background = `conic-gradient(#DC143C ${deg}deg, #FFB6C1 ${deg}deg)`;
  else if(state.timeLeft<=5) t.style.background = `conic-gradient(#FF8C00 ${deg}deg, #FFE4B5 ${deg}deg)`;
  else t.style.background = `conic-gradient(${getComputedStyle(document.documentElement).getPropertyValue('--gold')} ${deg}deg, #F5E6D3 ${deg}deg)`;
}

function finishQuiz(){
  const correct = state.answers.filter(a=>a.isCorrect).length;
  const total = quizQuestions.length;
  const score = state.answers.reduce((s,a)=>s+a.doubloons,0);

  $('#finalScore').textContent = `${correct}/${total}`;
  $('#doubloonsEarned').textContent = score;
  $('#resultsTeamInfo').textContent = 'Crew: ' + state.currentTeam.teamName;

  let breakdown='';
  state.answers.forEach((a,i)=>{
    const q = quizQuestions[i];
    breakdown += `<div style="display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid ${getComputedStyle(document.documentElement).getPropertyValue('--gold')}">
      <div>Riddle ${i+1}: ${q.question.substring(0,50)}…</div>
      <div style="font-weight:800;color:${a.isCorrect?'#32CD32':'#DC143C'}">${a.isCorrect?('✓ +'+a.doubloons):'✗ 0'}</div>
    </div>`;
  });
  $('#scoreBreakdown').innerHTML = breakdown;

  showSection('#resultsSection');
  submitQuizResults(score, correct, total);
}

async function submitQuizResults(totalDoubloons, correct, total){
  const loader = $('#submitLoading'); const msg = $('#submitMessage');
  loader.style.display='block'; msg.style.display='none';
  try{
    const payload = {
      eventId: state.eventId,
      teamCode: state.currentTeam.teamCode,
      teamName: state.currentTeam.teamName,
      totalScore: totalDoubloons,
      questionsCorrect: correct,
      totalQuestions: total,
      quizStartTime: state.startedAt?.toISOString?.() || new Date().toISOString(),
      completionTime: new Date().toISOString(),
      answers: state.answers
    };
    const res = await fetch('/.netlify/functions/submit_quiz_function',{
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || !data.success){ throw new Error(data.message || 'Submission failed'); }
    msg.className='message success-message'; msg.textContent="🎉 Doubloons recorded. Check the leaderboard in a minute."; msg.style.display='block';
  }catch(e){
    msg.className='message error-message'; msg.textContent="Failed to record doubloons. Your score is shown above."; msg.style.display='block';
  }finally{
    loader.style.display='none';
  }
}

/* ---------- Boot ---------- */
async function boot(){
  state.eventId = getEventId();
  await fetchEventState();
  await loadCrews();

  // Auto restore sign-in if present
  const tc = localStorage.getItem('tq.teamCode'); const tn = localStorage.getItem('tq.teamName');
  if(tc && tn){
    state.currentTeam = { teamCode: tc, teamName: tn };
    const st = await checkQuizStatus(tc);
    if(st.completed){
      // Completed: keep on login with message (no retake)
      showMsg('#loginMessage','This crew has already completed the quiz.','error');
    }else if(st.started){
      $('#alreadyStartedTeamInfo').textContent = 'Crew: ' + tn;
      showSection('#alreadyStartedSection');
    }else{
      $('#readyTeamInfo').textContent = 'Crew: ' + tn;
      showSection('#readySection');
      $('#acceptBtn')?.toggleAttribute('disabled', state.eventState!=='RUNNING');
    }
  }
}
$('#refreshState').addEventListener('click', fetchEventState);
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
