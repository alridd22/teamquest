<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest ‚Äì The Quiz Challenge</title>
  <style>
    /* --- keep styles lightweight (your visuals still intact) --- */
    :root { --gold:#DAA520; --brown:#8B4513; --cream:#FFF8DC; --sand:#F5E6D3; --ok:#32CD32; --warn:#FF8C00; --bad:#DC143C;}
    *{box-sizing:border-box} body{margin:0;font-family:Segoe UI,Tahoma,Verdana,sans-serif;background:linear-gradient(135deg,#8B4513,#D2691E 30%,#F4A460);min-height:100vh;padding:18px}
    .container{max-width:900px;margin:0 auto;background:linear-gradient(145deg,#F5E6D3,#E8D7C3);border:3px solid var(--brown);border-radius:22px;box-shadow:0 20px 40px rgba(0,0,0,.18);padding:28px}
    h1{margin:10px 0 4px;color:var(--brown)} .subtitle{color:#A0522D;margin-bottom:18px}
    .section{display:none} .section.active{display:block}
    .card{background:linear-gradient(135deg,#FFF8DC,#F5E6D3);border:2px solid var(--gold);border-radius:16px;padding:18px;margin:18px 0}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .field label{font-weight:600;color:var(--brown)} .field input,.field select{width:100%;padding:12px;border:3px solid var(--gold);border-radius:10px;background:linear-gradient(145deg,#fff,#FFF8DC);font-size:16px}
    .btn{display:inline-flex;gap:10px;align-items:center;justify-content:center;width:100%;padding:16px;border-radius:12px;border:2px solid var(--brown);font-weight:700;color:#fff;background:linear-gradient(135deg,#FF8C00,#DAA520);cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{display:none;margin-top:14px;padding:12px;border-radius:10px;border:2px solid}
    .msg.error{display:block;background:linear-gradient(135deg,#FFB6C1,#FFA0B4);border-color:var(--bad);color:#8B0000}
    .msg.ok{display:block;background:linear-gradient(135deg,#98FB98,#90EE90);border-color:var(--ok);color:#064406}
    .team-pill{background:linear-gradient(135deg,#8B4513,#A0522D);border:2px solid var(--gold);color:#fff;border-radius:14px;padding:12px 16px;font-weight:700;margin-bottom:16px;text-align:center}
    .timer{display:flex;align-items:center;gap:10px}
    .dial{width:56px;height:56px;border-radius:50%;border:3px solid var(--brown);display:flex;align-items:center;justify-content:center;font-weight:800;background:conic-gradient(var(--gold) 0deg,#F5E6D3 0deg);color:var(--brown)}
    .q{border:3px solid var(--gold);border-radius:18px;background:#fff;padding:20px;margin:18px 0}
    .q-num{color:var(--warn);font-weight:700;margin-bottom:8px}
    .opt{display:flex;align-items:center;gap:12px;padding:14px;border:3px solid var(--gold);border-radius:12px;background:linear-gradient(135deg,#FFF8DC,#F5E6D3);cursor:pointer}
    .opt:hover{transform:translateY(-1px)} .opt .letter{width:32px;height:32px;border-radius:50%;border:2px solid var(--gold);display:flex;align-items:center;justify-content:center;background:#fff;color:var(--brown);font-weight:800}
    .opt.correct{background:linear-gradient(135deg,#32CD32,#228B22);border-color:#006400;color:#fff} .opt.incorrect{background:linear-gradient(135deg,#DC143C,#B22222);border-color:#8B0000;color:#fff}
    .qimg{max-width:100%;max-height:280px;border-radius:12px;border:3px solid var(--gold);display:block;margin:14px auto}
    @media (max-width:680px){body{padding:10px} .container{padding:18px}}
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align:center">
      <h1>The Quiz Challenge</h1>
      <p class="subtitle">10 riddles from Terry‚Äôs archives! Prove your wit and claim doubloons!</p>
    </div>

    <!-- LOGIN -->
    <section id="login" class="section active">
      <div class="card">
        <h3>üìú Challenge Rules</h3>
        <ul style="margin:10px 0 0 18px;color:#654321;line-height:1.7">
          <li>10 riddles ‚Äî 15 seconds each</li><li>Some include audio ‚Äî check your volume</li>
          <li>Choose once ‚Äî no changes</li><li>Up to 100 doubloons for perfection</li>
        </ul>
      </div>

      <div class="card">
        <div class="field" style="margin-bottom:14px">
          <label for="teamSelect">Select Your Crew</label>
          <select id="teamSelect"><option value="">Choose your treasure hunting crew...</option></select>
        </div>
        <div class="field">
          <label for="teamPin">Enter Your Crew‚Äôs Secret Code</label>
          <input id="teamPin" inputmode="numeric" pattern="\\d{4}" minlength="4" maxlength="4" placeholder="1234"/>
        </div>
        <button id="beginBtn" class="btn" style="margin-top:14px">üß≠ Begin the Knowledge Trial</button>
        <div id="loginMsg" class="msg"></div>
      </div>
    </section>

    <!-- READY -->
    <section id="ready" class="section">
      <div id="readyTeam" class="team-pill">Crew: ‚Äî</div>
      <div class="card">
        <h3>‚ö° Terry‚Äôs Knowledge Trial</h3>
        <ul style="margin:10px 0 0 18px;color:#654321;line-height:1.7">
          <li><b>10 riddles</b> total</li><li><b>15 seconds per riddle</b></li>
          <li><b>No turning back</b> once answered</li>
          <li><b>Audio clues</b> may appear</li><li><b>One trial only</b></li>
        </ul>
      </div>
      <button id="acceptBtn" class="btn">üöÄ Accept the Challenge</button>
      <div id="readyMsg" class="msg"></div>
    </section>

    <!-- QUIZ -->
    <section id="quiz" class="section">
      <div id="quizTeam" class="team-pill">Crew: ‚Äî</div>
      <div class="row card">
        <div id="qCounter" style="font-weight:700;color:var(--brown)">Riddle 1 of 10</div>
        <div class="timer"><div id="dial" class="dial">15</div><div style="font-weight:700;color:var(--brown)">seconds</div></div>
      </div>
      <div id="qCard" class="q"></div>
    </section>

    <!-- RESULTS -->
    <section id="results" class="section">
      <div id="resTeam" class="team-pill">Crew: ‚Äî</div>
      <div class="card" style="text-align:center">
        <h2>üéâ Trial Complete!</h2>
        <div id="finalScore" style="font-size:2.6rem;color:#FF8C00;font-weight:800;margin:6px 0">0/10</div>
        <p>Doubloons earned: <b id="earned" style="color:#FF8C00">0</b> ü™ô</p>
        <div id="breakdown" class="card" style="text-align:left"></div>
        <button class="btn" onclick="location.href='/teamquest_leaderboard.html'">üèÜ View Treasure Map</button>
        <div id="submitMsg" class="msg" style="margin-top:12px"></div>
      </div>
    </section>
  </div>

  <script>
    /* ========== shared helpers ========== */
    const EVENT_ID = new URLSearchParams(location.search).get('event') || '';
    const $ = id => document.getElementById(id);

    function show(sectionId){
      for(const s of document.querySelectorAll('.section')) s.classList.remove('active');
      $(sectionId).classList.add('active');
    }
    function setMsg(id, text, type){ const m=$(id); m.textContent=text; m.className='msg '+(type==='error'?'error':'ok'); }

    // POST helper that tries both with and without "_function"
    async function postAny(basenames, payload){
      const body = JSON.stringify(payload||{});
      const headers={'Content-Type':'application/json'};
      for (const base of basenames){
        try{
          const r = await fetch(`/.netlify/functions/${base}`, {method:'POST',headers,body});
          if (r.ok) return await r.json();
        }catch(e){}
      }
      throw new Error('All endpoints failed: '+basenames.join(', '));
    }
    // GET helper (fallback)
    async function getJson(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    /* ========== SAME TEAM LOADER AS OTHER ACTIVITIES ========== */
    function extractTeams(data){
      if (Array.isArray(data?.teams)) return data.teams;

      if (Array.isArray(data?.leaderboard)){
        return data.leaderboard
          .map(r=>({
            teamCode: r.teamCode || r.code || r.teamId || '',
            teamName: r.teamName || r.name || ''
          }))
          .filter(t=>t.teamName);
      }

      if (Array.isArray(data?.rows)){
        return data.rows
          .map(r=>({
            teamCode: r.teamCode || r.code || r.teamId || '',
            teamName: r.teamName || r.name || ''
          }))
          .filter(t=>t.teamName);
      }
      return [];
    }

    async function loadTeams(){
      try{
        // Preferred: POST (works with your other pages)
        let data = await postAny(['get_leaderboard','get_leaderboard_function'], { eventId: EVENT_ID });
        let teams = extractTeams(data);

        // Fallback: GET
        if(!teams.length){
          const d = await getJson(`/.netlify/functions/get_leaderboard?eventId=${encodeURIComponent(EVENT_ID)}`);
          teams = extractTeams(d);
        }

        if(!teams.length) throw new Error('No teams returned');

        teams.sort((a,b)=> (a.teamName||'').localeCompare(b.teamName||''));
        const sel = $('teamSelect');
        sel.innerHTML = '<option value="">Choose your treasure hunting crew...</option>'
          + teams.map(t=>`<option value="${t.teamCode}">${t.teamName}</option>`).join('');

      }catch(e){
        console.error('load teams Error:', e);
        setMsg('loginMsg','Unable to load crew list. Please refresh.','error');
      }
    }

    /* ========== QUIZ LOGIC (unchanged scoring) ========== */
    let allTeams=[], currentTeam=null, quizStart=null, idx=0, tLeft=15, tId=null, answers=[];

    const questions = [
      {id:1,type:'multiple_choice',question:'What 3 letter animal makes this noise?',audioUrl:'/animal-sound',options:[{letter:'A',text:'Pig'},{letter:'B',text:'Cow'},{letter:'C',text:'Yak'},{letter:'D',text:'Elk'}],correctAnswer:'C',doubloons:10},
      {id:2,type:'multiple_choice',question:'What is the meaning of the word: Gambado?',options:[{letter:'A',text:'Colourful Hat'},{letter:'B',text:'Native of Gambia'},{letter:'C',text:'Prank'},{letter:'D',text:'Foolish bet'}],correctAnswer:'C',doubloons:10},
      {id:3,type:'multiple_choice',question:'Which UK island has its own railway, currency, and parliament, but is not part of the United Kingdom?',options:[{letter:'A',text:'Isle of Man'},{letter:'B',text:'Isle of Skye'},{letter:'C',text:'Isle of Wight'},{letter:'D',text:'Isles of Scilly'}],correctAnswer:'A',doubloons:10},
      {id:4,type:'multiple_choice',question:'Answer this riddle: What gets wetter the more it dries?',options:[{letter:'A',text:'___s_'},{letter:'B',text:'__w__'},{letter:'C',text:'___t'},{letter:'D',text:'_a__'}],correctAnswer:'B',explanation:'Answer: Towel',doubloons:10},
      {id:5,type:'text_input',question:'Name the one-word sport depicted in this image?',imageUrl:'/tennis-sport.png',correctAnswer:'tennis',acceptableAnswers:['tennis','Tennis','TENNIS'],doubloons:10},
      {id:6,type:'multiple_choice',question:'Who is this talking in this clip?',audioUrl:'/voice-clip.mp3',options:[{letter:'A',text:'Ed Sheeran'},{letter:'B',text:'Harry Styles'},{letter:'C',text:'Tom Holland'},{letter:'D',text:'Taron Egerton'}],correctAnswer:'C',doubloons:10},
      {id:7,type:'text_input',question:'What is the number of the only other month, after August (8), named after a mortal man?',correctAnswer:'7',acceptableAnswers:['7','seven','Seven','SEVEN','july','July','JULY','Jul','jul','JUL'],explanation:'Answer: 7 (July)',doubloons:10},
      {id:8,type:'text_input',question:'Which one-word car manufacturer uses this logo?',imageUrl:'/smart-logo.png',correctAnswer:'smart',acceptableAnswers:['smart','Smart','SMART','SmArt','sMaRt'],doubloons:10},
      {id:9,type:'multiple_choice',question:'Listen to this intro. Which band had a huge hit with this song?',audioUrl:'/song-intro.mp3',options:[{letter:'A',text:'Red Hot Chili Peppers'},{letter:'B',text:'The Killers'},{letter:'C',text:'The Foo Fighters'},{letter:'D',text:'Kings of Leon'}],correctAnswer:'B',doubloons:10},
      {id:10,type:'multiple_choice',question:'Five friends are waiting in line for coffee... Who is at the front of the line?',options:[{letter:'A',text:'Ross'},{letter:'B',text:'Joey'},{letter:'C',text:'Chandler'},{letter:'D',text:'Monica'},{letter:'E',text:'Rachel'}],correctAnswer:'D',doubloons:10}
    ];

    function normalize(s){ return (s||'').toLowerCase().trim().replace(/[^\w\s]/g,'').replace(/\s+/g,'').trim(); }
    function textCorrect(ans,q){ const u=normalize(ans); const ok = (q.acceptableAnswers||[q.correctAnswer]).some(a=>normalize(a)===u); return ok; }

    function paintTimer(){
      const dial=$('dial'); dial.textContent=tLeft;
      const pct=(tLeft/15)*360; dial.style.background=`conic-gradient(${tLeft<=3? '#DC143C': (tLeft<=5?'#FF8C00':'#DAA520')} ${pct}deg,#F5E6D3 ${pct}deg)`;
    }
    function startTick(){
      clearInterval(tId); paintTimer();
      tId=setInterval(()=>{ tLeft--; paintTimer(); if(tLeft<=0){ clearInterval(tId); submit(''); } },1000);
    }

    function drawQ(){
      const q=questions[idx]; $('qCounter').textContent=`Riddle ${idx+1} of ${questions.length}`;
      let html=`<div class="q-num">Riddle ${idx+1}</div><div style="font-size:1.15rem;color:#654321;margin:8px 0">${q.question}</div>`;
      if(q.audioUrl){ html+=`<div class="card" style="text-align:center"><div style="font-weight:700;color:${'#8B4513'};margin-bottom:8px">üéµ Listen to this clue:</div><audio controls preload="auto" id="qaudio"><source src="${q.audioUrl}" type="audio/mpeg"></audio></div>`;}
      if(q.imageUrl){ html+=`<img class="qimg" src="${q.imageUrl}" alt="">`; }
      if(q.type==='multiple_choice'){
        html+='<div style="display:grid;gap:12px">';
        q.options.forEach(o=> html+=`<div class="opt" data-letter="${o.letter}"><div class="letter">${o.letter}</div><div>${o.text}</div></div>`);
        html+='</div>';
      }else{
        html+=`<input id="textAns" class="field" style="padding:14px;border:3px solid var(--gold);border-radius:10px;width:100%" placeholder="Type your answer...">`;
        html+=`<div style="height:8px"></div><button class="btn" id="textSubmit">Submit</button>`;
      }
      $('qCard').innerHTML=html;

      if(q.type==='multiple_choice'){
        document.querySelectorAll('.opt').forEach(el=> el.addEventListener('click',()=> submit(el.dataset.letter)));
      }else{
        $('textSubmit').onclick=()=> submit(($('textAns').value||'').trim());
        $('textAns').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('textSubmit').click(); }});
      }

      tLeft=15; startTick();
      const a=$('qaudio'); a&&a.play().catch(()=>{});
    }

    function submit(val){
      clearInterval(tId);
      const q=questions[idx];
      const correct = q.type==='multiple_choice' ? (val===q.correctAnswer) : textCorrect(val,q);

      answers.push({
        questionId:q.id,userAnswer:val,correctAnswer:q.correctAnswer,
        isCorrect:correct,doubloons:correct? q.doubloons:0,timeLeft:tLeft
      });

      if(q.type==='multiple_choice'){
        document.querySelectorAll('.opt').forEach(el=>{
          const letter=el.dataset.letter;
          el.classList.toggle('correct',letter===q.correctAnswer);
          if(letter!==q.correctAnswer && letter===val) el.classList.add('incorrect');
          el.style.pointerEvents='none';
        });
      }

      setTimeout(()=>{
        idx++;
        if(idx<questions.length) drawQ(); else finish();
      }, 900);
    }

    async function finish(){
      show('results');
      $('resTeam').textContent='Crew: '+currentTeam.teamName;
      const correct = answers.filter(a=>a.isCorrect).length;
      const score = answers.reduce((s,a)=>s+a.doubloons,0);
      $('finalScore').textContent=`${correct}/${questions.length}`;
      $('earned').textContent=score;

      $('breakdown').innerHTML = answers.map((a,i)=>{
        const q=questions[i];
        return `<div class="row" style="border-bottom:1px solid var(--gold);padding:8px 0">
            <div>Riddle ${i+1}: ${q.question.slice(0,60)}...</div>
            <div style="font-weight:700;color:${a.isCorrect?'#32CD32':'#DC143C'}">${a.isCorrect?('‚úì +'+a.doubloons):'‚úó 0'}</div>
        </div>`;
      }).join('');

      try{
        const payload = {
          eventId: EVENT_ID,
          teamCode: currentTeam.teamCode,
          teamName: currentTeam.teamName,
          totalScore: score,
          questionsCorrect: correct,
          totalQuestions: questions.length,
          completionTime: new Date().toISOString(),
          quizStartTime: quizStart?.toISOString?.() || new Date().toISOString(),
          answers
        };
        await postAny(['submit_quiz','submit_quiz_function'], payload);
        setMsg('submitMsg','üéâ Doubloons recorded in the ledger!','ok');
      }catch(e){
        console.error(e);
        setMsg('submitMsg','Couldn‚Äôt record your score, but the quiz is complete.','error');
      }
    }

    /* ========== FLOW ========== */
    $('beginBtn').onclick = async ()=>{
      const code = $('teamSelect').value.trim();
      const pin = $('teamPin').value.trim();
      if(!code){ setMsg('loginMsg','Please select your crew.','error'); return; }
      if(!/^\d{4}$/.test(pin)){ setMsg('loginMsg','Enter a valid 4-digit secret code.','error'); return; }

      try{
        const v = await postAny(['verify_team_pin','verify_team_pin_function'], { teamCode: code, pin });
        if(!v?.success || !v?.valid){ setMsg('loginMsg','Incorrect secret code.','error'); return; }
        currentTeam = { teamCode: code, teamName: (document.querySelector(`#teamSelect option[value="${code}"]`)?.textContent)||code };
        $('readyTeam').textContent='Crew: '+currentTeam.teamName;
        show('ready');
      }catch(e){
        console.error(e); setMsg('loginMsg','Problem verifying crew. Try again.','error');
      }
    };

    $('acceptBtn').onclick = async ()=>{
      try{
        quizStart = new Date();
        await postAny(['start_quiz','start_quiz_function'], {
          teamCode: currentTeam.teamCode,
          teamName: currentTeam.teamName,
          quizStartTime: quizStart.toISOString(),
          eventId: EVENT_ID
        });
        $('quizTeam').textContent='Crew: '+currentTeam.teamName;
        idx=0; answers=[]; show('quiz'); drawQ();
      }catch(e){
        console.error(e);
        setMsg('readyMsg','Couldn‚Äôt start the quiz. Please try again.','error');
      }
    };

    // boot
    loadTeams();
  </script>
</body>
</html>
