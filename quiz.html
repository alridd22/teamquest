<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest - The Quiz Challenge</title>
  <style>
    /* ‚Äî‚Äî‚Äî NAV ‚Äî‚Äî‚Äî */
    .treasure-nav{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,0.3);z-index:1000;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;height:80px}
    .nav-container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 20px;height:100%}
    .nav-logo{text-decoration:none;transition:.3s;display:flex;align-items:center}
    .nav-logo:hover{transform:scale(1.05)}
    .nav-logo img{height:50px;width:auto;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5));transition:.3s}
    @media (max-width:768px){.nav-logo img{height:85px!important}}
    .nav-logo:hover img{filter:drop-shadow(2px 2px 8px rgba(255,215,0,.6))}
    .nav-menu{display:flex;list-style:none;margin:0;padding:0;gap:30px}
    .nav-item{position:relative}
    .nav-link{color:#F5DEB3;text-decoration:none;font-size:1rem;font-weight:bold;padding:12px 18px;border-radius:8px;transition:.3s;display:block;text-shadow:1px 1px 2px rgba(0,0,0,.7);background:rgba(101,67,33,.3);border:2px solid rgba(218,165,32,.4);white-space:nowrap}
    .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(218,165,32,.4);border-color:#DAA520}
    .nav-dropdown{position:absolute;top:100%;left:0;background:linear-gradient(135deg,#654321 0%,#8B4513 100%);border:2px solid #DAA520;border-radius:8px;min-width:180px;opacity:0;visibility:hidden;transform:translateY(-10px);transition:.2s;box-shadow:0 8px 20px rgba(0,0,0,.3)}
    .nav-item:hover .nav-dropdown{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-link{display:block;color:#F5DEB3;text-decoration:none;padding:12px 18px;font-size:.95rem;border-bottom:1px solid rgba(218,165,32,.2);transition:.2s;background:rgba(101,67,33,.2);margin:2px;border-radius:6px;font-weight:600}
    .dropdown-link:last-child{border-bottom:none}
    .dropdown-link:hover{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;padding-left:25px;transform:translateX(5px);box-shadow:0 2px 8px rgba(255,140,0,.3)}
    .nav-toggle{display:none;background:none;border:none;color:#DAA520;font-size:1.8rem;cursor:pointer}
    @media (max-width:768px){
      .treasure-nav{height:120px}
      .nav-container{justify-content:center;position:relative}
      .nav-logo{position:absolute;left:50%;transform:translateX(-50%)}
      .nav-toggle{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:block}
      .nav-menu{position:fixed;top:120px;left:-100%;width:100%;height:calc(100vh - 120px);background:linear-gradient(135deg,#8B4513 0%,#654321 100%);flex-direction:column;align-items:center;padding-top:30px;gap:20px;transition:left .3s;overflow-y:auto}
      .nav-menu.active{left:0}
      .nav-link{font-size:1.1rem;padding:15px 25px;width:280px;text-align:center;background:linear-gradient(135deg,rgba(101,67,33,.8),rgba(139,69,19,.6));border:2px solid #DAA520;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .nav-dropdown{position:static;opacity:1;visibility:visible;transform:none;background:rgba(101,67,33,.9);border:2px solid #DAA520;border-radius:12px;margin-top:10px;width:280px;box-shadow:0 8px 20px rgba(0,0,0,.4)}
      .dropdown-link{padding:12px 20px;font-size:1rem;margin:4px;border-radius:8px;text-align:center;background:rgba(139,69,19,.4);border:1px solid rgba(218,165,32,.3)}
    }
    /* ‚Äî‚Äî‚Äî PAGE ‚Äî‚Äî‚Äî */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;padding-top:100px!important;position:relative}
    @media (max-width:768px){body{padding-top:140px!important}}
    body::before{content:'';position:fixed;inset:0;background:
      radial-gradient(circle at 20% 20%,rgba(255,215,0,.1) 0%,transparent 50%),
      radial-gradient(circle at 80% 80%,rgba(255,140,0,.1) 0%,transparent 50%)}
    .container{background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border-radius:25px;padding:40px;box-shadow:0 20px 40px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.3);max-width:900px;width:100%;position:relative;overflow:hidden;z-index:1;border:3px solid #8B4513}
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}
    .container::after{content:'';position:absolute;top:15px;left:15px;right:15px;bottom:15px;border:2px solid #DAA520;border-radius:20px;pointer-events:none}
    .logo{text-align:center;margin-bottom:30px}
    .quiz-icon{font-size:48px;margin-bottom:20px;animation:pulse 2s infinite;filter:drop-shadow(2px 2px 4px rgba(139,69,19,.3))}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    h1{color:#8B4513;text-align:center;margin-bottom:10px;font-size:2.5em;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .subtitle{text-align:center;color:#A0522D;margin-bottom:30px;font-size:1.1em;font-weight:500}
    .team-info{background:linear-gradient(135deg,#8B4513,#A0522D);color:#fff;padding:20px;border-radius:15px;text-align:center;font-size:1.2em;font-weight:bold;margin-bottom:30px;box-shadow:0 5px 15px rgba(139,69,19,.3);border:2px solid #DAA520}
    .login-section,.ready-section,.quiz-section,.results-section,.already-started-section{display:none}
    .login-section.active,.ready-section.active,.quiz-section.active,.results-section.active,.already-started-section.active{display:block}
    .instructions{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-left:6px solid #FF8C00;padding:25px;margin-bottom:30px;border-radius:0 15px 15px 0;box-shadow:0 4px 12px rgba(139,69,19,.1);border:2px solid #DAA520}
    .instructions h3{color:#8B4513;margin-bottom:15px;display:flex;align-items:center;gap:10px;font-size:1.3em;font-weight:700}
    .instructions ul{margin-left:20px;color:#654321;line-height:1.8}
    .form-group{margin-bottom:25px}
    label{display:block;margin-bottom:8px;color:#8B4513;font-weight:600;font-size:1.1em}
    input[type="text"],input[type="number"],select{width:100%;padding:15px;border:3px solid #DAA520;border-radius:12px;font-size:16px;transition:.3s;background:linear-gradient(145deg,#fff 0%,#FFF8DC 100%);font-family:inherit}
    input[type="text"]:focus,input[type="number"]:focus,select:focus{outline:none;border-color:#FF8C00;background:#fff;box-shadow:0 0 0 3px rgba(255,140,0,.2);transform:translateY(-1px)}
    .pin-input{text-align:center;font-size:1.5em;letter-spacing:3px;font-weight:bold}
    .submit-btn{width:100%;background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:none;padding:18px;border-radius:12px;font-size:1.1em;font-weight:700;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:20px;border:2px solid #8B4513;text-shadow:1px 1px 2px rgba(0,0,0,.2)}
    .submit-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(255,140,0,.3);background:linear-gradient(135deg,#FFB347,#F0C814)}
    .submit-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding:20px;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-radius:15px;border:2px solid #DAA520}
    .question-counter{font-size:1.2em;font-weight:bold;color:#8B4513}
    .timer{display:flex;align-items:center;gap:10px}
    .timer-circle{width:60px;height:60px;border-radius:50%;background:conic-gradient(#DAA520 0deg,#F5E6D3 0deg);display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:bold;color:#8B4513;transition:.1s;border:3px solid #8B4513}
    .timer-circle.warning{background:conic-gradient(#FF8C00 0deg,#FFE4B5 0deg);animation:shake .5s infinite}
    .timer-circle.danger{background:conic-gradient(#DC143C 0deg,#FFB6C1 0deg);animation:shake .2s infinite}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
    .question-card{background:linear-gradient(145deg,#fff 0%,#FFF8DC 100%);border:3px solid #DAA520;border-radius:20px;padding:30px;margin-bottom:30px;box-shadow:0 10px 25px rgba(139,69,19,.15)}
    .question-number{color:#FF8C00;font-size:1.1em;font-weight:bold;margin-bottom:15px}
    .question-text{font-size:1.3em;color:#654321;margin-bottom:25px;line-height:1.4;font-weight:500}
    .question-image{max-width:100%;max-height:300px;border-radius:15px;margin:20px auto;display:block;border:3px solid #DAA520}
    .audio-player{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:3px solid #DAA520;border-radius:15px;padding:20px;margin:20px 0;text-align:center}
    .audio-player audio{width:100%;max-width:400px}
    .play-instruction{color:#8B4513;font-weight:bold;margin-bottom:15px;font-size:1.1em}
    .options-grid{display:grid;gap:15px;margin-bottom:30px}
    .option{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:3px solid #DAA520;border-radius:15px;padding:20px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:15px;font-size:1.1em}
    .option:hover{background:linear-gradient(135deg,#FFE4B5 0%,#DDD3C2 100%);transform:translateY(-2px);box-shadow:0 5px 15px rgba(139,69,19,.2)}
    .option.selected{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border-color:#8B4513}
    .option.correct{background:linear-gradient(135deg,#32CD32,#228B22);color:#fff;border-color:#006400}
    .option.incorrect{background:linear-gradient(135deg,#DC143C,#B22222);color:#fff;border-color:#8B0000}
    .option-letter{background:#fff;color:#8B4513;width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;flex-shrink:0;border:2px solid #DAA520}
    .option.selected .option-letter{background:#FFF8DC;color:#8B4513}
    .option.correct .option-letter{background:#006400;color:#fff;border-color:#004000}
    .option.incorrect .option-letter{background:#8B0000;color:#fff;border-color:#600000}
    .text-input{width:100%;padding:15px;border:3px solid #DAA520;border-radius:12px;font-size:1.2em;text-align:center;margin-bottom:20px;background:linear-gradient(145deg,#fff 0%,#FFF8DC 100%)}
    .text-input:focus{outline:none;border-color:#FF8C00;box-shadow:0 0 0 3px rgba(255,140,0,.2)}
    .results-summary{text-align:center;padding:40px}
    .final-score{font-size:3em;color:#FF8C00;font-weight:bold;margin-bottom:20px;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .score-breakdown{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-radius:15px;padding:30px;margin:30px 0;border:2px solid #DAA520}
    .breakdown-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #DAA520}
    .breakdown-item:last-child{border-bottom:none}
    .message{padding:15px;border-radius:12px;margin:20px 0;text-align:center;display:none;border:2px solid}
    .success-message{background:linear-gradient(135deg,#98FB98 0%,#90EE90 100%);border-color:#32CD32;color:#006400}
    .error-message{background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);border-color:#DC143C;color:#8B0000}
    .loading{display:none;text-align:center;margin-top:15px;color:#8B4513;font-weight:600}
    .ready-countdown{font-size:4em;color:#FF8C00;font-weight:bold;text-align:center;margin:30px 0;animation:pulse 1s infinite;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
    .ready-instructions{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border:3px solid #DAA520;border-radius:20px;padding:30px;margin:30px 0;text-align:center}
    .start-quiz-btn{width:100%;background:linear-gradient(135deg,#32CD32,#228B22);color:#fff;border:none;padding:20px;border-radius:15px;font-size:1.3em;font-weight:700;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:15px;margin-top:30px;animation:glow 2s infinite;border:2px solid #006400}
    .start-quiz-btn:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(50,205,50,.4);background:linear-gradient(135deg,#50C878,#32CD32)}
    @keyframes glow{0%,100%{box-shadow:0 5px 15px rgba(50,205,50,.3)}50%{box-shadow:0 10px 25px rgba(50,205,50,.5)}}
    .terry-greeting{display:flex;align-items:flex-start;gap:20px;margin:20px 0;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-radius:20px;padding:25px;border:3px solid #DAA520;box-shadow:0 5px 15px rgba(139,69,19,.2)}
    .terry-image{width:120px;height:120px;border-radius:50%;border:4px solid #DAA520;box-shadow:0 4px 12px rgba(139,69,19,.3);object-fit:cover;background:linear-gradient(135deg,#8B4513,#A0522D)}
    .terry-note{background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);color:#8B4513;padding:25px;border-radius:15px;margin:0;border:3px solid #DAA520;font-weight:500;line-height:1.6;box-shadow:0 5px 15px rgba(255,215,0,.3)}
    .already-started-warning{background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);border:3px solid #DC143C;border-radius:20px;padding:30px;margin:30px 0;text-align:center}
    @media (max-width:768px){.terry-greeting{flex-direction:column;align-items:center;text-align:center}.container{padding:30px 20px}.quiz-header{flex-direction:column;gap:15px}.timer-circle{width:50px;height:50px;font-size:1.2em}}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo">
        <img src="/Team Quest Logo-01.png" alt="TeamQuest Logo">
      </a>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link">üéØ Activities ‚ñº</a>
          <div class="nav-dropdown">
            <a class="dropdown-link" href="https://theteamquest.netlify.app/clue_hunt_challenge">üíé The Treasure Hunt</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/scavenger_hunt">üîç The Scavenger Hunt</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/kindness_challenge_page">‚ù§Ô∏è The Kindness Task</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/limerick_challenge_page">üìù The Limerick Challenge</a>
          </div>
        </li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_leaderboard">üèÜ The Leaderboard</a></li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_gallery">üì∏ The Gallery</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle">‚ò∞</button>
    </div>
  </nav>

  <div class="container">
    <!-- LOGIN -->
    <div class="login-section active" id="loginSection">
      <div class="logo">
        <div class="quiz-icon">üß†</div>
        <h1>The Quiz Challenge</h1>
        <p class="subtitle">10 riddles from Terry's archives! Prove your wit and claim doubloons!</p>
      </div>

      <div class="terry-greeting">
        <img src="/terry-thumbs-up.png" alt="Terry Quest" class="terry-image" />
        <div class="terry-note"><strong>Greetings, brave adventurers!</strong> Answer me riddles ten and riches shall be yours!</div>
      </div>

      <div class="instructions">
        <h3>üìú Challenge Rules</h3>
        <ul>
          <li>10 riddles ‚Äî 15 seconds each</li>
          <li>Some include audio ‚Äî check your volume</li>
          <li>Choose once ‚Äî no changes</li>
          <li>Up to 100 doubloons for perfection</li>
        </ul>
      </div>

      <form id="loginForm">
        <div class="form-group">
          <label for="teamSelect">Select Your Crew</label>
          <select id="teamSelect" required>
            <option value="">Choose your treasure hunting crew...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="teamPin">Enter Your Crew's Secret Code</label>
          <input id="teamPin" type="number" class="pin-input" min="1000" max="9999" placeholder="1234" required/>
        </div>

        <button type="submit" class="submit-btn">üè¥‚Äç‚ò†Ô∏è Begin the Knowledge Trial</button>
      </form>

      <div class="message" id="loginMessage"></div>
    </div>

    <!-- ALREADY STARTED -->
    <div class="already-started-section" id="alreadyStartedSection">
      <div class="team-info" id="alreadyStartedTeamInfo">Crew: Loading...</div>
      <div class="logo"><div class="quiz-icon">‚ö†Ô∏è</div><h1>Trial Already in Progress</h1></div>
      <div class="already-started-warning">
        <h3>üîí Knowledge Trial Locked</h3>
        <p><strong>This crew has already accepted the challenge!</strong></p>
        <p>The trial has been marked as attempted and cannot be retaken.</p>
        <p>Your crew's final score remains at <strong>0 doubloons</strong> for this challenge.</p>
      </div>
      <button class="submit-btn" onclick="window.location.href='/teamquest_leaderboard.html'">üó∫Ô∏è Return to Treasure Map</button>
    </div>

    <!-- READY -->
    <div class="ready-section" id="readySection">
      <div class="team-info" id="readyTeamInfo">Crew: Loading...</div>
      <div class="logo"><div class="quiz-icon">üß†</div><h1>Prepare for the Trial!</h1></div>
      <div class="ready-instructions">
        <h3>‚ö° Terry's Knowledge Trial</h3>
        <ul>
          <li><strong>10 riddles</strong>, <strong>15s each</strong></li>
          <li><strong>No turning back</strong> after answering</li>
          <li>Some riddles include <strong>audio clues</strong></li>
          <li>One attempt only</li>
        </ul>
        <div style="margin-top:25px;padding:15px;background:linear-gradient(135deg,#FFE4B5 0%,#DEB887 100%);border-radius:10px;color:#8B4513;border:2px solid #DAA520;">
          <strong>‚ö†Ô∏è Heads up:</strong> Once begun, there‚Äôs no restart.
        </div>
      </div>
      <button class="start-quiz-btn" onclick="acceptChallenge()">üöÄ Accept the challenge</button>
      <div class="message" id="readyMessage"></div>
    </div>

    <!-- QUIZ -->
    <div class="quiz-section" id="quizSection">
      <div class="team-info" id="teamInfo">Crew: Loading...</div>
      <div class="quiz-header">
        <div class="question-counter" id="questionCounter">Riddle 1 of 10</div>
        <div class="timer"><div class="timer-circle" id="timerCircle">15</div><div style="color:#8B4513;font-weight:bold">seconds</div></div>
      </div>
      <div class="question-card" id="questionCard"></div>
      <button class="submit-btn" id="nextBtn" style="display:none" onclick="nextQuestion()">Next Riddle ‚Üí</button>
    </div>

    <!-- RESULTS -->
    <div class="results-section" id="resultsSection">
      <div class="team-info" id="resultsTeamInfo">Crew: Loading...</div>
      <div class="results-summary">
        <h2>üéâ Trial Complete!</h2>
        <div class="final-score" id="finalScore">0/10</div>
        <p style="font-size:1.2em;color:#8B4513;margin-bottom:30px">Doubloons earned: <span id="doubloonsEarned" style="color:#FF8C00;font-weight:bold">0</span> ü™ô</p>
        <div class="terry-note"><strong>Well done!</strong> Your doubloons have been logged. Check the map to compare!</div>
        <div class="score-breakdown" id="scoreBreakdown"></div>
        <p style="color:#8B4513;margin-top:30px;">Return to the map to continue your quest!</p>
        <button class="submit-btn" onclick="window.location.href='/teamquest_leaderboard.html'">üó∫Ô∏è View Treasure Map</button>
      </div>
      <div class="loading" id="submitLoading">ü™ô Recording your doubloons in the treasure ledger...</div>
      <div class="message" id="submitMessage"></div>
    </div>
  </div>

  <script>
    /* NAV */
    document.addEventListener('DOMContentLoaded', () => {
      const navToggle = document.getElementById('nav-toggle');
      const navMenu = document.getElementById('nav-menu');
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', () => {
          navMenu.classList.toggle('active');
          navToggle.textContent = navMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
        });
        document.querySelectorAll('.nav-link, .dropdown-link').forEach(a=>{
          a.addEventListener('click',()=>{navMenu.classList.remove('active');navToggle.textContent='‚ò∞';});
        });
        document.addEventListener('click', e=>{
          const inside = navToggle.contains(e.target)||navMenu.contains(e.target);
          if(!inside && navMenu.classList.contains('active')){navMenu.classList.remove('active');navToggle.textContent='‚ò∞';}
        });
      }
      loadTeamsList();
    });

    /* STATE */
    let currentTeam=null, allTeams=[], currentQuestionIndex=0, timeLeft=15, timerInterval=null, userAnswers=[], quizStartTime=null;

    /* QUESTIONS */
    const quizQuestions = [
      {id:1,type:'multiple_choice',question:'What 3 letter animal makes this noise?',audioUrl:'/animal-sound',options:[{letter:'A',text:'Pig'},{letter:'B',text:'Cow'},{letter:'C',text:'Yak'},{letter:'D',text:'Elk'}],correctAnswer:'C',doubloons:10},
      {id:2,type:'multiple_choice',question:'What is the meaning of the word: Gambado?',options:[{letter:'A',text:'Colourful Hat'},{letter:'B',text:'Native of Gambia'},{letter:'C',text:'Prank'},{letter:'D',text:'Foolish bet'}],correctAnswer:'C',doubloons:10},
      {id:3,type:'multiple_choice',question:'Which UK island has its own railway, currency, and parliament, but is not part of the United Kingdom?',options:[{letter:'A',text:'Isle of Man'},{letter:'B',text:'Isle of Skye'},{letter:'C',text:'Isle of Wight'},{letter:'D',text:'Isles of Scilly'}],correctAnswer:'A',doubloons:10},
      {id:4,type:'multiple_choice',question:'Answer this riddle: What gets wetter the more it dries?',options:[{letter:'A',text:'___s_'},{letter:'B',text:'__w__'},{letter:'C',text:'___t'},{letter:'D',text:'_a__'}],correctAnswer:'B',explanation:'Answer: Towel',doubloons:10},
      {id:5,type:'text_input',question:'Name the one-word sport depicted in this image?',imageUrl:'/tennis-sport.png',correctAnswer:'tennis',acceptableAnswers:['tennis','Tennis','TENNIS'],doubloons:10},
      {id:6,type:'multiple_choice',question:'Who is this talking in this clip?',audioUrl:'/voice-clip.mp3',options:[{letter:'A',text:'Ed Sheeran'},{letter:'B',text:'Harry Styles'},{letter:'C',text:'Tom Holland'},{letter:'D',text:'Taron Egerton'}],correctAnswer:'C',doubloons:10},
      {id:7,type:'text_input',question:'What is the number of the only other month, after August (8), for Augustus, to be named after a mortal man?',correctAnswer:'7',acceptableAnswers:['7','seven','Seven','SEVEN','july','July','JULY','Jul','jul','JUL'],explanation:'Answer: 7 (July)',doubloons:10},
      {id:8,type:'text_input',question:'Which one-word car manufacturer uses this logo?',imageUrl:'/smart-logo.png',correctAnswer:'smart',acceptableAnswers:['smart','Smart','SMART','SmArt','sMaRt'],doubloons:10},
      {id:9,type:'multiple_choice',question:'Listen to this intro. Which band had a huge hit with this song?',audioUrl:'/song-intro.mp3',options:[{letter:'A',text:'Red Hot Chili Peppers'},{letter:'B',text:'The Killers'},{letter:'C',text:'The Foo Fighters'},{letter:'D',text:'Kings of Leon'}],correctAnswer:'B',doubloons:10},
      {id:10,type:'multiple_choice',question:'Five friends are waiting in line to get coffee... Who is at the front of the line?',options:[{letter:'A',text:'Ross'},{letter:'B',text:'Joey'},{letter:'C',text:'Chandler'},{letter:'D',text:'Monica'},{letter:'E',text:'Rachel'}],correctAnswer:'D',doubloons:10}
    ];

    /* LOGIN */
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const teamCode=document.getElementById('teamSelect').value;
      const pin=document.getElementById('teamPin').value;
      if(!teamCode){return showMessage('loginMessage','Please select your crew.','error');}
      if(!/^\d{4}$/.test(pin)){return showMessage('loginMessage','Please enter a valid 4-digit secret code.','error');}

      try{
        const status=await checkQuizStatus(teamCode);
        if(status.completed){return showMessage('loginMessage','This crew has already completed the trial.','error');}

        const valid=await verifyTeamAndPin(teamCode,pin);
        if(!valid){return showMessage('loginMessage','Incorrect secret code.','error');}

        currentTeam=allTeams.find(t=>t.teamCode===teamCode);
        if(status.started){showAlreadyStartedSection();} else {showReadyScreen();}
      }catch(err){
        showMessage('loginMessage','Error verifying crew. Please try again.','error');
      }
    });

    function showReadyScreen(){
      document.getElementById('readyTeamInfo').textContent='Crew: '+currentTeam.teamName;
      document.getElementById('loginSection').classList.remove('active');
      document.getElementById('readySection').classList.add('active');
    }
    function showAlreadyStartedSection(){
      document.getElementById('alreadyStartedTeamInfo').textContent='Crew: '+currentTeam.teamName;
      document.getElementById('loginSection').classList.remove('active');
      document.getElementById('alreadyStartedSection').classList.add('active');
    }

    /* >>> UPDATED <<< */
    async function acceptChallenge(){
      const btn = document.querySelector('.start-quiz-btn');
      btn.disabled = true;
      try{
        const res = await fetch('/.netlify/functions/start_quiz_function',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            teamCode: currentTeam.teamCode,
            teamName: currentTeam.teamName,
            quizStartTime: new Date().toISOString()
          })
        });

        const text = await res.text();
        let data = {};
        try{ data = JSON.parse(text||'{}'); }catch{}

        if(res.status === 409){
          // Already started ‚Äì route to lock screen
          showAlreadyStartedSection();
          return;
        }
        if(!res.ok || data.success !== true){
          throw new Error(data.error || `HTTP ${res.status} ${res.statusText}`);
        }
        // Start
        startQuizCountdown();
      }catch(err){
        showMessage('readyMessage', `Couldn't start the quiz. ${err.message}`, 'error');
      }finally{
        btn.disabled = false;
      }
    }

    function startQuizCountdown(){
      const readySection=document.getElementById('readySection');
      readySection.innerHTML = `
        <div class="team-info">Crew: ${currentTeam.teamName}</div>
        <div class="logo"><div class="quiz-icon">üß†</div><h1>Prepare Yourself!</h1></div>
        <div class="ready-countdown" id="countdownNumber">3</div>
        <div style="text-align:center;font-size:1.2em;color:#8B4513;">Trial begins in...</div>
      `;
      let c=3; const el=document.getElementById('countdownNumber');
      const iv=setInterval(()=>{c--; if(c>0){el.textContent=c;} else if(c===0){el.textContent='FORTH!';el.style.color='#32CD32';} else {clearInterval(iv); startQuiz();}},1000);
    }

    function startQuiz(){
      quizStartTime=new Date(); currentQuestionIndex=0; userAnswers=[];
      document.getElementById('teamInfo').textContent='Crew: '+currentTeam.teamName;
      document.getElementById('readySection').classList.remove('active');
      document.getElementById('quizSection').classList.add('active');
      showQuestion();
    }

    function showQuestion(){
      const q=quizQuestions[currentQuestionIndex]; const card=document.getElementById('questionCard');
      document.getElementById('questionCounter').textContent=`Riddle ${currentQuestionIndex+1} of ${quizQuestions.length}`;
      timeLeft=15; updateTimer(); startTimer();

      let html=`<div class="question-number">Riddle ${currentQuestionIndex+1}</div><div class="question-text">${q.question}</div>`;
      if(q.audioUrl){ html+=`<div class="audio-player"><div class="play-instruction">üéµ Listen to this mysterious clue:</div><audio controls preload="auto" id="questionAudio"><source src="${q.audioUrl}" type="audio/mpeg" />Your browser does not support the audio element.</audio></div>`; }
      if(q.imageUrl){ html+=`<img src="${q.imageUrl}" alt="" class="question-image"/>`; }
      if(q.type==='multiple_choice'){
        html+='<div class="options-grid">';
        q.options.forEach(o=>{ html+=`<div class="option" onclick="selectOption('${o.letter}', event)"><div class="option-letter">${o.letter}</div><div>${o.text}</div></div>`; });
        html+='</div>';
      }else{
        html+='<input type="text" class="text-input" id="textAnswer" placeholder="Type your answer here..." maxlength="50">';
      }
      card.innerHTML=html;
      const audio=document.getElementById('questionAudio'); if(audio){audio.play().catch(()=>{});}
    }

    function selectOption(letter, ev){
      document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
      ev.currentTarget.classList.add('selected');
      submitAnswer(letter);
    }

    function submitAnswer(ans){
      clearInterval(timerInterval);
      const q=quizQuestions[currentQuestionIndex];
      let correct=false;

      if(q.type==='multiple_choice'){ correct = (ans===q.correctAnswer); }
      else{ if(!ans){ ans=(document.getElementById('textAnswer')?.value||'').trim(); } correct = checkTextAnswer(ans,q); }

      userAnswers.push({questionId:q.id,userAnswer:ans,correctAnswer:q.correctAnswer,isCorrect:correct,doubloons:correct?q.doubloons:0,timeLeft});
      showAnswerFeedback(correct,q);

      setTimeout(()=>{ if(currentQuestionIndex<quizQuestions.length-1){ currentQuestionIndex++; showQuestion(); } else { finishQuiz(); } },2000);
    }

    function checkTextAnswer(user, q){
      if(!user||typeof user!=='string') return false;
      const norm = t=> t.toLowerCase().trim().replace(/[^\w\s]/g,'').replace(/\s+/g,'').replace(/\s/g,'');
      const u = norm(user);
      if(q.acceptableAnswers){ return q.acceptableAnswers.some(a=>norm(a)===u); }
      return norm(q.correctAnswer)===u;
    }

    function showAnswerFeedback(isCorrect,q){
      if(q.type==='multiple_choice'){
        document.querySelectorAll('.option').forEach(opt=>{
          const letter=opt.querySelector('.option-letter').textContent;
          if(letter===q.correctAnswer){opt.classList.add('correct');}
          else if(opt.classList.contains('selected') && !isCorrect){opt.classList.add('incorrect');}
          opt.style.pointerEvents='none';
        });
      }
      if(q.explanation){
        const card=document.getElementById('questionCard');
        card.innerHTML += `<div style="margin-top:20px;padding:15px;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-radius:10px;color:#8B4513;font-weight:bold;border:2px solid #DAA520;">${q.explanation}</div>`;
      }
    }

    function startTimer(){
      timerInterval=setInterval(()=>{timeLeft--;updateTimer(); if(timeLeft<=0){submitAnswer('');}},1000);
    }
    function updateTimer(){
      const el=document.getElementById('timerCircle'); el.textContent=timeLeft; el.classList.remove('warning','danger');
      if(timeLeft<=3){el.classList.add('danger');} else if(timeLeft<=5){el.classList.add('warning');}
      const deg=(timeLeft/15)*360;
      if(timeLeft<=3){el.style.background=`conic-gradient(#DC143C ${deg}deg,#FFB6C1 ${deg}deg)`;}
      else if(timeLeft<=5){el.style.background=`conic-gradient(#FF8C00 ${deg}deg,#FFE4B5 ${deg}deg)`;}
      else{el.style.background=`conic-gradient(#DAA520 ${deg}deg,#F5E6D3 ${deg}deg)`;}
    }

    function finishQuiz(){
      const correct=userAnswers.filter(a=>a.isCorrect).length;
      const total=userAnswers.reduce((s,a)=>s+a.doubloons,0);

      document.getElementById('quizSection').classList.remove('active');
      document.getElementById('resultsSection').classList.add('active');
      document.getElementById('resultsTeamInfo').textContent='Crew: '+currentTeam.teamName;
      document.getElementById('finalScore').textContent=`${correct}/${quizQuestions.length}`;
      document.getElementById('doubloonsEarned').textContent=total;

      let html='';
      userAnswers.forEach((a,i)=>{
        const q=quizQuestions[i];
        html+=`<div class="breakdown-item"><div>Riddle ${i+1}: ${q.question.substring(0,50)}...</div><div style="color:${a.isCorrect?'#32CD32':'#DC143C'};font-weight:bold;">${a.isCorrect?`‚úì +${a.doubloons} doubloons`:'‚úó 0 doubloons'}</div></div>`;
      });
      document.getElementById('scoreBreakdown').innerHTML=html;

      submitQuizResults(total,userAnswers);
    }

    async function submitQuizResults(totalDoubloons, answers){
      const loader=document.getElementById('submitLoading'); const msg=document.getElementById('submitMessage');
      loader.style.display='block';
      try{
        const payload={
          teamCode: currentTeam.teamCode,
          teamName: currentTeam.teamName,
          totalScore: totalDoubloons,
          questionsCorrect: answers.filter(a=>a.isCorrect).length,
          totalQuestions: quizQuestions.length,
          completionTime: new Date().toISOString(),
          quizStartTime: quizStartTime.toISOString(),
          answers
        };
        const res=await fetch('/.netlify/functions/submit_quiz_function',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok){throw new Error('HTTP '+res.status);}
        const json=await res.json();
        if(json.success){showMessage('submitMessage','üéâ Doubloons recorded!','success');}
        else{throw new Error(json.error||'Submission failed');}
      }catch(e){
        console.error(e);
        showMessage('submitMessage','Failed to record doubloons. Your score: '+totalDoubloons+' doubloons.','error');
      }finally{loader.style.display='none';}
    }

    document.addEventListener('keydown', e=>{
      if(e.key==='Enter' && document.getElementById('textAnswer')){
        const v=document.getElementById('textAnswer').value.trim();
        if(v){submitAnswer(v);}
      }
    });

    async function loadTeamsList(){
      try{
        const r=await fetch('/.netlify/functions/get_leaderboard');
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data=await r.json();
        if(data?.success && Array.isArray(data.teams)){ allTeams=data.teams; populateTeamDropdown(data.teams); }
        else throw new Error('Invalid response');
      }catch(e){
        console.error('load teams',e);
        showMessage('loginMessage','Unable to load crew list. Please refresh.','error');
      }
    }
    function populateTeamDropdown(teams){
      const sel=document.getElementById('teamSelect'); sel.innerHTML='<option value="">Choose your treasure hunting crew...</option>';
      teams.sort((a,b)=>a.teamName.localeCompare(b.teamName)).forEach(t=>{
        const o=document.createElement('option'); o.value=t.teamCode; o.textContent=t.teamName; sel.appendChild(o);
      });
    }

    async function verifyTeamAndPin(teamCode,pin){
      try{
        const r=await fetch('/.netlify/functions/verify_team_pin_function',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({teamCode,pin})});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j=await r.json();
        return !!j.success && !!j.valid;
      }catch{ return false; }
    }

    function showMessage(id,text,type){
      const el=document.getElementById(id); el.textContent=text; el.className='message '+(type==='error'?'error-message':'success-message'); el.style.display='block';
    }

    async function checkQuizStatus(teamCode){
      try{
        const r=await fetch('/.netlify/functions/check_quiz_status_function',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({teamCode})});
        if(!r.ok) return {started:false,completed:false};
        const j=await r.json();
        return {started:!!j.started,completed:!!j.completed};
      }catch{ return {started:false,completed:false}; }
    }
  </script>
</body>
</html>
