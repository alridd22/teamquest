<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta name="theme-color" content="#2A1F18"/>
  <title>TeamQuest ‚Äì The Quiz Challenge</title>

  <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:url("/TQ%20Web%20extended%20background-100.jpg");
      --ink:#2E2114; --ink-soft:#6A5A47;
      --parchment:#F7EED8; --parchment-2:#F3E6CF;
      --gold:#F0C433; --gold-deep:#A7711F;
      --nav-h:64px; --gutter:22px; --hero-h:280px;
      --radius-card:22px; --shadow-card:0 18px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:"Handlee",ui-rounded,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,rgba(0,0,0,.24),rgba(0,0,0,.45)),var(--bg);
      background-size:cover;background-position:top center;background-attachment:fixed;
      padding-top:var(--nav-h);
    }

    /* NAV */
    .treasure-nav{position:fixed;inset:0 0 auto 0;height:var(--nav-h);z-index:1000;
      backdrop-filter:saturate(120%) blur(6px);
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.15));
      border-bottom:1px solid rgba(255,255,255,.18)}
    .nav-container{max-width:1000px;margin:0 auto;height:100%;display:flex;align-items:center;justify-content:space-between;padding:0 12px}
    .nav-logo img{height:40px;width:auto;display:block;filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}
    .nav-toggle{background:none;border:none;color:#F7EED8;font-size:1.6rem;cursor:pointer}
    .nav-menu{position:fixed;top:var(--nav-h);left:-100%;width:100%;height:calc(100vh - var(--nav-h));
      background:linear-gradient(180deg,rgba(0,0,0,.8),rgba(0,0,0,.75));
      display:flex;flex-direction:column;align-items:center;gap:14px;padding:18px 14px;transition:left .25s}
    .nav-menu.active{left:0}
    .nav-link,.dropdown-link{display:block;width:92%;max-width:360px;text-align:center;
      text-decoration:none;color:#F7EED8;font-weight:900;padding:12px 14px;border-radius:14px;
      background:rgba(247,238,216,.22);border:1px solid rgba(255,255,255,.28)}
    .nav-link:hover,.dropdown-link:hover{background:rgba(247,238,216,.3)}

    /* HERO */
    .hero{min-height:var(--hero-h);display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:24px var(--gutter) 20px;text-align:center}
    .brand-logo{width:min(240px,68vw);height:auto;margin-bottom:10px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 10px 24px rgba(0,0,0,.35))}
    .hero-title{font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;font-weight:900;font-size:22px;color:#F7EED8;text-shadow:0 2px 6px rgba(0,0,0,.6)}

    /* LAYOUT */
    .wrap{max-width:900px;margin:0 auto;padding:0 var(--gutter) 28px}
    .card{background:var(--parchment);border-radius:var(--radius-card);box-shadow:var(--shadow-card);padding:18px 16px;border:1px solid rgba(0,0,0,.06);margin:0 auto 18px}
    h1{margin:0 0 8px;text-align:center;font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;font-weight:900;color:var(--ink)}

    .rules{border:2px solid var(--gold-deep);border-radius:14px;padding:16px;background:#fff9ee;margin:12px 0}
    label{display:block;font-weight:800;color:var(--ink);margin:8px 6px 6px}
    select,input[type="text"]{width:100%;padding:14px;border:3px solid var(--gold);border-radius:16px;font-size:16px;background:#fff}
    .btn{width:100%;padding:16px;border:3px solid var(--gold-deep);border-radius:14px;background:linear-gradient(90deg,#FDBA2D,#F0C433);color:#442812;font-weight:900;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.2)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .msg{margin-top:12px;border:2px solid;border-radius:11px;padding:12px;display:none;text-align:center}
    .msg.error{display:block;background:#ffd6db;border-color:#d22;color:#8b0000}
    .msg.ok{display:block;background:#ddffe3;border-color:#1e8f3e;color:#0c5e24}
    .section{display:none}.section.active{display:block}
    .team-pill{background:#D7C39B;border:3px dashed rgba(0,0,0,.6);border-radius:14px;padding:10px 14px;margin-bottom:12px;text-align:center;font-weight:900}

    .quiz-head{display:flex;justify-content:space-between;gap:16px;align-items:center;border:2px solid var(--gold-deep);background:#fff9ee;border-radius:14px;padding:14px;margin-bottom:14px}
    .timer{width:60px;height:60px;border-radius:50%;border:3px solid #8B4513;display:flex;align-items:center;justify-content:center;font-weight:800;color:#8B4513;background:conic-gradient(#F0C433 0deg,#F7EED8 0deg)}
    .qcard{border:3px solid var(--gold);background:#fff;border-radius:18px;padding:18px}
    .opt{border:3px solid var(--gold);border-radius:14px;padding:14px;background:#fff9ee;cursor:pointer;margin-top:10px}
    .opt:hover{background:#ffeec9}
    .opt.sel{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border-color:#8B4513}
    .opt.good{background:linear-gradient(135deg,#29c74a,#17983a);color:#fff;border-color:#0b6f27}
    .opt.bad{background:linear-gradient(135deg,#d11,#a00909);color:#fff;border-color:#6b0000}
    .textAnswer{width:100%;padding:14px;border:3px solid var(--gold);border-radius:12px;font-size:18px;background:#fff}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo" aria-label="TeamQuest Home">
        <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest Logo">
      </a>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle menu">‚ò∞</button>
    </div>
    <ul class="nav-menu" id="nav-menu" role="menu">
      <!-- All but the current page (Quiz) -->
      <li><a href="https://theteamquest.netlify.app/clue_hunt" class="nav-link" role="menuitem">üíé The Treasure Hunt</a></li>
      <li><a href="https://theteamquest.netlify.app/scavenger" class="nav-link" role="menuitem">üîç The Scavenger Hunt</a></li>
      <li><a href="https://theteamquest.netlify.app/limerick" class="nav-link" role="menuitem">üìù The Limerick Challenge</a></li>
      <li><a href="/kindness" class="nav-link" role="menuitem">üíñ Kindness</a></li>
      <li><a href="https://theteamquest.netlify.app/leaderboard" class="dropdown-link" role="menuitem">üèÜ The Leaderboard</a></li>
      <li><a href="https://theteamquest.netlify.app/gallery" class="dropdown-link" role="menuitem">üì∏ The Gallery</a></li>
    </ul>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest" class="brand-logo" width="640" height="480">
    <div class="hero-title">The Quiz Challenge</div>
  </header>

  <div class="wrap">
    <!-- SIGN IN -->
    <section id="secSign" class="card section active">
      <div class="rules">
        <ul style="line-height:1.6;margin:0">
          <li>10 riddles ‚Äî 15 seconds each</li>
          <li>Some include audio ‚Äî check volume</li>
          <li>Choose once ‚Äî no changes</li>
          <li>Up to 100 doubloons for perfection</li>
        </ul>
      </div>

      <div class="row">
        <label for="teamSelect">Select Your Crew</label>
        <select id="teamSelect" class="field">
          <option value="">Choose your treasure hunting crew‚Ä¶</option>
        </select>
      </div>

      <div class="row">
        <label for="teamPin">Enter Your Crew‚Äôs Secret Code</label>
        <input id="teamPin" class="field" type="text" inputmode="numeric" autocomplete="one-time-code" placeholder="1234" pattern="^\\d{4}$" maxlength="4"/>
      </div>

      <button class="btn" id="btnSign">üß≠ Begin the Knowledge Trial</button>
      <div id="signMsg" class="msg"></div>
    </section>

    <!-- READY -->
    <section id="secReady" class="card section">
      <div class="team-pill" id="readyTeam">Crew: ‚Ä¶</div>
      <div class="rules">
        <strong>‚ö° You‚Äôre good to go!</strong>
        <ul style="margin-top:10px;line-height:1.6">
          <li>15 seconds per riddle</li>
          <li>No going back</li>
          <li>Volume up for audio prompts</li>
        </ul>
      </div>
      <button class="btn" id="btnAccept">üöÄ Accept the challenge</button>
      <div id="readyMsg" class="msg"></div>
    </section>

    <!-- QUIZ -->
    <section id="secQuiz" class="card section">
      <div class="team-pill" id="quizTeam">Crew: ‚Ä¶</div>
      <div class="quiz-head">
        <div id="qCount">Riddle 1 of 10</div>
        <div class="timer" id="timer">15</div>
      </div>
      <div class="qcard" id="qcard"></div>
    </section>

    <!-- RESULTS -->
    <section id="secDone" class="card section">
      <div class="team-pill" id="doneTeam">Crew: ‚Ä¶</div>
      <div class="qcard">
        <h1 style="font-size:22px;margin-bottom:8px">üéâ Trial Complete!</h1>
        <p id="scoreLine" style="margin-bottom:14px;font-weight:900;color:#8B4513"></p>
        <div id="breakdown"></div>
        <div id="submitMsg" class="msg" style="margin-top:14px"></div>
        <button class="btn" onclick="location.href='/leaderboard'">üèÜ View Leaderboard</button>
      </div>
    </section>
  </div>

  <script>
    // NAV toggle
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu');
    navToggle?.addEventListener('click',()=>{ navMenu.classList.toggle('active'); navToggle.textContent = navMenu.classList.contains('active') ? '‚úï' : '‚ò∞'; });
    document.addEventListener('click',e=>{
      const inside = navToggle.contains(e.target)||navMenu.contains(e.target);
      if(!inside && navMenu.classList.contains('active')){ navMenu.classList.remove('active'); navToggle.textContent='‚ò∞'; }
    });
    document.querySelectorAll('.nav-link,.dropdown-link').forEach(a=>a.addEventListener('click',()=>{ navMenu.classList.remove('active'); navToggle.textContent='‚ò∞'; }));

    // ====== constants / helpers ======
    const EVENT_ID = new URLSearchParams(location.search).get('event') || '';
    const $ = (id) => document.getElementById(id);
    const teamSelect = $('teamSelect'), teamPin = $('teamPin');
    const signMsg = $('signMsg'), readyMsg = $('readyMsg'), submitMsg = $('submitMsg');

    function setMsg(el, text, type){ el.textContent = text; el.className = 'msg ' + (type==='error' ? 'error' : 'ok'); el.style.display = 'block'; }
    function clearMsg(el){ el.textContent=''; el.className='msg'; el.style.display='none'; }

    async function callFn(name, payload = {}, method='POST'){
      const url = '/.netlify/functions/'+name + (method==='GET' ? ('?'+new URLSearchParams(payload)) : '');
      const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: method==='GET'?undefined:JSON.stringify(payload) });
      let data = {}; try{ data = await res.json(); }catch{}
      if(!res.ok) throw new Error((data && (data.error||data.message)) || ('HTTP '+res.status));
      return data;
    }

    // ====== TEAM LOADING ======
    function extractTeams(data){
      if(Array.isArray(data?.teams)) return data.teams;
      if(Array.isArray(data?.leaderboard)){
        return data.leaderboard.map(r=>({teamCode:r.teamCode||r.code||r.teamId||'',teamName:r.teamName||r.name||''})).filter(t=>t.teamName);
      }
      if(Array.isArray(data?.rows)){
        return data.rows.map(r=>({teamCode:r.teamCode||r.code||'',teamName:r.teamName||r.name||''})).filter(t=>t.teamName);
      }
      return [];
    }
    async function loadTeams(){
      try{
        let data = await callFn('get_leaderboard',{eventId:EVENT_ID});
        let teams = extractTeams(data);
        if(!teams.length){
          const r = await fetch('/.netlify/functions/get_leaderboard?eventId='+encodeURIComponent(EVENT_ID));
          if(r.ok){ data = await r.json(); teams = extractTeams(data); }
        }
        if(!teams.length) throw new Error('No teams');
        teams.sort((a,b)=>a.teamName.localeCompare(b.teamName));
        teamSelect.innerHTML = '<option value="">Choose your treasure hunting crew‚Ä¶</option>' + teams.map(t=>`<option value="${t.teamCode}">${t.teamName}</option>`).join('');
      }catch(e){ setMsg(signMsg,'Unable to load crew list. Please refresh.','error'); }
    }

    // ====== SIGN-IN ======
    async function signin(){
      clearMsg(signMsg);
      const code = teamSelect.value;
      const pin = (teamPin.value||'').trim();
      if(!code) return setMsg(signMsg,'Pick your crew from the list.','error');
      if(!/^\d{4}$/.test(pin)) return setMsg(signMsg,'Enter your 4-digit PIN.','error');
      try{
        const res = await callFn('verify_team_pin_function',{eventId:EVENT_ID,teamCode:code,pin});
        if(!res.success || !res.valid) return setMsg(signMsg,'That PIN doesn‚Äôt match this crew.','error');
        localStorage.setItem('teamToken', res.token);
        localStorage.setItem('teamCode', code);
        localStorage.setItem('teamName', res.teamName || teamSelect.options[teamSelect.selectedIndex]?.textContent || '');
        setMsg(signMsg,'Signed in. You can start the quiz!','ok');
        $('readyTeam').textContent = 'Crew: ' + (localStorage.getItem('teamName') || 'Unknown');
        $('secSign').classList.remove('active'); $('secReady').classList.add('active');
      }catch(err){
        setMsg(signMsg,((''+err.message).includes('404'))?'Sign-in service is off. Ask the host to enable verify_team_pin_function.':(err.message||'Could not sign you in. Try again.'),'error');
      }
    }
    $('btnSign').addEventListener('click',signin);

    // ====== QUIZ ======
    const quizQuestions = [
      { id:1,type:'multiple_choice',question:'What 3 letter animal makes this noise?',audioUrl:'/animal-sound',options:[
        {letter:'A',text:'Pig'},{letter:'B',text:'Cow'},{letter:'C',text:'Yak'},{letter:'D',text:'Elk'}],correctAnswer:'C',doubloons:10 },
      { id:2,type:'multiple_choice',question:'What is the meaning of the word: Gambado?',options:[
        {letter:'A',text:'Colourful Hat'},{letter:'B',text:'Native of Gambia'},{letter:'C',text:'Prank'},{letter:'D',text:'Foolish bet'}],correctAnswer:'C',doubloons:10 },
      { id:3,type:'multiple_choice',question:'Which UK island has its own railway, currency, and parliament, but is not part of the United Kingdom?',options:[
        {letter:'A',text:'Isle of Man'},{letter:'B',text:'Isle of Skye'},{letter:'C',text:'Isle of Wight'},{letter:'D',text:'Isles of Scilly'}],correctAnswer:'A',doubloons:10 },
      { id:4,type:'multiple_choice',question:'Answer this riddle: What gets wetter the more it dries?',options:[
        {letter:'A',text:'___s_'},{letter:'B',text:'__w__'},{letter:'C',text:'___t'},{letter:'D',text:'_a__'}],correctAnswer:'B',explanation:'Answer: Towel',doubloons:10 },
      { id:5,type:'text_input',question:'Name the one-word sport depicted in this image?',imageUrl:'/tennis-sport.png',
        correctAnswer:'tennis',acceptableAnswers:['tennis','Tennis','TENNIS'],doubloons:10 },
      { id:6,type:'multiple_choice',question:'Who is this talking in this clip?',audioUrl:'/voice-clip.mp3',options:[
        {letter:'A',text:'Ed Sheeran'},{letter:'B',text:'Harry Styles'},{letter:'C',text:'Tom Holland'},{letter:'D',text:'Taron Egerton'}],correctAnswer:'C',doubloons:10 },
      { id:7,type:'text_input',question:'What is the number of the only other month, after August (8), named after a mortal man?',
        correctAnswer:'7',acceptableAnswers:['7','seven','Seven','SEVEN','july','July','JULY','Jul','jul','JUL'],explanation:'Answer: 7 (July)',doubloons:10 },
      { id:8,type:'text_input',question:'Which one-word car manufacturer uses this logo?',imageUrl:'/smart-logo.png',
        correctAnswer:'smart',acceptableAnswers:['smart','Smart','SMART','SmArt','sMaRt'],doubloons:10 },
      { id:9,type:'multiple_choice',question:'Listen to this intro. Which band had a huge hit with this song?',audioUrl:'/song-intro.mp3',options:[
        {letter:'A',text:'Red Hot Chili Peppers'},{letter:'B',text:'The Killers'},{letter:'C',text:'The Foo Fighters'},{letter:'D',text:'Kings of Leon'}],correctAnswer:'B',doubloons:10 },
      { id:10,type:'multiple_choice',question:'Five friends are waiting in line to get coffee‚Ä¶ Who is at the front of the line?',options:[
        {letter:'A',text:'Ross'},{letter:'B',text:'Joey'},{letter:'C',text:'Chandler'},{letter:'D',text:'Monica'},{letter:'E',text:'Rachel'}],correctAnswer:'D',doubloons:10 }
    ];

    let currentTeam = { code:'', name:'' };
    let qIndex = 0, timeLeft = 15, timerId = null;
    const answers = [];

    $('btnAccept').addEventListener('click', startQuizFlow);

    async function startQuizFlow(){
      clearMsg(readyMsg);
      try{
        await callFn('start_quiz_function',{
          eventId: EVENT_ID, teamCode: localStorage.getItem('teamCode'),
          teamName: localStorage.getItem('teamName'),
          quizStartTime: new Date().toISOString()
        });
        $('quizTeam').textContent = 'Crew: ' + (localStorage.getItem('teamName')||'');
        $('secReady').classList.remove('active'); $('secQuiz').classList.add('active');
        currentTeam = { code: localStorage.getItem('teamCode'), name: localStorage.getItem('teamName') };
        qIndex = 0; answers.length = 0; showQuestion();
      }catch(e){ setMsg(readyMsg,'Couldn‚Äôt start the quiz. Please try again. ('+(e.message||'error')+')','error'); }
    }

    function showQuestion(){
      const q = quizQuestions[qIndex];
      $('qCount').textContent = `Riddle ${qIndex+1} of ${quizQuestions.length}`;
      timeLeft = 15; updateTimer(); startTimer();

      let html = `<div style="font-weight:900;color:#654321;margin-bottom:12px">${q.question}</div>`;
      if(q.audioUrl){
        html += `<audio id="qAud" controls preload="auto" style="width:100%;margin:12px 0">
                  <source src="${q.audioUrl}" type="audio/mpeg">
                </audio>`;
      }
      if(q.imageUrl) html += `<img src="${q.imageUrl}" alt="" style="max-width:100%;border-radius:12px;border:3px solid #DAA520;margin:12px 0">`;

      if(q.type==='multiple_choice'){
        q.options.forEach(o=>{ html += `<div class="opt" data-letter="${o.letter}"><strong>${o.letter}.</strong> ${o.text}</div>`; });
      }else{
        html += `<input id="textAns" class="textAnswer" placeholder="Type your answer‚Ä¶" maxlength="50">`;
        html += `<button class="btn" style="margin-top:12px" onclick="submitAnswer()">Submit</button>`;
      }
      $('qcard').innerHTML = html;

      document.querySelectorAll('.opt').forEach(el=>{
        el.addEventListener('click',()=>{
          document.querySelectorAll('.opt').forEach(x=>x.classList.remove('sel'));
          el.classList.add('sel'); submitAnswer(el.dataset.letter);
        });
      });
      $('qAud')?.play().catch(()=>{});
    }

    function startTimer(){
      clearInterval(timerId);
      timerId = setInterval(()=>{ timeLeft--; updateTimer(); if(timeLeft<=0){ submitAnswer(''); } },1000);
    }
    function updateTimer(){
      $('timer').textContent = timeLeft;
      const pct = (timeLeft/15)*360;
      $('timer').style.background = `conic-gradient(${timeLeft<=3?'#DC143C':timeLeft<=5?'#FF8C00':'#F0C433'} ${pct}deg, #F7EED8 ${pct}deg)`;
    }
    function normalize(s){ return (s||'').toLowerCase().trim().replace(/[^\w\s]/g,'').replace(/\s+/g,''); }

    function submitAnswer(choice){
      clearInterval(timerId);
      const q = quizQuestions[qIndex];
      let correct = false;

      if(q.type==='multiple_choice'){
        correct = (choice === q.correctAnswer);
        document.querySelectorAll('.opt').forEach(el=>{
          const lett = el.dataset.letter;
          if(lett===q.correctAnswer) el.classList.add('good');
          else if(el.classList.contains('sel') && !correct) el.classList.add('bad');
          el.style.pointerEvents='none';
        });
      }else{
        const user = normalize($('textAns')?.value || '');
        if(q.acceptableAnswers?.length) correct = q.acceptableAnswers.some(a=>normalize(a)===user);
        else correct = normalize(q.correctAnswer)===user;
      }

      answers.push({
        questionId:q.id, userAnswer: choice || ($('textAns')?.value || ''),
        correctAnswer:q.correctAnswer, isCorrect:correct, doubloons:correct?q.doubloons:0, timeLeft
      });

      if(q.explanation){
        $('qcard').insertAdjacentHTML('beforeend',
          `<div style="margin-top:12px;padding:10px;border:2px solid #DAA520;border-radius:10px;background:#fff9ee;font-weight:700">${q.explanation}</div>`);
      }

      setTimeout(()=>{ (qIndex < quizQuestions.length-1) ? (qIndex++,showQuestion()) : finishQuiz(); }, 1400);
    }
    window.submitAnswer = submitAnswer;

    async function finishQuiz(){
      $('secQuiz').classList.remove('active');
      $('doneTeam').textContent = 'Crew: ' + (currentTeam.name || '');
      $('secDone').classList.add('active');

      const correct = answers.filter(a=>a.isCorrect).length;
      const doubloons = answers.reduce((s,a)=>s+a.doubloons,0);
      $('scoreLine').textContent = `Score: ${correct}/${quizQuestions.length} ‚Äî Doubloons earned: ${doubloons}`;

      $('breakdown').innerHTML = answers.map((a,i)=>{
        const q = quizQuestions[i];
        return `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #DAA520;padding:8px 0">
                  <div>Riddle ${i+1}: ${q.question.slice(0,60)}‚Ä¶</div>
                  <div style="font-weight:900;color:${a.isCorrect?'#1e8f3e':'#b00020'}">${a.isCorrect?'‚úì +'+a.doubloons:'‚úó 0'}</div>
                </div>`;
      }).join('');

      clearMsg(submitMsg);
      try{
        await callFn('submit_quiz_function',{
          eventId:EVENT_ID, teamCode:currentTeam.code, teamName:currentTeam.name,
          totalScore:doubloons, questionsCorrect:correct, totalQuestions:quizQuestions.length,
          completionTime:new Date().toISOString(), answers
        });
        setMsg(submitMsg,'üéâ Doubloons successfully added to your treasure chest!','ok');
      }catch(e){ setMsg(submitMsg,'Couldn‚Äôt record doubloons. (Saved locally.)','error'); }
    }

    // boot
    loadTeams();
    teamPin.addEventListener('keydown', e=>{ if(e.key==='Enter') $('btnSign').click(); });
  </script>
</body>
</html>
