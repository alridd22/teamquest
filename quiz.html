<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>TeamQuest ‚Äì The Quiz Challenge</title>

<link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet"/>

<style>
  :root{
    --bg:url("/TQ%20Web%20extended%20background-100.jpg");
    --ink:#2E2114; --ink-soft:#6A5A47;
    --parchment:#F7EED8; --parchment-2:#F3E6CF; --cream:#FBF3E1;
    --gold:#F0C433; --amber:#FFB62E; --accent:#1594d2;
    --ok:#1F6E38; --okbg:#CFF2DA; --err:#B42318; --errbg:#FFD9DE;
    --brown:#8B4513; --brown-2:#5b3512; --green:#2ba05f;
    --radius-card:22px; --radius-input:16px;
    --shadow-card:0 18px 40px rgba(0,0,0,.35);
    --shadow-soft:0 8px 18px rgba(0,0,0,.18);
    --gutter:22px; --nav-h:64px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Handlee", ui-rounded, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    background:linear-gradient(180deg,rgba(0,0,0,.24),rgba(0,0,0,.45)),var(--bg);
    background-size:cover;background-position:top center;background-attachment:fixed;
    -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    padding-top:var(--nav-h);
  }

  /* NAV */
  .treasure-nav{position:fixed;inset:0 0 auto 0;height:var(--nav-h);z-index:1000;
    backdrop-filter:saturate(120%) blur(6px);
    background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.15));
    border-bottom:1px solid rgba(255,255,255,.18)}
  .nav-container{height:100%;max-width:1000px;margin:0 auto;padding:0 12px;display:flex;align-items:center;justify-content:space-between}
  .nav-logo img{height:40px;display:block;filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}
  .nav-toggle{background:none;border:none;color:#F7EED8;font-size:1.6rem;cursor:pointer}
  .nav-menu{position:fixed;top:var(--nav-h);left:-100%;width:100%;height:calc(100vh - var(--nav-h));
    background:linear-gradient(180deg,rgba(0,0,0,.85),rgba(0,0,0,.72));
    display:flex;flex-direction:column;align-items:center;gap:14px;padding:18px 14px;transition:left .25s}
  .nav-menu.active{left:0}
  .nav-link,.dropdown-link{display:block;width:92%;max-width:360px;text-align:center;text-decoration:none;color:#F7EED8;font-weight:900;padding:12px 14px;border-radius:14px;background:rgba(247,238,216,.22);border:1px solid rgba(255,255,255,.28)}
  .nav-link:hover,.dropdown-link:hover{background:rgba(247,238,216,.32)}

  /* HERO */
  .hero{min-height:220px;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:24px var(--gutter) 18px;text-align:center}
  .brand-logo{width:min(240px,68vw);height:auto;margin-bottom:10px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 10px 24px rgba(0,0,0,.35))}
  .hero-title{font-family:"Handlee";font-weight:900;font-size:24px;color:#F7EED8;text-shadow:0 2px 6px rgba(0,0,0,.6)}

  /* LAYOUT */
  .stack{padding:0 var(--gutter) 28px}
  .card{background:linear-gradient(145deg,var(--parchment),var(--parchment-2));border-radius:var(--radius-card);box-shadow:var(--shadow-card);padding:18px 16px;border:1px solid rgba(0,0,0,.06);max-width:980px;margin:0 auto 18px}
  .title{margin:0 0 10px;font-size:22px;color:#402a12}

  /* Inputs/select */
  label{display:block;margin:10px 0 6px;font-weight:900}
  .input,.tq-select{
    width:100%;padding:14px;border:3px solid var(--gold);border-radius:16px;background:#fff;font-size:18px;
    font-family:"Handlee",ui-rounded,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--ink);-webkit-text-fill-color:var(--ink)
  }
  .tq-select{
    -webkit-appearance:none;-moz-appearance:none;appearance:none;padding-right:44px;
    background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M6 9l6 6 6-6' fill='none' stroke='%233b2d16' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
    background-repeat:no-repeat;background-position:right 12px center;background-size:18px 18px;
  }
  .tq-select:required:invalid{color:rgba(0,0,0,.5);-webkit-text-fill-color:rgba(0,0,0,.5)}
  .pin{text-align:center;letter-spacing:3px}
  .btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:16px;border-radius:16px;border:2px solid var(--brown-2);
    background:linear-gradient(135deg,#FF8C00,#DAA520);color:#442812;font-weight:900;cursor:pointer;box-shadow:var(--shadow-soft);font-size:20px}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .msg{display:none;margin-top:12px;padding:12px;border-radius:12px;border:2px solid;font-weight:800}
  .msg.ok{display:block;background:var(--okbg);border-color:var(--ok);color:#064b06}
  .msg.err{display:block;background:var(--errbg);border-color:var(--err);color:#8B0000}

  /* Rules block (mockup) */
  .rules{background:#fff7e7;border-radius:18px;border:1px solid rgba(0,0,0,.06);padding:16px}
  .rule{background:#f2e4c8;border:2px solid #e4c27a;border-radius:14px;padding:14px 16px;margin:10px 0;font-weight:700}

  /* QUIZ UI */
  .q-card{background:linear-gradient(145deg,#FFF5DE,#F2E6CF);border-radius:18px;border:1px solid rgba(0,0,0,.08);padding:16px}
  .q-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .timer{font-weight:900;background:#fff;border:2px dashed #d6ad5f;border-radius:999px;padding:6px 12px}
  .q-text{font-size:22px;font-weight:900;margin:6px 0 10px;color:#402a12}
  .choices{display:grid;gap:10px}
  .choice{padding:14px;border-radius:14px;border:3px solid #cfa44d;background:#fff;cursor:pointer;font-weight:900}
  .choice:hover{box-shadow:0 6px 18px rgba(0,0,0,.1)}
  .choice.lock{cursor:not-allowed;opacity:.8}
  .choice.correct{border-color:#2ba05f;background:#e9f9ef}
  .choice.wrong{border-color:#c6463b;background:#ffe9ec}
  .nextRow{display:flex;justify-content:center;margin-top:12px}
  .muted{opacity:.75}

  .center{display:flex;justify-content:center}
</style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo" aria-label="TeamQuest Home">
        <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest Logo">
      </a>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle menu">‚ò∞</button>
    </div>
    <ul class="nav-menu" id="nav-menu" role="menu">
      <li><a href="https://theteamquest.netlify.app/clue_hunt" class="nav-link" role="menuitem">üíé The Treasure Hunt</a></li>
      <li><a href="https://theteamquest.netlify.app/scavenger" class="nav-link" role="menuitem">üß≠ The Scavenger Hunt</a></li>
      <li><a href="https://theteamquest.netlify.app/limerick" class="nav-link" role="menuitem">üìù The Limerick Challenge</a></li>
      <li><a href="https://theteamquest.netlify.app/kindness" class="nav-link" role="menuitem">üíñ Kindness</a></li>
      <li><a href="https://theteamquest.netlify.app/leaderboard" class="dropdown-link" role="menuitem">üèÜ The Leaderboard</a></li>
      <li><a href="https://theteamquest.netlify.app/gallery" class="dropdown-link" role="menuitem">üì∏ The Gallery</a></li>
    </ul>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest" class="brand-logo" width="640" height="480">
    <div class="hero-title">The Quiz Challenge</div>
  </header>

  <main class="stack">
    <!-- Sign-in only -->
    <section class="card" id="secSign">
      <h2 class="title">Sign in</h2>

      <label for="teamSelect">Crew Name</label>
      <select id="teamSelect" class="tq-select" required>
        <option value="" disabled selected>Loading crews‚Ä¶</option>
      </select>

      <label for="teamPin">Crew Pin</label>
      <input id="teamPin" class="input pin" inputmode="numeric" maxlength="4" pattern="\\d{4}" placeholder="1234">
      <div style="height:10px"></div>
      <button class="btn" id="btnSign">Sign In</button>
      <div id="signMsg" class="msg" role="status" aria-live="polite"></div>
    </section>

    <!-- Rules + Accept (after sign-in) -->
    <section class="card" id="secRules" style="display:none">
      <div class="center"><div class="msg ok" style="display:block;margin:0">‚úÖ Signed in. You can submit now!</div></div>
      <div style="height:12px"></div>

      <div class="center"><div id="crewPill" class="input" style="max-width:520px;text-align:center;background:#e8d7b1;border-style:dashed">Shamalam</div></div>

      <div style="height:14px"></div>
      <div class="rules">
        <h3 class="title" style="text-align:center;margin-top:0">Get ready‚Ä¶</h3>
        <div class="rule">‚Ä¢ 10 questions ‚Äì 15 seconds each</div>
        <div class="rule">‚Ä¢ Some include audio ‚Äì make sure your volume is up!</div>
        <div class="rule">‚Ä¢ Choose once ‚Äì no changes</div>
        <div class="rule">‚Ä¢ Up to 100 points for perfection</div>
      </div>

      <div class="center" style="margin-top:18px">
        <button class="btn" id="btnAccept">Accept the challenge</button>
      </div>
    </section>

    <!-- Quiz -->
    <section class="card" id="secQuiz" style="display:none">
      <div class="q-card">
        <div class="q-top">
          <div id="qCounter" class="title" style="margin:0">Question 1 / 10</div>
          <div class="timer" id="timer">15s</div>
        </div>

        <div id="qMedia" style="margin:6px 0 4px"></div>
        <div class="q-text" id="qText">‚Ä¶</div>

        <div class="choices" id="choices"></div>

        <div class="nextRow">
          <button class="btn" id="btnNext" disabled>Next question</button>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="card" id="secDone" style="display:none">
      <h2 class="title" style="text-align:center">Quiz complete!</h2>
      <div class="center"><div class="input" id="scoreLine" style="max-width:460px;text-align:center;background:#e9f9ef;border-color:#2ba05f">Score: 0 / 100</div></div>
      <div class="center" style="margin-top:14px">
        <a class="btn" href="leaderboard">See the leaderboard</a>
      </div>
    </section>
  </main>

  <script>
    /* ===================== Nav + persist ?event ===================== */
    (function(){
      const navToggle=document.getElementById('nav-toggle'); const navMenu=document.getElementById('nav-menu');
      navToggle?.addEventListener('click',()=>{navMenu.classList.toggle('active');navToggle.textContent=navMenu.classList.contains('active')?'‚úï':'‚ò∞';});
      document.addEventListener('click',e=>{const inside=navToggle?.contains(e.target)||navMenu?.contains(e.target); if(!inside&&navMenu?.classList.contains('active')){navMenu.classList.remove('active'); navToggle.textContent='‚ò∞';}});
      const qs=new URLSearchParams(location.search); const EVENT=qs.get('event')||qs.get('eventId')||'';
      if(EVENT){
        const paths=['/clue_hunt','/scavenger','/quiz','/limerick','/kindness','/leaderboard','/gallery'];
        document.querySelectorAll('a.nav-link, a.dropdown-link, .nav-logo').forEach(a=>{
          try{const u=new URL(a.getAttribute('href'),location.origin); if(!paths.some(p=>u.pathname.endsWith(p))) return; if(!u.searchParams.get('event')){u.searchParams.set('event',EVENT); a.setAttribute('href',`${u.pathname}?${u.searchParams.toString()}${u.hash}`);} }catch{}
        });
      }
    })();

    /* ===================== Helpers/state ===================== */
    const qs = new URLSearchParams(location.search);
    const eventId = (qs.get('event') || qs.get('eventId') || '').trim();

    const $ = id => document.getElementById(id);
    const teamSelect=$('teamSelect'), teamPin=$('teamPin'), btnSign=$('btnSign'), signMsg=$('signMsg');
    const secSign=$('secSign'), secRules=$('secRules'), crewPill=$('crewPill'), btnAccept=$('btnAccept');
    const secQuiz=$('secQuiz'), qCounter=$('qCounter'), timerEl=$('timer'), qText=$('qText'), qMedia=$('qMedia'), choicesEl=$('choices'), btnNext=$('btnNext');
    const secDone=$('secDone'), scoreLine=$('scoreLine');

    function setMsg(el, text, kind='error'){ el.textContent=text; el.className='msg ' + (kind==='error'?'err':'ok'); el.style.display='block'; }
    function clearMsg(el){ el.textContent=''; el.style.display='none'; }
    function uuidv4(){ return URL.createObjectURL(new Blob()).split('/').pop(); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    const keyFor = k => `tq_${eventId}_${k}`;
    const token = ()=> localStorage.getItem(keyFor('token')) || '';

    let TEAMS=[], signedTeam=null;

    // Demo questions (replace with your loader)
    const QUESTIONS = [
      { id:'q1', text:'Which city is known as the ‚ÄúBig Apple‚Äù?', options:['Los Angeles','New York','Chicago','Miami'], correct:1 },
      { id:'q2', text:'Tap to hear the instrument and identify it.', audio:'https://upload.wikimedia.org/wikipedia/commons/4/4e/Violin.ogg', options:['Cello','Violin','Flute','Piano'], correct:1 },
      { id:'q3', text:'2 + 2 √ó 3 = ?', options:['8','10','12','6'], correct:0 }
    ];
    const QUIZ_SECONDS = 15;

    let index=0, score=0, timer=null, remaining=QUIZ_SECONDS, locked=false;

    /* ===================== Teams loader (CSV like other pages) ===================== */
    const TEAMS_PUBLIC_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTlOyDNnFwKccCdMKyTQqvr-hfwNGLzv-3h1WEG06RHsMepnhpAZvSeTBHrNgVARlK2NT9VbgYx2jWS/pub?gid=1017404807&single=true&output=csv';

    function parseCsv(t){
      const rows=[]; let i=0,cur='',row=[],inQ=false;
      while(i<t.length){
        const c=t[i];
        if(c==='\"'){ if(inQ && t[i+1]==='\"'){cur+='\"'; i+=2; continue;} inQ=!inQ; i++; continue; }
        if(!inQ && (c===','||c==='\n'||c==='\r')){ row.push(cur); cur=''; if(c!==','){ if(row.length) rows.push(row); row=[]; } i++; continue; }
        cur+=c; i++;
      }
      if(cur.length||row.length){ row.push(cur); rows.push(row); }
      return rows;
    }

    async function loadCrews(){
      if(!eventId){ teamSelect.innerHTML=`<option value="" disabled selected>Add ?event=EVENT_ID to the URL</option>`; setMsg(signMsg,'This page needs an event link (with ?event=...).','error'); btnSign.disabled=true; return; }
      try{
        const res = await fetch(`${TEAMS_PUBLIC_CSV}&t=${Date.now()}`, { cache:'no-store' });
        const rows = parseCsv(await res.text());
        const header = rows[0].map(h=>String(h||'').trim().toLowerCase());
        const idx = n => header.indexOf(n.toLowerCase());
        const iCode=idx('team code'), iName=idx('team name'), iEvent=idx('event id');
        const wanted = String(eventId).toUpperCase();
        TEAMS = rows.slice(1).map(r=>({
          code:String(r[iCode]||'').trim(),
          name:String((iName>-1?r[iName]:'')||r[iCode]||'').trim(),
          event:String(r[iEvent]||'').trim().toUpperCase()
        })).filter(t=>t.code && t.event===wanted).sort((a,b)=>a.name.localeCompare(b.name));
        teamSelect.innerHTML = '<option value="" disabled selected>Choose your crew‚Ä¶</option>' +
          TEAMS.map(t=>`<option value="${escapeHtml(t.code)}">${escapeHtml(t.name)}</option>`).join('');
        clearMsg(signMsg); btnSign.disabled=false;
      }catch(e){
        teamSelect.innerHTML = '<option value="" disabled selected>‚Äî</option>';
        setMsg(signMsg,'Couldn‚Äôt load crews. Refresh and try again.','error');
      }
    }

    /* ===================== Sign in ===================== */
    async function signIn(){
      clearMsg(signMsg);
      const teamCode=(teamSelect.value||'').trim(), pin=(teamPin.value||'').trim();
      if(!teamCode) return setMsg(signMsg,'Pick your crew first.','error');
      if(!/^\d{4}$/.test(pin)) return setMsg(signMsg,'Enter a 4-digit PIN.','error');

      try{
        const res = await fetch('/.netlify/functions/verify_team_pin_function', {
          method:'POST',
          headers:{'Content-Type':'application/json','Idempotency-Key':uuidv4()},
          body:JSON.stringify({ eventId, teamCode, pin })
        });
        const json = await res.json().catch(()=>({}));
        if(!res.ok || json.success===false || json.valid===false) return setMsg(signMsg,'PIN doesn‚Äôt match this crew.','error');

        const t = TEAMS.find(x=>x.code===teamCode);
        signedTeam = { code: teamCode, name: t ? t.name : (json.teamName||'Crew') };
        if(json.token) localStorage.setItem(keyFor('token'), json.token);
        localStorage.setItem(keyFor('team'), JSON.stringify(signedTeam));

        crewPill.textContent = signedTeam.name;
        secSign.style.display='none';
        secRules.style.display='block';
      }catch(e){ setMsg(signMsg,'Sign-in service unavailable. Try again later.','error'); }
    }
    btnSign.addEventListener('click', signIn);
    teamPin.addEventListener('keydown', e=>{ if(e.key==='Enter') signIn(); });

    /* ===================== Quiz engine (Next button gating) ===================== */
    btnAccept.addEventListener('click', startQuiz);
    btnNext.addEventListener('click', ()=>{ nextQuestion(); });

    function startQuiz(){
      index=0; score=0;
      secRules.style.display='none';
      secQuiz.style.display='block';
      loadQuestion();
    }

    function loadQuestion(){
      locked=false; btnNext.disabled=true;
      qMedia.innerHTML='';
      const q = QUESTIONS[index];
      qCounter.textContent = `Question ${index+1} / ${QUESTIONS.length}`;
      qText.textContent = q.text;

      // media (audio)
      if(q.audio){
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = q.audio;
        audio.style.width='100%';
        qMedia.appendChild(audio);
        // optional: autoplay on load
        audio.addEventListener('canplay', ()=>{ try{ audio.play().catch(()=>{}); }catch{} });
      }

      choicesEl.innerHTML='';
      q.options.forEach((opt,i)=>{
        const btn = document.createElement('button');
        btn.className='choice';
        btn.textContent = opt;
        btn.addEventListener('click', ()=> choose(i));
        choicesEl.appendChild(btn);
      });

      startTimer();
    }

    function startTimer(){
      clearInterval(timer);
      remaining = QUIZ_SECONDS;
      timerEl.textContent = `${remaining}s`;
      timer = setInterval(()=>{
        remaining--;
        timerEl.textContent = `${remaining}s`;
        if(remaining<=0){ clearInterval(timer); timeUp(); }
      },1000);
    }

    function timeUp(){
      if(locked) return;
      locked=true;
      markChoices(-1); // no selection
      btnNext.disabled=false;
    }

    function choose(i){
      if(locked) return;
      locked=true;
      clearInterval(timer);
      markChoices(i);
      btnNext.disabled=false;
      // TODO: if you submit answers to backend, call your function here.
    }

    function markChoices(selectedIndex){
      const q = QUESTIONS[index];
      const nodes = Array.from(choicesEl.children);
      nodes.forEach((n,idx)=>{
        n.classList.add('lock');
        if(idx===q.correct) n.classList.add('correct');
        if(idx===selectedIndex && selectedIndex!==q.correct) n.classList.add('wrong');
        n.disabled=true;
      });
      if(selectedIndex===q.correct) score += 10; // simple 10 points per correct
    }

    function nextQuestion(){
      index++;
      if(index>=QUESTIONS.length){ return finishQuiz(); }
      loadQuestion();
    }

    function finishQuiz(){
      secQuiz.style.display='none';
      secDone.style.display='block';
      scoreLine.textContent = `Score: ${score} / ${QUESTIONS.length*10}`;
      // TODO: send final score to your backend if needed.
    }

    /* ===================== Boot ===================== */
    (function boot(){
      // restore session
      try{
        const raw = localStorage.getItem(keyFor('team'));
        if(raw){
          const t = JSON.parse(raw);
          if(t && t.code && t.name){ signedTeam = t; crewPill.textContent=t.name; secSign.style.display='none'; secRules.style.display='block'; }
        }
      }catch{}
      loadCrews();
    })();
  </script>
</body>
</html>
