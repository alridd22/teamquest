<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terry's Treasure Hunt Command Centre</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 30%, #F4A460 100%);
            min-height: 100vh;
            color: #3E2723;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255,215,0,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255,140,0,0.1) 0%, transparent 50%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,215,0,0.3)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,140,0,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(218,165,32,0.2)"/></svg>');
            pointer-events: none;
            z-index: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .logo {
            font-size: 3em;
            margin-bottom: 10px;
            filter: drop-shadow(2px 2px 4px rgba(139,69,19,0.3));
            animation: gentle-sway 3s ease-in-out infinite;
        }

        @keyframes gentle-sway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #3E2723;
            text-shadow: 3px 3px 6px rgba(255,255,255,0.8), 1px 1px 3px rgba(0,0,0,0.8);
        }

        .subtitle {
            color: #A0522D;
            font-size: 1.3em;
            font-weight: 600;
        }

        .terry-greeting {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin: 30px auto 40px;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 20px;
            padding: 25px;
            border: 3px solid #DAA520;
            box-shadow: 0 5px 15px rgba(139,69,19,0.2);
            max-width: 900px;
            position: relative;
            z-index: 1;
        }

        .terry-character {
            flex-shrink: 0;
        }

        .terry-character img {
            width: 120px !important;
            height: 120px !important;
            border-radius: 15px !important;
            border: 4px solid #DAA520;
            box-shadow: 0 4px 12px rgba(139,69,19,0.3);
            object-fit: cover;
            background: linear-gradient(135deg, #8B4513, #A0522D);
            display: block;
        }

        .terry-speech {
            flex: 1;
            position: relative;
        }

        .terry-speech::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 15px 15px 15px 0;
            border-color: transparent #FFD700 transparent transparent;
        }

        .terry-note {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #8B4513;
            padding: 25px;
            border-radius: 15px;
            margin: 0;
            border: 3px solid #DAA520;
            position: relative;
            font-weight: 500;
            line-height: 1.6;
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            position: relative;
            z-index: 1;
        }

        .control-panel {
            background: linear-gradient(145deg, #F5E6D3 0%, #E8D7C3 100%);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
            border: 3px solid #8B4513;
            position: relative;
            overflow: hidden;
        }

        .control-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #DAA520, #FFD700);
        }

        .control-panel::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 2px solid #DAA520;
            border-radius: 20px;
            pointer-events: none;
        }

        .section-title {
            font-size: 1.6em;
            margin-bottom: 25px;
            color: #8B4513;
            border-bottom: 3px solid #DAA520;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .adventure-control {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        .timer-display {
            font-size: 3.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #8B4513;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 15px;
            border: 3px solid #DAA520;
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
            transition: all 0.3s ease;
        }

        /* Enhanced Timer States */
        .timer-penalty {
            background: linear-gradient(135deg, #DC143C 0%, #B22222 100%);
            color: white;
            animation: pulse-penalty 1s ease-in-out infinite;
            border-color: #8B0000;
        }

        @keyframes pulse-penalty {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 5px 15px rgba(220,20,60,0.4);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 8px 25px rgba(220,20,60,0.6);
            }
        }

        /* Penalty Warning System */
        .penalty-warning {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
            border: 3px solid #DC143C;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            color: #8B0000;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(220,20,60,0.3);
            display: none;
            position: relative;
            z-index: 2;
        }

        .penalty-warning.show {
            display: block;
            animation: warning-pulse 2s ease-in-out infinite;
        }

        @keyframes warning-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .penalty-rate {
            font-size: 1.1em;
            margin-top: 10px;
            color: #8B0000;
        }

        .adventure-status {
            font-size: 1.3em;
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            border: 2px solid;
        }

        .status-stopped { 
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%); 
            border-color: #DC143C; 
            color: #8B0000;
        }
        .status-running { 
            background: linear-gradient(135deg, #98FB98 0%, #90EE90 100%); 
            border-color: #32CD32; 
            color: #006400;
        }
        .status-paused { 
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%); 
            border-color: #FF8C00; 
            color: #8B4513;
        }
        .status-ended { 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); 
            border-color: #DAA520; 
            color: #8B4513;
        }
        .status-not-started {
            background: linear-gradient(135deg, #E6E6FA 0%, #D8BFD8 100%);
            border-color: #9370DB;
            color: #4B0082;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        .btn {
            padding: 18px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 3px solid #8B4513;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .btn-start { 
            background: linear-gradient(135deg, #32CD32, #228B22); 
            color: white; 
        }
        .btn-pause { 
            background: linear-gradient(135deg, #FFD700, #FF8C00); 
            color: #8B4513; 
        }
        .btn-stop { 
            background: linear-gradient(135deg, #DC143C, #B22222); 
            color: white; 
        }
        .btn-reset { 
            background: linear-gradient(135deg, #A0522D, #8B4513); 
            color: white; 
        }
        .btn-publish {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #8B4513;
            font-size: 1.3em;
            padding: 20px 30px;
            border: 4px solid #DAA520;
            grid-column: 1 / -1;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #6c757d !important;
            color: #fff !important;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .results-management {
            background: linear-gradient(135deg, #FFFACD 0%, #F0E68C 100%);
            border: 3px solid #DAA520;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            z-index: 2;
        }

        .results-management h3 {
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .results-status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .results-unpublished {
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%);
            border: 2px solid #FF8C00;
            color: #8B4513;
        }

        .results-published {
            background: linear-gradient(135deg, #98FB98 0%, #90EE90 100%);
            border: 2px solid #32CD32;
            color: #006400;
        }

        .publish-warning {
            background: linear-gradient(135deg, #FFCCCB 0%, #FFA07A 100%);
            border: 2px solid #DC143C;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            color: #8B0000;
            font-weight: 600;
        }

        .emergency-controls {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
            border: 3px solid #DC143C;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            z-index: 2;
        }

        .emergency-controls h3 {
            color: #8B0000;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .crews-panel {
            background: linear-gradient(145deg, #F5E6D3 0%, #E8D7C3 100%);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
            border: 3px solid #8B4513;
            position: relative;
            overflow: hidden;
        }

        .crews-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #DAA520, #FFD700);
        }

        .crews-panel::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 2px solid #DAA520;
            border-radius: 20px;
            pointer-events: none;
        }

        .crews-grid {
            display: grid;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            z-index: 2;
        }

        .crew-card {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #DAA520;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(139,69,19,0.1);
            position: relative;
        }

        .crew-card:hover {
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139,69,19,0.2);
        }

        /* Enhanced Crew Card States */
        .crew-card.late {
            background: linear-gradient(135deg, #FFCCCB 0%, #FFA0B4 100%);
            border: 3px solid #DC143C;
            box-shadow: 0 4px 12px rgba(220,20,60,0.2);
        }

        .crew-card.returned {
            background: linear-gradient(135deg, #98FB98 0%, #90EE90 100%);
            border: 3px solid #32CD32;
            box-shadow: 0 4px 12px rgba(50,205,50,0.2);
        }

        .crew-card.penalized {
            border-left: 8px solid #DC143C;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
        }

        .crew-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .crew-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #8B4513;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crew-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active {
            background: #3498db;
            color: white;
        }

        .status-returned {
            background: #27ae60;
            color: white;
        }

        .status-late {
            background: #e74c3c;
            color: white;
            animation: badge-pulse 1.5s ease-in-out infinite;
        }

        @keyframes badge-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .crew-doubloons {
            font-size: 1.5em;
            color: #DAA520;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .crew-doubloons.penalized {
            color: #DC143C;
        }

        .original-score {
            font-size: 0.7em;
            color: #999;
            text-decoration: line-through;
            margin-bottom: 2px;
        }

        /* Penalty Information Display */
        .penalty-info {
            background: linear-gradient(135deg, #FFCCCB 0%, #FFA0B4 100%);
            border: 2px solid #DC143C;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #8B0000;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .penalty-icon {
            font-size: 1.2em;
            animation: warning-shake 1s ease-in-out infinite;
        }

        @keyframes warning-shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }

        .crew-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-select {
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #DAA520;
            background: linear-gradient(145deg, #FFFFFF 0%, #FFF8DC 100%);
            color: #8B4513;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-select.late {
            border-color: #DC143C;
            background: linear-gradient(145deg, #FFCCCB 0%, #FFA0B4 100%);
            color: #8B0000;
        }

        .return-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #8B4513;
            font-weight: 500;
        }

        .return-checkbox input[type="checkbox"] {
            transform: scale(1.3);
            accent-color: #DAA520;
        }

        /* Manual Penalty Override */
        .penalty-override {
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%);
            border: 2px solid #FF8C00;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .penalty-override.show {
            display: block;
        }

        .penalty-override h4 {
            color: #8B4513;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .penalty-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .penalty-input {
            padding: 8px 12px;
            border: 2px solid #DAA520;
            border-radius: 8px;
            background: white;
            color: #8B4513;
            font-weight: bold;
            width: 80px;
            text-align: center;
        }

        .penalty-apply-btn {
            background: linear-gradient(135deg, #FF8C00, #FF7700);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .penalty-apply-btn:hover {
            background: linear-gradient(135deg, #FF7700, #FF6600);
            transform: translateY(-1px);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 40px;
            position: relative;
            z-index: 1;
        }

        .stat-card {
            background: linear-gradient(145deg, #F5E6D3 0%, #E8D7C3 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 3px solid #8B4513;
            box-shadow: 0 5px 15px rgba(139,69,19,0.2);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #DAA520, #FFD700);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #8B4513;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 1em;
            color: #A0522D;
            margin-top: 8px;
            font-weight: 600;
        }

        .activity-summary {
            margin-top: 25px;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #DAA520;
            position: relative;
            z-index: 2;
        }

        .activity-summary h3 {
            color: #8B4513;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 700;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .activity-item {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%);
            border-radius: 10px;
            border: 2px solid #DAA520;
            font-weight: 600;
            color: #8B4513;
        }

        .activity-item div:first-child {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .activity-item div:last-child {
            font-size: 1.2em;
            font-weight: 700;
            color: #A0522D;
        }

        .loading {
            text-align: center;
            opacity: 0.8;
            padding: 25px;
            color: #8B4513;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }

        .success-message, .error-message {
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            border: 2px solid;
            position: relative;
            z-index: 2;
        }

        .success-message {
            background: linear-gradient(135deg, #98FB98 0%, #90EE90 100%);
            border-color: #32CD32;
            color: #006400;
        }

        .error-message {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
            border-color: #DC143C;
            color: #8B0000;
        }

        @media (max-width: 1200px) {
            .admin-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .activity-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .terry-greeting {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .terry-speech::before {
                display: none;
            }

            .terry-character img {
                width: 100px !important;
                height: 100px !important;
            }

            h1 {
                font-size: 2.2em;
            }

            .penalty-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">🏴‍☠️</div>
        <h1>Terry's Treasure Hunt Command Centre</h1>
        <p class="subtitle">Captain's Bridge for Managing the Grand Adventure</p>
    </div>

    <div class="terry-greeting">
        <div class="terry-character">
            <img src="/terry-clock.png" alt="Captain Terry" class="terry-image">
        </div>
        <div class="terry-speech">
            <div class="terry-note">
                <strong>Ahoy, Admiral!</strong> Yer command centre now includes penalty tracking for crews who return after the adventure cutoff! When the timer runs out, any crew marked as "Late" will automatically lose <strong>5 doubloons per minute</strong> they're overdue. The timer will turn red and show how much penalty time has elapsed. Fair winds and following seas!
            </div>
        </div>
    </div>

    <div class="admin-container">
        <!-- Adventure Control Panel -->
        <div class="control-panel">
            <h2 class="section-title">⚓ Adventure Control</h2>
            
            <div class="adventure-control">
                <div class="timer-display" id="timerDisplay">01:30:00</div>
                
                <!-- Penalty Warning System -->
                <div class="penalty-warning" id="penaltyWarning">
                    <div style="font-size: 1.3em; margin-bottom: 10px;">⚠️ Late Return Penalties Active! ⚠️</div>
                    <div>Teams checking in late will lose <strong>3 doubloons per minute</strong></div>
                    <div class="penalty-rate" id="penaltyRate">Current penalty: 0 minutes = 0 doubloons</div>
                </div>
                
                <div class="adventure-status status-stopped" id="timerStatus">
                    🔄 Loading status...
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-start" id="startBtn" onclick="startAdventure()">
                        🚀 Launch Adventure
                    </button>
                    <button class="btn btn-pause" id="pauseBtn" onclick="pauseAdventure()" disabled>
                        ⏸️ Pause Quest
                    </button>
                    <button class="btn btn-stop" id="stopBtn" onclick="stopAdventure()" disabled>
                        ⏹️ End Adventure
                    </button>
                    <button class="btn btn-reset" id="resetBtn" onclick="resetTimer()">
                        🔄 Reset Timer
                    </button>
                    <button class="btn btn-publish" id="publishBtn" onclick="publishResults()" disabled>
                        🏆 Publish Final Results & Unlock Gallery
                    </button>
                </div>
            </div>

            <div class="results-management" id="resultsManagement">
                <h3>🏆 Final Results Management</h3>
                
                <div class="results-status" id="resultsStatus">
                    🔒 Results not published - Gallery locked
                </div>

                <div class="publish-warning" id="publishWarning" style="display: none;">
                    ⚠️ <strong>Captain's Notice:</strong> Publishing results will unfreeze the leaderboard and unlock the treasure gallery for all crews. This action cannot be undone!
                </div>
            </div>

            <div class="emergency-controls">
                <h3>🚨 Emergency Captain's Orders</h3>
                <button class="btn btn-stop" onclick="emergencyStop()" style="width: 100%; margin-top: 15px;">
                    ⚠️ Emergency All Stop
                </button>
            </div>

            <div class="activity-summary">
                <h3>🗺️ Quest Activity Overview</h3>
                <div class="activity-grid">
                    <div class="activity-item">
                        <div>Crew Registration</div>
                        <div id="regCount">-</div>
                    </div>
                    <div class="activity-item">
                        <div>Treasure Map</div>
                        <div id="clueCount">-</div>
                    </div>
                    <div class="activity-item">
                        <div>Knowledge Challenge</div>
                        <div id="quizCount">-</div>
                    </div>
                    <div class="activity-item">
                        <div>Heart Treasures</div>
                        <div id="kindnessCount">-</div>
                    </div>
                    <div class="activity-item">
                        <div>Verse Vault</div>
                        <div id="limerickCount">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crews Management Panel -->
        <div class="crews-panel">
            <h2 class="section-title">👥 Crew Management</h2>
            
            <div id="loading" class="loading">
                🔍 Loading crew data from the treasure logs...
            </div>
            
            <div id="crewsContent" style="display: none;">
                <div class="crews-grid" id="crewsGrid">
                    <!-- Crew cards will be populated here -->
                </div>
            </div>
            
            <div id="messages"></div>
        </div>
    </div>

    <!-- Treasure Statistics Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-number" id="totalCrews">-</div>
            <div class="stat-label">Total Crews</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="activeCrews">-</div>
            <div class="stat-label">Active Crews</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="returnedCrews">-</div>
            <div class="stat-label">Returned Crews</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="penalizedCrews">-</div>
            <div class="stat-label">Penalised Crews</div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(145deg, #F5E6D3 0%, #E8D7C3 100%); border: 3px solid #8B4513; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <div style="text-align: center;">
                <h3 id="confirmTitle" style="color: #8B4513; margin-bottom: 20px; font-size: 1.4em;"></h3>
                <div id="confirmMessage" style="color: #8B4513; margin-bottom: 25px; line-height: 1.6;"></div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="cancelReturn()" class="btn" style="background: linear-gradient(135deg, #A0522D, #8B4513); color: white; padding: 12px 20px;">Cancel</button>
                    <button onclick="confirmReturn()" class="btn" style="background: linear-gradient(135deg, #32CD32, #228B22); color: white; padding: 12px 20px;">Confirm Return</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced state management with penalty tracking
        let adventureState = {
            backendStatus: null,
            isRunning: false,
            isPaused: false,
            timeRemaining: 90 * 60,
            startTime: null,
            crews: [],
            resultsPublished: false,
            competitionData: null,
            hasEnded: false,
            // NEW: Penalty tracking
            penaltyMode: false,
            penaltyMinutes: 0,
            allTeamsReturned: false
        };

        let timerInterval = null;
        let dataRefreshInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced admin panel loading - checking current state...');
            loadCurrentState();
            dataRefreshInterval = setInterval(loadCurrentState, 30000);
        });

        async function loadCurrentState() {
            try {
                console.log('Loading current competition state from backend...');
                
                const response = await fetch('/.netlify/functions/get_leaderboard_function');
                const data = await response.json();
                
                if (!data || !data.success) {
                    throw new Error('Failed to get competition status');
                }
                
                adventureState.backendStatus = data.competitionStatus || data.status;
                adventureState.resultsPublished = data.resultsPublished === 'yes' || data.resultsPublished === true;
                adventureState.crews = data.teams || data.leaderboard || [];
                adventureState.competitionData = data;
                
                console.log('Backend status:', adventureState.backendStatus);
                console.log('Results published:', adventureState.resultsPublished);
                
                syncWithBackendState(data);
                updateTimerDisplay();
                updateButtonStates();
                updateResultsManagement();
                renderCrews(adventureState.crews);
                updateStatistics(adventureState.crews);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('crewsContent').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading current state:', error);
                showMessage('Failed to load current status: ' + error.message, 'error');
            }
        }

        function syncWithBackendState(data) {
            // Enhanced status detection with better empty sheet handling
            const rawStatus = data.competitionStatus || data.status;
            const backendStatus = (rawStatus || '').toString().toLowerCase().trim();
            
            // Add debugging to help diagnose issues
            console.log('Raw backend status:', rawStatus);
            console.log('Processed backend status:', backendStatus);
            console.log('Full backend data:', data);
            
            // Check if this appears to be an empty/uninitialized competition
            const isEmpty = !rawStatus || rawStatus === '' || rawStatus === null || rawStatus === undefined;
            const hasNoStartTime = !data.startTime;
            const hasNoTeams = !data.teams || !data.leaderboard || (data.teams && data.teams.length === 0) || (data.leaderboard && data.leaderboard.length === 0);
            
            console.log('Empty status check:', { isEmpty, hasNoStartTime, hasNoTeams });
            
            if (isEmpty && hasNoStartTime) {
                // Definitely an uninitialized competition
                console.log('Detected uninitialized competition - setting to not started state');
                adventureState.isRunning = false;
                adventureState.isPaused = false;
                adventureState.hasEnded = false;
                adventureState.timeRemaining = 90 * 60;
                adventureState.penaltyMode = false;
                adventureState.penaltyMinutes = 0;
                adventureState.allTeamsReturned = false;
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
            } else if (backendStatus === 'start' || backendStatus === 'running') {
                console.log('Competition is running');
                adventureState.isRunning = true;
                adventureState.isPaused = false;
                adventureState.hasEnded = false;
                
                if (data.startTime && data.durationMinutes) {
                    const startTime = new Date(data.startTime);
                    const duration = data.durationMinutes * 60 * 1000;
                    const endTime = new Date(startTime.getTime() + duration);
                    const now = new Date();
                    const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));
                    adventureState.timeRemaining = timeLeft;
                    
                    // Check for penalty mode
                    if (timeLeft <= 0) {
                        const overTime = Math.floor((now - endTime) / 1000);
                        adventureState.penaltyMode = true;
                        adventureState.penaltyMinutes = Math.ceil(overTime / 60);
                    } else {
                        adventureState.penaltyMode = false;
                        adventureState.penaltyMinutes = 0;
                    }
                    
                    if (!timerInterval) {
                        startTimer();
                    }
                }
                
            } else if (backendStatus === 'stop' || backendStatus === 'stopped') {
                console.log('Competition is stopped/ended');
                adventureState.isRunning = false;
                adventureState.isPaused = false;
                adventureState.hasEnded = true;
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
            } else {
                // Unknown status or other edge cases
                console.log('Unknown or edge case status, defaulting to not started');
                adventureState.isRunning = false;
                adventureState.isPaused = false;
                adventureState.hasEnded = false;
                adventureState.timeRemaining = 90 * 60;
                adventureState.penaltyMode = false;
                adventureState.penaltyMinutes = 0;
                adventureState.allTeamsReturned = false;
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }
            
            // Check if all teams have returned
            checkAllTeamsReturned();
        }

        function checkAllTeamsReturned() {
            const activeTeams = adventureState.crews.filter(crew => 
                (crew.status || 'active') === 'active'
            );
            
            const newAllTeamsReturned = activeTeams.length === 0 && adventureState.crews.length > 0;
            
            if (newAllTeamsReturned && !adventureState.allTeamsReturned && adventureState.penaltyMode) {
                // All teams returned during penalty phase - stop penalty timer
                adventureState.allTeamsReturned = true;
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                updateTimerDisplay();
                updateButtonStates();
                showMessage('🎉 All crews have returned! Timer stopped.', 'success');
            }
            
            adventureState.allTeamsReturned = newAllTeamsReturned;
        }

        function formatTime(seconds) {
            if (seconds <= 0) return "QUEST COMPLETE!";
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            const status = document.getElementById('timerStatus');
            const penaltyWarning = document.getElementById('penaltyWarning');
            const penaltyRate = document.getElementById('penaltyRate');
            
            if (adventureState.penaltyMode && adventureState.isRunning) {
                // Penalty mode - show red timer counting up
                const penaltyTime = adventureState.penaltyMinutes * 60;
                const hours = Math.floor(penaltyTime / 3600);
                const minutes = Math.floor((penaltyTime % 3600) / 60);
                const seconds = penaltyTime % 60;
                
                display.textContent = `+${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                display.className = 'timer-display timer-penalty';
                
                // Show penalty warning
                penaltyWarning.classList.add('show');
                penaltyRate.textContent = `Current penalty: ${adventureState.penaltyMinutes} minutes = ${adventureState.penaltyMinutes * 3} doubloons`;
                
                if (adventureState.allTeamsReturned) {
                    status.innerHTML = '🏁 All Crews Returned - Adventure Complete';
                    status.className = 'adventure-status status-ended';
                } else {
                    status.innerHTML = '⚠️ Penalty Phase - Teams Late!';
                    status.className = 'adventure-status status-stopped';
                }
                
            } else {
                // Normal mode
                display.textContent = formatTime(adventureState.timeRemaining);
                display.className = 'timer-display';
                penaltyWarning.classList.remove('show');
                
                if (adventureState.resultsPublished) {
                    status.innerHTML = '🏆 Final Results Published';
                    status.className = 'adventure-status status-ended';
                } else if (adventureState.hasEnded) {
                    status.innerHTML = '🏁 Adventure Complete - Ready to Publish';
                    status.className = 'adventure-status status-ended';
                } else if (adventureState.isRunning && !adventureState.isPaused) {
                    status.innerHTML = '🏴‍☠️ Adventure in Progress';
                    status.className = 'adventure-status status-running';
                } else if (adventureState.isPaused) {
                    status.innerHTML = '⏸️ Quest Paused';
                    status.className = 'adventure-status status-paused';
                } else {
                    // This is the key fix - better handling of not-started state
                    const hasAnyData = adventureState.competitionData && 
                                     (adventureState.competitionData.startTime || 
                                      (adventureState.crews && adventureState.crews.length > 0));
                    
                    if (!hasAnyData) {
                        status.innerHTML = '🗺️ Adventure Not Started - Ready to Launch';
                        status.className = 'adventure-status status-not-started';
                    } else {
                        status.innerHTML = '🏴‍☠️ Adventure Awaiting Launch';
                        status.className = 'adventure-status status-stopped';
                    }
                }
            }

            // Timer color logic
            if (adventureState.timeRemaining <= 300 && adventureState.isRunning && !adventureState.penaltyMode) {
                display.style.color = '#DC143C';
            } else if (adventureState.timeRemaining <= 900 && adventureState.isRunning && !adventureState.penaltyMode) {
                display.style.color = '#FF8C00';
            }
        }

        function updateButtonStates() {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            const resetBtn = document.getElementById('resetBtn');

            if (adventureState.resultsPublished) {
                startBtn.disabled = true;
                startBtn.innerHTML = '🏆 Results Published';
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                resetBtn.disabled = false;
                
            } else if (adventureState.hasEnded || adventureState.allTeamsReturned) {
                startBtn.disabled = true;
                startBtn.innerHTML = '🔒 Adventure Ended';
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                stopBtn.innerHTML = '✅ Adventure Ended';
                resetBtn.disabled = false;
                
            } else if (adventureState.isRunning && !adventureState.isPaused) {
                startBtn.disabled = true;
                startBtn.innerHTML = '✅ Adventure Running';
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                stopBtn.innerHTML = '⏹️ End Adventure';
                resetBtn.disabled = true;
                
            } else if (adventureState.isPaused) {
                startBtn.disabled = false;
                startBtn.innerHTML = '▶️ Resume Quest';
                pauseBtn.disabled = true;
                stopBtn.disabled = false;
                resetBtn.disabled = true;
                
            } else {
                startBtn.disabled = false;
                startBtn.innerHTML = '🚀 Launch Adventure';
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                resetBtn.disabled = false;
            }
        }

        function updateResultsManagement() {
            const resultsStatus = document.getElementById('resultsStatus');
            const publishBtn = document.getElementById('publishBtn');
            const publishWarning = document.getElementById('publishWarning');

            if (adventureState.resultsPublished) {
                resultsStatus.innerHTML = '🏆 Results Published - Gallery Unlocked';
                resultsStatus.className = 'results-status results-published';
                publishBtn.disabled = true;
                publishBtn.innerHTML = '🏆 Results Already Published';
                publishWarning.style.display = 'none';
            } else {
                resultsStatus.innerHTML = '🔒 Results Not Published - Gallery Locked';
                resultsStatus.className = 'results-status results-unpublished';
                
                const timeLeftMinutes = Math.floor(adventureState.timeRemaining / 60);
                const canPublish = adventureState.hasEnded || 
                                 adventureState.allTeamsReturned ||
                                 (adventureState.isRunning && timeLeftMinutes <= 20) ||
                                 adventureState.timeRemaining <= 0;
                
                if (canPublish) {
                    publishBtn.disabled = false;
                    publishBtn.innerHTML = '🏆 Publish Final Results & Unlock Gallery';
                    publishWarning.style.display = 'block';
                } else {
                    publishBtn.disabled = true;
                    publishBtn.innerHTML = '🔒 Results Not Ready';
                    publishWarning.style.display = 'none';
                }
            }
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                if (adventureState.isRunning && !adventureState.isPaused) {
                    if (adventureState.timeRemaining > 0) {
                        // Countdown phase
                        adventureState.timeRemaining--;
                        
                        if (adventureState.timeRemaining <= 0) {
                            // Enter penalty phase
                            adventureState.penaltyMode = true;
                            adventureState.penaltyMinutes = 1;
                            showMessage('⚠️ Adventure time expired! Late return penalties now active!', 'error');
                        }
                    } else if (adventureState.penaltyMode && !adventureState.allTeamsReturned) {
                        // Penalty phase - increment penalty time
                        adventureState.penaltyMinutes = Math.ceil((Date.now() - (new Date(adventureState.competitionData.startTime).getTime() + adventureState.competitionData.durationMinutes * 60 * 1000)) / (60 * 1000));
                    }
                    
                    updateTimerDisplay();
                    updateResultsManagement();
                }
            }, 1000);
        }

        // Enhanced crew rendering with penalty display
        function renderCrews(crews) {
            const container = document.getElementById('crewsGrid');
            container.innerHTML = '';

            crews.forEach(crew => {
                const crewCard = document.createElement('div');
                
                const totalScore = crew.totalScore || crew.total || 0;
                const teamCode = crew.teamCode || crew.code || '';
                const teamName = crew.teamName || crew.name || 'Unknown Crew';
                const status = crew.status || 'active';
                const locked = crew.locked || false;
                const penalty = crew.penalty || 0;
                const penaltyMinutes = crew.penaltyMinutes || 0;
                
                // Calculate adjusted score
                const adjustedScore = Math.max(0, totalScore - penalty);
                
                // Determine card classes
                let cardClasses = 'crew-card';
                if (status === 'late') cardClasses += ' late';
                if (status === 'returned') cardClasses += ' returned';
                if (penalty > 0) cardClasses += ' penalized';
                
                crewCard.className = cardClasses;
                
                // Status badge - show "returned" for both returned and late teams, but style differently
                const displayStatus = (status === 'late' || status === 'returned') ? 'returned' : status;
                const badgeClass = penalty > 0 ? 'status-late' : `status-${displayStatus}`;
                const statusBadge = `<span class="crew-status-badge ${badgeClass}">${getStatusText(status)}</span>`;
                
                // Penalty info display
                let penaltyDisplay = '';
                if (penalty > 0) {
                    penaltyDisplay = `
                        <div class="penalty-info">
                            <span class="penalty-icon">⚠️</span>
                            <div>
                                <strong>Late Penalty:</strong> -${penalty} doubloons (${penaltyMinutes} minutes late)
                                <br><small>Original: ${totalScore} → Adjusted: ${adjustedScore}</small>
                            </div>
                        </div>
                    `;
                }
                
                // Score display
                let scoreDisplay = '';
                if (penalty > 0) {
                    scoreDisplay = `
                        <div class="crew-doubloons penalized">
                            <div class="original-score">${totalScore}</div>
                            ${adjustedScore} 🪙
                        </div>
                    `;
                } else {
                    scoreDisplay = `
                        <div class="crew-doubloons">
                            ${totalScore} 🪙
                        </div>
                    `;
                }
                
                // Manual penalty override section - show for teams with penalties
                let penaltyOverride = '';
                if (penalty > 0 && adventureState.isRunning) {
                    penaltyOverride = `
                        <div class="penalty-override show" id="penalty-override-${teamCode}">
                            <h4>Manual Penalty Override</h4>
                            <div class="penalty-controls">
                                <label>Penalty:</label>
                                <input type="number" class="penalty-input" id="penalty-input-${teamCode}" 
                                       value="${penalty}" min="0" max="999" step="3">
                                <span>doubloons</span>
                                <button class="penalty-apply-btn" onclick="applyManualPenalty('${teamCode}')">
                                    Apply
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                crewCard.innerHTML = `
                    <div class="crew-header">
                        <div class="crew-name">
                            ${teamName}
                            ${statusBadge}
                        </div>
                        ${scoreDisplay}
                    </div>
                    
                    ${penaltyDisplay}
                    
                    <div class="crew-controls">
                        <select class="status-select ${penalty > 0 ? 'late' : ''}" 
                                onchange="handleStatusChange('${teamCode}', this.value, ${totalScore}, ${penalty})"
                                ${!adventureState.isRunning ? 'disabled' : ''}>
                            <option value="active" ${status === 'active' ? 'selected' : ''}>🏴‍☠️ Active</option>
                            <option value="returned" ${status === 'returned' || status === 'late' ? 'selected' : ''}>⚓ Returned</option>
                        </select>
                        <label class="return-checkbox">
                            <input type="checkbox" ${locked ? 'checked' : ''} 
                                   onchange="toggleCrewLock('${teamCode}', this.checked)"
                                   ${!adventureState.isRunning ? 'disabled' : ''}> 
                            🔒 Lock Doubloons
                        </label>
                    </div>
                    
                    ${penaltyOverride}
                    
                    <div style="margin-top: 15px; font-size: 0.9em; color: #8B4513; font-weight: 500;">
                        ${teamCode} | Reg: ${crew.registration || 0} | Map: ${crew.clueHunt || 0} | Quiz: ${crew.quiz || 0}
                    </div>
                `;
                
                container.appendChild(crewCard);
            });
        }

        function getStatusText(status) {
            switch (status) {
                case 'active': return 'Active';
                case 'returned': 
                case 'late': return 'Returned';
                default: return status;
            }
        }

        // Enhanced crew status update with confirmation and auto-penalty detection
        let pendingStatusChange = null;

        function handleStatusChange(teamCode, newStatus, currentScore, currentPenalty) {
            if (newStatus === 'returned') {
                // Show confirmation dialog for returning teams
                showReturnConfirmation(teamCode, currentScore, currentPenalty);
            } else {
                // Direct update for active status
                updateCrewStatus(teamCode, newStatus);
            }
        }

        function showReturnConfirmation(teamCode, currentScore, currentPenalty) {
            const team = adventureState.crews.find(c => (c.teamCode || c.code) === teamCode);
            const teamName = team ? team.teamName || team.name : teamCode;
            
            // Calculate penalty if in penalty mode
            let penalty = currentPenalty || 0;
            let isLateReturn = false;
            
            if (adventureState.penaltyMode && adventureState.penaltyMinutes > 0) {
                penalty = adventureState.penaltyMinutes * 3;
                isLateReturn = true;
            }
            
            const adjustedScore = Math.max(0, currentScore - penalty);
            
            // Store pending change
            pendingStatusChange = {
                teamCode,
                teamName,
                status: 'returned',
                originalScore: currentScore,
                penalty: penalty,
                adjustedScore: adjustedScore,
                isLateReturn: isLateReturn
            };
            
            // Update modal content
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            
            if (isLateReturn) {
                confirmTitle.innerHTML = '⚠️ Confirm Late Team Return';
                confirmMessage.innerHTML = `
                    <strong>Are you sure ${teamName} has returned?</strong><br><br>
                    • Original score: <strong>${currentScore} doubloons</strong><br>
                    • Late penalty: <strong>-${penalty} doubloons (${adventureState.penaltyMinutes} minutes)</strong><br>
                    • Final score: <strong>${adjustedScore} doubloons</strong><br><br>
                    <span style="color: #DC143C;">⚠️ Doubloons will be FROZEN</span><br>
                    <span style="color: #DC143C;">⚠️ No further activities allowed</span>
                `;
            } else {
                confirmTitle.innerHTML = '⚓ Confirm Team Return';
                confirmMessage.innerHTML = `
                    <strong>Are you sure ${teamName} has returned?</strong><br><br>
                    • Final score: <strong>${currentScore} doubloons</strong><br><br>
                    <span style="color: #FF8C00;">⚠️ Doubloons will be FROZEN</span><br>
                    <span style="color: #FF8C00;">⚠️ No further activities allowed</span>
                `;
            }
            
            // Show modal
            const modal = document.getElementById('confirmationModal');
            modal.style.display = 'flex';
        }

        function confirmReturn() {
            if (!pendingStatusChange) return;
            
            const { teamCode, status, penalty } = pendingStatusChange;
            
            // Hide modal
            document.getElementById('confirmationModal').style.display = 'none';
            
            // Process the return
            updateCrewStatus(teamCode, status, penalty);
            
            // Clear pending change
            pendingStatusChange = null;
        }

        function cancelReturn() {
            // Hide modal
            document.getElementById('confirmationModal').style.display = 'none';
            
            // Reset dropdown to previous value
            if (pendingStatusChange) {
                const team = adventureState.crews.find(c => (c.teamCode || c.code) === pendingStatusChange.teamCode);
                if (team) {
                    const dropdown = document.querySelector(`select[onchange*="${pendingStatusChange.teamCode}"]`);
                    if (dropdown) {
                        dropdown.value = team.status || 'active';
                    }
                }
            }
            
            // Clear pending change
            pendingStatusChange = null;
        }

        async function updateCrewStatus(teamCode, newStatus, customPenalty = null) {
            try {
                let penalty = 0;
                let finalStatus = newStatus;
                
                // Auto-detect penalty for returned teams
                if (newStatus === 'returned') {
                    if (adventureState.penaltyMode && adventureState.penaltyMinutes > 0) {
                        penalty = customPenalty !== null ? customPenalty : adventureState.penaltyMinutes * 3;
                        finalStatus = 'late'; // Internal status for penalty tracking
                    }
                }

                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update_team_status',
                        teamCode: teamCode,
                        status: finalStatus,
                        penalty: penalty,
                        returnTime: new Date().toISOString(),
                        penaltyMinutes: adventureState.penaltyMinutes || 0
                    })
                });

                if (response.ok) {
                    await loadCurrentState();
                    
                    if (penalty > 0) {
                        showMessage(`${teamCode} returned late. Penalty applied: -${penalty} doubloons. Doubloons frozen.`, 'error');
                    } else {
                        showMessage(`${teamCode} returned safely. Doubloons frozen.`, 'success');
                    }
                } else {
                    throw new Error('Failed to update crew status');
                }
            } catch (error) {
                console.error('Error updating crew status:', error);
                showMessage('Failed to update crew status: ' + error.message, 'error');
            }
        }

        // Manual penalty override function - for already returned teams
        async function applyManualPenalty(teamCode) {
            const penaltyInput = document.getElementById(`penalty-input-${teamCode}`);
            const customPenalty = parseInt(penaltyInput.value) || 0;
            
            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update_team_status',
                        teamCode: teamCode,
                        status: customPenalty > 0 ? 'late' : 'returned', // Internal status based on penalty
                        penalty: customPenalty,
                        returnTime: new Date().toISOString(),
                        penaltyMinutes: Math.ceil(customPenalty / 3) // Calculate equivalent minutes
                    })
                });

                if (response.ok) {
                    await loadCurrentState();
                    showMessage(`Manual penalty applied to ${teamCode}: -${customPenalty} doubloons`, 'success');
                } else {
                    throw new Error('Failed to apply manual penalty');
                }
            } catch (error) {
                console.error('Error applying manual penalty:', error);
                showMessage('Failed to apply manual penalty: ' + error.message, 'error');
            }
        }

        function updateStatistics(crews) {
            const totalCrews = crews.length;
            const activeCrews = crews.filter(c => (c.status || 'active') === 'active').length;
            const returnedCrews = crews.filter(c => {
                const status = c.status || 'active';
                return status === 'returned' || status === 'late';
            }).length;
            const penalizedCrews = crews.filter(c => (c.penalty || 0) > 0).length;

            document.getElementById('totalCrews').textContent = totalCrews;
            document.getElementById('activeCrews').textContent = activeCrews;
            document.getElementById('returnedCrews').textContent = returnedCrews;
            document.getElementById('penalizedCrews').textContent = penalizedCrews;

            // Update activity counts
            document.getElementById('regCount').textContent = crews.filter(c => (c.registration || 0) > 0).length;
            document.getElementById('clueCount').textContent = crews.filter(c => (c.clueHunt || 0) > 0).length;
            document.getElementById('quizCount').textContent = crews.filter(c => (c.quiz || 0) > 0).length;
            document.getElementById('kindnessCount').textContent = crews.filter(c => (c.kindness || 0) > 0).length;
            document.getElementById('limerickCount').textContent = crews.filter(c => (c.limerick || 0) > 0).length;
        }

        // Existing functions remain the same...
        async function startAdventure() {
            await loadCurrentState();
            
            if (adventureState.hasEnded) {
                alert('⚠️ Cannot restart adventure that has been completed!\n\nUse "Reset Timer" to prepare for a new adventure.');
                return;
            }
            
            if (adventureState.resultsPublished) {
                alert('⚠️ Cannot restart - results have been published!\n\nUse "Reset Timer" to prepare for a new adventure.');
                return;
            }
            
            if (adventureState.isRunning && !adventureState.isPaused) {
                alert('⚠️ Adventure is already running!');
                return;
            }

            try {
                const action = adventureState.isPaused ? 'start' : 'start';
                
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    if (adventureState.isPaused) {
                        adventureState.isPaused = false;
                    } else {
                        adventureState.isRunning = true;
                        adventureState.startTime = new Date();
                        adventureState.timeRemaining = 90 * 60;
                        adventureState.hasEnded = false;
                        adventureState.penaltyMode = false;
                        adventureState.penaltyMinutes = 0;
                    }

                    adventureState.isRunning = true;
                    startTimer();
                    
                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('🚀 Adventure launched! The treasure hunt has begun!', 'success');
                    
                    setTimeout(loadCurrentState, 2000);
                    
                } else {
                    throw new Error(result.error || 'Failed to start adventure');
                }
            } catch (error) {
                console.error('Error starting adventure:', error);
                showMessage(`Failed to launch adventure: ${error.message}`, 'error');
            }
        }

        async function pauseAdventure() {
            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'stop'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    adventureState.isPaused = true;
                    adventureState.isRunning = false;
                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('⏸️ Adventure paused. Crews await your signal to continue.', 'success');
                } else {
                    throw new Error(result.error || 'Failed to pause adventure');
                }
            } catch (error) {
                console.error('Error pausing adventure:', error);
                showMessage('Failed to pause adventure.', 'error');
            }
        }

        async function stopAdventure() {
            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'stop'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    adventureState.isRunning = false;
                    adventureState.isPaused = false;
                    adventureState.hasEnded = true;
                    
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    
                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('⚓ Adventure ended. All crews return to harbour.', 'success');
                } else {
                    throw new Error(result.error || 'Failed to stop adventure');
                }
            } catch (error) {
                console.error('Error stopping adventure:', error);
                showMessage('Failed to end adventure.', 'error');
            }
        }

        async function resetTimer() {
            if (!confirm('Reset competition? This will clear all data and prepare for a new adventure.')) return;
            
            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'reset'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    adventureState.isRunning = false;
                    adventureState.isPaused = false;
                    adventureState.timeRemaining = 90 * 60;
                    adventureState.resultsPublished = false;
                    adventureState.hasEnded = false;
                    adventureState.penaltyMode = false;
                    adventureState.penaltyMinutes = 0;
                    adventureState.allTeamsReturned = false;
                    
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    
                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('🔄 Timer reset to 90 minutes. Ready for a new adventure!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to reset timer');
                }
            } catch (error) {
                console.error('Error resetting timer:', error);
                showMessage('Failed to reset timer.', 'error');
            }
        }

        async function publishResults() {
            if (!confirm('Are ye absolutely certain ye want to publish the final results? This will unfreeze the leaderboard and unlock the treasure gallery for all crews to see. This action cannot be undone!')) {
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'publish_results'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    adventureState.resultsPublished = true;
                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('🏆 Final results published! The treasure gallery is now unlocked and the leaderboard unfrozen for all crews to see!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to publish results');
                }
            } catch (error) {
                console.error('Error publishing results:', error);
                showMessage(`Failed to publish results: ${error.message}`, 'error');
            }
        }

        function emergencyStop() {
            if (confirm('Are ye sure ye want to emergency stop the entire treasure hunt? This will immediately halt all quest activities across the realm!')) {
                stopAdventure();
                showMessage('🚨 EMERGENCY STOP activated. All adventure activities halted by Captain\'s orders.', 'error');
            }
        }

        function toggleCrewLock(teamCode, isLocked) {
            console.log(`${isLocked ? 'Locking' : 'Unlocking'} ${teamCode} doubloons`);
            showMessage(`Crew ${teamCode} doubloons ${isLocked ? 'locked' : 'unlocked'}`, 'success');
            
            const crew = adventureState.crews.find(c => (c.teamCode || c.code) === teamCode);
            if (crew) {
                crew.locked = isLocked;
            }
        }

        function showMessage(text, type) {
            const messagesContainer = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = type === 'error' ? 'error-message' : 'success-message';
            message.textContent = text;
            
            messagesContainer.appendChild(message);
            
            setTimeout(() => {
                if (messagesContainer.contains(message)) {
                    messagesContainer.removeChild(message);
                }
            }, 5000);
        }

        window.addEventListener('beforeunload', function() {
            if (timerInterval) clearInterval(timerInterval);
            if (dataRefreshInterval) clearInterval(dataRefreshInterval);
        });
    </script>
</body>
</html>
