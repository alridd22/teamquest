<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terry's Treasure Hunt Command Centre</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 30%, #F4A460 100%);
            min-height: 100vh;
            color: #3E2723;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255,215,0,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255,140,0,0.1) 0%, transparent 50%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,215,0,0.3)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,140,0,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(218,165,32,0.2)"/></svg>');
            pointer-events: none;
            z-index: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .logo {
            font-size: 3em;
            margin-bottom: 10px;
            filter: drop-shadow(2px 2px 4px rgba(139,69,19,0.3));
            animation: gentle-sway 3s ease-in-out infinite;
        }

        @keyframes gentle-sway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #3E2723;
            text-shadow: 3px 3px 6px rgba(255,255,255,0.8), 1px 1px 3px rgba(0,0,0,0.8);
        }

        .subtitle {
            color: #A0522D;
            font-size: 1.3em;
            font-weight: 600;
        }

        .terry-greeting {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin: 30px auto 40px;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 20px;
            padding: 25px;
            border: 3px solid #DAA520;
            box-shadow: 0 5px 15px rgba(139,69,19,0.2);
            max-width: 900px;
            position: relative;
            z-index: 1;
        }

        .terry-character {
            flex-shrink: 0;
        }

        .terry-character img {
            width: 120px !important;
            height: 120px !important;
            border-radius: 15px !important;
            border: 4px solid #DAA520;
            box-shadow: 0 4px 12px rgba(139,69,19,0.3);
            object-fit: cover;
            background: linear-gradient(135deg, #8B4513, #A0522D);
            display: block;
        }

        .terry-speech {
            flex: 1;
            position: relative;
        }

        .terry-speech::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 15px 15px 15px 0;
            border-color: transparent #FFD700 transparent transparent;
        }

        .terry-note {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #8B4513;
            padding: 25px;
            border-radius: 15px;
            margin: 0;
            border: 3px solid #DAA520;
            position: relative;
            font-weight: 500;
            line-height: 1.6;
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            position: relative;
            z-index: 1;
        }

        .control-panel {
            background: linear-gradient(145deg, #F5E6D3 0%, #E8D7C3 100%);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
            border: 3px solid #8B4513;
            position: relative;
            overflow: hidden;
        }

        .control-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #DAA520, #FFD700);
        }

        .control-panel::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 2px solid #DAA520;
            border-radius: 20px;
            pointer-events: none;
        }

        .section-title {
            font-size: 1.6em;
            margin-bottom: 25px;
            color: #8B4513;
            border-bottom: 3px solid #DAA520;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .adventure-control {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        .timer-display {
            font-size: 3.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #8B4513;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 15px;
            border: 3px solid #DAA520;
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }

        .adventure-status {
            font-size: 1.3em;
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            border: 2px solid;
        }

        .status-stopped { 
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%); 
            border-color: #DC143C; 
            color: #8B0000;
        }
        .status-running { 
            background: linear-gradient(135deg, #98FB98 0%, #90EE90 100%); 
            border-color: #32CD32; 
            color: #006400;
        }
        .status-paused { 
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%); 
            border-color: #FF8C00; 
            color: #8B4513;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        .btn {
            padding: 18px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 3px solid #8B4513;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .btn-start { 
            background: linear-gradient(135deg, #32CD32, #228B22); 
            color: white; 
        }
        .btn-pause { 
            background: linear-gradient(135deg, #FFD700, #FF8C00); 
            color: #8B4513; 
        }
        .btn-stop { 
            background: linear-gradient(135deg, #DC143C, #B22222); 
            color: white; 
        }
        .btn-reset { 
            background: linear-gradient(135deg, #A0522D, #8B4513); 
            color: white; 
        }
        .btn-publish {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #8B4513;
            font-size: 1.3em;
            padding: 20px 30px;
            border: 4px solid #DAA520;
            grid-column: 1 / -1;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        /* Results Management Section */
        .results-management {
            background: linear-gradient(135deg, #FFFACD 0%, #F0E68C 100%);
            border: 3px solid #DAA520;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            z-index: 2;
        }

        .results-management h3 {
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .results-status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .results-unpublished {
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%);
            border: 2px solid #FF8C00;
            color: #8B4513;
        }

        .results-published {
            background: linear-gradient(135deg, #98FB98 0%, #90EE90 100%);
            border: 2px solid #32CD32;
            color: #006400;
        }

        .publish-warning {
            background: linear-gradient(135deg, #FFCCCB 0%, #FFA07A 100%);
            border: 2px solid #DC143C;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            color: #8B0000;
            font-weight: 600;
        }

        .emergency-controls {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
            border: 3px solid #DC143C;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            z-index: 2;
        }

        .emergency-controls h3 {
            color: #8B0000;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .crews-panel {
            background: linear-gradient(145deg, #F5E6D3 0%, #E8D7C3 100%);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
            border: 3px solid #8B4513;
            position: relative;
            overflow: hidden;
        }

        .crews-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #DAA520, #FFD700);
        }

        .crews-panel::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 2px solid #DAA520;
            border-radius: 20px;
            pointer-events: none;
        }

        .crews-grid {
            display: grid;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            z-index: 2;
        }

        .crew-card {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #DAA520;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(139,69,19,0.1);
        }

        .crew-card:hover {
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139,69,19,0.2);
        }

        .crew-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .crew-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #8B4513;
        }

        .crew-doubloons {
            font-size: 1.5em;
            color: #DAA520;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .crew-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .status-select {
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #DAA520;
            background: linear-gradient(145deg, #FFFFFF 0%, #FFF8DC 100%);
            color: #8B4513;
            font-size: 0.9em;
            font-weight: 600;
        }

        .return-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #8B4513;
            font-weight: 500;
        }

        .return-checkbox input[type="checkbox"] {
            transform: scale(1.3);
            accent-color: #DAA520;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 40px;
            position: relative;
            z-index: 1;
        }

        .stat-card {
            background: linear-gradient(145deg, #F5E6D3 0%, #E8D7C3 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 3px solid #8B4513;
            box-shadow: 0 5px 15px rgba(139,69,19,0.2);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #DAA520, #FFD700);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #8B4513;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 1em;
            color: #A0522D;
            margin-top: 8px;
            font-weight: 600;
        }

        .activity-summary {
            margin-top: 25px;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #DAA520;
            position: relative;
            z-index: 2;
        }

        .activity-summary h3 {
            color: #8B4513;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 700;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .activity-item {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%);
            border-radius: 10px;
            border: 2px solid #DAA520;
            font-weight: 600;
            color: #8B4513;
        }

        .activity-item div:first-child {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .activity-item div:last-child {
            font-size: 1.2em;
            font-weight: 700;
            color: #A0522D;
        }

        .loading {
            text-align: center;
            opacity: 0.8;
            padding: 25px;
            color: #8B4513;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }

        .success-message, .error-message {
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            border: 2px solid;
            position: relative;
            z-index: 2;
        }

        .success-message {
            background: linear-gradient(135deg, #98FB98 0%, #90EE90 100%);
            border-color: #32CD32;
            color: #006400;
        }

        .error-message {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
            border-color: #DC143C;
            color: #8B0000;
        }

        @media (max-width: 1200px) {
            .admin-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .activity-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .terry-greeting {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .terry-speech::before {
                display: none;
            }

            .terry-character img {
                width: 100px !important;
                height: 100px !important;
            }

            h1 {
                font-size: 2.2em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">🏴‍☠️</div>
        <h1>Terry's Treasure Hunt Command Centre</h1>
        <p class="subtitle">Captain's Bridge for Managing the Grand Adventure</p>
    </div>

    <div class="terry-greeting">
        <div class="terry-character">
            <img src="/terry-clock.png" alt="Captain Terry" class="terry-image">
        </div>
        <div class="terry-speech">
            <div class="terry-note">
                <strong>Welcome to me command centre, Admiral!</strong> From this helm, ye can steer the entire treasure hunt adventure. Start the quest timer, monitor yer brave crews, and when the final moment arrives, use the golden "Publish Results" treasure chest to unlock the final standings and gallery for all to see!
            </div>
        </div>
    </div>

    <div class="admin-container">
        <!-- Adventure Control Panel -->
        <div class="control-panel">
            <h2 class="section-title">⚓ Adventure Control</h2>
            
            <div class="adventure-control">
                <div class="timer-display" id="timerDisplay">01:30:00</div>
                <div class="adventure-status status-stopped" id="timerStatus">
                    🏴‍☠️ Adventure Awaiting Launch
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-start" id="startBtn" onclick="startAdventure()">
                        🚀 Launch Adventure
                    </button>
                    <button class="btn btn-pause" id="pauseBtn" onclick="pauseAdventure()" disabled>
                        ⏸️ Pause Quest
                    </button>
                    <button class="btn btn-stop" id="stopBtn" onclick="stopAdventure()" disabled>
                        ⏹️ End Adventure
                    </button>
                    <button class="btn btn-reset" id="resetBtn" onclick="resetTimer()">
                        🔄 Reset Timer
                    </button>
                    <button class="btn btn-publish" id="publishBtn" onclick="publishResults()" disabled>
                        🏆 Publish Final Results & Unlock Gallery
                    </button>
                </div>
            </div>

            <!-- Results Management Section -->
            <div class="results-management" id="resultsManagement">
                <h3>🏆 Final Results Management</h3>
                
                <div class="results-status" id="resultsStatus">
                    🔒 Results not published - Gallery locked
                </div>

                <div class="publish-warning" id="publishWarning" style="display: none;">
                    ⚠️ <strong>Captain's Notice:</strong> Publishing results will unfreeze the leaderboard and unlock the treasure gallery for all crews. This action cannot be undone!
                </div>
            </div>

            <div class="emergency-controls">
                <h3>🚨 Emergency Captain's Orders</h3>
                <button class="btn btn-stop" onclick="emergencyStop()" style="width: 100%; margin-top: 15px;">
                    ⚠️ Emergency All Stop
                </button>
            </div>

            <div class="activity-summary">
                <h3>🗺️ Quest Activity Overview</h3>
                <div class="activity-grid">
                    <div class="activity-item">
                        <div>Crew Registration</div>
                        <div id="regCount">-</div>
                    </div>
                    <div class="activity-item">
                        <div>Treasure Map</div>
                        <div id="clueCount">-</div>
                    </div>
                    <div class="activity-item">
                        <div>Knowledge Challenge</div>
                        <div id="quizCount">-</div>
                    </div>
                    <div class="activity-item">
                        <div>Heart Treasures</div>
                        <div id="kindnessCount">-</div>
                    </div>
                    <div class="activity-item">
                        <div>Verse Vault</div>
                        <div id="limerickCount">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crews Management Panel -->
        <div class="crews-panel">
            <h2 class="section-title">👥 Crew Management</h2>
            
            <div id="loading" class="loading">
                🔍 Loading crew data from the treasure logs...
            </div>
            
            <div id="crewsContent" style="display: none;">
                <div class="crews-grid" id="crewsGrid">
                    <!-- Crew cards will be populated here -->
                </div>
            </div>
            
            <div id="messages"></div>
        </div>
    </div>

    <!-- Treasure Statistics Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-number" id="totalCrews">-</div>
            <div class="stat-label">Total Crews</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="activeCrews">-</div>
            <div class="stat-label">Active Crews</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="returnedCrews">-</div>
            <div class="stat-label">Returned Crews</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avgDoubloons">-</div>
            <div class="stat-label">Average Doubloons</div>
        </div>
    </div>

    <script>
        // Adventure state management
        let adventureState = {
            isRunning: false,
            isPaused: false,
            timeRemaining: 90 * 60, // 90 minutes in seconds
            startTime: null,
            crews: [],
            resultsPublished: false,
            competitionData: null,
            competitionStatus: 'stopped', // Track backend competition status
            competitionEnded: false // Track if competition has ended
        };

        let timerInterval = null;
        let dataRefreshInterval = null;

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            loadCrewData();
            updateTimerDisplay();
            updateButtonStates();
            
            // Auto-refresh crew data every 30 seconds
            dataRefreshInterval = setInterval(loadCrewData, 30000);
        });

        function formatTime(seconds) {
            if (seconds <= 0) return "QUEST COMPLETE!";
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            const status = document.getElementById('timerStatus');
            
            display.textContent = formatTime(adventureState.timeRemaining);
            
            // Sync with backend competition status
            if (adventureState.competitionStatus === 'running' && !adventureState.isPaused) {
                status.innerHTML = '🏴‍☠️ Adventure in Progress';
                status.className = 'adventure-status status-running';
                display.style.color = '#006400';
            } else if (adventureState.isPaused || adventureState.competitionStatus === 'paused') {
                status.innerHTML = '⏸️ Quest Paused';
                status.className = 'adventure-status status-paused';
                display.style.color = '#8B4513';
            } else if (adventureState.competitionStatus === 'stopped' && adventureState.competitionEnded) {
                status.innerHTML = '⚓ Adventure Ended - Results Ready';
                status.className = 'adventure-status status-stopped';
                display.style.color = '#8B4513';
            } else {
                status.innerHTML = '🏴‍☠️ Adventure Awaiting Launch';
                status.className = 'adventure-status status-stopped';
                display.style.color = '#8B4513';
            }

            // Change color based on time remaining
            if (adventureState.timeRemaining <= 300 && adventureState.competitionStatus === 'running') { // Last 5 minutes
                display.style.color = '#DC143C';
            } else if (adventureState.timeRemaining <= 900 && adventureState.competitionStatus === 'running') { // Last 15 minutes
                display.style.color = '#FF8C00';
            }
        }

        function updateButtonStates() {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            const resetBtn = document.getElementById('resetBtn');

            if (adventureState.competitionStatus === 'running' && !adventureState.isPaused) {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                resetBtn.disabled = true;
            } else if (adventureState.isPaused || adventureState.competitionStatus === 'paused') {
                startBtn.disabled = false;
                startBtn.innerHTML = '▶️ Resume Quest';
                pauseBtn.disabled = true;
                stopBtn.disabled = false;
                resetBtn.disabled = true;
            } else {
                startBtn.disabled = false;
                startBtn.innerHTML = '🚀 Launch Adventure';
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                resetBtn.disabled = false;
            }
        }

        function updateResultsManagement() {
            const resultsStatus = document.getElementById('resultsStatus');
            const publishBtn = document.getElementById('publishBtn');
            const publishWarning = document.getElementById('publishWarning');

            if (adventureState.resultsPublished) {
                resultsStatus.innerHTML = '🏆 Results Published - Gallery Unlocked';
                resultsStatus.className = 'results-status results-published';
                publishBtn.disabled = true;
                publishBtn.innerHTML = '🏆 Results Already Published';
                publishWarning.style.display = 'none';
            } else {
                resultsStatus.innerHTML = '🔒 Results Not Published - Gallery Locked';
                resultsStatus.className = 'results-status results-unpublished';
                
                // FIXED LOGIC: Enable publish button if:
                // 1. Competition is running and 20 minutes or less remaining, OR
                // 2. Timer naturally reached 0, OR  
                // 3. Competition has been manually ended (stopped)
                const timeLeftMinutes = Math.floor(adventureState.timeRemaining / 60);
                const canPublish = (timeLeftMinutes <= 20 && adventureState.competitionStatus === 'running') || 
                                 adventureState.timeRemaining <= 0 || 
                                 (adventureState.competitionStatus === 'stopped' && adventureState.competitionEnded);
                
                if (canPublish) {
                    publishBtn.disabled = false;
                    publishWarning.style.display = 'block';
                } else {
                    publishBtn.disabled = true;
                    publishWarning.style.display = 'none';
                }
            }
        }

        async function publishResults() {
            if (!confirm('Are ye absolutely certain ye want to publish the final results? This will unfreeze the leaderboard and unlock the treasure gallery for all crews to see. This action cannot be undone!')) {
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'publish_results'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    adventureState.resultsPublished = true;
                    updateResultsManagement();
                    showMessage('🏆 Final results published! The treasure gallery is now unlocked and the leaderboard unfrozen for all crews to see!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to publish results');
                }
            } catch (error) {
                console.error('Error publishing results:', error);
                showMessage(`Failed to publish results: ${error.message}`, 'error');
            }
        }

        async function loadCrewData() {
            try {
                const response = await fetch('/.netlify/functions/get_leaderboard_function');
                const data = await response.json();
                
                if (data.success) {
                    adventureState.crews = data.teams || data.leaderboard || [];
                    adventureState.resultsPublished = data.resultsPublished || false;
                    adventureState.competitionData = data;
                    
                    // SYNC BACKEND STATE: Update local state based on backend competition status
                    if (data.competitionStatus) {
                        const backendStatus = data.competitionStatus.toLowerCase();
                        // FIXED: Map "start" to "running" for frontend consistency
                        adventureState.competitionStatus = backendStatus === 'start' ? 'running' : backendStatus;
                        
                        console.log('Backend status:', backendStatus, '-> Frontend status:', adventureState.competitionStatus);
                        
                        // If backend shows stopped and we have a start time, competition has ended
                        if (backendStatus === 'stopped' && data.startTime) {
                            adventureState.competitionEnded = true;
                            adventureState.isRunning = false;
                            adventureState.isPaused = false;
                            
                            // Calculate remaining time based on start time and duration
                            if (data.startTime && data.durationMinutes) {
                                const startTime = new Date(data.startTime);
                                const endTime = new Date(startTime.getTime() + (data.durationMinutes * 60 * 1000));
                                const now = new Date();
                                const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));
                                adventureState.timeRemaining = timeLeft;
                            }
                        } else if (backendStatus === 'running') {
                            adventureState.competitionEnded = false;
                            adventureState.isRunning = true;
                            adventureState.isPaused = false;
                            
                            // Start local timer if not already running
                            if (!timerInterval) {
                                timerInterval = setInterval(() => {
                                    if (adventureState.competitionStatus === 'running' && !adventureState.isPaused) {
                                        adventureState.timeRemaining--;
                                        
                                        if (adventureState.timeRemaining <= 0) {
                                            stopAdventure();
                                            showMessage('🏆 Adventure time has ended! All crews return to base!', 'success');
                                        }
                                        
                                        updateTimerDisplay();
                                        updateResultsManagement();
                                    }
                                }, 1000);
                            }
                        } else {
                            // Backend shows stopped but no evidence of a previous competition
                            adventureState.competitionEnded = false;
                            adventureState.isRunning = false;
                            adventureState.isPaused = false;
                        }
                        
                        // Update UI based on synchronized state
                        updateButtonStates();
                        updateTimerDisplay();
                    }
                    
                    renderCrews(adventureState.crews);
                    updateStatistics(adventureState.crews);
                    updateResultsManagement();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('crewsContent').style.display = 'block';
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error loading crew data:', error);
                showMessage('Failed to load crew data from the treasure logs. ' + error.message, 'error');
            }
        }

        async function startAdventure() {
            try {
                const action = adventureState.isPaused ? 'start' : 'start';
                
                console.log('Starting adventure with action:', action);
                
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action
                    })
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Start competition result:', result);
                
                if (result.success) {
                    // FIXED: Clear any existing timer to prevent conflicts
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    
                    if (adventureState.isPaused) {
                        // Resume from pause
                        adventureState.isPaused = false;
                    } else {
                        // Start fresh
                        adventureState.isRunning = true;
                        adventureState.startTime = new Date();
                        adventureState.competitionEnded = false;
                        // FIXED: Always reset to 90 minutes when starting fresh
                        adventureState.timeRemaining = 90 * 60;
                    }

                    adventureState.isRunning = true;
                    adventureState.competitionStatus = 'running';
                    
                    // Start timer countdown
                    timerInterval = setInterval(() => {
                        if (adventureState.competitionStatus === 'running' && !adventureState.isPaused) {
                            adventureState.timeRemaining--;
                            
                            if (adventureState.timeRemaining <= 0) {
                                stopAdventure();
                                showMessage('🏆 Adventure time has ended! All crews return to base!', 'success');
                            }
                            
                            updateTimerDisplay();
                            updateResultsManagement(); // Update publish button availability
                        }
                    }, 1000);

                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('🚀 Adventure launched! The treasure hunt has begun! Leaderboard will update within 30 seconds.', 'success');
                    
                    // Force refresh crew data to pick up any changes
                    setTimeout(() => {
                        loadCrewData();
                    }, 2000);
                    
                } else {
                    throw new Error(result.error || 'Failed to start adventure');
                }
            } catch (error) {
                console.error('Error starting adventure:', error);
                showMessage(`Failed to launch adventure: ${error.message}. Please check browser console for details.`, 'error');
            }
        }

        async function pauseAdventure() {
            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'stop' // Using stop for pause functionality
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    adventureState.isPaused = true;
                    adventureState.competitionStatus = 'paused';
                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('⏸️ Adventure paused. Crews await your signal to continue.', 'success');
                } else {
                    throw new Error(result.error || 'Failed to pause adventure');
                }
            } catch (error) {
                console.error('Error pausing adventure:', error);
                showMessage('Failed to pause adventure.', 'error');
            }
        }

        async function stopAdventure() {
            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'stop'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    adventureState.isRunning = false;
                    adventureState.isPaused = false;
                    adventureState.competitionStatus = 'stopped';
                    adventureState.competitionEnded = true; // Mark as ended when manually stopped
                    
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    
                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('⚓ Adventure ended. All crews return to harbour.', 'success');
                } else {
                    throw new Error(result.error || 'Failed to stop adventure');
                }
            } catch (error) {
                console.error('Error stopping adventure:', error);
                showMessage('Failed to end adventure.', 'error');
            }
        }

        async function resetTimer() {
            try {
                const response = await fetch('/.netlify/functions/start_competition_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'reset'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    adventureState.isRunning = false;
                    adventureState.isPaused = false;
                    adventureState.timeRemaining = 90 * 60; // Reset to 90 minutes
                    adventureState.resultsPublished = false; // Reset results published status
                    adventureState.competitionStatus = 'stopped';
                    adventureState.competitionEnded = false; // Reset ended flag
                    
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    
                    updateButtonStates();
                    updateTimerDisplay();
                    updateResultsManagement();
                    showMessage('🔄 Timer reset to 90 minutes. Ready for a new adventure!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to reset timer');
                }
            } catch (error) {
                console.error('Error resetting timer:', error);
                showMessage('Failed to reset timer.', 'error');
            }
        }

        function emergencyStop() {
            if (confirm('Are ye sure ye want to emergency stop the entire treasure hunt? This will immediately halt all quest activities across the realm!')) {
                stopAdventure();
                showMessage('🚨 EMERGENCY STOP activated. All adventure activities halted by Captain\'s orders.', 'error');
            }
        }

        function renderCrews(crews) {
            const container = document.getElementById('crewsGrid');
            container.innerHTML = '';

            crews.forEach(crew => {
                const crewCard = document.createElement('div');
                crewCard.className = 'crew-card';
                
                const totalScore = crew.totalScore || crew.total || 0;
                const teamCode = crew.teamCode || crew.code || '';
                const teamName = crew.teamName || crew.name || 'Unknown Crew';
                const status = crew.status || 'active';
                const locked = crew.locked || false;
                
                crewCard.innerHTML = `
                    <div class="crew-header">
                        <div class="crew-name">${teamName}</div>
                        <div class="crew-doubloons">${totalScore} 🪙</div>
                    </div>
                    <div class="crew-controls">
                        <select class="status-select" onchange="updateCrewStatus('${teamCode}', this.value)">
                            <option value="active" ${status === 'active' ? 'selected' : ''}>🏴‍☠️ Active</option>
                            <option value="returned" ${status === 'returned' ? 'selected' : ''}>⚓ Returned</option>
                            <option value="late" ${status === 'late' ? 'selected' : ''}>⏰ Late</option>
                        </select>
                        <label class="return-checkbox">
                            <input type="checkbox" ${locked ? 'checked' : ''} 
                                   onchange="toggleCrewLock('${teamCode}', this.checked)">
                            🔒 Lock Doubloons
                        </label>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9em; color: #8B4513; font-weight: 500;">
                        ${teamCode} | Reg: ${crew.registration || 0} | Map: ${crew.clueHunt || 0} | Quiz: ${crew.quiz || 0}
                    </div>
                `;
                
                container.appendChild(crewCard);
            });
        }

        function updateStatistics(crews) {
            const totalCrews = crews.length;
            const activeCrews = crews.filter(c => (c.status || 'active') === 'active').length;
            const returnedCrews = crews.filter(c => (c.status || 'active') === 'returned').length;
            const avgDoubloons = totalCrews > 0 ? Math.round(crews.reduce((sum, c) => sum + (c.totalScore || c.total || 0), 0) / totalCrews) : 0;

            document.getElementById('totalCrews').textContent = totalCrews;
            document.getElementById('activeCrews').textContent = activeCrews;
            document.getElementById('returnedCrews').textContent = returnedCrews;
            document.getElementById('avgDoubloons').textContent = avgDoubloons;

            // Update activity counts
            document.getElementById('regCount').textContent = crews.filter(c => (c.registration || 0) > 0).length;
            document.getElementById('clueCount').textContent = crews.filter(c => (c.clueHunt || 0) > 0).length;
            document.getElementById('quizCount').textContent = crews.filter(c => (c.quiz || 0) > 0).length;
            document.getElementById('kindnessCount').textContent = crews.filter(c => (c.kindness || 0) > 0).length;
            document.getElementById('limerickCount').textContent = crews.filter(c => (c.limerick || 0) > 0).length;
        }

        function updateCrewStatus(teamCode, newStatus) {
            // In a real implementation, this would update the Google Sheet
            console.log(`Updating ${teamCode} status to ${newStatus}`);
            showMessage(`Crew ${teamCode} status updated to ${newStatus}`, 'success');
            
            // Update local state
            const crew = adventureState.crews.find(c => (c.teamCode || c.code) === teamCode);
            if (crew) {
                crew.status = newStatus;
            }
        }

        function toggleCrewLock(teamCode, isLocked) {
            // In a real implementation, this would update the Google Sheet
            console.log(`${isLocked ? 'Locking' : 'Unlocking'} ${teamCode} doubloons`);
            showMessage(`Crew ${teamCode} doubloons ${isLocked ? 'locked' : 'unlocked'}`, 'success');
            
            // Update local state
            const crew = adventureState.crews.find(c => (c.teamCode || c.code) === teamCode);
            if (crew) {
                crew.locked = isLocked;
            }
        }

        function showMessage(text, type) {
            const messagesContainer = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = type === 'error' ? 'error-message' : 'success-message';
            message.textContent = text;
            
            messagesContainer.appendChild(message);
            
            // Auto-remove message after 5 seconds
            setTimeout(() => {
                if (messagesContainer.contains(message)) {
                    messagesContainer.removeChild(message);
                }
            }, 5000);
        }

        // Cleanup intervals when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (timerInterval) clearInterval(timerInterval);
            if (dataRefreshInterval) clearInterval(dataRefreshInterval);
        });
    </script>
</body>
</html>
