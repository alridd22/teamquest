<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest ‚Äì Clue Hunt</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root { --gold:#DAA520; --amber:#FF8C00; --brown:#8B4513; --sand:#F5E6D3; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(135deg,#8B4513 0%,#D2691E 35%,#F4A460 100%); padding:24px}
    /* nav */
    .nav{position:sticky;top:0;z-index:10;background:linear-gradient(135deg,#8B4513,#654321);border:0;border-bottom:3px solid var(--gold);padding:8px 14px;display:flex;gap:16px;align-items:center}
    .nav img{height:36px}
    .wrap{max-width:980px;margin:24px auto;background:linear-gradient(145deg,#F5E6D3,#E8D7C3);border:3px solid var(--brown);border-radius:22px;padding:28px}
    h1{margin:0 0 4px;color:var(--brown)}
    .muted{color:#7a5a37;margin:0 0 18px}
    /* sections */
    .section{display:none}.section.active{display:block}
    /* card bits */
    .team{background:linear-gradient(135deg,#8B4513,#A0522D);border:2px solid var(--gold);color:#fff;padding:14px;border-radius:12px;text-align:center;font-weight:700;margin:10px 0 18px}
    .rulebox{background:linear-gradient(135deg,#FFF8DC,#F5E6D3);border-left:6px solid var(--amber);border:2px solid var(--gold);border-radius:12px;padding:16px;margin:16px 0}
    label{display:block;margin:10px 0 6px;color:var(--brown);font-weight:600}
    select,input[type="number"],input[type="text"]{width:100%;padding:14px;border-radius:10px;border:3px solid var(--gold);background:linear-gradient(145deg,#fff,#FFF8DC);font-size:16px}
    select:focus,input:focus{outline:none;border-color:#ff9a1f;box-shadow:0 0 0 3px rgba(255,140,0,.2)}
    .btn{width:100%;padding:16px;border-radius:12px;border:2px solid var(--brown);background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{display:none;margin:14px 0;padding:14px;border-radius:10px;border:2px solid}
    .msg.ok{display:block;background:#aaf0b3;border-color:#2e8b57;color:#084c1f}
    .msg.err{display:block;background:#ffb5c0;border-color:#b00020;color:#6b0014}
    /* grid */
    .score{background:linear-gradient(135deg,#FF8C00,#DAA520);border:3px solid var(--brown);color:#fff;border-radius:14px;text-align:center;padding:18px;font-weight:800;margin:10px 0 18px}
    .bar{border:3px solid var(--gold);border-radius:12px;background:linear-gradient(135deg,#A0522D,#8B4513);padding:5px;margin-bottom:20px}
    .fill{height:28px;border-radius:8px;background:linear-gradient(135deg,#FFD700,#FFA500);display:flex;align-items:center;justify-content:center;font-weight:800;color:#704a18}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px}
    .clue{padding:18px;border-radius:12px;border:3px solid var(--brown);background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;font-weight:800;cursor:pointer;position:relative}
    .clue.completed{background:linear-gradient(135deg,#32CD32,#228B22);border-color:#0d5d0d;cursor:not-allowed}
    .clue.incorrect{background:linear-gradient(135deg,#DC143C,#B22222);border-color:#7a0000;cursor:not-allowed}
    .clue.completed::after{content:"‚úì";position:absolute;top:6px;right:10px;font-size:18px}
    .clue.incorrect::after{content:"‚úó";position:absolute;top:6px;right:10px;font-size:18px}
    .panel{background:linear-gradient(135deg,#FFF8DC,#F5E6D3);border:3px solid var(--gold);border-radius:16px;padding:18px;margin-top:16px}
    .row{display:flex;justify-content:space-between;gap:12px;align-items:center}
    .back{padding:10px 14px;border-radius:10px;border:2px solid #654321;background:linear-gradient(135deg,#8B4513,#A0522D);color:#fff;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="nav">
    <a href="https://theteamquest.netlify.app/"><img src="/Team Quest Logo-01.png" alt="TeamQuest"></a>
  </div>

  <div class="wrap">
    <h1>Clue Hunt</h1>
    <p class="muted">Solve clues in any order. Each correct answer earns hidden doubloons.</p>

    <!-- ‚Äî‚Äî‚Äî Sign in ‚Äî‚Äî‚Äî -->
    <section id="signin" class="section active">
      <div class="rulebox">
        <ul style="margin:0 0 0 18px;line-height:1.7">
          <li>20 clues ‚Ä¢ one try each</li>
          <li>Hidden reward per clue (5‚Äì10)</li>
          <li>Come and go anytime ‚Äî progress saves</li>
        </ul>
      </div>

      <label for="teamSelect">Select your crew</label>
      <select id="teamSelect"><option value="">Loading‚Ä¶</option></select>

      <label for="teamPin">Crew PIN</label>
      <input id="teamPin" type="number" inputmode="numeric" placeholder="1234" min="1000" max="9999"/>

      <button id="signinBtn" class="btn" style="margin-top:12px">üìñ Begin Treasure Hunt</button>
      <div id="signinMsg" class="msg"></div>
    </section>

    <!-- ‚Äî‚Äî‚Äî Hunt ‚Äî‚Äî‚Äî -->
    <section id="hunt" class="section">
      <div id="crewTag" class="team">Crew: ‚Äî</div>
      <div id="scoreBox" class="score">Treasure: 0 doubloons</div>

      <div class="bar"><div id="fill" class="fill" style="width:15%">0/20 Solved ‚Ä¢ 0 Explored</div></div>

      <div id="gridWrap">
        <h3 style="color:#8B4513;margin:10px 0 14px">Pick a clue</h3>
        <div id="clueGrid" class="grid"></div>
      </div>

      <div id="cluePanel" class="panel" style="display:none">
        <div class="row">
          <strong id="clueTitle" style="color:#FF8C00">Clue #</strong>
          <button class="back" id="backBtn">‚Üê Back</button>
        </div>
        <p id="clueText" style="margin:12px 0 14px;font-weight:600;color:#654321"></p>
        <input id="answer" type="text" placeholder="Your answer‚Ä¶" maxlength="60"/>
        <button id="submitAnswer" class="btn" style="margin-top:10px">üí∞ Claim treasure</button>
        <div id="result" class="msg" style="margin-top:12px"></div>
      </div>
    </section>
  </div>

  <script>
    // ============ Config / helpers ============
    const EVENT_ID = new URLSearchParams(location.search).get('event') || localStorage.getItem('eventId') || '';
    const $ = id => document.getElementById(id);

    async function callFn(name, payload){
      const res = await fetch(`/.netlify/functions/${name}`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload || {})
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // ============ Team list + sign-in (same pattern as other activities) ============
    // ‚Äî‚Äî‚Äî Load teams (robust) ‚Äî‚Äî‚Äî
    function extractTeams(data){
      if(Array.isArray(data?.teams)) return data.teams;
      if(Array.isArray(data?.leaderboard)) {
        return data.leaderboard.map(r=>({ teamCode: r.teamCode || r.code || r.teamId || '', teamName: r.teamName || r.name || '' })).filter(t=>t.teamName);
      }
      if(Array.isArray(data?.rows)) {
        return data.rows.map(r=>({ teamCode: r.teamCode || r.code || '', teamName: r.teamName || r.name || '' })).filter(t=>t.teamName);
      }
      return [];
    }

    async function loadTeams(){
      try{
        // Try POST first (preferred)
        let data = await callFn('get_leaderboard', { eventId: EVENT_ID });
        let teams = extractTeams(data);

        // GET fallback
        if(!teams.length){
          const res = await fetch(`/.netlify/functions/get_leaderboard?eventId=${encodeURIComponent(EVENT_ID)}`);
          if(res.ok){ data = await res.json().catch(()=>({})); teams = extractTeams(data); }
        }

        if(!teams.length) throw new Error('No teams returned');

        teams.sort((a,b)=>(a.teamName||'').localeCompare(b.teamName||''));
        $('teamSelect').innerHTML = `<option value="">Choose your crew‚Ä¶</option>` +
          teams.map(t=>`<option value="${t.teamCode}">${t.teamName}</option>`).join('');
        clearSigninMsg();
      }catch(e){
        $('teamSelect').innerHTML = `<option value="">Couldn‚Äôt load teams</option>`;
        setSigninMsg('Couldn‚Äôt load team list. Refresh the page or try again.', 'error');
      }
    }

    function setSigninMsg(txt, kind='error'){ const el=$('signinMsg'); el.className='msg ' + (kind==='error'?'err':'ok'); el.textContent=txt; el.style.display='block'; }
    function clearSigninMsg(){ const el=$('signinMsg'); el.style.display='none'; el.textContent=''; el.className='msg'; }
    function updateCrewLabel(){ $('crewTag').textContent = 'Crew: ' + (localStorage.getItem('teamName') || localStorage.getItem('teamCode') || ''); }

    // ‚Äî‚Äî‚Äî Sign in (dropdown + PIN) ‚Äî‚Äî‚Äî
    async function signIn(){
      clearSigninMsg();
      const code = $('teamSelect').value;
      const pin  = (String($('teamPin').value || '')).trim();
      if(!code){ setSigninMsg('Pick your crew from the list.'); return; }
      if(!/^\d{4}$/.test(pin)){ setSigninMsg('Enter your 4-digit PIN.'); return; }

      try{
        const res = await callFn('verify_team_pin_function', { eventId: EVENT_ID, teamCode: code, pin });
        // expected: { success:true, valid:true, token?:string, teamName?:string }
        if(!res.valid){ setSigninMsg('That PIN doesn‚Äôt match this crew.'); return; }
        if(res.token) localStorage.setItem('teamToken', res.token);
        localStorage.setItem('teamCode', code);
        localStorage.setItem('teamName', res.teamName || ($('teamSelect').options[$('teamSelect').selectedIndex]?.textContent || ''));
        updateCrewLabel();
        setSigninMsg('Signed in. Loading your map‚Ä¶', 'success');
        await beginHunt(); // move into the hunt after success
      }catch(err){
        if(String(err.message).includes('HTTP 404')){
          setSigninMsg('Sign-in service is off. Enable verify_team_pin_function.', 'error');
        }else{
          setSigninMsg(err.message || 'Could not sign you in. Try again.', 'error');
        }
      }
    }

    // ============ Hunt state ============
    let currentTeam = null;
    let completedClues = {};  // { [id]: {points,answer,correctAnswer,completedAt,wasCorrect} }
    let currentScore = 0;
    let activeClue = null;

    // 20 simple placeholder clues (5‚Äì10 pts each; total 140)
    const clueData = [
      {id:1,clue:"What comes after zero?",answer:"one",accept:["one","1","One"],points:6},
      {id:2,clue:"What comes after one?",answer:"two",accept:["two","2","Two"],points:5},
      {id:3,clue:"What comes after two?",answer:"three",accept:["three","3","Three"],points:8},
      {id:4,clue:"What comes after three?",answer:"four",accept:["four","4","Four"],points:7},
      {id:5,clue:"What comes after four?",answer:"five",accept:["five","5","Five"],points:9},
      {id:6,clue:"What comes after five?",answer:"six",accept:["six","6","Six"],points:5},
      {id:7,clue:"What comes after six?",answer:"seven",accept:["seven","7","Seven"],points:7},
      {id:8,clue:"What comes after seven?",answer:"eight",accept:["eight","8","Eight"],points:6},
      {id:9,clue:"What comes after eight?",answer:"nine",accept:["nine","9","Nine"],points:5},
      {id:10,clue:"What comes after nine?",answer:"ten",accept:["ten","10","Ten"],points:8},
      {id:11,clue:"What comes after ten?",answer:"eleven",accept:["eleven","11","Eleven"],points:10},
      {id:12,clue:"What comes after eleven?",answer:"twelve",accept:["twelve","12","Twelve"],points:6},
      {id:13,clue:"What comes after twelve?",answer:"thirteen",accept:["thirteen","13","Thirteen"],points:7},
      {id:14,clue:"What comes after thirteen?",answer:"fourteen",accept:["fourteen","14","Fourteen"],points:5},
      {id:15,clue:"What comes after fourteen?",answer:"fifteen",accept:["fifteen","15","Fifteen"],points:9},
      {id:16,clue:"What comes after fifteen?",answer:"sixteen",accept:["sixteen","16","Sixteen"],points:6},
      {id:17,clue:"What comes after sixteen?",answer:"seventeen",accept:["seventeen","17","Seventeen"],points:8},
      {id:18,clue:"What comes after seventeen?",answer:"eighteen",accept:["eighteen","18","Eighteen"],points:7},
      {id:19,clue:"What comes after eighteen?",answer:"nineteen",accept:["nineteen","19","Nineteen"],points:5},
      {id:20,clue:"What comes after nineteen?",answer:"twenty",accept:["twenty","20","Twenty"],points:6}
    ];

    function norm(s){ return String(s||'').toLowerCase().trim().replace(/[^\w\s]/g,'').replace(/\s+/g,''); }
    function correct(user, clue){ const u=norm(user); return clue.accept.some(a=>norm(a)===u); }

    function renderGrid(){
      const g = $('clueGrid'); g.innerHTML='';
      clueData.forEach(c=>{
        const status = completedClues[c.id];
        const btn = document.createElement('button');
        btn.className = 'clue' + (status ? (status.wasCorrect ? ' completed' : ' incorrect') : '');
        btn.textContent = `Clue ${c.id}`;
        if(!status){
          btn.addEventListener('click', ()=>openClue(c));
        }else{
          btn.disabled = true;
        }
        g.appendChild(btn);
      });
    }

    function openClue(c){
      activeClue = c;
      $('gridWrap').style.display='none';
      $('cluePanel').style.display='block';
      $('clueTitle').textContent = `Clue ${c.id}`;
      $('clueText').textContent  = c.clue;
      $('result').style.display='none';
      $('answer').value='';
      $('answer').focus();
    }

    function backToGrid(){
      $('cluePanel').style.display='none';
      $('gridWrap').style.display='block';
      renderGrid();
    }

    function updateScoreUI(){
      $('scoreBox').textContent = `Treasure: ${currentScore} doubloons`;
      const attempted = Object.keys(completedClues).length;
      const solved = Object.values(completedClues).filter(v=>v.wasCorrect).length;
      const pct = Math.max(15, (attempted/clueData.length)*100);
      $('fill').style.width = `${pct}%`;
      $('fill').textContent = `${solved}/${clueData.length} Solved ‚Ä¢ ${attempted} Explored`;
    }

    async function submitActive(){
      const ans = $('answer').value.trim();
      if(!activeClue){ return; }
      if(!ans){ showResult('Enter an answer.', false, true); return; }

      const ok = correct(ans, activeClue);
      const points = ok ? activeClue.points : 0;

      completedClues[activeClue.id] = {
        points, answer:ans, correctAnswer:activeClue.answer,
        completedAt:new Date().toISOString(), wasCorrect:ok
      };
      if(ok) currentScore += points;

      updateScoreUI();
      renderGrid();

      showResult(
        ok ? `üéâ Correct! +${points} doubloons` : `‚úó Not quite. Correct answer: ${activeClue.answer} (worth ${activeClue.points})`,
        ok
      );

      // persist attempt
      try{
        const payload = {
          teamCode: localStorage.getItem('teamCode'),
          teamName: localStorage.getItem('teamName'),
          clueId: activeClue.id,
          clueText: activeClue.clue,
          userAnswer: ans,
          correctAnswer: activeClue.answer,
          points, currentScore, wasCorrect: ok, eventId: EVENT_ID
        };
        await callFn('submit_cluehunt_function', payload);
      }catch(e){ /* non-blocking */ }

      // small delay then return
      setTimeout(backToGrid, 1500);
    }

    function showResult(text, good, force=false){
      const el=$('result');
      el.className = 'msg ' + (good ? 'ok' : 'err');
      el.textContent = text;
      el.style.display = 'block';
    }

    // load prior attempts for this team (resume)
    async function loadPrevious(){
      completedClues = {}; currentScore = 0;
      try{
        const teamCode = localStorage.getItem('teamCode');
        if(!teamCode) return;
        const res = await callFn('get_cluehunt_submissions_function', { teamCode, eventId: EVENT_ID });
        if(res?.success && Array.isArray(res.submissions)){
          res.submissions.forEach(s=>{
            completedClues[s.clueId] = {
              points: s.points || 0,
              answer: s.userAnswer || '',
              correctAnswer: s.correctAnswer || '',
              completedAt: s.attemptTime || '',
              wasCorrect: (s.points||0) > 0
            };
          });
          currentScore = Number(res.totalScore || 0);
        }
      }catch(e){ /* ignore */ }
    }

    // Start the hunt UI
    async function beginHunt(){
      currentTeam = {
        teamCode: localStorage.getItem('teamCode') || '',
        teamName: localStorage.getItem('teamName') || ''
      };
      updateCrewLabel();
      await loadPrevious();
      updateScoreUI();
      renderGrid();
      $('signin').classList.remove('active');
      $('hunt').classList.add('active');
    }

    // ============ Wire up ============
    $('signinBtn').addEventListener('click', signIn);
    $('backBtn').addEventListener('click', backToGrid);
    $('submitAnswer').addEventListener('click', submitActive);
    $('answer').addEventListener('keydown', e=>{ if(e.key==='Enter') submitActive(); });

    // boot
    loadTeams();
  </script>
</body>
</html>
