<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta name="theme-color" content="#2A1F18">
  <title>TeamQuest - Gallery</title>

  <style>
    :root{
      --bg:url("/TQ%20Web%20extended%20background-100.jpg");
      --ink:#2E2114; --ink-soft:#6A5A47;
      --parchment:#F7EED8; --parchment-2:#F3E6CF; --paper:#FFFDF8;
      --gold:#F0C433; --gold-deep:#A7711F;
      --nav-h:64px;
      --radius-card:22px; --radius-sm:14px;
      --shadow-card:0 18px 40px rgba(0,0,0,.35);
      --shadow-soft:0 6px 18px rgba(0,0,0,.12);
      --gutter:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; color:var(--ink);
      background:linear-gradient(180deg, rgba(0,0,0,.24), rgba(0,0,0,.45)), var(--bg);
      background-size:cover; background-position:top center; background-attachment:fixed;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      padding-top:var(--nav-h);
    }

    /* NAV */
    .treasure-nav{position:fixed; top:0; left:0; right:0; z-index:1000; height:var(--nav-h);
      backdrop-filter:saturate(120%) blur(6px);
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      border-bottom:1px solid rgba(255,255,255,.18)}
    .nav-container{height:100%; padding:0 12px; display:flex; align-items:center; justify-content:space-between; max-width:1000px; margin:0 auto}
    .nav-logo img{height:40px; width:auto; display:block; filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}
    .nav-logo{pointer-events:none; cursor:default;}
    .nav-toggle{background:none;border:none;color:#F7EED8;font-size:1.6rem;cursor:pointer}
    .nav-menu{position:fixed; top:var(--nav-h); left:-100%; width:100%; height:calc(100vh - var(--nav-h));
      background:linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.72));
      display:flex; flex-direction:column; align-items:center; gap:14px; padding:18px 14px; transition:left .25s}
    .nav-menu.active{left:0}
    .nav-link,.dropdown-link{display:block; width:92%; max-width:360px; text-align:center; text-decoration:none; color:#F7EED8; font-weight:900;
      padding:12px 14px; border-radius:14px; background:rgba(247,238,216,.22); border:1px solid rgba(255,255,255,.3)}
    .nav-link:hover,.dropdown-link:hover{ background:rgba(247,238,216,.32) }

    /* HERO */
    .hero{min-height:220px; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; padding:24px var(--gutter) 18px; text-align:center}
    .brand-logo{width:min(220px,68vw); height:auto; margin-bottom:8px; filter: drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 10px 24px rgba(0,0,0,.35))}
    .hero-title{font-weight:900; font-size:22px; color:#F7EED8; letter-spacing:.2px; text-shadow:0 2px 6px rgba(0,0,0,.6)}

    /* CONTENT */
    .stack{ padding:0 var(--gutter) 28px }
    .panel{background:var(--parchment); border-radius:var(--radius-card); box-shadow:var(--shadow-card); padding:18px 16px; border:1px solid rgba(0,0,0,.06); margin:0 auto; max-width:1100px}
    h1{margin:0 0 6px; font-weight:900}
    .sub{color:var(--ink-soft); margin-bottom:12px; font-weight:700}

    .tabs{display:flex;gap:10px;margin:8px 0 14px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:999px; border:2px solid var(--gold-deep);
      background:linear-gradient(90deg, #FDBA2D, #F0C433); cursor:pointer; font-weight:900; color:#442812; box-shadow:0 6px 14px rgba(0,0,0,.12)}
    .tab.active{filter:brightness(1.05)}
    .tab.ghost{background:var(--parchment-2); color:var(--ink); border-color:#C6A168}

    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width: 600px){.grid{grid-template-columns:1fr}}

    .card{background:var(--paper); border:1px solid #ecdac7; border-radius:16px; padding:12px; box-shadow:var(--shadow-soft)}
    .card img{width:100%;height:200px;object-fit:cover;border-radius:12px;margin-bottom:8px;border:2px solid #e7d8c4}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0 8px}
    .team{font-weight:900;color:#4a351e}
    .tag{font-weight:900;font-size:12px;border:2px dashed #C6A168;border-radius:999px;padding:4px 10px;background:#fff0d1}
    .text{margin:6px 0 0; color:#4a3a26; line-height:1.5}

    .lock{background:#fff7e6;border:2px dashed #d69b45;border-radius:16px;padding:18px;text-align:center;font-weight:800;color:#6A5A47}
    .status{margin-top:12px;text-align:center;color:#6A5A47;font-weight:700}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo" aria-label="TeamQuest Home">
        <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest Logo">
      </a>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle menu">‚ò∞</button>
    </div>
    <ul class="nav-menu" id="nav-menu" role="menu">
      <li><a href="https://theteamquest.netlify.app/clue_hunt" class="nav-link" role="menuitem">üíé The Clue Hunt</a></li>
      <li><a href="https://theteamquest.netlify.app/scavenger" class="nav-link" role="menuitem">üîç The Scavenger Hunt</a></li>
      <li><a href="https://theteamquest.netlify.app/quiz" class="nav-link" role="menuitem">‚è∞ The Timed Quiz</a></li>
      <li><a href="https://theteamquest.netlify.app/limerick" class="nav-link" role="menuitem">üìù The Limerick Challenge</a></li>
      <li><a href="https://theteamquest.netlify.app/kindness" class="nav-link" role="menuitem">üíñ Kindness</a></li>
      <li><a href="https://theteamquest.netlify.app/leaderboard" class="dropdown-link" role="menuitem">üèÜ The Leaderboard</a></li>
    </ul>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest" class="brand-logo" width="640" height="480">
    <div class="hero-title">Gallery</div>
  </header>

  <main class="stack">
    <section class="panel">
      <h1>üèÖ Gallery</h1>
      <div class="sub">Limericks and Acts of Kindness from the adventure</div>

      <div id="lock" class="lock" style="display:none">üîí The gallery will unlock when results are published. Check back soon!</div>

      <div id="content" style="display:none">
        <div class="tabs">
          <button class="tab active" data-view="both">All</button>
          <button class="tab ghost" data-view="limerick">Limericks</button>
          <button class="tab ghost" data-view="kindness">Kindness</button>
        </div>

        <div id="grid" class="grid"></div>
        <div class="status" id="status">Loaded</div>
      </div>
    </section>
  </main>

  <script>
    // Mobile nav + persist ?event=
    (function(){
      const navToggle = document.getElementById('nav-toggle');
      const navMenu   = document.getElementById('nav-menu');
      navToggle?.addEventListener('click',()=>{ 
        navMenu.classList.toggle('active'); 
        navToggle.textContent = navMenu.classList.contains('active')?'‚úï':'‚ò∞'; 
      });
      document.addEventListener('click',e=>{
        const inside = navToggle.contains(e.target)||navMenu.contains(e.target);
        if(!inside && navMenu.classList.contains('active')){ 
          navMenu.classList.remove('active'); 
          navToggle.textContent='‚ò∞'; 
        }
      });
      const qs = new URLSearchParams(location.search);
      const EVENT_ID = qs.get('event') || qs.get('eventId') || '';
      if (!EVENT_ID) return;
      document.querySelectorAll('a.nav-link, a.dropdown-link, .nav-logo').forEach(a=>{
        try{
          const u = new URL(a.getAttribute('href'), location.origin);
          if (u.origin !== location.origin) return;
          if (!u.searchParams.get('event')) u.searchParams.set('event', EVENT_ID);
          a.setAttribute('href', `${u.pathname}?${u.searchParams.toString()}${u.hash}`);
        }catch{}
      });
    })();
  </script>

  <!-- Gallery logic with LKG protection -->
  <script>
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event') || qs.get('eventId') || '';

    const $ = s => document.querySelector(s);

    let data = { limerick: [], kindness: [] };

    function esc(s){ 
      return String(s||'').replace(/[&<>"']/g, m => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      )); 
    }
    function nl2br(s){ return esc(s).replace(/\n/g,'<br>'); }

    function guessMime(b64){
      if (b64.startsWith('iVBOR')) return 'image/png';
      if (b64.startsWith('R0lGOD')) return 'image/gif';
      if (b64.startsWith('UklGR')) return 'image/webp';
      return 'image/jpeg';
    }

    function normalizeItem(it){
      const teamName =
        it.teamName || it.team || it.crew || it.name || it.team_name || it.teamCode || 'Unknown Crew';
      const text =
        it.text || it.content || it.limerick || it.poem || it.what || it.description || '';
      const evt =
        it.eventId || it.event || it.event_id || '';
      let imageUrl =
        it.imageUrl || it.photoUrl || it.photo || it.image || '';

      const base64 = it.photoBase64 || it.imageBase64 || '';
      if (!imageUrl && base64 && base64.length > 50){
        imageUrl = base64.startsWith('data:')
          ? base64
          : `data:${guessMime(base64)};base64,${base64}`;
      }
      return { teamName, text, imageUrl, eventId: evt };
    }

    function normalizeResponse(j){
      const pub =
        (typeof j.published === 'boolean') ? j.published :
        (j.state ? String(j.state).toLowerCase() === 'published' : false);

      let lim = j.limerick || j.limericks || [];
      let kin = j.kindness || j.kindnesses || [];

      if (!Array.isArray(lim) && Array.isArray(j.items)){
        lim = j.items.filter(x => /limerick/i.test(x.activity || x.type || ''));
      }
      if (!Array.isArray(kin) && Array.isArray(j.items)){
        kin = j.items.filter(x => /kindness/i.test(x.activity || x.type || ''));
      }

      lim = (Array.isArray(lim) ? lim : []).map(normalizeItem);
      kin = (Array.isArray(kin) ? kin : []).map(normalizeItem);

      if (EVENT_ID){
        const wanted = String(EVENT_ID).trim().toUpperCase();
        const keep = (x) => !x.eventId || String(x.eventId).trim().toUpperCase() === wanted;
        lim = lim.filter(keep);
        kin = kin.filter(keep);
      }

      return { published: pub, limerick: lim, kindness: kin };
    }

    function cardHtml(e){
      const img = e.imageUrl ? `<img src="${esc(e.imageUrl)}" alt="evidence">` : '';
      const text = e.text ? `<div class="text">${nl2br(e.text)}</div>` : '';
      const tag = `<span class="tag">${e.activity ? esc(e.activity) : (img ? 'kindness' : 'limerick')}</span>`;
      return `
        <div class="card">
          ${img}
          <div class="meta">
            <div class="team">${esc(e.teamName)}</div>
            ${tag}
          </div>
          ${text}
        </div>
      `;
    }

    function render(view='both'){
      const items = [
        ...(view==='kindness' ? [] : data.limerick.map(x => ({...x, activity:'limerick'}))),
        ...(view==='limerick' ? [] : data.kindness.map(x => ({...x, activity:'kindness'}))),
      ];
      $('#grid').innerHTML = items.length
        ? items.map(cardHtml).join('')
        : `<div class="lock">No submissions yet.</div>`;
      $('#status').textContent =
        `Limericks ${data.limerick.length} ‚Ä¢ Kindness ${data.kindness.length} ‚Ä¢ Showing ${items.length}`;
    }

    function setTabs(){
      document.querySelectorAll('.tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.tab').forEach(b=>{
            b.classList.remove('active');
            b.classList.add('ghost');
          });
          btn.classList.add('active');
          btn.classList.remove('ghost');
          render(btn.dataset.view);
        });
      });
    }

    /* ==========================================================
       LKG SNAPSHOT: prevents blanking / re-locking on bad polls
       ========================================================== */

    let LKG_STATE = null; // { published, limerick, kindness }
    let LKG_TS = 0;

    async function fetchGallery(){
      const callAt = Date.now();
      let j;

      try {
        const base = '/.netlify/functions/get_gallery';
        const url = EVENT_ID ? `${base}?eventId=${encodeURIComponent(EVENT_ID)}` : base;
        const r = await fetch(url, { cache:'no-store' });
        j = await r.json();
      } catch {
        try {
          const alt = EVENT_ID
            ? `/.netlify/functions/get_gallery_function?eventId=${encodeURIComponent(EVENT_ID)}`
            : '/.netlify/functions/get_gallery_function';
          const r2 = await fetch(alt, { cache:'no-store' });
          j = await r2.json();
        } catch {
          // complete failure: keep whatever LKG we have
          return;
        }
      }

      const norm = normalizeResponse(j);

      // ignore malformed responses
      if (!norm || typeof norm.published !== 'boolean') return;

      // stale-response guard
      if (callAt < LKG_TS) return;

      LKG_STATE = norm;
      LKG_TS = callAt;

      applyGalleryState();
    }

    function applyGalleryState(){
      if (!LKG_STATE) return;

      if (!LKG_STATE.published){
        // not published yet -> show lock, hide content
        $('#lock').style.display = 'block';
        $('#content').style.display = 'none';
        return;
      }

      // published -> unlock and keep it unlocked
      data = LKG_STATE;

      $('#lock').style.display = 'none';
      $('#content').style.display = 'block';
      setTabs();
      render('both');
    }

    // Initial load
    fetchGallery().then(applyGalleryState);

    // Poll every 6 seconds
    setInterval(fetchGallery, 6000);
  </script>

  <!-- Safeguard: neutralize any link behavior on the logo element -->
  <script>
    (function(){
      document.querySelectorAll('.nav-logo[href]').forEach(a=>{
        a.removeAttribute('href');
        a.setAttribute('aria-disabled','true');
        a.setAttribute('tabindex','-1');
      });
    })();
  </script>
</body>
</html>
