<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeamQuest ‚Äî Terry‚Äôs Verse Vault</title>
  <style>
    /* ===== NAV ===== */
    .treasure-nav{position:fixed;inset:0 0 auto 0;height:80px;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:1000}
    .nav-container{max-width:1200px;margin:0 auto;height:100%;display:flex;align-items:center;justify-content:space-between;padding:0 20px}
    .nav-logo img{height:50px;width:auto;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5))}
    .nav-menu{display:flex;gap:28px;list-style:none;margin:0;padding:0}
    .nav-item{position:relative}
    .nav-link{display:block;color:#F5DEB3;text-decoration:none;font-weight:800;padding:10px 16px;border-radius:10px;background:rgba(101,67,33,.3);border:2px solid rgba(218,165,32,.4);text-shadow:1px 1px 2px rgba(0,0,0,.7)}
    .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff;transform:translateY(-1px)}
    .nav-dropdown{position:absolute;top:100%;left:0;background:linear-gradient(135deg,#654321,#8B4513);border:2px solid #DAA520;border-radius:10px;min-width:200px;opacity:0;visibility:hidden;transform:translateY(-8px);transition:.2s}
    .nav-item:hover .nav-dropdown{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-link{display:block;color:#F5DEB3;text-decoration:none;padding:12px 16px}
    .dropdown-link:hover{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff}
    .nav-toggle{display:none;background:none;border:none;font-size:1.8rem;color:#DAA520}

    @media (max-width:768px){
      .treasure-nav{height:120px}
      .nav-container{justify-content:center;position:relative}
      .nav-logo{position:absolute;left:50%;transform:translateX(-50%)}
      .nav-toggle{display:block;position:absolute;right:20px;top:50%;transform:translateY(-50%)}
      .nav-menu{position:fixed;top:120px;left:-100%;width:100%;height:calc(100vh - 120px);background:linear-gradient(135deg,#8B4513,#654321);flex-direction:column;align-items:center;gap:18px;padding-top:24px;transition:left .25s ease}
      .nav-menu.active{left:0}
      .nav-dropdown{position:static;opacity:1;visibility:visible;transform:none}
    }

    /* ===== PAGE ===== */
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:22px;padding-top:100px!important}
    @media (max-width:768px){body{padding-top:140px!important}}

    .container{background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border:3px solid #8B4513;border-radius:22px;max-width:720px;width:100%;padding:24px 20px;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .container::before{content:"";display:block;height:8px;border-radius:6px;margin:-10px -6px 18px;background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}

    h1{margin:0 0 6px;text-align:center;color:#8B4513;font-size:2.2rem}
    .subtitle{text-align:center;color:#A0522D;margin-bottom:14px}
    .banner{background:#fff8e6;border:2px dashed #DAA520;border-radius:12px;padding:10px 14px;margin-bottom:12px;color:#6e440b;font-weight:700}

    .section{background:#fff8e6;border:2px solid #DAA520;border-left:6px solid #FF8C00;border-radius:12px;padding:16px;margin:14px 0}
    .team-info{background:linear-gradient(135deg,#8B4513,#A0522D);color:#fff;border:2px solid #DAA520;border-radius:12px;padding:12px;text-align:center;font-weight:900;margin:12px 0}

    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:8px;color:#8B4513;font-weight:800}
    select,input[type="text"],textarea{width:100%;padding:14px;border:3px solid #DAA520;border-radius:12px;background:linear-gradient(145deg,#fff,#FFF8DC);font-size:16px}
    textarea{min-height:160px;resize:vertical;font-family:Georgia,serif;line-height:1.6}
    .char-count{text-align:right;font-size:.9rem;color:#8B4513;margin-top:6px}

    .submit-btn{width:100%;background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:none;padding:16px;border-radius:14px;font-weight:900;font-size:1.05rem;display:flex;align-items:center;justify-content:center;gap:10px;border:2px solid #8B4513;cursor:pointer}
    .submit-btn[disabled]{opacity:.6;cursor:not-allowed}

    .message{display:none;margin:14px 0;padding:14px;border-radius:12px;border:3px solid;font-weight:700;text-align:center}
    .success-message{background:linear-gradient(135deg,#98FB98,#90EE90);border-color:#32CD32;color:#064d06}
    .error-message{background:linear-gradient(135deg,#FFB6C1,#FFA0B4);border-color:#DC143C;color:#8B0000}
    .loading{display:none;text-align:center;font-weight:800;color:#8B4513;margin-top:10px}

    .examples{background:#fff;border:2px solid #DAA520;border-radius:12px;padding:16px}
    .example{font-family:Georgia,serif;background:linear-gradient(145deg,#fff,#FFF8DC);border:2px solid #DAA520;border-left:4px solid #FF8C00;border-radius:10px;padding:14px;line-height:1.5}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a class="nav-logo" href="https://theteamquest.netlify.app/">
        <img src="/Team Quest Logo-01.png" alt="TeamQuest Logo" />
      </a>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link">üéØ Activities ‚ñº</a>
          <div class="nav-dropdown">
            <a class="dropdown-link" href="https://theteamquest.netlify.app/clue_hunt_challenge">üíé The Treasure Hunt</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/scavenger_hunt">üîç The Scavenger Hunt</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/quiz_challenge">‚è∞ The Timed Quiz</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/kindness_challenge_page">‚ù§Ô∏è The Kindness Task</a>
          </div>
        </li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_leaderboard">üèÜ The Leaderboard</a></li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_gallery">üì∏ The Gallery</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle">‚ò∞</button>
    </div>
  </nav>

  <div class="container">
    <div class="banner" id="eventBanner" aria-live="polite">Event status‚Ä¶</div>

    <!-- LOGIN -->
    <section id="loginSection" class="section" aria-labelledby="loginTitle">
      <h1 id="loginTitle">üìù Terry‚Äôs Verse Vault</h1>
      <p class="subtitle">Write a limerick. Make us smile. Earn doubloons.</p>

      <div class="form-group">
        <label for="teamSelect">Choose your crew</label>
        <select id="teamSelect" disabled>
          <option>Loading crews‚Ä¶</option>
        </select>
      </div>

      <div class="form-group">
        <label for="teamPin">Crew PIN</label>
        <input id="teamPin" type="text" inputmode="numeric" pattern="\\d{4}" maxlength="4" placeholder="1234" />
      </div>

      <button id="signInBtn" class="submit-btn" disabled>üîì Sign in</button>
      <div id="loginMessage" class="message" aria-live="polite" role="status"></div>
    </section>

    <!-- CHALLENGE -->
    <section id="challengeSection" class="section" style="display:none">
      <div class="team-info" id="teamInfo">Crew: ‚Ä¶</div>

      <div class="examples" aria-hidden="true">
        <div class="example">
          A seeker of maps from of old,<br>
          Found X where the coastline was bold;<br>
          &nbsp;&nbsp;They dug by the bay,<br>
          &nbsp;&nbsp;As gulls swooped to play‚Äî<br>
          And out spilled a torrent of gold!
        </div>
      </div>

      <form id="limerickForm" novalidate>
        <div class="form-group">
          <label for="limerickTopic">Topic (optional)</label>
          <input id="limerickTopic" type="text" placeholder="e.g., pirates, maps, mysterious islands‚Ä¶" />
        </div>

        <div class="form-group">
          <label for="limerickText">Your limerick (5 lines)</label>
          <textarea id="limerickText" maxlength="500" placeholder="Type your limerick here‚Ä¶" required></textarea>
          <div class="char-count"><span id="charCount">500</span> characters left</div>
        </div>

        <button id="submitBtn" class="submit-btn" type="submit">ü™ô Submit for doubloons</button>
        <div id="loading" class="loading">Analysing your verse‚Ä¶</div>
        <div id="challengeMessage" class="message" aria-live="polite" role="status"></div>
      </form>
    </section>
  </div>

  <script>
    // ===== Shared constants =====
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event') || qs.get('eventId') || '';

    // ===== State =====
    let currentTeam = null;
    let allTeams = [];

    // ===== Helpers =====
    const $ = id => document.getElementById(id);
    function msg(id, text, type='success'){
      const el = $(id);
      el.textContent = text;
      el.className = `message ${type==='error' ? 'error-message' : 'success-message'}`;
      el.style.display = 'block';
    }

    // ===== Event state banner =====
    function setEventBanner(state){
      const el = $('eventBanner');
      if(state==='RUNNING') el.textContent = 'Event running ‚Äî submit your limerick when ready.';
      else if(state==='PAUSED') el.textContent = 'Event paused ‚Äî please wait.';
      else if(state==='ENDED') el.textContent = 'Event ended ‚Äî submissions closed.';
      else if(state==='PUBLISHED') el.textContent = 'Results published ‚Äî see the leaderboard & gallery.';
      else el.textContent = 'Checking event status‚Ä¶';
    }
    async function fetchEventState(){
      try{
        const res = await fetch('/.netlify/functions/get_event_state',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ eventId: EVENT_ID })
        });
        const data = await res.json().catch(()=> ({}));
        setEventBanner(data.state || '');
      }catch{ setEventBanner(''); }
    }

    // ===== Load crews (SAME method as Kindness: no legacy endpoint, no fallback) =====
    async function loadTeamsList(){
      try{
        const res = await fetch('/.netlify/functions/get_leaderboard',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ eventId: EVENT_ID || '' })
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        allTeams = Array.isArray(data?.teams) ? data.teams : [];
        if(!allTeams.length) throw new Error('No teams found');
        populateTeamDropdown(allTeams);
        $('teamSelect').disabled = false;
        $('signInBtn').disabled = false;
      }catch(err){
        console.error('loadTeamsList:', err);
        $('teamSelect').innerHTML = '<option>Couldn‚Äôt load crews</option>';
        $('teamSelect').disabled = true;
        $('signInBtn').disabled = true;
        msg('loginMessage','Couldn‚Äôt load crews. Refresh this page or return to the team start page.','error');
      }
    }
    function populateTeamDropdown(teams){
      const sel = $('teamSelect');
      sel.innerHTML = '<option value="">Choose your crew‚Ä¶</option>';
      teams
        .slice()
        .sort((a,b)=> (a.teamName||'').localeCompare(b.teamName||''))
        .forEach(t=>{
          const o=document.createElement('option');
          o.value=t.teamCode;
          o.textContent=t.teamName || t.teamCode;
          sel.appendChild(o);
        });
    }

    // ===== Verify PIN (same endpoint as Kindness) =====
    async function verifyTeamAndPin(teamCode, pin){
      try{
        const res = await fetch('/.netlify/functions/verify_team_pin_function',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ teamCode, pin })
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const result = await res.json();
        return !!result?.valid && result?.success!==false;
      }catch(err){
        console.error('verifyTeamAndPin:', err);
        return false;
      }
    }

    // ===== Submission =====
    async function submitLimerick(topic, text){
      const payload = {
        eventId: EVENT_ID,
        teamCode: currentTeam.teamCode,
        teamName: currentTeam.teamName,
        topic,
        limerickText: text
      };
      const res = await fetch('/.netlify/functions/submit_limerick_function',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok || data.success===false) throw new Error(data.message || data.error || 'Request failed');
      return data;
    }

    // ===== UI wiring =====
    $('nav-toggle')?.addEventListener('click', ()=>{
      const menu = $('nav-menu');
      menu.classList.toggle('active');
      $('nav-toggle').textContent = menu.classList.contains('active') ? '‚úï' : '‚ò∞';
    });

    $('limerickText').addEventListener('input', e=>{
      const left = 500 - e.target.value.length;
      $('charCount').textContent = left;
      $('charCount').style.color = left<50 ? '#b00020' : '#8B4513';
    });

    $('signInBtn').addEventListener('click', async ()=>{
      const teamCode = $('teamSelect').value;
      const pin = $('teamPin').value.trim();
      if(!teamCode) return msg('loginMessage','Please select your crew from the list.','error');
      if(!/^\d{4}$/.test(pin)) return msg('loginMessage','Please enter a valid 4-digit PIN.','error');

      const ok = await verifyTeamAndPin(teamCode, pin);
      if(!ok) return msg('loginMessage','Incorrect PIN for that crew. Try again.','error');

      currentTeam = allTeams.find(t=>t.teamCode===teamCode) || { teamCode, teamName: teamCode };
      $('teamInfo').textContent = `Crew: ${currentTeam.teamName}`;
      $('loginSection').style.display='none';
      $('challengeSection').style.display='block';
    });

    $('limerickForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = $('limerickText').value.trim();
      const topic = $('limerickTopic').value.trim();
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length);

      if(!text) return msg('challengeMessage','Please write your limerick first.','error');
      if(lines.length<5) return msg('challengeMessage','Please write 5 lines (AABBA).','error');

      $('submitBtn').disabled = true;
      $('loading').style.display = 'block';
      $('challengeMessage').style.display = 'none';

      try{
        await submitLimerick(topic, text);
        msg('challengeMessage',"üéâ Submitted! Check back in a few minutes for a score ‚Äî Terry‚Äôs AI is weighing your verse.",'success');
        $('limerickForm').style.opacity = .6;
        $('limerickForm').style.pointerEvents = 'none';
      }catch(err){
        console.error('submit error', err);
        msg('challengeMessage', err.message || 'Couldn‚Äôt submit. Please try again.','error');
        $('submitBtn').disabled = false;
      }finally{
        $('loading').style.display = 'none';
      }
    });

    // ===== Boot =====
    fetchEventState();
    loadTeamsList();
  </script>
</body>
</html>
