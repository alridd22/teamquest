<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TeamQuest ¬∑ The Limerick Challenge</title>
<style>
  :root{
    --brown:#7a4b27; --brown2:#5b361d; --tan:#f3e7d6; --gold:#d6a628; --gold2:#ffb52e; --ink:#2b190e;
    --cream:#fff7ec; --ok:#1b7f3a; --err:#8b1212; --okbg:#e8fbef; --errbg:#ffe9ed;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background: radial-gradient(1200px 600px at 20% 0,#8b5a2b22,transparent),
                radial-gradient(1000px 600px at 80% 100%,#d6a62822,transparent),
                linear-gradient(180deg,#8b5a2b 0%,#a96d3a 50%,#cf9258 100%);
    min-height:100dvh; color:var(--ink);
  }

  /* Fixed nav */
  .nav{
    position:fixed; inset:0 0 auto 0; height:64px; z-index:20;
    background:linear-gradient(135deg,var(--brown) 0%,var(--brown2) 100%);
    border-bottom:3px solid var(--gold);
    display:flex; align-items:center; gap:14px; padding:0 14px;
  }
  .brand{display:flex; align-items:center; gap:10px; text-decoration:none}
  .brand img{height:36px; width:auto; display:block; filter:drop-shadow(0 1px 2px #0006)}
  .navlinks{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
  .pill{
    color:#ffe9b6; font-weight:700; text-decoration:none; padding:10px 14px; border-radius:10px;
    border:2px solid #e7c26a55; background:#ffffff12; display:inline-flex; align-items:center; gap:8px;
  }
  .pill:hover{background:linear-gradient(135deg,#e7b748,#ff9800); color:#fff}
  .active{outline:2px dashed #ffd36b; outline-offset:2px}

  /* Page shell */
  .wrap{max-width:980px; margin:84px auto 32px; padding:16px}
  .card{
    background:linear-gradient(145deg,#f7efe3 0%,#eeddc9 100%);
    border:3px solid var(--brown); border-radius:20px; padding:18px 18px 6px;
    box-shadow:0 18px 42px #00000022, inset 0 1px 0 #fff8;
    position:relative;
  }
  .card:before{
    content:""; position:absolute; inset:12px; border:2px solid var(--gold); border-radius:14px; pointer-events:none;
  }

  /* Banner / badges */
  .banner{
    background:#fff7ee; border:2px dashed var(--gold); border-radius:14px; padding:14px 12px; display:flex;
    align-items:center; justify-content:space-between; gap:10px; margin:6px 0 14px;
  }
  .status{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
    border:2px dashed var(--gold); font-weight:800; background:#fff4d9;
  }
  .btn, button{
    appearance:none; border:none; cursor:pointer; font-weight:800;
    background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 100%);
    color:#3c240f; border-radius:12px; padding:12px 16px; box-shadow:0 2px 0 #5b361d;
    border:2px solid #8b5a2b; display:inline-flex; align-items:center; gap:8px;
  }
  .btn.small{padding:8px 12px; border-radius:10px}
  .btn:disabled{opacity:.6; cursor:not-allowed; filter:saturate(.6)}
  .ghost{
    background:linear-gradient(135deg,#8b5a2b,#6b3f22); color:#fff; border-color:#4b2a17;
  }

  /* Form + inputs */
  label{font-weight:700; color:#5a3218; margin-bottom:6px; display:block}
  .field{
    border:3px solid var(--gold); border-radius:12px; padding:12px 14px;
    background:linear-gradient(145deg,#fff 0%,#fff8e6 100%); width:100%; font-size:16px;
  }
  textarea.field{min-height:160px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 160px; gap:12px}
  .strip{
    background:linear-gradient(135deg,#8b5a2b,#a86737); color:#fff; border:2px solid #3e2313;
    border-radius:12px; padding:12px 14px; font-weight:800; margin:8px 0 14px;
  }
  .box{
    background:#fffdf7; border:2px dashed var(--gold); border-radius:14px; padding:14px; margin:10px 0 16px;
  }
  .help{color:#6b3f22; font-size:.9rem}
  .ctr{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .message{display:none; margin:12px 0 8px; padding:12px 14px; border-radius:12px; font-weight:700; text-align:center}
  .message.ok{display:block; background:var(--okbg); color:var(--ok); border:2px solid #20a45a}
  .message.err{display:block; background:var(--errbg); color:var(--err); border:2px solid #e06a7a}
  .muted{opacity:.65; pointer-events:none}

  @media (max-width:720px){ .row{grid-template-columns:1fr} .nav{height:72px} .wrap{margin-top:96px}}
</style>
</head>
<body>
  <!-- Fixed nav -->
  <nav class="nav">
    <a class="brand" href="/">
      <img src="/Team Quest Logo-01.png" alt="TeamQuest" />
    </a>
    <div class="navlinks">
      <a class="pill" href="/clue_hunt_challenge">Treasure Hunt</a>
      <a class="pill" href="/scavenger_hunt">Scavenger</a>
      <a class="pill" href="/quiz_challenge">Timed Quiz</a>
      <a class="pill" href="/kindness_challenge_page">Kindness</a>
      <a class="pill active" href="#">Limerick</a>
      <a class="pill" href="/teamquest_gallery">Gallery</a>
    </div>
  </nav>

  <main class="wrap">
    <div class="card">
      <!-- Event banner -->
      <div class="banner">
        <div id="eventMsg">‚õ≥ Checking event‚Ä¶</div>
        <div class="ctr">
          <span id="eventBadge" class="status">‚Äî</span>
          <button id="refreshState" class="btn small">‚Üª Refresh</button>
        </div>
      </div>

      <!-- Sign-in -->
      <div class="box">
        <div class="row" style="align-items:end">
          <div>
            <label for="teamSelect">Choose your crew</label>
            <select id="teamSelect" class="field">
              <option value="">Loading crews‚Ä¶</option>
            </select>
          </div>
          <div>
            <label for="pinInput">Crew PIN</label>
            <input id="pinInput" class="field" inputmode="numeric" autocomplete="one-time-code" maxlength="4" placeholder="1234" />
          </div>
        </div>
        <div class="ctr" style="margin-top:10px">
          <button id="signInBtn" class="btn">üîê Sign in</button>
          <button id="reloadCrews" class="btn ghost">‚Üª Reload crews</button>
        </div>
        <div id="signMsg" class="message"></div>
      </div>

      <!-- Crew strip -->
      <div id="crewStrip" class="strip" style="display:none">Crew: <span id="crewName">‚Äî</span></div>

      <!-- Quick rules -->
      <div class="box">
        <strong>Quick rules</strong>
        <ul style="margin:8px 0 0 18px; line-height:1.5">
          <li>Five lines. Keep it fun + clean.</li>
          <li>At least 20 characters total.</li>
          <li>One submit at a time per crew.</li>
        </ul>
      </div>

      <!-- Limerick form -->
      <form id="limerickForm" class="box" novalidate>
        <div style="margin-bottom:10px">
          <label for="topic">Topic (optional)</label>
          <input id="topic" class="field" placeholder="e.g. Castle gates / teamwork / parrot‚Ä¶" />
        </div>

        <div style="margin-bottom:10px">
          <label for="limerick">Your limerick</label>
          <textarea id="limerick" class="field" maxlength="500" placeholder="There once was a crew bold and keen‚Ä¶"></textarea>
          <div class="help"><span id="charCount">0</span>/500 characters remaining</div>
        </div>

        <div class="ctr">
          <button id="submitBtn" class="btn" type="submit">üìú Submit to the Vault</button>
          <div id="busy" class="help" style="display:none">‚è≥ Sending‚Ä¶</div>
        </div>

        <div id="formMsg" class="message"></div>
      </form>
    </div>
  </main>

<script>
(function(){
  // --------- helpers
  const $ = sel => document.querySelector(sel);
  const state = { eventId:"", eventState:"", crews:[], teamCode:"", teamName:"", signed:false, canSubmit:false };

  function getEventId(){
    const q = new URLSearchParams(location.search);
    return q.get("event") || q.get("eventId") || "";
  }
  function showMsg(el, text, ok=false){
    const box = $(el);
    if(!box) return;
    box.textContent = text;
    box.className = "message " + (ok ? "ok":"err");
    box.style.display = "block";
  }
  function clearMsg(el){ const box=$(el); if(box){ box.style.display="none"; } }
  function setBadge(text){ const b=$("#eventBadge"); if(b) b.textContent = text; }
  function setBanner(message){ const m=$("#eventMsg"); if(m) m.textContent = message; }
  function lockForm(disabled=true){
    $("#topic").disabled = disabled;
    $("#limerick").disabled = disabled;
    $("#submitBtn").disabled = disabled;
    state.canSubmit = !disabled;
  }
  function setCrewStrip(){
    if(state.teamName){
      $("#crewName").textContent = state.teamName;
      $("#crewStrip").style.display = "block";
    } else {
      $("#crewStrip").style.display = "none";
    }
  }

  // --------- Event state
  async function fetchEventState(){
    try{
      const res = await fetch("/.netlify/functions/get_event_state",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId:state.eventId})});
      const data = await res.json();
      state.eventState = (data && data.state) || "RUNNING";
    }catch(e){
      state.eventState = "RUNNING";
    }
    if(state.eventState === "RUNNING"){ setBanner("Event running ‚Äî submit your limerick when ready."); setBadge("Running"); }
    else if(state.eventState === "PAUSED"){ setBanner("Event paused ‚Äî submissions are closed"); setBadge("Paused"); }
    else if(state.eventState === "ENDED"){ setBanner("Event ended ‚Äî submissions are closed"); setBadge("Ended"); }
    else if(state.eventState === "PUBLISHED"){ setBanner("Results published ‚Äî submissions closed"); setBadge("Published"); }
    lockForm(state.eventState !== "RUNNING" || !state.signed);
  }

  // --------- Crews
  async function loadCrews(){
    const sel = $("#teamSelect");
    sel.innerHTML = '<option value="">Loading crews‚Ä¶</option>';
    try{
      const res = await fetch("/.netlify/functions/get_leaderboard?eventId="+encodeURIComponent(state.eventId));
      if(!res.ok) throw new Error("bad");
      const data = await res.json();
      const list = (Array.isArray(data.teams)?data.teams : (Array.isArray(data.leaderboard)?data.leaderboard:[]))
        .map(t => ({teamCode: t.teamCode, teamName: t.teamName}))
        .filter(t => t.teamCode && t.teamName);
      state.crews = list;
      sel.innerHTML = '<option value="">Choose your crew‚Ä¶</option>' +
        list.sort((a,b)=>a.teamName.localeCompare(b.teamName))
            .map(t=>`<option value="${t.teamCode}">${t.teamName}</option>`).join("");
    }catch(e){
      sel.innerHTML = '<option value="">‚Äî</option>';
      showMsg("#signMsg","Couldn‚Äôt load crews. Refresh and try again.");
    }
  }

  // --------- Sign in
  async function signIn(){
    clearMsg("#signMsg");
    const teamCode = $("#teamSelect").value;
    const pin = ($("#pinInput").value || "").replace(/\D/g,"").slice(0,4);
    if(!teamCode){ showMsg("#signMsg","Pick your crew from the list."); return; }
    if(pin.length !== 4){ showMsg("#signMsg","Enter a 4-digit PIN."); return; }

    $("#signInBtn").disabled = true;
    try{
      const res = await fetch("/.netlify/functions/verify_team_pin_function",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({eventId:state.eventId, teamCode, pin})
      });
      if(res.status === 404){ showMsg("#signMsg","Sign-in service unavailable. Try again later."); return; }
      const data = await res.json();
      if(data && data.success && data.valid){
        const t = state.crews.find(c=>c.teamCode===teamCode);
        state.teamCode = teamCode;
        state.teamName = t ? t.teamName : "";
        state.signed = true;
        localStorage.setItem("tq.teamCode", state.teamCode);
        localStorage.setItem("tq.teamName", state.teamName);
        if(data.token){ localStorage.setItem("tq.token", data.token); }
        setCrewStrip();
        clearMsg("#signMsg");
        lockForm(state.eventState !== "RUNNING" ? true : false);
      }else if(data && data.success === true && data.valid === false){
        showMsg("#signMsg","PIN doesn‚Äôt match this crew.");
      }else{
        showMsg("#signMsg","Sign-in failed. Try again.");
      }
    }catch(e){
      showMsg("#signMsg","Sign-in service unavailable. Try again later.");
    }finally{
      $("#signInBtn").disabled = false;
    }
  }

  // --------- Submit limerick
  $("#limerick").addEventListener("input",()=>{
    const val = ($("#limerick").value||"");
    const left = 500 - val.length;
    $("#charCount").textContent = 500 - (left<0?0:(500-left));
    // keep it simple to show remaining
    $("#charCount").textContent = val.length;
  });

  $("#limerickForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    clearMsg("#formMsg");
    if(!state.signed){ showMsg("#formMsg","Please sign in first."); return; }
    if(state.eventState!=="RUNNING"){ showMsg("#formMsg","Submissions are closed."); return; }
    const text = ($("#limerick").value||"").trim();
    if(text.length < 20){ showMsg("#formMsg","Write at least 20 characters."); return; }

    const payload = {
      eventId: state.eventId,
      teamCode: state.teamCode,
      teamName: state.teamName,
      limerick: text,
      topic: ($("#topic").value||"").trim()
      // photoUrl optional ‚Äì omitted here
    };

    $("#submitBtn").disabled = true; $("#busy").style.display="inline";

    try{
      const res = await fetch("/.netlify/functions/submit_limerick_function",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok){
        showMsg("#formMsg", (data && (data.message||data.error)) || `Couldn‚Äôt submit. Request failed (${res.status})`);
        $("#submitBtn").disabled = false; $("#busy").style.display="none";
        return;
      }
      showMsg("#formMsg","üéâ Submitted! Terry‚Äôs tallymaster is reviewing. Check the leaderboard in a few minutes.", true);
      // grey/disable to avoid double-submit
      $("#topic").classList.add("muted"); $("#limerick").classList.add("muted");
      lockForm(true);
    }catch(err){
      showMsg("#formMsg","Network error. Try again.");
      $("#submitBtn").disabled = false;
    }finally{
      $("#busy").style.display="none";
    }
  });

  // --------- Boot
  async function boot(){
    state.eventId = getEventId();
    await fetchEventState();
    await loadCrews();

    // Autofill from prior sign-in
    const tc = localStorage.getItem("tq.teamCode"); const tn = localStorage.getItem("tq.teamName");
    if(tc && tn){
      state.teamCode = tc; state.teamName = tn; state.signed = true; setCrewStrip();
      lockForm(state.eventState!=="RUNNING");
    }
  }

  $("#refreshState").addEventListener("click", fetchEventState);
  $("#reloadCrews").addEventListener("click", loadCrews);
  $("#signInBtn").addEventListener("click", signIn);
  boot();
})();
</script>
</body>
</html>
