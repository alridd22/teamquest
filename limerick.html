<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest ‚Äì Terry‚Äôs Verse Vault</title>
  <style>
    /* NAV */
    .treasure-nav{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:1000;height:80px}
    .nav-container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;height:100%;padding:0 20px}
    .nav-logo{display:flex;align-items:center}
    .nav-logo img{height:50px;width:auto;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5))}
    .nav-menu{display:flex;gap:30px;list-style:none;margin:0;padding:0}
    .nav-item{position:relative}
    .nav-link{display:block;color:#F5DEB3;text-decoration:none;font-weight:700;padding:12px 18px;border-radius:8px;background:rgba(101,67,33,.3);border:2px solid rgba(218,165,32,.4);text-shadow:1px 1px 2px rgba(0,0,0,.7)}
    .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff;transform:translateY(-2px)}
    .nav-dropdown{position:absolute;top:100%;left:0;background:linear-gradient(135deg,#654321,#8B4513);border:2px solid #DAA520;border-radius:8px;min-width:180px;opacity:0;visibility:hidden;transform:translateY(-10px);transition:.2s}
    .nav-item:hover .nav-dropdown{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-link{display:block;padding:12px 18px;color:#F5DEB3;text-decoration:none}
    .dropdown-link:hover{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff}
    .nav-toggle{display:none;background:none;border:none;color:#DAA520;font-size:1.8rem}
    @media (max-width:768px){
      .treasure-nav{height:120px}
      .nav-container{justify-content:center;position:relative}
      .nav-logo{position:absolute;left:50%;transform:translateX(-50%)}
      .nav-toggle{display:block;position:absolute;right:20px;top:50%;transform:translateY(-50%)}
      .nav-menu{position:fixed;top:120px;left:-100%;width:100%;height:calc(100vh - 120px);background:linear-gradient(135deg,#8B4513,#654321);flex-direction:column;align-items:center;gap:18px;padding-top:24px;transition:left .25s ease}
      .nav-menu.active{left:0}
      .nav-dropdown{position:static;opacity:1;visibility:visible;transform:none}
    }

    /* PAGE */
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;padding-top:100px!important}
    @media (max-width:768px){body{padding-top:140px!important}}
    .container{background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border:3px solid #8B4513;border-radius:24px;max-width:720px;width:100%;padding:26px 22px;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .container::before{content:'';display:block;height:8px;background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700);border-radius:6px;margin:-10px -6px 20px}
    h1{color:#8B4513;text-align:center;margin:0 0 6px;font-size:2.2rem}
    .subtitle{text-align:center;color:#A0522D;margin-bottom:16px}

    .banner{background:#fff8e6;border:2px dashed #DAA520;border-radius:14px;padding:10px 14px;margin:10px 0;color:#7a4a0b;font-weight:600}
    .section{background:#fff8e6;border:2px solid #DAA520;border-left:6px solid #FF8C00;border-radius:12px;padding:16px;margin:14px 0}
    .team-info{background:linear-gradient(135deg,#8B4513,#A0522D);color:#fff;padding:14px;border-radius:12px;text-align:center;font-weight:800;border:2px solid #DAA520;margin:14px 0}

    .form-group{margin-bottom:18px}
    label{display:block;margin-bottom:8px;color:#8B4513;font-weight:700}
    select,input[type="text"],textarea{width:100%;padding:14px;border:3px solid #DAA520;border-radius:12px;background:linear-gradient(145deg,#fff,#FFF8DC);font-size:16px}
    textarea{min-height:160px;resize:vertical;font-family:Georgia,serif;line-height:1.5}
    .char-count{text-align:right;font-size:.9em;color:#8B4513;margin-top:6px}

    .submit-btn{width:100%;background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:none;padding:16px;border-radius:14px;font-weight:900;font-size:1.05rem;display:flex;align-items:center;justify-content:center;gap:10px;border:2px solid #8B4513;cursor:pointer}
    .submit-btn[disabled]{opacity:.6;cursor:not-allowed}
    .message{display:none;margin:16px 0;padding:14px;border-radius:12px;border:3px solid;font-weight:600;text-align:center}
    .success-message{background:linear-gradient(135deg,#98FB98,#90EE90);border-color:#32CD32;color:#064d06}
    .error-message{background:linear-gradient(135deg,#FFB6C1,#FFA0B4);border-color:#DC143C;color:#8B0000}
    .loading{display:none;text-align:center;font-weight:700;color:#8B4513;margin-top:10px}

    .examples{background:#fff;border:2px solid #DAA520;border-radius:12px;padding:16px}
    .example{font-family:Georgia,serif;background:linear-gradient(145deg,#fff,#FFF8DC);border:2px solid #DAA520;border-left:4px solid #FF8C00;border-radius:10px;padding:14px;line-height:1.5}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav">
    <div class="nav-container">
      <a class="nav-logo" href="https://theteamquest.netlify.app/"><img src="/Team Quest Logo-01.png" alt="TeamQuest Logo"/></a>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link">üéØ Activities ‚ñº</a>
          <div class="nav-dropdown">
            <a class="dropdown-link" href="https://theteamquest.netlify.app/clue_hunt_challenge">üíé The Treasure Hunt</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/scavenger_hunt">üîç The Scavenger Hunt</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/quiz_challenge">‚è∞ The Timed Quiz</a>
            <a class="dropdown-link" href="https://theteamquest.netlify.app/kindness_challenge_page">‚ù§Ô∏è The Kindness Task</a>
          </div>
        </li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_leaderboard">üèÜ The Leaderboard</a></li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_gallery">üì∏ The Gallery</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle">‚ò∞</button>
    </div>
  </nav>

  <div class="container">
    <div class="banner" id="eventBanner" aria-live="polite">Checking event status‚Ä¶</div>

    <!-- LOGIN -->
    <section id="loginSection" class="section" aria-labelledby="loginTitle">
      <h1 id="loginTitle">üìù Terry‚Äôs Verse Vault</h1>
      <p class="subtitle">Write a limerick. Make us smile. Earn doubloons.</p>

      <div class="form-group">
        <label for="teamSelect">Choose your crew</label>
        <select id="teamSelect" disabled>
          <option>Loading crews‚Ä¶</option>
        </select>
      </div>

      <div class="form-group">
        <label for="teamPin">Crew PIN</label>
        <input id="teamPin" type="text" inputmode="numeric" pattern="\\d{4}" maxlength="4" placeholder="1234" aria-describedby="pinHelp"/>
      </div>

      <button id="signInBtn" class="submit-btn" disabled>üîì Sign in</button>
      <div id="loginMessage" class="message" role="status" aria-live="polite"></div>
    </section>

    <!-- CHALLENGE -->
    <section id="challengeSection" class="section" style="display:none">
      <div class="team-info" id="teamInfo">Crew: ‚Ä¶</div>

      <div class="examples" aria-hidden="true">
        <div class="example">
          There once was a seeker of gold,<br/>
          Who followed a map that was old;<br/>
          &nbsp;&nbsp;It led to a tree,<br/>
          &nbsp;&nbsp;By the edge of the sea‚Äî<br/>
          And there lay a chest to behold!
        </div>
      </div>

      <form id="limerickForm" novalidate>
        <div class="form-group">
          <label for="limerickTopic">Topic (optional)</label>
          <input id="limerickTopic" type="text" placeholder="e.g., Pirates, maps, mysterious islands‚Ä¶"/>
        </div>

        <div class="form-group">
          <label for="limerickText">Your limerick (5 lines)</label>
          <textarea id="limerickText" maxlength="500" placeholder="Type your limerick here‚Ä¶" required></textarea>
          <div class="char-count"><span id="charCount">500</span> characters left</div>
        </div>

        <button id="submitBtn" class="submit-btn" type="submit">ü™ô Submit for doubloons</button>
        <div id="loading" class="loading">Analysing your verse‚Ä¶</div>
        <div id="challengeMessage" class="message" role="status" aria-live="polite"></div>
      </form>
    </section>
  </div>

  <script>
    /* ------- Query + Auth helpers ------- */
    const qs = new URLSearchParams(location.search);
    const EVENT_ID   = qs.get('event') || qs.get('eventId') || '';
    const TEAM_TOKEN = localStorage.getItem('teamToken') || '';
    const TEAM_CODE  = localStorage.getItem('teamCode') || '';

    async function callFn(path, payload){
      const res = await fetch(`/.netlify/functions/${path}`,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          ...(TEAM_TOKEN ? { 'Authorization': `Bearer ${TEAM_TOKEN}` } : {})
        },
        body: JSON.stringify(payload)
      });
      let data=null, raw='';
      try{ data = await res.json(); }catch{ try{ raw = await res.text(); }catch{} }
      if(!res.ok || (data && data.success===false)){
        const msg = (data && (data.message||data.error)) || raw || `Request failed (${res.status})`;
        throw new Error(msg);
      }
      return data || {};
    }

    /* ------- DOM helpers ------- */
    const $ = id => document.getElementById(id);
    const show = el => el.style.display='block';
    const hide = el => el.style.display='none';
    function msg(id, text, type='success'){
      const el = $(id);
      el.textContent = text;
      el.className = `message ${type==='error'?'error-message':'success-message'}`;
      show(el);
    }
    function setBanner(t){ $('eventBanner').textContent = t; }

    /* ------- Event state ------- */
    async function loadEventState(){
      if(!EVENT_ID){ setBanner('No event selected. Add ?event=YOUR_EVENT_ID to the URL.'); return; }
      try{
        const { state } = await callFn('get_event_state', { eventId: EVENT_ID });
        if(state==='RUNNING')      setBanner('Event running ‚Äî submit your limerick when ready.');
        else if(state==='PAUSED')  { setBanner('Event paused ‚Äî please wait.'); disableForm(true); }
        else if(state==='ENDED')   { setBanner('Event ended ‚Äî submissions closed.'); disableForm(true); }
        else if(state==='PUBLISHED'){ setBanner('Results published ‚Äî see the leaderboard & gallery.'); disableForm(true); }
        else                        { setBanner('Event not started yet.'); disableForm(true); }
      }catch{ setBanner('Event status unavailable ‚Äî you can still try to submit.'); }
    }
    function disableForm(off){
      $('submitBtn').disabled = off;
      $('limerickText').disabled = off;
      $('limerickTopic').disabled = off;
    }

    /* ------- Load crews (NO random fallbacks) ------- */
    let crews = [];
    async function loadCrews(){
      try{
        const data = await callFn('get_leaderboard', { eventId: EVENT_ID });
        if(Array.isArray(data.teams) && data.teams.length){
          crews = data.teams;
          const sel = $('teamSelect');
          sel.innerHTML = '<option value="">Choose your crew‚Ä¶</option>';
          crews.sort((a,b)=>a.teamName.localeCompare(b.teamName))
               .forEach(t=>{
                 const o = document.createElement('option');
                 o.value = t.teamCode; o.textContent = t.teamName;
                 sel.appendChild(o);
               });
          sel.disabled = false;
          $('signInBtn').disabled = false;
          // Preselect previously used teamCode (no auto-login; still requires PIN)
          if(TEAM_CODE){ sel.value = TEAM_CODE; }
        }else{
          throw new Error('No teams found for this event.');
        }
      }catch(err){
        $('teamSelect').innerHTML = '<option>Couldn‚Äôt load crews</option>';
        msg('loginMessage','Couldn‚Äôt load crews. Refresh this page or return to the team start page.','error');
      }
    }

    /* ------- Sign in with team + PIN (same flow as Kindness) ------- */
    $('signInBtn').addEventListener('click', async ()=>{
      const teamCode = $('teamSelect').value;
      const pin = $('teamPin').value.trim();
      if(!teamCode) return msg('loginMessage','Choose your crew first.','error');
      if(!/^\d{4}$/.test(pin)) return msg('loginMessage','Enter your 4-digit PIN.','error');

      try{
        const res = await fetch('/.netlify/functions/verify_team_pin_function',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ teamCode, pin, eventId: EVENT_ID })
        });
        const data = await res.json();
        if(!res.ok || !data?.success || data.valid===false) throw new Error(data.message||'Invalid PIN');

        const team = crews.find(t=>t.teamCode===teamCode) || { teamCode, teamName: data.teamName||teamCode };
        if(data.token) localStorage.setItem('teamToken', data.token);
        localStorage.setItem('teamCode', team.teamCode);
        localStorage.setItem('teamName', team.teamName);

        $('teamInfo').textContent = `Crew: ${team.teamName}`;
        hide($('loginSection')); show($('challengeSection'));
      }catch(err){
        msg('loginMessage', err.message || 'Sign-in failed. Try again.','error');
      }
    });

    /* ------- Limerick form ------- */
    $('limerickText').addEventListener('input', e=>{
      const left = 500 - e.target.value.length;
      $('charCount').textContent = left;
      $('charCount').style.color = left<50 ? '#b00020' : '#8B4513';
    });

    $('limerickForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = $('limerickText').value.trim();
      const topic = $('limerickTopic').value.trim();
      const teamCode = localStorage.getItem('teamCode') || '';
      if(!text) return msg('challengeMessage','Type your limerick first.','error');
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
      if(lines.length < 5) return msg('challengeMessage','Please write 5 lines (AABBA).','error');

      $('submitBtn').disabled = true; $('loading').style.display='block'; hide($('challengeMessage'));
      try{
        await callFn('submit_limerick_function',{
          eventId: EVENT_ID,
          teamCode,
          topic,
          limerickText: text
        });
        msg('challengeMessage',"üéâ Submitted! Check back in a few minutes for a score ‚Äî Terry‚Äôs AI is weighing your verse.",'success');
        $('limerickForm').style.opacity = .6; disableForm(true);
      }catch(err){
        msg('challengeMessage', err.message || 'Couldn‚Äôt submit. Please try again.','error');
        $('submitBtn').disabled = false;
      }finally{
        $('loading').style.display='none';
      }
    });

    /* ------- Nav + boot ------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      const navToggle = document.getElementById('nav-toggle');
      const navMenu = document.getElementById('nav-menu');
      navToggle?.addEventListener('click', ()=>{
        navMenu.classList.toggle('active');
        navToggle.textContent = navMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
      });

      loadEventState();
      loadCrews();
    });
  </script>
</body>
</html>
