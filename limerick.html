<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta name="theme-color" content="#2A1F18">
  <title>TeamQuest ¬∑ The Limerick Challenge</title>

  <!-- Handlee for body; system sans for headings/buttons -->
  <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:url("/TQ%20Web%20extended%20background-100.jpg");
      --ink:#2E2114; --ink-soft:#6A5A47;
      --parchment:#F7EED8; --parchment-2:#F3E6CF;
      --gold:#F0C433; --gold-deep:#A7711F;
      --success:#1F6E38; --success-bg:#CFF2DA;
      --error:#B42318;

      --radius-card:22px; --radius-input:16px;
      --shadow-card:0 18px 40px rgba(0,0,0,.35);
      --shadow-soft:0 2px 8px rgba(0,0,0,.12);
      --focus:0 0 0 3px rgba(240,196,51,.45);

      --gutter:22px;
      --hero-h:280px;
      --nav-h:64px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Handlee", ui-rounded, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        linear-gradient(180deg, rgba(0,0,0,.24), rgba(0,0,0,.45)),
        var(--bg);
      background-size:cover;
      background-position:top center;
      background-attachment:fixed;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      padding-top:var(--nav-h);
    }

    /* NAV */
    .nav{
      position:fixed; top:0; left:0; right:0; height:var(--nav-h); z-index:1000;
      backdrop-filter:saturate(120%) blur(6px);
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      border-bottom:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:space-between; padding:0 12px;
    }
    .brand img{height:40px; width:auto; display:block; filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}
    .menu-btn{background:none;border:none;color:#F7EED8;font-size:1.6rem;cursor:pointer}
    .navlinks{
      position:fixed; top:var(--nav-h); left:-100%; width:100%; height:calc(100vh - var(--nav-h));
      background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,.6));
      display:flex; flex-direction:column; align-items:center; gap:14px; padding:18px 14px; transition:left .25s;
    }
    .navlinks.active{left:0}
    .pill{
      display:block; width:92%; max-width:360px; text-align:center; text-decoration:none;
      color:#F7EED8; font-weight:900; padding:12px 14px; border-radius:14px;
      background:rgba(247,238,216,.18); border:1px solid rgba(255,255,255,.25);
    }
    .pill:hover{ background:rgba(247,238,216,.28) }

    /* HERO */
    .hero{
      min-height:var(--hero-h);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
      padding:24px var(--gutter) 22px; text-align:center;
    }
    .brand-logo{
      width:min(240px,68vw); height:auto; margin-bottom:10px;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 10px 24px rgba(0,0,0,.35));
    }
    .hero-title{
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-weight:900; font-size:22px; color:#F7EED8; letter-spacing:.2px;
      text-shadow:0 2px 6px rgba(0,0,0,.6);
    }

    /* STACK / CARDS */
    .wrap{ padding:0 var(--gutter) 28px; max-width:1000px; margin:0 auto; }
    .card{
      background:var(--parchment);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-card);
      padding:18px 16px;
      border:1px solid rgba(0,0,0,.06);
      margin:0 auto 18px; width:100%;
    }
    .card h2{
      margin:0 0 10px; text-align:center;
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-weight:900; font-size:24px; color:var(--ink);
    }
    .card p{ margin:0; line-height:1.6; color:var(--ink); font-size:18px; }

    /* Sign-in & form */
    .box{ background:var(--parchment-2); border-radius:16px; border:1px solid rgba(0,0,0,.08); padding:16px; margin:0 0 16px; }
    .row{ display:grid; grid-template-columns:1fr 150px; gap:12px; align-items:end; }
    @media (max-width:560px){ .row{ grid-template-columns:1fr } }
    label{ display:block; margin:0 6px 6px; font-size:18px; font-weight:800; color:var(--ink); }
    .field{
      width:100%; padding:14px 12px; border-radius:var(--radius-input);
      border:3px solid var(--gold); background:#fff; color:var(--ink); font-size:18px;
      transition:border-color .18s, box-shadow .18s, transform .18s;
    }
    .field:focus{ outline:none; box-shadow:var(--focus); border-color:var(--gold-deep); transform:translateY(-1px); }
    .ctr{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:900;
      background:linear-gradient(90deg, #FDBA2D, #F0C433); color:#442812;
      border-radius:12px; padding:12px 16px; border:3px solid var(--gold-deep);
      box-shadow:0 8px 18px rgba(0,0,0,.2);
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .btn.small{ padding:10px 12px; }

    /* Crew strip */
    .strip{
      background:#D7C39B; color:var(--ink); border:3px dashed rgba(0,0,0,.6);
      border-radius:14px; padding:12px 14px; font-weight:900; margin:0 0 16px; text-align:center;
    }

    /* Quick rules */
    .rules strong{
      display:block; text-align:center; margin-bottom:6px;
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-weight:900; font-size:20px; color:var(--ink);
    }
    .rules ul{ margin:8px 0 0 18px; line-height:1.6; color:var(--ink-soft); }

    /* Messages */
    .help{ color:var(--ink-soft); font-weight:800; }
    .message{ display:none; margin:12px 0 8px; padding:12px 14px; border-radius:12px; font-weight:900; text-align:center }
    .message.ok{ display:block; background:var(--success-bg); color:var(--success); border:2px solid #20a45a }
    .message.err{ display:block; background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%); color:#8B0000; border:2px solid #DC143C }
    .muted{ opacity:.65; pointer-events:none; }

    @media (min-width:480px){
      :root{ --gutter:26px; --hero-h:320px; }
      .brand-logo{ width:min(280px,62vw); }
    }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation-duration:0ms !important; }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <a class="brand" href="/">
      <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest">
    </a>
    <button class="menu-btn" id="menuBtn" aria-label="Toggle menu">‚ò∞</button>
  </nav>

  <!-- Updated links (exclude current page: Limerick) -->
  <div class="navlinks" id="navlinks" role="menu">
    <a class="pill nav-link" href="https://theteamquest.netlify.app/clue_hunt" role="menuitem">üíé The Treasure Hunt</a>
    <a class="pill nav-link" href="https://theteamquest.netlify.app/scavenger" role="menuitem">üîç The Scavenger Hunt</a>
    <a class="pill nav-link" href="https://theteamquest.netlify.app/quiz" role="menuitem">‚è∞ The Timed Quiz</a>
    <a class="pill nav-link" href="/kindness" role="menuitem">üíñ Kindness</a>
    <a class="pill dropdown-link" href="https://theteamquest.netlify.app/leaderboard" role="menuitem">üèÜ The Leaderboard</a>
    <a class="pill dropdown-link" href="https://theteamquest.netlify.app/gallery" role="menuitem">üì∏ The Gallery</a>
  </div>

  <!-- HERO -->
  <header class="hero">
    <img class="brand-logo" src="/Team%20Quest%20Logo-01.png" alt="TeamQuest" width="640" height="480">
    <div class="hero-title">The Limerick Challenge</div>
  </header>

  <!-- CONTENT -->
  <main class="wrap">
    <section class="card">
      <!-- Sign-in -->
      <div class="box">
        <div class="row">
          <div>
            <label for="teamSelect">Choose your crew</label>
            <select id="teamSelect" class="field">
              <option value="">Loading crews‚Ä¶</option>
            </select>
          </div>
          <div>
            <label for="pinInput">Crew PIN</label>
            <input id="pinInput" class="field" inputmode="numeric" autocomplete="one-time-code" maxlength="4" placeholder="1234"/>
          </div>
        </div>
        <div class="ctr" style="margin-top:10px">
          <button id="signInBtn" class="btn" type="button">üîê Sign in</button>
          <button id="reloadCrews" class="btn small" type="button">‚Üª Reload crews</button>
        </div>
        <div id="signMsg" class="message"></div>
      </div>

      <!-- Crew strip -->
      <div id="crewStrip" class="strip" style="display:none">Crew: <span id="crewName">‚Äî</span></div>

      <!-- Quick rules -->
      <div class="box rules">
        <strong>Quick rules</strong>
        <ul>
          <li>Five lines. Keep it fun + clean.</li>
          <li>At least 20 characters total.</li>
          <li>One submit at a time per crew.</li>
        </ul>
      </div>

      <!-- Limerick form -->
      <form id="limerickForm" class="box" novalidate>
        <div style="margin-bottom:10px">
          <label for="topic">Topic (optional)</label>
          <input id="topic" class="field" placeholder="e.g., castle gates / teamwork / parrot‚Ä¶"/>
        </div>

        <div style="margin-bottom:10px">
          <label for="limerick">Your limerick</label>
          <textarea id="limerick" class="field" maxlength="500" placeholder="There once was a crew bold and keen‚Ä¶"></textarea>
          <div class="help"><span id="charCount">500</span> characters remaining</div>
        </div>

        <div class="ctr">
          <button id="submitBtn" class="btn" type="submit">üìú Submit to the Vault</button>
          <div id="busy" class="help" style="display:none">‚è≥ Sending‚Ä¶</div>
        </div>

        <div id="formMsg" class="message"></div>
      </form>
    </section>
  </main>

  <script>
    (function(){
      // mobile nav toggle
      const menuBtn = document.getElementById('menuBtn');
      const navlinks = document.getElementById('navlinks');
      menuBtn?.addEventListener('click', ()=>{
        navlinks.classList.toggle('active');
        menuBtn.textContent = navlinks.classList.contains('active') ? '‚úï' : '‚ò∞';
      });
      document.addEventListener('click', (e)=>{
        if(!navlinks.contains(e.target) && !menuBtn.contains(e.target)){
          navlinks.classList.remove('active'); menuBtn.textContent = '‚ò∞';
        }
      });

      // --------- helpers
      const $ = sel => document.querySelector(sel);
      const state = { eventId:"", eventState:"", crews:[], teamCode:"", teamName:"", signed:false, canSubmit:false };

      function getEventId(){
        const q = new URLSearchParams(location.search);
        return q.get("event") || q.get("eventId") || "";
      }
      function showMsg(el, text, ok=false){
        const box = $(el);
        if(!box) return;
        box.textContent = text;
        box.className = "message " + (ok ? "ok":"err");
        box.style.display = "block";
      }
      function clearMsg(el){ const box=$(el); if(box){ box.style.display="none"; } }
      function lockForm(disabled=true){
        $("#topic").disabled = disabled;
        $("#limerick").disabled = disabled;
        $("#submitBtn").disabled = disabled;
        state.canSubmit = !disabled;
      }
      function setCrewStrip(){
        if(state.teamName){
          $("#crewName").textContent = state.teamName;
          $("#crewStrip").style.display = "block";
        } else {
          $("#crewStrip").style.display = "none";
        }
      }

      // --------- Event state (no visual banner)
      async function fetchEventState(){
        try{
          const res = await fetch("/.netlify/functions/get_event_state",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId:state.eventId})});
          const data = await res.json();
          state.eventState = (data && data.state) || "RUNNING";
        }catch(e){
          state.eventState = "RUNNING";
        }
        lockForm(state.eventState !== "RUNNING" || !state.signed);
      }

      // --------- Crews
      async function loadCrews(){
        const sel = $("#teamSelect");
        sel.innerHTML = '<option value="">Loading crews‚Ä¶</option>';
        try{
          const res = await fetch("/.netlify/functions/get_leaderboard?eventId="+encodeURIComponent(state.eventId));
          if(!res.ok) throw new Error("bad");
          const data = await res.json();
          const list = (Array.isArray(data.teams)?data.teams : (Array.isArray(data.leaderboard)?data.leaderboard:[]))
            .map(t => ({teamCode: t.teamCode, teamName: t.teamName}))
            .filter(t => t.teamCode && t.teamName);
          state.crews = list;
          sel.innerHTML = '<option value="">Choose your crew‚Ä¶</option>' +
            list.sort((a,b)=>a.teamName.localeCompare(b.teamName))
                .map(t=>`<option value="${t.teamCode}">${t.teamName}</option>`).join("");
        }catch(e){
          sel.innerHTML = '<option value="">‚Äî</option>';
          showMsg("#signMsg","Couldn‚Äôt load crews. Refresh and try again.");
        }
      }

      // --------- Sign in
      async function signIn(){
        clearMsg("#signMsg");
        const teamCode = $("#teamSelect").value;
        const pin = ($("#pinInput").value || "").replace(/\D/g,"").slice(0,4);
        if(!teamCode){ showMsg("#signMsg","Pick your crew from the list."); return; }
        if(pin.length !== 4){ showMsg("#signMsg","Enter a 4-digit PIN."); return; }

        $("#signInBtn").disabled = true;
        try{
          const res = await fetch("/.netlify/functions/verify_team_pin_function",{
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({eventId:state.eventId, teamCode, pin})
          });
          if(res.status === 404){ showMsg("#signMsg","Sign-in service unavailable. Try again later."); return; }
          const data = await res.json();
          if(data && data.success && data.valid){
            const t = state.crews.find(c=>c.teamCode===teamCode);
            state.teamCode = teamCode;
            state.teamName = t ? t.teamName : "";
            state.signed = true;
            localStorage.setItem("tq.teamCode", state.teamCode);
            localStorage.setItem("tq.teamName", state.teamName);
            if(data.token){ localStorage.setItem("tq.token", data.token); }
            setCrewStrip();
            clearMsg("#signMsg");
            lockForm(state.eventState !== "RUNNING" ? true : false);
          }else if(data && data.success === true && data.valid === false){
            showMsg("#signMsg","PIN doesn‚Äôt match this crew.");
          }else{
            showMsg("#signMsg","Sign-in failed. Try again.");
          }
        }catch(e){
          showMsg("#signMsg","Sign-in service unavailable. Try again later.");
        }finally{
          $("#signInBtn").disabled = false;
        }
      }

      // --------- Submit limerick
      const limerick = document.getElementById('limerick');
      const charCount = document.getElementById('charCount');
      limerick.addEventListener("input", ()=>{
        const used = (limerick.value||"").length;
        const remaining = Math.max(0, 500 - used);
        charCount.textContent = remaining;
        charCount.style.color = remaining < 50 ? '#B42318' : '#6A5A47';
      });

      document.getElementById("limerickForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        clearMsg("#formMsg");
        if(!state.signed){ showMsg("#formMsg","Please sign in first."); return; }
        if(state.eventState!=="RUNNING"){ showMsg("#formMsg","Submissions are closed."); return; }
        const text = (limerick.value||"").trim();
        if(text.length < 20){ showMsg("#formMsg","Write at least 20 characters."); return; }

        const payload = {
          eventId: state.eventId,
          teamCode: state.teamCode,
          teamName: state.teamName,
          limerick: text,
          topic: ($("#topic").value||"").trim()
        };

        document.getElementById("submitBtn").disabled = true; document.getElementById("busy").style.display="inline";

        try{
          const res = await fetch("/.netlify/functions/submit_limerick_function",{
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(()=>({}));
          if(!res.ok){
            showMsg("#formMsg", (data && (data.message||data.error)) || `Couldn‚Äôt submit. Request failed (${res.status})`);
            document.getElementById("submitBtn").disabled = false; document.getElementById("busy").style.display="none";
            return;
          }
          showMsg("#formMsg","üéâ Submitted! Terry‚Äôs tallymaster is reviewing. Check the leaderboard in a few minutes.", true);
          document.getElementById("topic").classList.add("muted");
          limerick.classList.add("muted");
          lockForm(true);
        }catch(err){
          showMsg("#formMsg","Network error. Try again.");
          document.getElementById("submitBtn").disabled = false;
        }finally{
          document.getElementById("busy").style.display="none";
        }
      });

      // --------- Boot
      async function boot(){
        state.eventId = getEventId();
        await fetchEventState();
        await loadCrews();

        // Autofill from prior sign-in
        const tc = localStorage.getItem("tq.teamCode"); const tn = localStorage.getItem("tq.teamName");
        if(tc && tn){
          state.teamCode = tc; state.teamName = tn; state.signed = true; setCrewStrip();
          lockForm(state.eventState!=="RUNNING");
        }
      }

      document.getElementById("reloadCrews").addEventListener("click", loadCrews);
      document.getElementById("signInBtn").addEventListener("click", signIn);
      boot();
    })();
  </script>
</body>
</html>
