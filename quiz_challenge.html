<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamQuest - The Quiz Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 30%, #F4A460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255,215,0,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255,140,0,0.1) 0%, transparent 50%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,215,0,0.3)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,140,0,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(218,165,32,0.2)"/></svg>');
            pointer-events: none;
            z-index: 0;
        }

        .container {
            background: linear-gradient(145deg, #F5E6D3 0%, #E8D7C3 100%);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
            max-width: 900px;
            width: 100%;
            position: relative;
            overflow: hidden;
            z-index: 1;
            border: 3px solid #8B4513;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #DAA520, #FFD700);
        }

        .container::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 2px solid #DAA520;
            border-radius: 20px;
            pointer-events: none;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        .quiz-icon {
            font-size: 48px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
            filter: drop-shadow(2px 2px 4px rgba(139,69,19,0.3));
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        h1 {
            color: #8B4513;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            text-align: center;
            color: #A0522D;
            margin-bottom: 30px;
            font-size: 1.1em;
            font-weight: 500;
        }

        .team-info {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(139,69,19,0.3);
            border: 2px solid #DAA520;
        }

        .login-section, .ready-section, .quiz-section, .results-section, .already-started-section {
            display: none;
            position: relative;
            z-index: 2;
        }

        .login-section.active, .ready-section.active, .quiz-section.active, .results-section.active, .already-started-section.active {
            display: block;
        }

        .instructions {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-left: 6px solid #DAA520;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 0 15px 15px 0;
            box-shadow: 0 4px 12px rgba(139,69,19,0.1);
            border: 2px solid #DAA520;
            border-left: 6px solid #FF8C00;
        }

        .instructions h3 {
            color: #8B4513;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
            font-weight: 700;
        }

        .instructions ul {
            margin-left: 20px;
            color: #654321;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #8B4513;
            font-weight: 600;
            font-size: 1.1em;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 15px;
            border: 3px solid #DAA520;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #FFFFFF 0%, #FFF8DC 100%);
            font-family: inherit;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #FF8C00;
            background: white;
            box-shadow: 0 0 0 3px rgba(255,140,0,0.2);
            transform: translateY(-1px);
        }

        .pin-input {
            text-align: center;
            font-size: 1.5em;
            letter-spacing: 3px;
            font-weight: bold;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #FF8C00, #DAA520);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            border: 2px solid #8B4513;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255,140,0,0.3);
            background: linear-gradient(135deg, #FFB347, #F0C814);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 15px;
            border: 2px solid #DAA520;
        }

        .question-counter {
            font-size: 1.2em;
            font-weight: bold;
            color: #8B4513;
        }

        .timer {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timer-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(#DAA520 0deg, #F5E6D3 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #8B4513;
            transition: all 0.1s ease;
            border: 3px solid #8B4513;
        }

        .timer-circle.warning {
            background: conic-gradient(#FF8C00 0deg, #FFE4B5 0deg);
            animation: shake 0.5s infinite;
        }

        .timer-circle.danger {
            background: conic-gradient(#DC143C 0deg, #FFB6C1 0deg);
            animation: shake 0.2s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .question-card {
            background: linear-gradient(145deg, #FFFFFF 0%, #FFF8DC 100%);
            border: 3px solid #DAA520;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(139,69,19,0.15);
        }

        .question-number {
            color: #FF8C00;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.3em;
            color: #654321;
            margin-bottom: 25px;
            line-height: 1.4;
            font-weight: 500;
        }

        .question-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            display: block;
            margin-left: auto;
            margin-right: auto;
            border: 3px solid #DAA520;
        }

        .audio-player {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border: 3px solid #DAA520;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .audio-player audio {
            width: 100%;
            max-width: 400px;
        }

        .play-instruction {
            color: #8B4513;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .options-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .option {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border: 3px solid #DAA520;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1em;
        }

        .option:hover {
            background: linear-gradient(135deg, #FFE4B5 0%, #DDD3C2 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139,69,19,0.2);
        }

        .option.selected {
            background: linear-gradient(135deg, #FF8C00, #DAA520);
            color: white;
            border-color: #8B4513;
        }

        .option.correct {
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
            border-color: #006400;
        }

        .option.incorrect {
            background: linear-gradient(135deg, #DC143C, #B22222);
            color: white;
            border-color: #8B0000;
        }

        .option-letter {
            background: white;
            color: #8B4513;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            border: 2px solid #DAA520;
        }

        .option.selected .option-letter {
            background: #FFF8DC;
            color: #8B4513;
        }

        .option.correct .option-letter {
            background: #006400;
            color: white;
            border-color: #004000;
        }

        .option.incorrect .option-letter {
            background: #8B0000;
            color: white;
            border-color: #600000;
        }

        .text-input {
            width: 100%;
            padding: 15px;
            border: 3px solid #DAA520;
            border-radius: 12px;
            font-size: 1.2em;
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(145deg, #FFFFFF 0%, #FFF8DC 100%);
        }

        .text-input:focus {
            outline: none;
            border-color: #FF8C00;
            box-shadow: 0 0 0 3px rgba(255,140,0,0.2);
        }

        .results-summary {
            text-align: center;
            padding: 40px;
        }

        .final-score {
            font-size: 3em;
            color: #FF8C00;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .score-breakdown {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #DAA520;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #DAA520;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .message {
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            display: none;
            border: 2px solid;
        }

        .success-message {
            background: linear-gradient(135deg, #98FB98 0%, #90EE90 100%);
            border-color: #32CD32;
            color: #006400;
        }

        .error-message {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
            border-color: #DC143C;
            color: #8B0000;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
            color: #8B4513;
            font-weight: 600;
        }

        .ready-countdown {
            font-size: 4em;
            color: #FF8C00;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            animation: pulse 1s infinite;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .ready-instructions {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border: 3px solid #DAA520;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .ready-instructions h3 {
            color: #8B4513;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .ready-instructions ul {
            text-align: left;
            margin: 20px 0;
            color: #654321;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .ready-instructions li {
            margin-bottom: 10px;
        }

        .start-quiz-btn {
            width: 100%;
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            animation: glow 2s infinite;
            border: 2px solid #006400;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .start-quiz-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(50,205,50,0.4);
            background: linear-gradient(135deg, #50C878, #32CD32);
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 5px 15px rgba(50,205,50,0.3); }
            50% { box-shadow: 0 10px 25px rgba(50,205,50,0.5); }
        }

        .terry-greeting {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin: 20px 0;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%);
            border-radius: 20px;
            padding: 25px;
            border: 3px solid #DAA520;
            box-shadow: 0 5px 15px rgba(139,69,19,0.2);
        }

        .terry-character {
            flex-shrink: 0;
        }

        .terry-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid #DAA520;
            box-shadow: 0 4px 12px rgba(139,69,19,0.3);
            object-fit: cover;
            background: linear-gradient(135deg, #8B4513, #A0522D);
        }

        .terry-speech {
            flex: 1;
            position: relative;
        }

        .terry-speech::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 15px 15px 15px 0;
            border-color: transparent #FFD700 transparent transparent;
        }

        .terry-note {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #8B4513;
            padding: 25px;
            border-radius: 15px;
            margin: 0;
            border: 3px solid #DAA520;
            position: relative;
            font-weight: 500;
            line-height: 1.6;
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }

        .terry-note::before {
            display: none;
        }

        .already-started-warning {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFA0B4 100%);
            border: 3px solid #DC143C;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .already-started-warning h3 {
            color: #8B0000;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .already-started-warning p {
            color: #8B0000;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .terry-greeting {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .terry-speech::before {
                display: none;
            }

            .terry-image {
                width: 100px;
                height: 100px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .quiz-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .timer-circle {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div class="login-section active" id="loginSection">
            <div class="logo">
                <div class="quiz-icon">🧠</div>
                <h1>The Quiz Challenge</h1>
                <p class="subtitle">10 riddles from Terry's archives! Prove your wit and claim doubloons!</p>
            </div>

            <div class="terry-greeting">
                <div class="terry-character">
                    <img src="/terry-thumbs-up.png" alt="Terry Quest" class="terry-image">
                </div>
                <div class="terry-speech">
                    <div class="terry-note">
                        <strong>Greetings, brave adventurers!</strong> I am Terry Quest, keeper of these treasure vaults. Before ye may claim yer doubloons, ye must prove yer knowledge worthy of a true treasure hunter! Answer me riddles ten, and riches shall be yours!
                    </div>
                </div>
            </div>

            <div class="instructions">
                <h3>📜 Challenge Rules</h3>
                <ul>
                    <li>10 challenging riddles from Terry's ancient archives</li>
                    <li>15 seconds per question - the treasure waits for no one!</li>
                    <li>Some riddles include mysterious audio clues - <strong>make sure your volume is up and ready!</strong></li>
                    <li>Choose wisely before time runs out</li>
                    <li>No turning back once answered - fortune favors the bold!</li>
                    <li>Earn up to 100 doubloons for perfect knowledge mastery!</li>
                </ul>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="teamSelect">Select Your Crew</label>
                    <select id="teamSelect" name="teamSelect" required>
                        <option value="">Choose your treasure hunting crew...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="teamPin">Enter Your Crew's Secret Code</label>
                    <input type="number" id="teamPin" name="teamPin" class="pin-input" 
                           min="1000" max="9999" placeholder="1234" required>
                </div>

                <button type="submit" class="submit-btn">
                    🏴‍☠️ Begin the Knowledge Trial
                </button>
            </form>

            <div class="message" id="loginMessage"></div>
        </div>

        <!-- Already Started Section -->
        <div class="already-started-section" id="alreadyStartedSection">
            <div class="team-info" id="alreadyStartedTeamInfo">
                Crew: Loading...
            </div>

            <div class="logo">
                <div class="quiz-icon">⚠️</div>
                <h1>Trial Already in Progress</h1>
            </div>

            <div class="already-started-warning">
                <h3>🔒 Knowledge Trial Locked</h3>
                <p><strong>This crew has already accepted the challenge!</strong></p>
                <p>The trial began but was not completed. According to Terry's ancient rules, once a crew accepts the challenge, there can be no turning back or restarting.</p>
                <p>The knowledge trial has been marked as <strong>attempted</strong> and cannot be retaken.</p>
                <p>Your crew's final score remains at <strong>0 doubloons</strong> for this challenge.</p>
            </div>

            <div class="terry-greeting">
                <div class="terry-character">
                    <img src="/terry-disappointed.png" alt="Terry Quest" class="terry-image">
                </div>
                <div class="terry-speech">
                    <div class="terry-note">
                        <strong>Alas, brave souls!</strong> The trial cannot be attempted twice. The ancient magic that protects these riddles has already been activated for your crew. Your chance has been used, and the treasure vault remains sealed to ye forever more!
                    </div>
                </div>
            </div>

            <button class="submit-btn" onclick="window.location.href='/teamquest_leaderboard.html'">
                🗺️ Return to Treasure Map
            </button>
        </div>

        <!-- Ready Section -->
        <div class="ready-section" id="readySection">
            <div class="team-info" id="readyTeamInfo">
                Crew: Loading...
            </div>

            <div class="logo">
                <div class="quiz-icon">🧠</div>
                <h1>Prepare for the Trial!</h1>
            </div>

            <div class="ready-instructions">
                <h3>⚡ Terry's Knowledge Trial</h3>
                <ul>
                    <li><strong>10 riddles</strong> total - mix of ancient puzzles and modern mysteries</li>
                    <li><strong>15 seconds per riddle</strong> - time is precious as doubloons!</li>
                    <li><strong>No turning back</strong> - once answered or time expires, ye sail forward</li>
                    <li><strong>Audio clues</strong> - some riddles contain mystical sound traces, <strong>ensure your volume is up!</strong></li>
                    <li><strong>One trial only</strong> - your wit will be tested and your doubloons earned</li>
                    <li><strong>Maximum 100 doubloons</strong> - 10 doubloons per correct answer</li>
                </ul>
                
                <div style="margin-top: 25px; padding: 15px; background: linear-gradient(135deg, #FFE4B5 0%, #DEB887 100%); border-radius: 10px; color: #8B4513; border: 2px solid #DAA520;">
                    <strong>⚠️ Heed this warning:</strong> Once the trial begins, there be no stopping or restarting. Prepare your mind and find a quiet harbor before ye proceed!
                </div>
            </div>

            <button class="start-quiz-btn" onclick="acceptChallenge()">
                🚀 Accept the Challenge
            </button>
        </div>

        <!-- Quiz Section -->
        <div class="quiz-section" id="quizSection">
            <div class="team-info" id="teamInfo">
                Crew: Loading...
            </div>

            <div class="quiz-header">
                <div class="question-counter" id="questionCounter">
                    Riddle 1 of 10
                </div>
                <div class="timer">
                    <div class="timer-circle" id="timerCircle">15</div>
                    <div style="color: #8B4513; font-weight: bold;">seconds</div>
                </div>
            </div>

            <div class="question-card" id="questionCard">
                <!-- Question content will be inserted here -->
            </div>

            <button class="submit-btn" id="nextBtn" style="display: none;" onclick="nextQuestion()">
                Next Riddle →
            </button>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <div class="team-info" id="resultsTeamInfo">
                Crew: Loading...
            </div>

            <div class="results-summary">
                <h2>🎉 Trial Complete!</h2>
                <div class="final-score" id="finalScore">0/10</div>
                <p style="font-size: 1.2em; color: #8B4513; margin-bottom: 30px;">
                    Doubloons earned: <span id="doubloonsEarned" style="color: #FF8C00; font-weight: bold;">0</span> 🪙
                </p>

                <div class="terry-note">
                    <strong>Well done, brave soul!</strong> Ye have completed me trial of knowledge. Your doubloons have been added to your crew's treasure chest. Check the treasure map to see how ye fare against other adventurers!
                </div>

                <div class="score-breakdown" id="scoreBreakdown">
                    <!-- Score breakdown will be inserted here -->
                </div>

                <p style="color: #8B4513; margin-top: 30px;">
                    Your knowledge has been tested and your doubloons claimed! Return to the treasure map to continue your quest for riches!
                </p>

                <button class="submit-btn" onclick="window.location.href='/teamquest_leaderboard.html'">
                    🗺️ View Treasure Map
                </button>
            </div>

            <div class="loading" id="submitLoading">
                🪙 Recording your doubloons in the treasure ledger...
            </div>

            <div class="message" id="submitMessage"></div>
        </div>
    </div>

    <script>
        let currentTeam = null;
        let allTeams = [];
        let currentQuestionIndex = 0;
        let timeLeft = 15;
        let timerInterval = null;
        let userAnswers = [];
        let quizStartTime = null;
        let quizStatus = null; // 'not_started', 'started', 'completed'

        // Quiz questions data
        const quizQuestions = [
            {
                id: 1,
                type: 'multiple_choice',
                question: 'What 3 letter animal makes this noise?',
                audioUrl: '/animal-sound',
                audioDescription: 'Animal sound clip',
                options: [
                    { letter: 'A', text: 'Pig' },
                    { letter: 'B', text: 'Cow' },
                    { letter: 'C', text: 'Yak' },
                    { letter: 'D', text: 'Elk' }
                ],
                correctAnswer: 'C',
                doubloons: 10
            },
            {
                id: 2,
                type: 'multiple_choice',
                question: 'What is the meaning of the word: Gambado?',
                options: [
                    { letter: 'A', text: 'Colourful Hat' },
                    { letter: 'B', text: 'Native of Gambia' },
                    { letter: 'C', text: 'Prank' },
                    { letter: 'D', text: 'Foolish bet' }
                ],
                correctAnswer: 'C',
                doubloons: 10
            },
            {
                id: 3,
                type: 'multiple_choice',
                question: 'How far away from the centre of Leamington Spa, is there another city called Leamington in Ontario, Canada?',
                options: [
                    { letter: 'A', text: '3,668 miles' },
                    { letter: 'B', text: '2,964 miles' },
                    { letter: 'C', text: '4,312 miles' },
                    { letter: 'D', text: '5,095 miles' }
                ],
                correctAnswer: 'A',
                doubloons: 10
            },
            {
                id: 4,
                type: 'multiple_choice',
                question: 'Answer this riddle: What gets wetter the more it dries?',
                options: [
                    { letter: 'A', text: '___s_' },
                    { letter: 'B', text: '__w__' },
                    { letter: 'C', text: '___t' },
                    { letter: 'D', text: '_a__' }
                ],
                correctAnswer: 'B',
                explanation: 'Answer: Towel',
                doubloons: 10
            },
            {
                id: 5,
                type: 'text_input',
                question: 'Name the one-word sport depicted in this image?',
                imageUrl: '/tennis-sport.png',
                imageDescription: 'Sports image showing tennis',
                correctAnswer: 'tennis',
                acceptableAnswers: ['tennis', 'Tennis', 'TENNIS'],
                doubloons: 10
            },
            {
                id: 6,
                type: 'multiple_choice',
                question: 'Who is this talking in this clip?',
                audioUrl: '/voice-clip.mp3',
                audioDescription: 'Voice identification clip',
                options: [
                    { letter: 'A', text: 'Ed Sheeran' },
                    { letter: 'B', text: 'Harry Styles' },
                    { letter: 'C', text: 'Tom Holland' },
                    { letter: 'D', text: 'Taron Egerton' }
                ],
                correctAnswer: 'C',
                doubloons: 10
            },
            {
                id: 7,
                type: 'text_input',
                question: 'What is the number of the only other month, after August (8), for Augustus, to be named after a mortal man?',
                correctAnswer: '7',
                acceptableAnswers: ['7', 'seven', 'Seven', 'SEVEN', 'july', 'July', 'JULY', 'Jul', 'jul', 'JUL'],
                explanation: 'Answer: 7 (July)',
                doubloons: 10
            },
            {
                id: 8,
                type: 'text_input',
                question: 'Which one-word car manufacturer uses this logo?',
                imageUrl: '/smart-logo.png',
                imageDescription: 'Smart car manufacturer logo',
                correctAnswer: 'smart',
                acceptableAnswers: ['smart', 'Smart', 'SMART', 'SmArt', 'sMaRt'],
                doubloons: 10
            },
            {
                id: 9,
                type: 'multiple_choice',
                question: 'Listen to this intro. Which band had a huge hit with this song?',
                audioUrl: '/song-intro.mp3',
                audioDescription: 'Song intro clip',
                options: [
                    { letter: 'A', text: 'Red Hot Chilli Peppers' },
                    { letter: 'B', text: 'The Killers' },
                    { letter: 'C', text: 'The Foo Fighters' },
                    { letter: 'D', text: 'Kings of Leon' }
                ],
                correctAnswer: 'B',
                doubloons: 10
            },
            {
                id: 10,
                type: 'multiple_choice',
                question: 'Five friends are waiting in line to get coffee. Ross is behind Joey but not last. Chandler is behind Monica, who is in front of both Ross and Joey. Rachel is second. Who is at the front of the line?',
                options: [
                    { letter: 'A', text: 'Ross' },
                    { letter: 'B', text: 'Joey' },
                    { letter: 'C', text: 'Chandler' },
                    { letter: 'D', text: 'Monica' },
                    { letter: 'E', text: 'Rachel' }
                ],
                correctAnswer: 'D',
                doubloons: 10
            }
        ];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTeamsList();
        });

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedTeamCode = document.getElementById('teamSelect').value;
            const enteredPin = document.getElementById('teamPin').value;
            
            if (!selectedTeamCode) {
                showMessage('loginMessage', 'Please select your crew from the list.', 'error');
                return;
            }
            
            if (!/^\d{4}$/.test(enteredPin)) {
                showMessage('loginMessage', 'Please enter a valid 4-digit secret code.', 'error');
                return;
            }

            try {
                // Check quiz status first
                const status = await checkQuizStatus(selectedTeamCode);
                
                if (status.completed) {
                    showMessage('loginMessage', 'This crew has already completed the knowledge trial. Doubloons are final and cannot be earned again.', 'error');
                    return;
                }
                
                if (status.started) {
                    // Verify PIN then show "already started" section
                    const isValid = await verifyTeamAndPin(selectedTeamCode, enteredPin);
                    if (isValid) {
                        const selectedTeam = allTeams.find(team => team.teamCode === selectedTeamCode);
                        currentTeam = selectedTeam;
                        showAlreadyStartedSection();
                    } else {
                        showMessage('loginMessage', 'Incorrect secret code for the selected crew. Check your code and try again.', 'error');
                    }
                    return;
                }

                // Quiz not started - proceed normally
                const isValid = await verifyTeamAndPin(selectedTeamCode, enteredPin);
                
                if (isValid) {
                    const selectedTeam = allTeams.find(team => team.teamCode === selectedTeamCode);
                    currentTeam = selectedTeam;
                    showReadyScreen();
                } else {
                    showMessage('loginMessage', 'Incorrect secret code for the selected crew. Check your code and try again.', 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'Error verifying crew credentials. Please try again.', 'error');
            }
        });

        function showReadyScreen() {
            document.getElementById('readyTeamInfo').textContent = 'Crew: ' + currentTeam.teamName;
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('readySection').classList.add('active');
        }

        function showAlreadyStartedSection() {
            document.getElementById('alreadyStartedTeamInfo').textContent = 'Crew: ' + currentTeam.teamName;
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('alreadyStartedSection').classList.add('active');
        }

        async function acceptChallenge() {
            try {
                // CRITICAL: Record quiz start in backend IMMEDIATELY
                const startResponse = await fetch('/.netlify/functions/start_quiz_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        teamCode: currentTeam.teamCode,
                        teamName: currentTeam.teamName,
                        quizStartTime: new Date().toISOString()
                    })
                });

                if (!startResponse.ok) {
                    throw new Error('Failed to record quiz start');
                }

                const startResult = await startResponse.json();
                if (!startResult.success) {
                    throw new Error('Quiz start recording failed');
                }

                // Quiz start successfully recorded - now begin countdown
                startQuizCountdown();

            } catch (error) {
                console.error('Error recording quiz start:', error);
                showMessage('loginMessage', 'Failed to start quiz trial. Please try again.', 'error');
                // Don't proceed if we can't record the start
            }
        }

        function startQuizCountdown() {
            const readySection = document.getElementById('readySection');
            
            readySection.innerHTML = `
                <div class="team-info">Crew: ${currentTeam.teamName}</div>
                <div class="logo">
                    <div class="quiz-icon">🧠</div>
                    <h1>Prepare Yourself!</h1>
                </div>
                <div class="ready-countdown" id="countdownNumber">3</div>
                <div style="text-align: center; font-size: 1.2em; color: #8B4513;">
                    Trial begins in...
                </div>
            `;
            
            let countdown = 3;
            const countdownElement = document.getElementById('countdownNumber');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = countdown;
                } else if (countdown === 0) {
                    countdownElement.textContent = 'FORTH!';
                    countdownElement.style.color = '#32CD32';
                } else {
                    clearInterval(countdownInterval);
                    startQuiz();
                }
            }, 1000);
        }

        function startQuiz() {
            quizStartTime = new Date();
            currentQuestionIndex = 0;
            userAnswers = [];
            
            document.getElementById('teamInfo').textContent = 'Crew: ' + currentTeam.teamName;
            document.getElementById('readySection').classList.remove('active');
            document.getElementById('quizSection').classList.add('active');
            
            showQuestion();
        }

        function showQuestion() {
            const question = quizQuestions[currentQuestionIndex];
            const questionCard = document.getElementById('questionCard');
            
            document.getElementById('questionCounter').textContent = 
                'Riddle ' + (currentQuestionIndex + 1) + ' of ' + quizQuestions.length;
            
            timeLeft = 15;
            updateTimer();
            startTimer();
            
            let questionHTML = '<div class="question-number">Riddle ' + (currentQuestionIndex + 1) + '</div>';
            questionHTML += '<div class="question-text">' + question.question + '</div>';
            
            if (question.audioUrl) {
                questionHTML += '<div class="audio-player">';
                questionHTML += '<div class="play-instruction">🎵 Listen to this mysterious clue:</div>';
                questionHTML += '<audio controls preload="auto" id="questionAudio">';
                questionHTML += '<source src="' + question.audioUrl + '" type="audio/mpeg">';
                questionHTML += 'Your browser does not support the audio element.';
                questionHTML += '</audio>';
                questionHTML += '</div>';
            }
            
            if (question.imageUrl) {
                questionHTML += '<img src="' + question.imageUrl + '" alt="' + question.imageDescription + '" class="question-image">';
            }
            
            if (question.type === 'multiple_choice') {
                questionHTML += '<div class="options-grid">';
                question.options.forEach(option => {
                    questionHTML += '<div class="option" onclick="selectOption(\'' + option.letter + '\')">';
                    questionHTML += '<div class="option-letter">' + option.letter + '</div>';
                    questionHTML += '<div>' + option.text + '</div>';
                    questionHTML += '</div>';
                });
                questionHTML += '</div>';
            } else if (question.type === 'text_input') {
                questionHTML += '<input type="text" class="text-input" id="textAnswer" placeholder="Type your answer here..." maxlength="50">';
            }
            
            questionCard.innerHTML = questionHTML;
            
            const audio = document.getElementById('questionAudio');
            if (audio) {
                audio.play().catch(e => console.log('Audio autoplay blocked'));
            }
        }

        function selectOption(letter) {
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            event.target.closest('.option').classList.add('selected');
            submitAnswer(letter);
        }

        function submitAnswer(answer) {
            clearInterval(timerInterval);
            
            const question = quizQuestions[currentQuestionIndex];
            let isCorrect = false;
            
            if (question.type === 'multiple_choice') {
                isCorrect = (answer === question.correctAnswer);
            } else if (question.type === 'text_input') {
                if (!answer) {
                    answer = document.getElementById('textAnswer').value.trim();
                }
                isCorrect = checkTextAnswer(answer, question);
            }
            
            userAnswers.push({
                questionId: question.id,
                userAnswer: answer,
                correctAnswer: question.correctAnswer,
                isCorrect: isCorrect,
                doubloons: isCorrect ? question.doubloons : 0,
                timeLeft: timeLeft
            });
            
            showAnswerFeedback(isCorrect, question);
            
            setTimeout(() => {
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                } else {
                    finishQuiz();
                }
            }, 2000);
        }

        function checkTextAnswer(userAnswer, question) {
            if (!userAnswer || typeof userAnswer !== 'string') {
                return false;
            }
            
            const normalizedUser = normalizeText(userAnswer);
            
            if (question.acceptableAnswers) {
                return question.acceptableAnswers.some(acceptable => {
                    const normalizedAcceptable = normalizeText(acceptable);
                    return normalizedUser === normalizedAcceptable;
                });
            }
            
            const normalizedCorrect = normalizeText(question.correctAnswer);
            return normalizedUser === normalizedCorrect;
        }

        function normalizeText(text) {
            if (!text || typeof text !== 'string') {
                return '';
            }
            
            return text
                .toLowerCase()
                .trim()
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, ' ')
                .replace(/\s/g, '');
        }

        function showAnswerFeedback(isCorrect, question) {
            if (question.type === 'multiple_choice') {
                document.querySelectorAll('.option').forEach(opt => {
                    const letter = opt.querySelector('.option-letter').textContent;
                    if (letter === question.correctAnswer) {
                        opt.classList.add('correct');
                    } else if (opt.classList.contains('selected') && !isCorrect) {
                        opt.classList.add('incorrect');
                    }
                    opt.style.pointerEvents = 'none';
                });
            }
            
            if (question.explanation) {
                const questionCard = document.getElementById('questionCard');
                questionCard.innerHTML += '<div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #FFF8DC 0%, #F5E6D3 100%); border-radius: 10px; color: #8B4513; font-weight: bold; border: 2px solid #DAA520;">' + question.explanation + '</div>';
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                
                if (timeLeft <= 0) {
                    submitAnswer('');
                }
            }, 1000);
        }

        function updateTimer() {
            const timerCircle = document.getElementById('timerCircle');
            timerCircle.textContent = timeLeft;
            
            timerCircle.classList.remove('warning', 'danger');
            if (timeLeft <= 3) {
                timerCircle.classList.add('danger');
            } else if (timeLeft <= 5) {
                timerCircle.classList.add('warning');
            }
            
            const percentage = (timeLeft / 15) * 360;
            if (timeLeft <= 3) {
                timerCircle.style.background = 'conic-gradient(#DC143C ' + percentage + 'deg, #FFB6C1 ' + percentage + 'deg)';
            } else if (timeLeft <= 5) {
                timerCircle.style.background = 'conic-gradient(#FF8C00 ' + percentage + 'deg, #FFE4B5 ' + percentage + 'deg)';
            } else {
                timerCircle.style.background = 'conic-gradient(#DAA520 ' + percentage + 'deg, #F5E6D3 ' + percentage + 'deg)';
            }
        }

        function finishQuiz() {
            const totalCorrect = userAnswers.filter(answer => answer.isCorrect).length;
            const totalDoubloons = userAnswers.reduce((sum, answer) => sum + answer.doubloons, 0);
            
            document.getElementById('quizSection').classList.remove('active');
            document.getElementById('resultsSection').classList.add('active');
            document.getElementById('resultsTeamInfo').textContent = 'Crew: ' + currentTeam.teamName;
            document.getElementById('finalScore').textContent = totalCorrect + '/' + quizQuestions.length;
            document.getElementById('doubloonsEarned').textContent = totalDoubloons;
            
            let breakdownHTML = '';
            userAnswers.forEach((answer, index) => {
                const question = quizQuestions[index];
                breakdownHTML += '<div class="breakdown-item">';
                breakdownHTML += '<div>Riddle ' + (index + 1) + ': ' + question.question.substring(0, 50) + '...</div>';
                breakdownHTML += '<div style="color: ' + (answer.isCorrect ? '#32CD32' : '#DC143C') + '; font-weight: bold;">';
                breakdownHTML += answer.isCorrect ? '✓ +' + answer.doubloons + ' doubloons' : '✗ 0 doubloons';
                breakdownHTML += '</div>';
                breakdownHTML += '</div>';
            });
            document.getElementById('scoreBreakdown').innerHTML = breakdownHTML;
            
            submitQuizResults(totalDoubloons, userAnswers);
        }

        async function submitQuizResults(totalDoubloons, answers) {
            const submitLoading = document.getElementById('submitLoading');
            const submitMessage = document.getElementById('submitMessage');
            
            submitLoading.style.display = 'block';
            
            try {
                const quizData = {
                    teamCode: currentTeam.teamCode,
                    teamName: currentTeam.teamName,
                    totalScore: totalDoubloons,
                    questionsCorrect: answers.filter(a => a.isCorrect).length,
                    totalQuestions: quizQuestions.length,
                    completionTime: new Date().toISOString(),
                    quizStartTime: quizStartTime.toISOString(),
                    answers: answers
                };
                
                const response = await fetch('/.netlify/functions/submit_quiz_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(quizData)
                });
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('submitMessage', '🎉 Doubloons successfully added to your treasure chest! Check the treasure map to see your crew\'s standing.', 'success');
                } else {
                    throw new Error(result.error || 'Submission failed');
                }
                
            } catch (error) {
                console.error('Quiz submission error:', error);
                showMessage('submitMessage', 'Failed to record doubloons. Your score: ' + totalDoubloons + ' doubloons.', 'error');
            } finally {
                submitLoading.style.display = 'none';
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('textAnswer')) {
                const answer = document.getElementById('textAnswer').value.trim();
                if (answer) {
                    submitAnswer(answer);
                }
            }
        });

        async function loadTeamsList() {
            try {
                const response = await fetch('/.netlify/functions/get_leaderboard_function');
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                const data = await response.json();
                
                if (data && data.success && data.teams && Array.isArray(data.teams)) {
                    allTeams = data.teams;
                    populateTeamDropdown(data.teams);
                    return;
                }
                
                throw new Error('Invalid response structure from leaderboard');
                
            } catch (error) {
                console.error('Failed to load crews:', error);
                showMessage('loginMessage', 'Unable to load crew list from the system. Please refresh the page or contact your organizer.', 'error');
            }
        }

        function populateTeamDropdown(teams) {
            const select = document.getElementById('teamSelect');
            select.innerHTML = '<option value="">Choose your treasure hunting crew...</option>';
            
            teams
                .sort((a, b) => a.teamName.localeCompare(b.teamName))
                .forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.teamCode;
                    option.textContent = team.teamName;
                    select.appendChild(option);
                });
        }

        async function verifyTeamAndPin(teamCode, enteredPin) {
            try {
                const response = await fetch('/.netlify/functions/verify_team_pin_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        teamCode: teamCode,
                        pin: enteredPin
                    })
                });
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    return result.valid;
                } else {
                    throw new Error(result.error || 'Verification failed');
                }
                
            } catch (error) {
                console.error('Error verifying team and PIN:', error);
                return false;
            }
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.textContent = message;
            container.className = 'message ' + (type === 'error' ? 'error-message' : 'success-message');
            container.style.display = 'block';
        }

        async function checkQuizStatus(teamCode) {
            try {
                const response = await fetch('/.netlify/functions/check_quiz_status_function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ teamCode: teamCode })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return {
                        started: result.started || false,
                        completed: result.completed || false
                    };
                }
                
                // If function doesn't exist yet, assume not started
                return { started: false, completed: false };
                
            } catch (error) {
                console.log('Quiz status check failed (assuming not started):', error);
                return { started: false, completed: false };
            }
        }
    </script>
</body>
</html>
