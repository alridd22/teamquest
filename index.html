<!--
TeamQuest • Crew Registration — Font Fix (2025-10-03)
CHANGES
- “Titles” (hero title, section h2, sub-h3, and form labels) now use the sans-serif UI stack.
- Text INSIDE inputs (including placeholders) is explicitly set to Handlee.
- Kept overall theme and spacing intact; no layout/JS changes.
- Minor polish: ensured labels have consistent weight/size; preserved accessible focus styles.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta name="theme-color" content="#2A1F18">
  <title>TeamQuest - Crew Registration</title>

  <!-- Handlee for input/body where needed -->
  <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:url("/TQ%20Web%20extended%20background-100.jpg");
      --ink:#2E2114; --ink-soft:#6A5A47;
      --parchment:#F7EED8; --parchment-2:#F3E6CF;
      --gold:#F0C433; --gold-deep:#A7711F;
      --error:#B42318;

      --radius-card:22px; --radius-input:16px;
      --shadow-card:0 18px 40px rgba(0,0,0,.35);
      --shadow-soft:0 2px 6px rgba(0,0,0,.10);
      --focus:0 0 0 3px rgba(240,196,51,.45);
      --dur:180ms; --ease:cubic-bezier(.2,.6,.2,1);

      --hero-h: 300px;
      --gutter: 22px;
      --hero-gap: 26px;

      /* Font stacks */
      --sans: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --handlee: "Handlee", ui-rounded, "Segoe UI", Roboto, Arial, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      /* Keep Handlee as the base body font per theme */
      font-family:var(--handlee);
      color:var(--ink);
      background:
        linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.45)),
        var(--bg);
      background-size:cover; background-position:top center; background-attachment:fixed;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    .hero{
      min-height:var(--hero-h);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
      padding:28px var(--gutter) var(--hero-gap);
      text-align:center;
    }
    .brand-logo{
      width:min(260px, 68vw); height:auto; margin-bottom:10px;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 10px 24px rgba(0,0,0,.35));
    }
    /* Title: sans-serif */
    .hero-title{
      font-family: var(--sans);
      font-weight:900; font-size:22px; color:#F7EED8;
      text-shadow:0 2px 6px rgba(0,0,0,.6); letter-spacing:.2px;
    }

    .stack{ padding:0 var(--gutter) 24px; }

    .card{
      background:var(--parchment);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-card);
      padding:18px 16px;
      border:1px solid rgba(0,0,0,.06);
      margin:0 auto 18px;
      width:100%;
      max-width:720px;
    }

    /* Section titles: sans-serif */
    .card h2{
      margin:0 0 10px; text-align:center;
      font-family: var(--sans);
      font-weight:900; font-size:24px; color:var(--ink);
    }
    .card p{ margin:0; line-height:1.6; color:var(--ink); font-size:18px; }

    .chip-wrap{ display:flex; justify-content:center; align-items:center; margin-top:14px; }
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 16px; min-width:66%;
      text-align:center; background:#D7C39B; color:var(--ink); font-weight:800;
      border-radius:14px; font-size:20px; border:3px dashed rgba(0,0,0,.6);
    }

    /* Form labels are “titles”: make sans-serif */
    label{
      display:block; margin:12px 6px 6px; font-size:22px; color:var(--ink); font-weight:800;
      font-family: var(--sans);
      line-height:1.2;
    }

    /* Inputs explicitly Handlee inside the boxes */
    .input{
      width:100%; padding:14px 12px; border-radius:var(--radius-input);
      border:3px solid var(--gold); background:#fff; color:var(--ink);
      font-size:20px; font-family: var(--handlee);
      transition:border-color var(--dur) var(--ease), box-shadow var(--dur) var(--ease), transform var(--dur) var(--ease);
      min-height:44px;
    }
    .input::placeholder{
      color:rgba(0,0,0,.35);
      font-family: var(--handlee);
    }
    .input:focus{ outline:none; box-shadow:var(--focus); border-color:var(--gold-deep); transform:translateY(-1px); }

    .char-row{ display:flex; justify-content:flex-end; margin:6px 6px 0; color:var(--ink-soft); font-size:16px; }

    .remember{
      background:var(--parchment-2);
      border-radius:var(--radius-card);
      border:1px solid rgba(0,0,0,.06);
      padding:18px 14px; box-shadow:var(--shadow-soft);
      margin-top:12px; text-align:left;
    }
    /* Subheading/title inside helper card: sans-serif */
    .remember h3{
      margin:6px 0 8px; font-size:22px; color:var(--ink);
      font-family: var(--sans);
      font-weight:900; text-align:left;
    }
    .remember p{ margin:0; font-size:18px; color:var(--ink); }
    .remember .icon{ font-size:30px; display:inline-block; vertical-align:middle; margin-right:6px; }

    .cta-gap{ height:16px; }

    /* Primary button stays sans-serif for clarity */
    .submit-btn{
      width:100%;
      background:linear-gradient(90deg, #FDBA2D, #F0C433);
      color:#442812; font-weight:900; font-size:22px;
      border-radius:16px; border:3px solid #A7711F;
      padding:16px; cursor:pointer; margin-top:6px; min-height:44px;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      transition:transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
      font-family: var(--sans);
    }
    .submit-btn:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(0,0,0,.3); }
    .submit-btn:active{ transform:translateY(0); }
    .submit-btn:disabled{ opacity:.6; cursor:not-allowed; }

    .loading{
      display:none; text-align:center; margin-top:10px; color:#EEE3CD; font-weight:700; font-size:18px;
      text-shadow:0 1px 2px rgba(0,0,0,.4);
      font-family: var(--sans);
    }
    .error-message{
      display:none; margin-top:12px; padding:10px; border-radius:12px;
      font-weight:700; font-size:16px; text-align:center; color:#fff;
      background:var(--error); border:2px solid #7E1C12;
      font-family: var(--sans);
    }
    .note{margin-top:8px; font-weight:800; color:#6A5A47; text-align:center}

    @media (min-width:480px){
      :root{ --hero-h: 340px; --gutter: 26px; --hero-gap: 30px; }
      .brand-logo{ width:min(300px, 62vw); }
      .chip{ min-width:58%; }
    }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation-duration:0ms !important; }
    }
  </style>
</head>
<body>
  <header class="hero" role="banner">
    <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest" class="brand-logo" width="640" height="480" decoding="async" onerror="this.remove()">
    <div class="hero-title">Crew Registration</div>
  </header>

  <main class="stack" role="main">
    <section class="card" aria-labelledby="welcome-title">
      <h2 id="welcome-title">Welcome aboard!</h2>
      <p>Pick a crew name and choose your 4-digit code to join the Quest.</p>
      <div class="chip-wrap">
        <div class="chip" id="teamCodeDisplay" aria-live="polite">Crew Code: Loading…</div>
      </div>
      <div class="note" id="eventNote"></div>
    </section>

    <section class="card" aria-labelledby="how-title">
      <h2 id="how-title">How it works</h2>
      <p>Enter your crew name and create a 4-digit code. You’ll use this code to access challenges throughout the Quest.</p>
    </section>

    <section class="card">
      <form id="registrationForm" novalidate>
        <label for="teamName">Crew Name</label>
        <input type="text" id="teamName" name="teamName" maxlength="50"
               placeholder="e.g., The Golden Compass Crew" required autocomplete="off" class="input" aria-describedby="charCount">
        <div class="char-row"><span id="charCount" aria-live="polite">50</span></div>

        <label for="teamPin">Crew Code (4-digits)</label>
        <input type="text" id="teamPin" name="teamPin" inputmode="numeric" pattern="\d{4}"
               placeholder="1234" required autocomplete="off" class="input" aria-describedby="pinHelp">

        <div class="remember" id="pinHelp">
          <h3><span class="icon" aria-hidden="true">⚠️</span>Remember your code</h3>
          <p>You’ll use this code to access the activities during the Quest.</p>
        </div>

        <div class="cta-gap" aria-hidden="true"></div>

        <button type="submit" class="submit-btn" id="submitBtn">Register Crew</button>

        <div class="loading" id="loading" role="status" aria-live="polite">Registering your crew…</div>
        <div class="error-message" id="errorMessage" role="alert" aria-live="assertive"></div>
      </form>
    </section>
  </main>

  <script>
    // --- Storage helpers ---
    const LS = { token:"tq_token", teamCode:"tq_team_code", teamName:"tq_team_name", eventId:"tq_event_id" };
    function saveAuth({ token, teamCode, teamName, eventId }) {
      if (token) localStorage.setItem(LS.token, token);
      if (teamCode) localStorage.setItem(LS.teamCode, teamCode);
      if (teamName) localStorage.setItem(LS.teamName, teamName);
      if (eventId) localStorage.setItem(LS.eventId, eventId);
    }

    // --- Params (NORMALISE EVENT TO UPPERCASE) ---
    const urlParams = new URLSearchParams(window.location.search);
    const teamCode = (urlParams.get('team') || 'UNKNOWN').toUpperCase();

    // Normalize EVENT to uppercase so backend/sheets match (e.g., TTHQTEST)
    const eventIdRaw = (urlParams.get('event') || urlParams.get('eventId') || '').trim();
    const eventId    = eventIdRaw ? eventIdRaw.toUpperCase() : '';

    // Display code + event hint
    document.getElementById('teamCodeDisplay').textContent = `Crew Code: ${teamCode}`;
    const eventNote = document.getElementById('eventNote');
    if (eventId) {
      eventNote.textContent = `Event: ${eventId}`;
      eventNote.style.color = '#2E2114';
    } else {
      eventNote.textContent = 'Add ?event=YOUR_EVENT_ID to this page URL before registering.';
      eventNote.style.color = '#B42318';
    }

    // Character counter
    const teamNameInput = document.getElementById('teamName');
    const charCount = document.getElementById('charCount');
    teamNameInput.addEventListener('input', function () {
      const remaining = Math.max(0, 50 - this.value.length);
      charCount.textContent = remaining;
      charCount.style.color = remaining < 8 ? '#B42318' : '#6A5A47';
    });

    // 4-digit clamp
    const teamPinInput = document.getElementById('teamPin');
    teamPinInput.addEventListener('input', function () {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    // Submit -> Netlify function (now includes eventId and preserves it on redirect)
    document.getElementById('registrationForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const teamName = teamNameInput.value.trim();
      const pin = (teamPinInput.value || "").trim();
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');

      function showError(message) { errorMessage.textContent = message; errorMessage.style.display = 'block'; }

      if (!eventId) return showError('Missing event in URL. Please add ?event=YOUR_EVENT_ID and reload.');
      if (!teamCode || teamCode === 'UNKNOWN') return showError('Missing crew code (?team=...) in the URL.');
      if (!teamName) return showError('Please enter a crew name.');
      if (!pin || pin.length !== 4) return showError('Please enter exactly 4 digits for your crew code.');

      submitBtn.disabled = true; loading.style.display = 'block'; errorMessage.style.display = 'none';

      try {
        const res = await fetch('/.netlify/functions/team_register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teamCode, pin, teamName, eventId })
        });
        const result = await res.json().catch(()=>({success:false}));
        if (!res.ok || result.success === false) {
          throw new Error(result.message || 'Crew registration failed. Please try again.');
        }

        saveAuth({ token: result.token, teamCode: result.teamCode, teamName: result.teamName, eventId: (result.eventId || eventId) });

        // Preserve event in the success URL too (force uppercase)
        const successUrl = new URL('team-registration-success.html', location.origin);
        successUrl.searchParams.set('team', result.teamName);
        successUrl.searchParams.set('code', teamCode);
        successUrl.searchParams.set('event', (result.eventId || eventId).toUpperCase());
        window.location.href = successUrl.pathname + '?' + successUrl.searchParams.toString();
      } catch (err) {
        showError(err.message || 'Crew registration failed. Please try again.');
      } finally {
        submitBtn.disabled = false; loading.style.display = 'none';
      }
    });
  </script>
</body>
</html>
