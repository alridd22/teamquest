<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <meta name="theme-color" content="#F7F0E5">
  <title>The Treasure Quest - Crew Registration</title>
  <style>
    /* ---------- Tokens (aligned to TeamQuest Style Guide) ---------- */
    :root{
      --color-bg:#F7F0E5;
      --color-card:#FFFFFF;
      --color-ink:#3B2A16;
      --color-ink-muted:#6E5538;
      --color-brand:#DAA520;    /* treasure gold */
      --color-accent:#FF8C00;   /* trail orange */
      --color-deep:#7A441D;     /* explorer brown */
      --color-line:rgba(59,42,22,0.14);
      --color-success:#208A3E; --color-warning:#B7791F; --color-error:#B42318;
      --radius-sm:12px; --radius-md:16px; --radius-lg:20px; --radius-xl:24px;
      --shadow-1:0 1px 3px rgba(0,0,0,.10), 0 1px 2px rgba(0,0,0,.06);
      --shadow-2:0 8px 20px rgba(0,0,0,.12);
      --focus:0 0 0 3px rgba(218,165,32,.45);
      --dur:180ms; --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color:var(--color-ink); background:var(--color-bg);
      background-image:
        radial-gradient(120% 100% at 80% 0%, rgba(218,165,32,0.06) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(122,68,29,0.03), rgba(255,255,255,0));
      display:flex; align-items:center; justify-content:center; padding:24px;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    .container{
      width:100%; max-width:640px; background:var(--color-card);
      border:2px solid var(--color-deep); border-radius:24px; box-shadow:var(--shadow-2);
      padding:28px 24px; position:relative; overflow:hidden;
    }
    .container::before{
      content:""; position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(218,165,32,.12), transparent 30%, transparent 70%, rgba(218,165,32,.12)),
        repeating-linear-gradient(0deg, rgba(0,0,0,.015), rgba(0,0,0,.015) 1px, transparent 1px, transparent 2px);
      pointer-events:none;
    }

    .header{ text-align:center; margin-bottom:16px; }
    /* TeamQuest brand logo */
    .brand-logo{
      display:block; margin:0 auto 8px;
      width:min(320px, 70vw); height:auto;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.25)) drop-shadow(0 8px 20px rgba(0,0,0,.18));
    }
    h1{ font-size:28px; margin:8px 0 4px; color:var(--color-deep); letter-spacing:.2px; }
    .subtitle{ color:var(--color-ink-muted); font-size:16px; }

    /* Header spacing (replace your existing .header rule) */
.header{
  text-align:center;
  margin-bottom:16px;
  padding-top:20px;   /* spacer above the logo */
}

/* TeamQuest brand logo ‚Äì smaller + responsive (replace your existing .brand-logo rule) */
.brand-logo{
  display:block;
  margin:0 auto 12px;     /* small gap under logo */
  width:min(200px, 42vw); /* was larger; now slimmer by default */
  height:auto;
  filter:
    drop-shadow(0 1px 0 rgba(0,0,0,.25))
    drop-shadow(0 8px 20px rgba(0,0,0,.18));
}

/* Step up slightly on wider screens */
@media (min-width:720px){
  .brand-logo{ width:min(260px, 30vw); }
}
    .terry-greeting{
      display:flex; gap:16px; margin:20px 0 16px; padding:16px;
      border:2px solid var(--color-brand); border-radius:16px; background:#FFF8DC;
      box-shadow:var(--shadow-1);
    }
    .terry-character img{
      width:84px; height:84px; border-radius:12px; object-fit:cover;
      border:3px solid var(--color-brand);
    }
    .terry-note{ margin:0; color:var(--color-ink); line-height:1.55; font-weight:600; }
    .terry-note strong{ color:var(--color-deep); }

    .team-code{
      margin:8px 0 20px; padding:12px 14px; text-align:center; font-weight:700;
      border:2px dashed var(--color-brand); border-radius:14px; background:#FFFDF3;
      color:var(--color-deep);
    }

    .instructions{
      border:1px solid var(--color-line); border-left:4px solid var(--color-accent);
      padding:14px; border-radius:12px; margin-bottom:16px; background:#FFFAF1;
    }
    .instructions h3{ margin:0 0 8px; color:var(--color-deep); font-size:18px; }
    .instructions p{ margin:0; color:var(--color-ink-muted); }

    form{ margin-top:8px; }
    .form-group{ margin-bottom:16px; }
    label{ display:block; font-weight:700; margin-bottom:6px; color:var(--color-deep); }

    input[type="text"], input[type="number"], input[type="tel"]{
      width:100%; padding:14px 12px; border:2px solid var(--color-brand); border-radius:12px;
      font-size:16px; transition:box-shadow var(--dur) var(--ease), border-color var(--dur) var(--ease), transform var(--dur) var(--ease);
      background:#FFFFFF; color:var(--color-ink);
    }
    input:focus{ outline:2px solid transparent; box-shadow:var(--focus); border-color:var(--color-accent); transform:translateY(-1px); }

    .char-count{ margin-top:6px; font-size:12px; color:var(--color-ink-muted); text-align:right; }

    .pin-group{ display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:start; }
    .pin-info{
      border:1px solid var(--color-line); border-radius:12px; padding:12px; background:#FFF9EA;
      color:var(--color-ink); font-size:14px; line-height:1.5;
    }
    .pin-info strong{ display:block; margin-bottom:6px; color:var(--color-deep); }

    .submit-btn{
      width:100%; background:linear-gradient(135deg,var(--color-accent),var(--color-brand)); color:#fff; border:none; padding:16px;
      border-radius:14px; font-size:18px; font-weight:800; cursor:pointer; display:flex; gap:10px; align-items:center; justify-content:center;
      transition:transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease), opacity var(--dur) var(--ease);
      border:2px solid var(--color-deep);
    }
    .submit-btn:hover{ transform:translateY(-2px); box-shadow:0 12px 25px rgba(255,140,0,.25); }
    .submit-btn:active{ transform:translateY(0); }
    .submit-btn:disabled{ opacity:.65; cursor:not-allowed; transform:none; }

    .loading{
      display:none; text-align:center; margin-top:14px; color:var(--color-deep); font-weight:700; font-size:16px;
    }

    .error-message{
      display:none; margin-top:14px; padding:12px; border-radius:12px; font-weight:600;
      color:#FFFFFF; background:var(--color-error); border:2px solid #7E1C12; text-align:center;
    }

    @media (max-width:600px){
      .container{ padding:24px 18px; }
      h1{ font-size:24px; }
      .pin-group{ grid-template-columns:1fr; gap:12px; }
      .terry-greeting{ flex-direction:column; align-items:center; text-align:center; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation-duration:0ms !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <!-- TeamQuest Logo -->
      <img
        src="/Team%20Quest%20Logo-01.png"
        alt="TeamQuest"
        class="brand-logo"
        width="640" height="480"
        decoding="async"
        fetchpriority="high"
      />
      <h1>The Treasure Quest</h1>
      <p class="subtitle">Crew Registration</p>
    </header>

    <section class="terry-greeting" aria-labelledby="welcome-title">
      <div class="terry-character">
        <img src="/terry-thinking.png" alt="Terry Quest mascot">
      </div>
      <div class="terry-speech">
        <p id="welcome-title" class="terry-note">
          <strong>Welcome aboard!</strong> Pick a crew name and choose your 4-digit code to join the Quest.
        </p>
      </div>
    </section>

    <div class="team-code" id="teamCodeDisplay" aria-live="polite">Crew Code: Loading‚Ä¶</div>

    <section class="instructions" aria-labelledby="how-title">
      <h3 id="how-title">üó∫Ô∏è How it works</h3>
      <p>Enter your crew name and create a 4 digit code. You‚Äôll use this code to access challenges throughout the Quest.</p>
    </section>

    <form id="registrationForm" novalidate>
      <div class="form-group">
        <label for="teamName">Crew Name</label>
        <input
          type="text"
          id="teamName"
          name="teamName"
          maxlength="50"
          placeholder="e.g., The Golden Compass Crew"
          required
          aria-describedby="teamNameHelp charCount"
          autocomplete="off"
        >
        <div id="teamNameHelp" class="help" style="font-size:12px;color:var(--color-ink-muted);margin-top:6px;">
          Max 50 characters.
        </div>
        <div class="char-count"><span id="charCount" aria-live="polite">50</span> characters remaining</div>
      </div>

      <div class="form-group">
        <label for="teamPin">Crew Code (4 digits)</label>
        <div class="pin-group">
          <div>
            <!-- Keep the same ID; text+pattern for keypad & validation -->
            <input
              type="text"
              id="teamPin"
              name="teamPin"
              inputmode="numeric"
              pattern="\\d{4}"
              placeholder="1234"
              required
              aria-describedby="pinHelp"
              autocomplete="off"
            >
          </div>
          <div class="pin-info" id="pinHelp">
            <strong>Remember it.</strong>
            You‚Äôll use this code to access activities during the quest.
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn" aria-label="Register Crew">
        üè¥‚Äç‚ò†Ô∏è Register Crew
      </button>

      <div class="loading" id="loading" role="status" aria-live="polite">‚ö° Registering your crew‚Ä¶</div>
      <div class="error-message" id="errorMessage" role="alert" aria-live="assertive"></div>
    </form>
  </div>

  <script>
    // --- Simple client storage helpers ---
    const LS = {
      token: "tq_token",
      teamCode: "tq_team_code",
      teamName: "tq_team_name",
      eventId: "tq_event_id",
    };
    function saveAuth({ token, teamCode, teamName, eventId }) {
      if (token) localStorage.setItem(LS.token, token);
      if (teamCode) localStorage.setItem(LS.teamCode, teamCode);
      if (teamName) localStorage.setItem(LS.teamName, teamName);
      if (eventId) localStorage.setItem(LS.eventId, eventId);
    }

    // Get crew code from URL (?team=ABC)
    const urlParams = new URLSearchParams(window.location.search);
    const teamCode = (urlParams.get('team') || 'UNKNOWN').toUpperCase();
    document.getElementById('teamCodeDisplay').textContent = `Crew Code: ${teamCode}`;

    // Character counter
    const teamNameInput = document.getElementById('teamName');
    const charCount = document.getElementById('charCount');
    teamNameInput.addEventListener('input', function () {
      const remaining = 50 - this.value.length;
      charCount.textContent = remaining;
      charCount.style.color = remaining < 10 ? '#B42318' : '#6E5538';
    });

    // 4-digit clamp (keep same #teamPin hook)
    const teamPinInput = document.getElementById('teamPin');
    teamPinInput.addEventListener('input', function () {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    // Submit -> /.netlify/functions/team_register
    document.getElementById('registrationForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const teamName = teamNameInput.value.trim();
      const pin = (teamPinInput.value || "").trim(); // API expects "pin"
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        errorMessage.focus?.();
      }

      // Basic validation
      if (!teamName) return showError('Please enter a crew name.');
      if (!pin || pin.length !== 4) return showError('Please enter exactly 4 digits for your crew code.');

      // UI state
      submitBtn.disabled = true;
      loading.style.display = 'block';
      errorMessage.style.display = 'none';

      try {
        const res = await fetch('/.netlify/functions/team_register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teamCode, pin, teamName })
        });
        const result = await res.json();

        if (!res.ok || result.success === false) {
          throw new Error(result.message || 'Crew registration failed. Please try again.');
        }

        // Save auth locally for the rest of the site
        saveAuth({
          token: result.token,
          teamCode: result.teamCode,
          teamName: result.teamName,
          eventId: result.eventId
        });

        // Redirect to your success/next page
        window.location.href = `team-registration-success.html?team=${encodeURIComponent(result.teamName)}&code=${encodeURIComponent(teamCode)}`;
      } catch (err) {
        console.error('Crew registration error:', err);
        showError(err.message || 'Crew registration failed. Please try again.');
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    });
  </script>
</body>
</html>
