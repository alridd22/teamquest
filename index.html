<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta name="theme-color" content="#F2E6D3">
  <title>The Treasure Quest - Crew Registration</title>
  <style>
    /* ---------- Tokens (Excitement Pack) ---------- */
    :root{
      --color-bg:#F2E6D3;
      --color-card:#FFFCF6;
      --color-ink:#2E2114;
      --color-ink-muted:#5B4630;
      --color-brand:#E0B218;   /* bright coin gold */
      --color-accent:#FF7A1A;  /* zestier trail orange */
      --color-deep:#6B3A18;    /* explorer brown */
      --color-line:rgba(46,33,20,.18);
      --color-success:#1F8A3B; --color-warning:#B7791F; --color-error:#B42318;

      --radius-sm:12px; --radius-md:16px; --radius-lg:20px; --radius-xl:24px;
      --shadow-1:0 1px 3px rgba(0,0,0,.10), 0 1px 2px rgba(0,0,0,.06);
      --shadow-2:0 14px 28px rgba(0,0,0,.16);
      --focus:0 0 0 3px rgba(224,178,24,.45);
      --dur:180ms; --ease:cubic-bezier(.2,.6,.2,1);

      --bg-vignette: radial-gradient(120% 90% at 50% -10%, rgba(224,178,24,.10) 0%, rgba(255,255,255,0) 55%),
                     radial-gradient(80% 60% at 100% 0%, rgba(224,178,24,.08) 0%, rgba(255,255,255,0) 50%);
      --bg-contours: url("data:image/svg+xml;utf8,\
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200' opacity='0.07'>\
        <path d='M0,120 C40,90 80,140 120,110 160,80 200,120 200,120' fill='none' stroke='%236B3A18' stroke-width='2' stroke-linecap='round'/>\
        <path d='M0,60 C50,40 100,80 150,60 200,40 200,60 200,60' fill='none' stroke='%236B3A18' stroke-width='1.5' stroke-linecap='round'/>\
      </svg>");
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color:var(--color-ink);
      background:var(--color-bg);
      background-image: var(--bg-vignette), var(--bg-contours);
      background-size: cover, 420px 420px;
      background-repeat: no-repeat, repeat;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      display:flex; align-items:flex-start; justify-content:center;
      padding: max(16px, env(safe-area-inset-top)) 16px 24px;
    }

    /* Mobile-first container */
    .container{
      width:100%; max-width:460px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,0)),
        var(--color-card);
      border:2px solid var(--color-deep);
      border-radius:24px;
      box-shadow:var(--shadow-2);
      padding:18px 16px 20px;
      position:relative; overflow:hidden;
    }
    .top-ribbon{
      position:absolute; left:0; right:0; top:0; height:10px;
      background:linear-gradient(90deg,#E0B218,#FF7A1A,#E0B218);
      opacity:.95;
    }

    .header{ text-align:center; margin-bottom:14px; padding-top:16px; position:relative; }
    .brand-wrap{ display:flex; align-items:center; justify-content:center; margin-bottom:8px; }
    .brand-logo{
      display:block; width:min(180px, 55vw); height:auto;
      filter:
        drop-shadow(0 1px 0 rgba(0,0,0,.25))
        drop-shadow(0 8px 14px rgba(0,0,0,.18));
    }
    .burst{
      position:absolute; inset:auto 0 0 0; top:8px; height:80px; pointer-events:none;
      background:
        radial-gradient(closest-side, rgba(255,255,255,.35), rgba(255,255,255,0) 70%),
        radial-gradient(closest-side, rgba(224,178,24,.25), rgba(224,178,24,0) 70%);
      opacity:.35; animation: floaty 6s var(--ease) infinite;
    }
    @keyframes floaty{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(3px)} }
    @media (prefers-reduced-motion: reduce){ .burst{ animation:none } }

    h1{ font-size:22px; margin:4px 0 2px; color:var(--color-deep); letter-spacing:.2px; }
    .subtitle{ color:var(--color-ink-muted); font-size:14px; }

    .terry-greeting{
      display:flex; gap:12px; margin:14px 0 12px; padding:12px;
      border:2px solid var(--color-brand); border-radius:16px; background:#FFF2C9;
      box-shadow:var(--shadow-1);
    }
    .terry-character img{
      width:72px; height:72px; border-radius:10px; object-fit:cover;
      border:3px solid var(--color-brand);
    }
    .terry-note{ margin:0; color:var(--color-ink); line-height:1.55; font-weight:600; }
    .terry-note strong{ color:var(--color-deep); }

    .team-code{
      margin:6px 0 14px; padding:10px 12px; text-align:center; font-weight:900; font-size:14px;
      border:2px dashed var(--color-brand); border-radius:14px; background:#FFF9E8; color:var(--color-deep);
    }

    .instructions{
      border:1px solid var(--color-line); border-left:4px solid var(--color-accent);
      padding:12px; border-radius:12px; margin-bottom:12px; background:#FFF6EC;
    }
    .instructions h3{ margin:0 0 6px; color:var(--color-deep); font-size:16px; }
    .instructions p{ margin:0; color:var(--color-ink-muted); font-size:14px; }

    form{ margin-top:4px; }
    .form-group{ margin-bottom:12px; }
    label{ display:block; font-weight:900; margin-bottom:6px; color:var(--color-deep); font-size:14px; }

    input[type="text"], input[type="number"], input[type="tel"]{
      width:100%; padding:14px 12px; border:2px solid var(--color-brand); border-radius:12px;
      font-size:16px; background:#FFFFFF; color:var(--color-ink);
      transition: box-shadow var(--dur) var(--ease), border-color var(--dur) var(--ease), transform var(--dur) var(--ease);
    }
    input::placeholder{ color:rgba(91,70,48,.7); }
    input:focus{ outline:2px solid transparent; box-shadow:var(--focus); border-color:var(--color-accent); transform:translateY(-1px); }

    .char-count{ margin-top:6px; font-size:12px; color:var(--color-ink-muted); text-align:right; }

    .pin-group{ display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start; }
    .pin-info{
      border:1px solid var(--color-line); border-radius:12px; padding:12px; background:#FFF3D8;
      color:var(--color-ink); font-size:13px; line-height:1.5;
    }
    .pin-info strong{ display:block; margin-bottom:6px; color:var(--color-deep); }

    .divider{
      height:10px; margin:14px 0 10px;
      background: radial-gradient(closest-side, rgba(224,178,24,.35), rgba(224,178,24,0) 70%);
      mask-image: radial-gradient(closest-side, #000, transparent 70%);
      -webkit-mask-image: radial-gradient(closest-side, #000, transparent 70%);
      opacity:.6;
    }

    .submit-btn{
      width:100%;
      background:linear-gradient(135deg,var(--color-accent),var(--color-brand));
      color:#fff; border:none; padding:16px;
      border-radius:14px; font-size:18px; font-weight:900; letter-spacing:.2px;
      cursor:pointer; display:flex; gap:10px; align-items:center; justify-content:center;
      transition: transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease), opacity var(--dur) var(--ease);
      border:2px solid var(--color-deep);
    }
    .submit-btn:hover{ transform:translateY(-2px); box-shadow:0 12px 22px rgba(255,122,26,.22); }
    .submit-btn:active{ transform:translateY(0); }
    .submit-btn:disabled{ opacity:.65; cursor:not-allowed; transform:none; }

    .loading{
      display:none; text-align:center; margin-top:12px; color:var(--color-deep); font-weight:800; font-size:15px;
    }

    .error-message{
      display:none; margin-top:12px; padding:12px; border-radius:12px; font-weight:700; font-size:14px;
      color:#FFFFFF; background:var(--color-error); border:2px solid #7E1C12; text-align:center;
    }

    @media (max-width:480px){
      .container{ padding:16px 14px 18px; }
      h1{ font-size:20px; }
      .pin-group{ grid-template-columns:1fr; gap:10px; }
      .terry-greeting{ align-items:center; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation-duration:0ms !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-ribbon" aria-hidden="true"></div>

    <header class="header">
      <div class="brand-wrap">
        <img
          src="/Team%20Quest%20Logo-01.png"
          alt="TeamQuest"
          class="brand-logo"
          width="640" height="480"
          decoding="async"
          onerror="this.closest('.brand-wrap').remove();"
        />
      </div>
      <div class="burst" aria-hidden="true"></div>
      <h1>Your Quest Begins</h1>
      <p class="subtitle">Crew Registration</p>
    </header>

    <section class="terry-greeting" aria-labelledby="welcome-title">
      <div class="terry-character">
        <img src="/terry-thinking.png" alt="Terry Quest mascot">
      </div>
      <div class="terry-speech">
        <p id="welcome-title" class="terry-note">
          <strong>Welcome aboard!</strong> Pick a crew name and choose your 4-digit code to join the Quest.
        </p>
      </div>
    </section>

    <div class="divider" aria-hidden="true"></div>

    <div class="team-code" id="teamCodeDisplay" aria-live="polite">Crew Code: Loading‚Ä¶</div>

    <section class="instructions" aria-labelledby="how-title">
      <h3 id="how-title">üó∫Ô∏è How it works</h3>
      <p>Enter your crew name and create a 4-digit code. You‚Äôll use this code to access challenges throughout the Quest.</p>
    </section>

    <form id="registrationForm" novalidate>
      <div class="form-group">
        <label for="teamName">Crew Name</label>
        <input
          type="text"
          id="teamName"
          name="teamName"
          maxlength="50"
          placeholder="e.g., The Golden Compass Crew"
          required
          aria-describedby="charCount"
          autocomplete="off"
        >
        <!-- No helper line; just the live counter -->
        <div class="char-count"><span id="charCount" aria-live="polite">50</span> characters remaining</div>
      </div>

      <div class="form-group">
        <label for="teamPin">Crew Code (4 digits)</label>
        <div class="pin-group">
          <div>
            <!-- Keep the same ID; text+pattern for keypad & validation -->
            <input
              type="text"
              id="teamPin"
              name="teamPin"
              inputmode="numeric"
              pattern="\\d{4}"
              placeholder="1234"
              required
              aria-describedby="pinHelp"
              autocomplete="off"
            >
          </div>
          <div class="pin-info" id="pinHelp">
            <strong>Remember it.</strong>
            You‚Äôll use this code to access activities during the quest.
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn" aria-label="Register Crew">
        üè¥‚Äç‚ò†Ô∏è Register Crew
      </button>

      <div class="loading" id="loading" role="status" aria-live="polite">‚ö° Registering your crew‚Ä¶</div>
      <div class="error-message" id="errorMessage" role="alert" aria-live="assertive"></div>
    </form>
  </div>

  <script>
    // --- Simple client storage helpers ---
    const LS = {
      token: "tq_token",
      teamCode: "tq_team_code",
      teamName: "tq_team_name",
      eventId: "tq_event_id",
    };
    function saveAuth({ token, teamCode, teamName, eventId }) {
      if (token) localStorage.setItem(LS.token, token);
      if (teamCode) localStorage.setItem(LS.teamCode, teamCode);
      if (teamName) localStorage.setItem(LS.teamName, teamName);
      if (eventId) localStorage.setItem(LS.eventId, eventId);
    }

    // Get crew code from URL (?team=ABC)
    const urlParams = new URLSearchParams(window.location.search);
    const teamCode = (urlParams.get('team') || 'UNKNOWN').toUpperCase();
    document.getElementById('teamCodeDisplay').textContent = `Crew Code: ${teamCode}`;

    // Character counter
    const teamNameInput = document.getElementById('teamName');
    const charCount = document.getElementById('charCount');
    teamNameInput.addEventListener('input', function () {
      const remaining = 50 - this.value.length;
      charCount.textContent = remaining;
      charCount.style.color = remaining < 10 ? '#B42318' : '#5B4630';
    });

    // 4-digit clamp (keep same #teamPin hook)
    const teamPinInput = document.getElementById('teamPin');
    teamPinInput.addEventListener('input', function () {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    // Submit -> /.netlify/functions/team_register
    document.getElementById('registrationForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const teamName = teamNameInput.value.trim();
      const pin = (teamPinInput.value || "").trim(); // API expects "pin"
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        errorMessage.focus?.();
      }

      // Basic validation
      if (!teamName) return showError('Please enter a crew name.');
      if (!pin || pin.length !== 4) return showError('Please enter exactly 4 digits for your crew code.');

      // UI state
      submitBtn.disabled = true;
      loading.style.display = 'block';
      errorMessage.style.display = 'none';

      try {
        const res = await fetch('/.netlify/functions/team_register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teamCode, pin, teamName })
        });
        const result = await res.json();

        if (!res.ok || result.success === false) {
          throw new Error(result.message || 'Crew registration failed. Please try again.');
        }

        // Save auth locally for the rest of the site
        saveAuth({
          token: result.token,
          teamCode: result.teamCode,
          teamName: result.teamName,
          eventId: result.eventId
        });

        // Redirect to your success/next page
        window.location.href = `team-registration-success.html?team=${encodeURIComponent(result.teamName)}&code=${encodeURIComponent(teamCode)}`;
      } catch (err) {
        console.error('Crew registration error:', err);
        showError(err.message || 'Crew registration failed. Please try again.');
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    });
  </script>
</body>
</html>
