<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Terry's Treasure Quest - Crew Registration</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:20px; position:relative;
    }
    body::before{
      content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,215,0,.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255,140,0,.1) 0%, transparent 50%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,215,0,0.3)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,140,0,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(218,165,32,0.2)"/></svg>');
    }
    .container{
      background: linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);
      border-radius:25px; padding:40px; max-width:600px; width:100%;
      position:relative; overflow:hidden; z-index:1; border:3px solid #8B4513;
      box-shadow:0 20px 40px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.3);
    }
    .container::before{content:''; position:absolute; top:0; left:0; right:0; height:8px;
      background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700);}
    .container::after{content:''; position:absolute; top:15px; left:15px; right:15px; bottom:15px;
      border:2px solid #DAA520; border-radius:20px; pointer-events:none;}
    .logo{text-align:center; margin-bottom:30px; position:relative; z-index:2;}
    .treasure-icon{font-size:48px; margin-bottom:20px; color:#DAA520; animation:bounce 2s infinite;
      filter:drop-shadow(2px 2px 4px rgba(139,69,19,.3));}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
    h1{color:#8B4513; text-align:center; margin-bottom:10px; font-size:2.5em; font-weight:700;
      text-shadow:2px 2px 4px rgba(0,0,0,.1);}
    .subtitle{text-align:center; color:#A0522D; margin-bottom:30px; font-size:1.1em; font-weight:500;}
    .terry-greeting{display:flex; align-items:flex-start; gap:20px; margin:20px 0;
      background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%); border-radius:20px; padding:25px;
      border:3px solid #DAA520; box-shadow:0 5px 15px rgba(139,69,19,.2);}
    .terry-character{flex-shrink:0;}
    .terry-character img{width:100px !important; height:100px !important; border-radius:15px !important;
      border:4px solid #DAA520; box-shadow:0 4px 12px rgba(139,69,19,.3); object-fit:cover;
      background:linear-gradient(135deg,#8B4513,#A0522D); display:block;}
    .terry-speech{flex:1; position:relative;}
    .terry-speech::before{content:''; position:absolute; left:-15px; top:20px; width:0; height:0;
      border-style:solid; border-width:15px 15px 15px 0; border-color:transparent #FFD700 transparent transparent;}
    .terry-note{background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%); color:#8B4513; padding:20px;
      border-radius:15px; margin:0; border:3px solid #DAA520; position:relative; font-weight:500; line-height:1.6;
      box-shadow:0 5px 15px rgba(255,215,0,.3);}
    .team-code{background:linear-gradient(135deg,#8B4513,#A0522D); color:#fff; padding:20px; border-radius:15px;
      text-align:center; font-size:1.3em; font-weight:bold; margin-bottom:30px; border:3px solid #DAA520;
      box-shadow:0 5px 15px rgba(139,69,19,.3); text-shadow:1px 1px 2px rgba(0,0,0,.2);}
    .instructions{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%); border-left:6px solid #FF8C00;
      padding:25px; margin-bottom:30px; border-radius:0 15px 15px 0; box-shadow:0 4px 12px rgba(139,69,19,.1);
      border:2px solid #DAA520;}
    .instructions h3{color:#8B4513; margin-bottom:15px; display:flex; align-items:center; gap:10px;
      font-size:1.3em; font-weight:700;}
    .instructions p{color:#654321; line-height:1.6; font-weight:500;}
    .form-group{margin-bottom:25px; position:relative; z-index:2;}
    label{display:block; margin-bottom:8px; color:#8B4513; font-weight:600; font-size:1.1em;}
    input[type="text"], input[type="number"]{
      width:100%; padding:15px; border:3px solid #DAA520; border-radius:12px; font-size:16px; transition:all .3s ease;
      background:linear-gradient(145deg,#FFFFFF 0%,#FFF8DC 100%); font-family:inherit; color:#654321; font-weight:500;
    }
    input[type="text"]:focus, input[type="number"]:focus{
      outline:none; border-color:#FF8C00; background:#fff; box-shadow:0 0 0 3px rgba(255,140,0,.2); transform:translateY(-1px);
    }
    .char-count{text-align:right; font-size:.9em; color:#8B4513; margin-top:5px; font-weight:500;}
    .pin-group{display:grid; grid-template-columns:1fr 1fr; gap:25px; align-items:start;}
    .pin-info{background:linear-gradient(135deg,#FFE4B5 0%,#DEB887 100%); border:3px solid #DAA520; border-radius:12px;
      padding:18px; font-size:.95em; color:#654321; font-weight:500; line-height:1.5;}
    .pin-info strong{display:block; margin-bottom:8px; color:#8B4513; font-size:1em;}
    .submit-btn{
      width:100%; background:linear-gradient(135deg,#FF8C00,#DAA520); color:#fff; border:none; padding:20px;
      border-radius:15px; font-size:1.2em; font-weight:700; cursor:pointer; transition:all .3s ease;
      display:flex; align-items:center; justify-content:center; gap:12px; border:3px solid #8B4513;
      text-shadow:1px 1px 2px rgba(0,0,0,.2);
    }
    .submit-btn:hover{transform:translateY(-2px); box-shadow:0 12px 25px rgba(255,140,0,.3);
      background:linear-gradient(135deg,#FFB347,#F0C814);}
    .submit-btn:disabled{opacity:.6; cursor:not-allowed; transform:none; background:linear-gradient(135deg,#A0522D,#8B4513);}
    .error-message{
      color:#8B0000; text-align:center; margin-top:20px; padding:15px; background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);
      border-radius:12px; border:3px solid #DC143C; display:none; font-weight:500;
    }
    .loading{display:none; text-align:center; margin-top:20px; color:#8B4513; font-weight:600; font-size:1.1em;}
    @media (max-width:600px){
      .container{padding:30px 20px;}
      h1{font-size:2em;}
      .pin-group{grid-template-columns:1fr; gap:20px;}
      .terry-greeting{flex-direction:column; align-items:center; text-align:center;}
      .terry-speech::before{display:none;}
      .terry-character img{width:90px !important; height:90px !important;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <div class="treasure-icon">üè¥‚Äç‚ò†Ô∏è</div>
      <h1>Terry's Treasure Quest</h1>
      <p class="subtitle">Crew Registration</p>
    </div>

    <div class="terry-greeting">
      <div class="terry-character">
        <img src="/terry-thinking.png" alt="Terry Quest" class="terry-image">
      </div>
      <div class="terry-speech">
        <div class="terry-note">
          <strong>Welcome aboard!</strong> Pick a crew name and confirm your 4-digit code to join the quest.
        </div>
      </div>
    </div>

    <div class="team-code" id="teamCodeDisplay">Crew Code: Loading‚Ä¶</div>

    <div class="instructions">
      <h3>üó∫Ô∏è How it works</h3>
      <p>Enter your crew name and your 4-digit code. That‚Äôs it ‚Äî you‚Äôll be signed in for all challenges.</p>
    </div>

    <form id="registrationForm">
      <div class="form-group">
        <label for="teamName">Crew Name</label>
        <input type="text" id="teamName" name="teamName" maxlength="50" placeholder="e.g., The Golden Compass Crew" required>
        <div class="char-count"><span id="charCount">50</span> characters remaining</div>
      </div>

      <div class="form-group">
        <label for="teamPin">Crew Code (4 digits)</label>
        <div class="pin-group">
          <div>
            <input type="number" id="teamPin" name="teamPin" min="0" max="9999" inputmode="numeric" placeholder="1234" required>
          </div>
          <div class="pin-info">
            <strong>Remember it.</strong>
            You‚Äôll use this code to access activities during the quest.
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">üè¥‚Äç‚ò†Ô∏è Register Crew</button>

      <div class="loading" id="loading">‚ö° Registering your crew‚Ä¶</div>
      <div class="error-message" id="errorMessage"></div>
    </form>
  </div>

  <script>
    // --- Simple client storage helpers ---
    const LS = {
      token: "tq_token",
      teamCode: "tq_team_code",
      teamName: "tq_team_name",
      eventId: "tq_event_id",
    };
    function saveAuth({ token, teamCode, teamName, eventId }) {
      if (token) localStorage.setItem(LS.token, token);
      if (teamCode) localStorage.setItem(LS.teamCode, teamCode);
      if (teamName) localStorage.setItem(LS.teamName, teamName);
      if (eventId) localStorage.setItem(LS.eventId, eventId);
    }

    // Get crew code from URL (?team=ABC)
    const urlParams = new URLSearchParams(window.location.search);
    const teamCode = (urlParams.get('team') || 'UNKNOWN').toUpperCase();
    document.getElementById('teamCodeDisplay').textContent = `Crew Code: ${teamCode}`;

    // Character counter
    const teamNameInput = document.getElementById('teamName');
    const charCount = document.getElementById('charCount');
    teamNameInput.addEventListener('input', function () {
      const remaining = 50 - this.value.length;
      charCount.textContent = remaining;
      charCount.style.color = remaining < 10 ? '#DC143C' : '#8B4513';
    });

    // 4-digit clamp
    const teamPinInput = document.getElementById('teamPin');
    teamPinInput.addEventListener('input', function () {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    // Submit -> /.netlify/functions/team_register
    document.getElementById('registrationForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const teamName = teamNameInput.value.trim();
      const pin = (teamPinInput.value || "").trim(); // API expects "pin"
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');

      // Basic validation
      if (!teamName) return showError('Please enter a crew name.');
      if (!pin || pin.length !== 4) return showError('Please enter exactly 4 digits.');

      // UI state
      submitBtn.disabled = true; loading.style.display = 'block'; errorMessage.style.display = 'none';

      try {
        const res = await fetch('/.netlify/functions/team_register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teamCode, pin, teamName })
        });
        const result = await res.json();

        if (!res.ok || result.success === false) {
          throw new Error(result.message || 'Crew registration failed. Please try again.');
        }

        // Save auth locally for the rest of the site
        saveAuth({
          token: result.token,
          teamCode: result.teamCode,
          teamName: result.teamName,
          eventId: result.eventId
        });

        // Redirect to your success/next page
        window.location.href = `team-registration-success.html?team=${encodeURIComponent(result.teamName)}&code=${encodeURIComponent(teamCode)}`;
      } catch (err) {
        console.error('Crew registration error:', err);
        showError(err.message || 'Crew registration failed. Please try again.');
      } finally {
        submitBtn.disabled = false; loading.style.display = 'none';
      }
    });

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
    }
  </script>
</body>
</html>
