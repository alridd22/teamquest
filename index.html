<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta name="theme-color" content="#2A1F18">
  <title>The Treasure Quest - Crew Registration</title>

  <!-- Handlee (playful script) -->
  <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">

  <style>
    /* ===== Tokens matching the mockups ===== */
    :root{
      --bg-image: url("/images/tq-bg-main.jpg"); /* ← replace with your actual background image */
      --color-wood:#2A1F18;           /* deep wood */
      --color-parchment:#F7EED8;      /* light parchment */
      --color-parchment-2:#F3E6CF;    /* slightly deeper parchment */
      --color-ink:#2E2114;            /* dark ink */
      --color-ink-muted:#6A5A47;      /* muted ink */
      --color-gold:#F0C433;           /* coin gold */
      --color-gold-deep:#C89E14;      /* outline gold */
      --color-orange:#FF8C00;         /* accent */
      --color-chip:#D7C39B;           /* code chip fill */
      --color-error:#B42318;

      --radius-card:20px;
      --radius-input:16px;
      --shadow-card:0 18px 40px rgba(0,0,0,.35);
      --shadow-soft:0 2px 6px rgba(0,0,0,.10);

      --focus:0 0 0 3px rgba(240,196,51,.45);
      --dur:180ms; --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Handlee", ui-rounded, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--color-ink);
      background-color:var(--color-wood);
      background-image:
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.45)),
        var(--bg-image);
      background-size:cover;
      background-position:top center;
      background-attachment:fixed;
      display:flex; align-items:flex-start; justify-content:center;
      padding: max(16px, env(safe-area-inset-top)) 14px 24px;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    .container{
      width:100%; max-width:500px;
      background:linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.30)), var(--color-parchment);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-card);
      padding:18px 14px 20px;
      position:relative; overflow:hidden;
      border:1px solid rgba(255,255,255,.25);
    }

    /* Brand header */
    .brand{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      margin-top:8px; margin-bottom:10px;
      text-align:center;
    }
    .brand-logo{
      width:min(200px, 60vw); height:auto;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 10px 24px rgba(0,0,0,.35));
    }
    .page-title{
      font-size:24px; color:#EEE3CD; letter-spacing:.3px;
      text-shadow:0 2px 6px rgba(0,0,0,.6);
      margin-top:8px;
    }

    /* Cards */
    .card{
      background:var(--color-parchment);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-soft);
      padding:16px;
      border:1px solid rgba(0,0,0,.06);
      margin:14px 8px;
    }
    .card + .card{ margin-top:16px; }

    .card h2{
      margin:0 0 10px; text-align:center;
      font-size:26px; color:var(--color-ink);
    }
    .card p{
      margin:0; line-height:1.6; color:var(--color-ink);
      font-size:18px;
    }

    /* Crew code chip (dashed) */
    .chip{
      margin:14px auto 2px; text-align:center; display:inline-block;
      background:var(--color-chip); color:var(--color-ink); font-weight:700;
      padding:10px 14px; border-radius:14px; font-size:20px;
      border:3px dashed rgba(0,0,0,.6);
    }

    /* Inputs */
    label{
      display:block; margin:12px 6px 6px;
      font-size:22px; color:var(--color-ink); font-weight:700;
    }
    .input{
      width:100%; padding:14px 12px; border-radius:var(--radius-input);
      border:3px solid var(--color-gold); background:#fff; color:var(--color-ink);
      font-size:20px; transition:border-color var(--dur) var(--ease), box-shadow var(--dur) var(--ease), transform var(--dur) var(--ease);
    }
    .input::placeholder{ color:rgba(0,0,0,.35) }
    .input:focus{ outline:none; box-shadow:var(--focus); border-color:var(--color-gold-deep); transform:translateY(-1px); }

    .char-row{
      display:flex; justify-content:space-between; align-items:center;
      margin:6px 6px 0; color:var(--color-ink-muted); font-size:16px;
    }

    /* Remember panel */
    .remember{
      background:var(--color-parchment-2);
      border-radius:var(--radius-card);
      border:1px solid rgba(0,0,0,.06);
      padding:18px 14px;
      text-align:center;
      margin:10px 8px 16px;
      box-shadow:var(--shadow-soft);
    }
    .remember h3{
      margin:10px 0 6px; font-size:26px; color:var(--color-ink);
    }
    .remember p{ margin:0; font-size:18px; color:var(--color-ink); }
    .remember .icon{ font-size:34px; display:inline-block; }

    /* CTA */
    .submit-btn{
      width:calc(100% - 28px); margin:6px 14px 2px;
      background:linear-gradient(90deg, #FDBA2D, #F0C433);
      color:#4A2A11; font-weight:900; font-size:22px;
      border-radius:16px; border:3px solid #A7711F;
      padding:16px; cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      transition:transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
    }
    .submit-btn:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(0,0,0,.3); }
    .submit-btn:active{ transform:translateY(0); }
    .submit-btn:disabled{ opacity:.6; cursor:not-allowed; }

    .loading{
      display:none; text-align:center; margin-top:10px; color:#EEE3CD; font-weight:700; font-size:18px;
      text-shadow:0 1px 2px rgba(0,0,0,.4);
    }
    .error-message{
      display:none; margin:12px 14px 0; padding:10px; border-radius:12px;
      font-weight:700; font-size:16px; text-align:center; color:#fff;
      background:var(--color-error); border:2px solid #7E1C12;
    }

    @media (max-width:420px){
      .page-title{ font-size:22px }
      .card h2, .remember h3{ font-size:24px }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation-duration:0ms !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest" class="brand-logo" width="640" height="480" decoding="async"
           onerror="this.remove()">
      <div class="page-title">Crew Registration</div>
    </div>

    <!-- Welcome card -->
    <section class="card" aria-labelledby="welcome-title">
      <h2 id="welcome-title">Welcome aboard!</h2>
      <p>Pick a crew name and choose your 4-digit code to join the Quest.</p>
      <div class="chip" id="teamCodeDisplay" aria-live="polite">Crew Code: Loading…</div>
    </section>

    <!-- How it works -->
    <section class="card" aria-labelledby="how-title">
      <h2 id="how-title">How it works</h2>
      <p>Enter your crew name and create a 4-digit code. You’ll use this code to access challenges throughout the Quest.</p>
    </section>

    <!-- Form (IDs/hooks preserved) -->
    <form id="registrationForm" novalidate>
      <label for="teamName">Crew Name</label>
      <input type="text" id="teamName" name="teamName" maxlength="50"
             placeholder="e.g., The Golden Compass Crew" required autocomplete="off" class="input" aria-describedby="charCount">
      <div class="char-row"><span></span><span id="charCount" aria-live="polite">50/50</span></div>

      <label for="teamPin">Crew Code (4-digits)</label>
      <input type="text" id="teamPin" name="teamPin" inputmode="numeric" pattern="\d{4}" placeholder="1234"
             required autocomplete="off" class="input" aria-describedby="pinHelp">

      <div class="remember" id="pinHelp">
        <div class="icon">⚠️</div>
        <h3>Remember your code.</h3>
        <p>You’ll use this code to access the activities during the Quest.</p>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">Register Crew</button>

      <div class="loading" id="loading" role="status" aria-live="polite">Registering your crew…</div>
      <div class="error-message" id="errorMessage" role="alert" aria-live="assertive"></div>
    </form>
  </div>

  <script>
    // --- Client storage keys (unchanged) ---
    const LS = { token:"tq_token", teamCode:"tq_team_code", teamName:"tq_team_name", eventId:"tq_event_id" };
    function saveAuth({ token, teamCode, teamName, eventId }) {
      if (token) localStorage.setItem(LS.token, token);
      if (teamCode) localStorage.setItem(LS.teamCode, teamCode);
      if (teamName) localStorage.setItem(LS.teamName, teamName);
      if (eventId) localStorage.setItem(LS.eventId, eventId);
    }

    // Crew code from URL (?team=ABC)
    const urlParams = new URLSearchParams(window.location.search);
    const teamCode = (urlParams.get('team') || 'UNKNOWN').toUpperCase();
    document.getElementById('teamCodeDisplay').textContent = `Crew Code: ${teamCode}`;

    // Character counter
    const teamNameInput = document.getElementById('teamName');
    const charCount = document.getElementById('charCount');
    teamNameInput.addEventListener('input', function () {
      const remaining = 50 - this.value.length;
      charCount.textContent = `${remaining}/50`;
      charCount.style.color = remaining < 8 ? '#B42318' : '#6A5A47';
    });

    // 4-digit clamp
    const teamPinInput = document.getElementById('teamPin');
    teamPinInput.addEventListener('input', function () {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    // Submit -> /.netlify/functions/team_register (unchanged)
    document.getElementById('registrationForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const teamName = teamNameInput.value.trim();
      const pin = (teamPinInput.value || "").trim();
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');

      function showError(message){ errorMessage.textContent = message; errorMessage.style.display='block'; }

      if (!teamName) return showError('Please enter a crew name.');
      if (!pin || pin.length !== 4) return showError('Please enter exactly 4 digits for your crew code.');

      submitBtn.disabled = true; loading.style.display = 'block'; errorMessage.style.display = 'none';

      try {
        const res = await fetch('/.netlify/functions/team_register', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teamCode, pin, teamName })
        });
        const result = await res.json();
        if (!res.ok || result.success === false) throw new Error(result.message || 'Crew registration failed. Please try again.');

        saveAuth({ token: result.token, teamCode: result.teamCode, teamName: result.teamName, eventId: result.eventId });
        window.location.href = `team-registration-success.html?team=${encodeURIComponent(result.teamName)}&code=${encodeURIComponent(teamCode)}`;
      } catch (err) {
        showError(err.message || 'Crew registration failed. Please try again.');
      } finally {
        submitBtn.disabled = false; loading.style.display = 'none';
      }
    });
  </script>
</body>
</html>
