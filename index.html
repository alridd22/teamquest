<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta name="theme-color" content="#2A1F18">
  <title>The Treasure Quest - Crew Registration</title>

  <!-- Handlee -->
  <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:url("/TQ%20Web%20extended%20background-100.jpg"); /* main page background */
      --ink:#2E2114; --ink-soft:#6A5A47;
      --parchment:#F7EED8; --parchment-2:#F3E6CF;
      --gold:#F0C433; --gold-deep:#A7711F;
      --error:#B42318;

      --radius-card:22px; --radius-input:16px;
      --shadow-card:0 18px 40px rgba(0,0,0,.35);
      --shadow-soft:0 2px 6px rgba(0,0,0,.10);
      --focus:0 0 0 3px rgba(240,196,51,.45);
      --dur:180ms; --ease:cubic-bezier(.2,.6,.2,1);

      --hero-h: 300px; /* hero height on phones */
      --gutter: 22px;  /* big side gutter so background shows */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Handlee", ui-rounded, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.45)),
        var(--bg);
      background-size:cover;
      background-position:top center;
      background-attachment:fixed;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    /* Full-bleed hero (logo + title sit directly on the background) */
    .hero{
      min-height:var(--hero-h);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
      padding:28px var(--gutter) 14px;
    }
    .brand-logo{
      width:min(210px, 62vw); height:auto; margin-bottom:10px;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 10px 24px rgba(0,0,0,.35));
    }
    .title-pill{
      color:#2E2114; font-size:22px; letter-spacing:.2px;
      background:rgba(247,238,216,.88);
      border:1px solid rgba(0,0,0,.08);
      border-radius:999px; padding:10px 16px;
      backdrop-filter:saturate(120%) blur(3px);
      box-shadow:0 8px 20px rgba(0,0,0,.25);
    }

    /* Main parchment stack (visibly inset so background shows) */
    .stack{
      padding:0 var(--gutter) 24px;
    }
    .card{
      background:var(--parchment);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-card);
      padding:18px 16px;
      border:1px solid rgba(0,0,0,.06);
      margin:0 auto 18px;
      width:100%;
    }
    .card h2{
      margin:0 0 10px; text-align:center; font-size:26px; color:var(--ink);
    }
    .card p{
      margin:0; line-height:1.6; color:var(--ink); font-size:18px;
    }

    /* Crew code chip */
    .chip{
      margin:14px auto 2px; text-align:center; display:inline-block;
      background:#D7C39B; color:var(--ink); font-weight:800;
      padding:10px 14px; border-radius:14px; font-size:20px;
      border:3px dashed rgba(0,0,0,.6);
    }

    /* Form */
    label{
      display:block; margin:12px 6px 6px; font-size:22px; color:var(--ink); font-weight:800;
    }
    .input{
      width:100%; padding:14px 12px; border-radius:var(--radius-input);
      border:3px solid var(--gold); background:#fff; color:var(--ink);
      font-size:20px; transition:border-color var(--dur) var(--ease), box-shadow var(--dur) var(--ease), transform var(--dur) var(--ease);
    }
    .input::placeholder{ color:rgba(0,0,0,.35) }
    .input:focus{ outline:none; box-shadow:var(--focus); border-color:var(--gold-deep); transform:translateY(-1px); }

    .char-row{
      display:flex; justify-content:flex-end; margin:6px 6px 0;
      color:var(--ink-soft); font-size:16px;
    }

    .remember{
      background:var(--parchment-2);
      border-radius:var(--radius-card);
      border:1px solid rgba(0,0,0,.06);
      padding:18px 14px; text-align:center; box-shadow:var(--shadow-soft);
      margin-top:12px;
    }
    .remember h3{ margin:10px 0 6px; font-size:26px; color:var(--ink); }
    .remember p{ margin:0; font-size:18px; color:var(--ink); }
    .remember .icon{ font-size:34px; display:inline-block; }

    /* CTA */
    .submit-btn{
      width:100%;
      background:linear-gradient(90deg, #FDBA2D, #F0C433);
      color:#442812; font-weight:900; font-size:22px;
      border-radius:16px; border:3px solid #A7711F;
      padding:16px; cursor:pointer; margin-top:6px;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      transition:transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
    }
    .submit-btn:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(0,0,0,.3); }
    .submit-btn:active{ transform:translateY(0); }
    .submit-btn:disabled{ opacity:.6; cursor:not-allowed; }

    .loading{
      display:none; text-align:center; margin-top:10px; color:#EEE3CD; font-weight:700; font-size:18px;
      text-shadow:0 1px 2px rgba(0,0,0,.4);
    }
    .error-message{
      display:none; margin-top:12px; padding:10px; border-radius:12px;
      font-weight:700; font-size:16px; text-align:center; color:#fff;
      background:var(--error); border:2px solid #7E1C12;
    }

    @media (min-width:480px){
      :root{ --hero-h: 340px; --gutter: 26px; }
    }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation-duration:0ms !important; }
    }
  </style>
</head>
<body>
  <!-- HERO on the background -->
  <header class="hero" role="banner">
    <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest" class="brand-logo" width="640" height="480" decoding="async"
         onerror="this.remove()">
    <div class="title-pill">Crew Registration</div>
  </header>

  <!-- PARCHMENT STACK with generous gutters -->
  <main class="stack" role="main">
    <section class="card" aria-labelledby="welcome-title">
      <h2 id="welcome-title">Welcome aboard!</h2>
      <p>Pick a crew name and choose your 4-digit code to join the Quest.</p>
      <div class="chip" id="teamCodeDisplay" aria-live="polite">Crew Code: Loading…</div>
    </section>

    <section class="card" aria-labelledby="how-title">
      <h2 id="how-title">How it works</h2>
      <p>Enter your crew name and create a 4-digit code. You’ll use this code to access challenges throughout the Quest.</p>
    </section>

    <section class="card">
      <form id="registrationForm" novalidate>
        <label for="teamName">Crew Name</label>
        <input type="text" id="teamName" name="teamName" maxlength="50"
               placeholder="e.g., The Golden Compass Crew" required autocomplete="off" class="input" aria-describedby="charCount">
        <!-- counter only, no “Max 50 characters” line -->
        <div class="char-row"><span id="charCount" aria-live="polite">50</span></div>

        <label for="teamPin">Crew Code (4-digits)</label>
        <input type="text" id="teamPin" name="teamPin" inputmode="numeric" pattern="\\d{4}"
               placeholder="1234" required autocomplete="off" class="input" aria-describedby="pinHelp">

        <div class="remember" id="pinHelp">
          <div class="icon">⚠️</div>
          <h3>Remember your code.</h3>
          <p>You’ll use this code to access the activities during the Quest.</p>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Register Crew</button>

        <div class="loading" id="loading" role="status" aria-live="polite">Registering your crew…</div>
        <div class="error-message" id="errorMessage" role="alert" aria-live="assertive"></div>
      </form>
    </section>
  </main>

  <script>
    // --- Storage keys (unchanged) ---
    const LS = { token:"tq_token", teamCode:"tq_team_code", teamName:"tq_team_name", eventId:"tq_event_id" };
    function saveAuth({ token, teamCode, teamName, eventId }) {
      if (token) localStorage.setItem(LS.token, token);
      if (teamCode) localStorage.setItem(LS.teamCode, teamCode);
      if (teamName) localStorage.setItem(LS.teamName, teamName);
      if (eventId) localStorage.setItem(LS.eventId, eventId);
    }

    // Crew code from URL (?team=ABC)
    const urlParams = new URLSearchParams(window.location.search);
    const teamCode = (urlParams.get('team') || 'UNKNOWN').toUpperCase();
    document.getElementById('teamCodeDisplay').textContent = `Crew Code: ${teamCode}`;

    // Character counter (no helper line)
    const teamNameInput = document.getElementById('teamName');
    const charCount = document.getElementById('charCount');
    teamNameInput.addEventListener('input', function () {
      const remaining = 50 - this.value.length;
      charCount.textContent = remaining;
      charCount.style.color = remaining < 8 ? '#B42318' : '#6A5A47';
    });

    // 4-digit clamp
    const teamPinInput = document.getElementById('teamPin');
    teamPinInput.addEventListener('input', function () {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    // Submit -> Netlify function (unchanged)
    document.getElementById('registrationForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const teamName = teamNameInput.value.trim();
      const pin = (teamPinInput.value || "").trim();
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');

      function showError(message){ errorMessage.textContent = message; errorMessage.style.display='block'; }

      if (!teamName) return showError('Please enter a crew name.');
      if (!pin || pin.length !== 4) return showError('Please enter exactly 4 digits for your crew code.');

      submitBtn.disabled = true; loading.style.display = 'block'; errorMessage.style.display = 'none';
      try {
        const res = await fetch('/.netlify/functions/team_register', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teamCode, pin, teamName })
        });
        const result = await res.json();
        if (!res.ok || result.success === false) throw new Error(result.message || 'Crew registration failed. Please try again.');

        saveAuth({ token: result.token, teamCode: result.teamCode, teamName: result.teamName, eventId: result.eventId });
        window.location.href = `team-registration-success.html?team=${encodeURIComponent(result.teamName)}&code=${encodeURIComponent(teamCode)}`;
      } catch (err) {
        showError(err.message || 'Crew registration failed. Please try again.');
      } finally {
        submitBtn.disabled = false; loading.style.display = 'none';
      }
    });
  </script>
</body>
</html>
