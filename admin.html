<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Terry's Treasure Hunt ‚Äî Command Centre</title>
  <style>
    /* ====== Base / Layout ====== */
    :root{
      --brown:#8B4513; --brown-2:#654321; --gold:#DAA520; --amber:#FF8C00;
      --cream:#F5E6D3; --cream-2:#E8D7C3; --paper:#FFF8DC; --red:#DC143C; --green:#2E8B57;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      min-height:100vh; padding:20px; padding-top:90px; color:#3E2723;
      background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);
      position:relative;
    }
    body::before{
      content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(circle at 20% 20%,rgba(255,215,0,.1) 0%,transparent 50%),
        radial-gradient(circle at 80% 80%,rgba(255,140,0,.1) 0%,transparent 50%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,215,0,0.3)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,140,0,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(218,165,32,0.2)"/></svg>');
    }

    /* ====== Top Nav (logo only) ====== */
    .treasure-nav{
      position:fixed; inset:0 0 auto 0; height:70px; z-index:1000;
      background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);
      border-bottom:3px solid var(--gold); box-shadow:0 4px 15px rgba(0,0,0,.3);
      display:flex; align-items:center; justify-content:center; padding:0 20px;
    }
    .nav-logo img{height:45px; width:auto; filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5))}
    @media (max-width:768px){ .treasure-nav{height:90px} .nav-logo img{height:65px} body{padding-top:110px}}

    /* ====== Hero note ====== */
    .hero{
      max-width:1100px; margin:0 auto 20px; display:flex; gap:14px; align-items:center;
      background:linear-gradient(145deg,#F5E6D3 0%,rgba(245,230,211,.95) 100%);
      border:3px solid var(--brown); border-radius:18px; padding:16px 18px;
      box-shadow:0 12px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.35);
      position:relative;
    }
    .hero::before{content:''; position:absolute; left:0; right:0; top:0; height:6px;
      background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}
    .hero-img{flex:0 0 64px; height:64px; border-radius:10px; border:3px solid var(--gold);
      background:linear-gradient(135deg,#8B4513,#A0522D); box-shadow:0 4px 12px rgba(139,69,19,.3)}
    .hero-copy{flex:1; background:linear-gradient(135deg,#FFD700,#FFA500); color:var(--brown);
      border:2px solid var(--gold); border-radius:12px; padding:14px; font-weight:600}

    /* ====== Two-column panels ====== */
    .grid{
      max-width:1200px; margin:0 auto; display:grid; gap:18px; grid-template-columns:1fr 1fr;
    }
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }

    .panel{
      background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%); border-radius:20px; padding:20px;
      border:3px solid var(--brown); box-shadow:0 18px 36px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.35);
      position:relative; overflow:hidden;
    }
    .panel::before{content:''; position:absolute; inset:0 0 auto 0; height:6px;
      background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}
    .panel::after{content:''; position:absolute; inset:10px; border:2px solid var(--gold); border-radius:14px; pointer-events:none}
    .panel h2{
      margin-bottom:12px; color:var(--brown); font-size:1.25rem; font-weight:800;
      border-bottom:3px solid var(--gold); padding-bottom:8px; display:flex; align-items:center; gap:8px;
    }

    /* ====== Timer / buttons ====== */
    .timer{
      font-family:'Courier New',monospace; font-weight:900; font-size:2.4rem; text-align:center;
      color:var(--brown); background:linear-gradient(135deg,#FFD700,#FFA500);
      border:3px solid var(--gold); border-radius:12px; padding:16px; box-shadow:0 5px 15px rgba(255,215,0,.35);
      margin-bottom:12px;
    }
    .timer.penalty{ background:linear-gradient(135deg,#dc143c,#b22222); color:#fff; border-color:#8b0000;
      animation:penpulse 1s ease-in-out infinite }
    @keyframes penpulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    .status{
      text-align:center; font-weight:800; border-radius:10px; padding:10px; margin-bottom:14px; border:2px solid;
      background:linear-gradient(135deg,#E6E6FA,#D8BFD8); color:#4B0082; border-color:#9370DB;  /* default - Not Started */
    }
    .status.running{ background:linear-gradient(135deg,#98FB98,#90EE90); color:#006400; border-color:#32CD32 }
    .status.ended{ background:linear-gradient(135deg,#FFD700,#FFA500); color:var(--brown); border-color:var(--gold) }

    .btns{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px }
    .btn{
      border:3px solid var(--brown); border-radius:10px; padding:14px 16px; font-weight:900; letter-spacing:.5px;
      text-transform:uppercase; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.25); transition:.2s;
      background:linear-gradient(135deg,#ffe9c7,#ffe0a6);
    }
    .btn:hover{ transform:translateY(-2px) }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none }
    .btn.launch{ background:linear-gradient(135deg,#32cd32,#228b22); color:#fff }
    .btn.pause{ background:linear-gradient(135deg,#ffd700,#ff8c00); color:var(--brown) }
    .btn.end{   background:linear-gradient(135deg,#dc143c,#b22222); color:#fff }
    .btn.reset{ background:linear-gradient(135deg,#a0522d,#8b4513); color:#fff }

    .notice{
      border:3px solid var(--gold); border-radius:12px; padding:12px; text-align:center; font-weight:700;
      background:linear-gradient(135deg,#FFFACD,#F0E68C);
    }
    .notice.ok{ background:linear-gradient(135deg,#98FB98,#90EE90); border-color:#32CD32; color:#006400 }
    .notice.warn{ background:linear-gradient(135deg,#FFE4B5,#DEB887); border-color:#FF8C00; color:var(--brown) }

    /* ====== Crew list & cards ====== */
    .crews{
      background:linear-gradient(145deg,#fff,#fff9ed); border:2px solid #d2691e; border-radius:14px; padding:16px;
      min-height:260px; box-shadow:inset 0 2px 10px rgba(0,0,0,.08);
    }
    .crews-grid{ display:grid; gap:10px; max-height:520px; overflow:auto }
    .crew{
      background:linear-gradient(145deg,#FFF8DC,#F5E6D3); border:2px solid var(--gold); border-radius:12px; padding:12px;
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
    }
    .crew.late{ background:linear-gradient(135deg,#FFCCCB,#FFA0B4); border-color:#DC143C }
    .crew.returned{ background:linear-gradient(135deg,#98FB98,#90EE90); border-color:#32CD32 }
    .c-title{ font-weight:900; color:var(--brown); display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .badge{ font-size:.72rem; border-radius:999px; padding:4px 8px; font-weight:800; color:#fff }
    .b-active{ background:#3498db } .b-returned{ background:#27ae60 } .b-late{ background:#e74c3c }
    .score{ text-align:right; font-weight:900; color:var(--gold); }
    .score .orig{ font-size:.75rem; color:#999; text-decoration:line-through; display:block }
    .pen{ font-size:.85rem; color:#8b0000; margin-top:4px }

    /* ====== Stats footer ====== */
    .stats{ max-width:1200px; margin:18px auto 0; display:grid; gap:14px; grid-template-columns:repeat(4,1fr)}
    .stat{
      background:linear-gradient(145deg,#F5E6D3,#E8D7C3); border:3px solid var(--brown); border-radius:12px;
      padding:16px; text-align:center; box-shadow:0 5px 15px rgba(139,69,19,.2);
      position:relative; overflow:hidden;
    }
    .stat::before{ content:''; position:absolute; left:0; right:0; top:0; height:4px;
      background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}
    .stat-val{ font-weight:900; font-size:1.6rem; color:var(--brown) }
    .stat-lab{ font-weight:700; color:#a0522d; margin-top:6px }

    /* ====== Modal ====== */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:1500 }
    .modal-card{ max-width:520px; width:92%; background:linear-gradient(145deg,#F5E6D3,#E8D7C3);
      border:3px solid var(--brown); border-radius:18px; padding:22px; box-shadow:0 24px 48px rgba(0,0,0,.35)}
    .modal h3{ color:var(--brown); margin-bottom:10px }
    .modal .row{ display:flex; gap:10px; justify-content:center; margin-top:16px}
    .ghost{ opacity:.65 }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav">
    <a class="nav-logo" href="/"><img src="/Team Quest Logo-01.png" alt="TeamQuest"></a>
  </nav>

  <!-- HERO -->
  <div class="hero">
    <img class="hero-img" src="/terry-clock.png" alt="">
    <div class="hero-copy">
      Keep it simple: launch the adventure, watch the clock, mark returns ‚Äî late returns auto-deduct based on the configured rate.
    </div>
  </div>

  <!-- GRID -->
  <div class="grid">
    <!-- LEFT: CONTROL -->
    <section class="panel" id="leftPanel">
      <h2>‚öì Adventure Control</h2>

      <div class="timer" id="timer">01:30:00</div>
      <div class="status" id="status">Not Started</div>

      <div class="btns">
        <button class="btn launch" id="btnStart">üöÄ Launch</button>
        <button class="btn pause" id="btnPause" disabled>‚è∏Ô∏è Pause</button>
        <button class="btn end"   id="btnEnd"   disabled>‚èπÔ∏è End</button>
        <button class="btn reset" id="btnReset">üîÑ Reset</button>
      </div>

      <button class="btn" id="btnPublish" style="width:100%; border-width:4px; background:linear-gradient(135deg,#FFD700,#FFA500); color:var(--brown); font-size:1.05rem" disabled>
        üèÜ Publish Final Results
      </button>

      <div id="resultsNotice" class="notice" style="margin-top:12px">üîí Results not published</div>
    </section>

    <!-- RIGHT: CREWS -->
    <section class="panel">
      <h2>üë• Crew Management</h2>
      <div class="crews">
        <div id="crewLoading" class="notice warn">üîé Loading crews‚Ä¶</div>
        <div id="crewError" class="notice" style="display:none; background:linear-gradient(135deg,#FFB6C1,#FFA0B4); border-color:#DC143C; color:#8B0000">Failed to load crew list.</div>
        <div id="crewsGrid" class="crews-grid" style="display:none;"></div>
      </div>
    </section>
  </div>

  <!-- STATS -->
  <div class="stats">
    <div class="stat"><div class="stat-val" id="stTotal">0</div><div class="stat-lab">Total Crews</div></div>
    <div class="stat"><div class="stat-val" id="stActive">0</div><div class="stat-lab">Active</div></div>
    <div class="stat"><div class="stat-val" id="stReturned">0</div><div class="stat-lab">Returned</div></div>
    <div class="stat"><div class="stat-val" id="stPenalised">0</div><div class="stat-lab">Penalised</div></div>
  </div>

  <!-- CONFIRM MODAL -->
  <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-card">
      <h3 id="confirmTitle">Confirm</h3>
      <div id="confirmMsg" class="ghost">Are you sure?</div>
      <div class="row">
        <button class="btn reset" id="confirmCancel">Cancel</button>
        <button class="btn launch" id="confirmOk">Confirm</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ---- state ----
    let state = {
      eventId: null,
      status: 'not_started',   // not_started | running | stopped
      startTime: null,         // ISO
      durationMin: 90,
      endsAt: null,            // ISO
      penaltyPerMin: 0,
      resultsPublished: false,
      crews: [],
      timerTick: null,
      refreshTick: null
    };

    // ---- els ----
    const elTimer = document.getElementById('timer');
    const elStatus = document.getElementById('status');
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnEnd   = document.getElementById('btnEnd');
    const btnReset = document.getElementById('btnReset');
    const btnPublish = document.getElementById('btnPublish');
    const resultsNotice = document.getElementById('resultsNotice');

    const crewLoading = document.getElementById('crewLoading');
    const crewError   = document.getElementById('crewError');
    const crewsGrid   = document.getElementById('crewsGrid');

    const stTotal = document.getElementById('stTotal');
    const stActive = document.getElementById('stActive');
    const stReturned = document.getElementById('stReturned');
    const stPenalised = document.getElementById('stPenalised');

    // ---- helpers ----
    const pad = n => String(n).padStart(2,'0');
    function msToHMS(ms){
      if (ms < 0) ms = 0;
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const r = s%60;
      return `${pad(h)}:${pad(m)}:${pad(r)}`;
    }
    function setStatus(label, cls){
      elStatus.textContent = label;
      elStatus.className = `status ${cls||''}`;
    }
    function setButtons(){
      const running = state.status === 'running';
      const stopped = state.status === 'stopped';
      const notStarted = state.status === 'not_started';
      btnStart.disabled  = running || state.resultsPublished;
      btnPause.disabled  = !running || state.resultsPublished;
      btnEnd.disabled    = (!running && !notStarted) ? false : !running;
      btnReset.disabled  = running;
      btnPublish.disabled = !stopped || state.resultsPublished;
    }
    function showModal(title, msg, onConfirm){
      const modal = document.getElementById('confirmModal');
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMsg').innerHTML = msg;
      modal.style.display='flex';
      const cancel = document.getElementById('confirmCancel');
      const ok = document.getElementById('confirmOk');
      const cleanup = ()=>{ modal.style.display='none'; ok.onclick = cancel.onclick = null; };
      cancel.onclick = cleanup;
      ok.onclick = async ()=>{ try{ await onConfirm?.(); } finally{ cleanup(); } };
    }

    // ---- fetchers ----
    async function fetchJSON(url, opts){
      const res = await fetch(url, opts);
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function loadEvent(){
      const data = await fetchJSON('/.netlify/functions/get_event_state');
      if(!data.success) throw new Error(data.message || 'get_event_state failed');
      state.eventId = data.eventId;
      state.penaltyPerMin = Number(data.penaltyPerMin || 0);
      // state mapping
      const st = (data.state || '').toUpperCase();
      if(st === 'READY' || st === 'NOT_STARTED' || !data.startedAt){
        state.status = 'not_started';
        state.startTime = null; state.endsAt = null;
      } else if (st === 'RUNNING' || st === 'STARTED'){
        state.status = 'running';
        state.startTime = data.startedAt;
        state.endsAt = data.endsAt || null;
      } else if (st === 'STOP' || st === 'STOPPED' || st === 'ENDED'){
        state.status = 'stopped';
        state.startTime = data.startedAt || null;
        state.endsAt = data.endsAt || null;
      }
      // update duration if provided
      if (data.durationMin || data.durationMinutes) {
        state.durationMin = Number(data.durationMin || data.durationMinutes);
      }
      // UI
      if (state.status==='running'){
        setStatus('Adventure in Progress','running');
      } else if (state.status==='stopped'){
        setStatus('Adventure Complete','ended');
      } else {
        setStatus('Not Started','');
      }
      setButtons();
      startTimerLoop();
    }

    async function loadCrews(){
      if(!state.eventId) return;
      crewLoading.style.display='block';
      crewError.style.display='none';
      crewsGrid.style.display='none';

      try{
        const data = await fetchJSON(`/.netlify/functions/admin_list_teams?eventId=${encodeURIComponent(state.eventId)}`);
        if(!data.success) throw new Error(data.message || 'admin_list_teams failed');
        state.crews = data.teams || data.leaderboard || [];
        renderCrews();
      }catch(e){
        crewError.style.display='block';
        crewError.textContent = `Failed to load crew list: ${e.message}`;
      }finally{
        crewLoading.style.display='none';
      }
    }

    // ---- render ----
    function renderCrews(){
      crewsGrid.innerHTML='';
      const list = state.crews.slice(); // already sorted server-side usually
      if(list.length===0){
        crewsGrid.style.display='block';
        crewsGrid.innerHTML = `<div class="notice warn">No registered crews yet.</div>`;
      }else{
        crewsGrid.style.display='grid';
        list.forEach(team=>{
          const code = team.teamCode || team.code || '';
          const name = team.teamName || team.name || code || 'Crew';
          const status = (team.status || 'active').toLowerCase(); // active | returned | late
          const total = Number(team.totalScore || team.total || 0);
          const penalty = Number(team.penalty || 0);
          const adj = Math.max(0, total - penalty);
          const minsLate = Number(team.penaltyMinutes || 0);

          const div = document.createElement('div');
          div.className = 'crew' + (status==='late' ? ' late' : status==='returned' ? ' returned' : '');
          div.innerHTML = `
            <div>
              <div class="c-title">
                ${name}
                <span class="badge ${status==='active'?'b-active':status==='late'?'b-late':'b-returned'}">
                  ${status==='active'?'Active':status==='late'?'Returned (Late)':'Returned'}
                </span>
              </div>
              ${penalty>0 ? `<div class="pen">‚ö†Ô∏è Late penalty: -${penalty} (${minsLate} min)</div>`:''}
            </div>
            <div class="score">
              ${penalty>0 ? `<span class="orig">${total}</span>`:''}
              ${adj} ü™ô
            </div>
          `;
          crewsGrid.appendChild(div);
        });
      }
      // stats
      const totalCrews = list.length;
      const active = list.filter(t=> (t.status||'active')==='active').length;
      const returned = list.filter(t=> ['returned','late'].includes((t.status||'active'))).length;
      const penalised = list.filter(t=> Number(t.penalty||0)>0).length;
      stTotal.textContent = totalCrews;
      stActive.textContent = active;
      stReturned.textContent = returned;
      stPenalised.textContent = penalised;
    }

    // ---- timer ----
    function startTimerLoop(){
      if(state.timerTick){ clearInterval(state.timerTick); state.timerTick=null; }
      const compute = ()=>{
        if (state.status==='not_started'){
          elTimer.classList.remove('penalty');
          elTimer.textContent = msToHMS(state.durationMin*60*1000);
          resultsNotice.className = 'notice';
          resultsNotice.innerHTML = 'üîí Results not published';
          return;
        }
        if (!state.startTime || !state.durationMin){
          elTimer.classList.remove('penalty');
          elTimer.textContent = '‚Äî : ‚Äî ‚Äî : ‚Äî ‚Äî';
          return;
        }
        const start = new Date(state.startTime).getTime();
        const end = start + state.durationMin*60*1000;
        const now = Date.now();
        const delta = end - now;

        if (delta >= 0){
          // countdown
          elTimer.classList.remove('penalty');
          elTimer.textContent = msToHMS(delta);
        }else{
          // overtime (penalty phase visual)
          elTimer.classList.add('penalty');
          const over = now - end;
          const s = Math.floor(over/1000);
          const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), r = s%60;
          elTimer.textContent = `+${pad(h)}:${pad(m)}:${pad(r)}`;
        }

        if (state.status==='stopped'){
          elTimer.classList.remove('penalty');
        }
      };
      compute();
      state.timerTick = setInterval(compute, 1000);
    }

    // ---- actions ----
    async function postAction(action){
      const res = await fetchJSON('/.netlify/functions/admin_start_event',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ action })
      });
      if(!res.success) throw new Error(res.message || 'admin_start_event failed');
      return res;
    }

    btnStart.addEventListener('click', ()=>{
      // simple confirm when already running or stopped
      showModal('Launch Adventure','Start the 90-minute adventure?', async ()=>{
        await postAction('start');
        await refreshAll();
      });
    });

    btnPause.addEventListener('click', async ()=>{
      await postAction('stop'); // using stop as pause in your backend list (no dedicated pause)
      await refreshAll();
    });

    btnEnd.addEventListener('click', ()=>{
      showModal('End Adventure','End the adventure now?', async ()=>{
        await postAction('stop');
        await refreshAll();
      });
    });

    btnReset.addEventListener('click', ()=>{
      showModal('Reset Timer','Reset the competition and timer to 90 minutes? (Keeps teams but clears live timer state.)', async ()=>{
        await postAction('reset');
        await refreshAll();
      });
    });

    btnPublish.addEventListener('click', ()=>{
      showModal('Publish Final Results','Publish final results and unlock the gallery?', async ()=>{
        const res = await fetchJSON('/.netlify/functions/admin_publish_final',{ method:'POST' });
        if(!res.success) throw new Error(res.message || 'admin_publish_final failed');
        state.resultsPublished = true;
        resultsNotice.className = 'notice ok';
        resultsNotice.innerHTML = 'üèÜ Results published';
        setButtons();
      });
    });

    // ---- refresh together ----
    async function refreshAll(){
      await loadEvent();
      await loadCrews();
      // publish state
      state.resultsPublished = Boolean((state.competitionData && state.competitionData.resultsPublished) || false);
      if (state.status==='stopped' && !state.resultsPublished){
        resultsNotice.className = 'notice warn';
        resultsNotice.innerHTML = 'üì£ Final results ready to publish';
      } else if (state.resultsPublished){
        resultsNotice.className = 'notice ok';
        resultsNotice.innerHTML = 'üèÜ Results published';
      } else {
        resultsNotice.className = 'notice';
        resultsNotice.innerHTML = 'üîí Results not published';
      }
      setButtons();
    }

    // ---- init ----
    (async function init(){
      try{
        await loadEvent();
        await loadCrews();
      }catch(e){
        console.error(e);
      }
      // background refresh (teams/state)
      if(state.refreshTick) clearInterval(state.refreshTick);
      state.refreshTick = setInterval(async ()=>{
        try{
          await loadEvent();
          await loadCrews();
        }catch(e){ /* swallow */ }
      }, 30000);
    })();

    // cleanup
    window.addEventListener('beforeunload', ()=>{
      if(state.timerTick) clearInterval(state.timerTick);
      if(state.refreshTick) clearInterval(state.refreshTick);
    });
  })();
  </script>
</body>
</html>
