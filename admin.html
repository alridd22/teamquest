<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Terry‚Äôs Treasure Quest ‚Äî Command Centre</title>
<style>
  :root{
    --bg1:#8B4513; --bg2:#D2691E; --bg3:#F4A460;
    --brown:#8b4513; --gold:#DAA520; --gold2:#FFD54F; --amber:#ffb300;
    --cream:#f5e6d3; --paper:#efe0c9; --ink:#2c1810;
    --green:#28a745; --red:#c0392b; --blue:#3498db; --muted:#b9a999;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: "Segoe UI", system-ui, -apple-system, sans-serif; color:var(--ink);
    background: radial-gradient(1200px 600px at 20% -10%, #b8682a55, transparent 60%),
                radial-gradient(1200px 600px at 120% 110%, #b8682a55, transparent 60%),
                linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 35%, var(--bg3) 100%);
    min-height:100vh; padding:18px;
  }

  /* Top banner */
  .banner{
    background: linear-gradient(180deg,#ffecb380,#ffe08280), var(--paper);
    border:3px solid var(--gold);
    border-radius:16px; padding:14px 16px; box-shadow:0 8px 24px #00000026;
    display:flex; align-items:center; gap:14px; max-width:1100px; margin:0 auto 16px;
  }
  .banner .dot{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#9b5b1f,#6d3c13);border:3px solid #f0d28a;box-shadow: inset 0 0 0 2px #00000022;}
  .banner h1{margin:0;font-size:18px;font-weight:800}
  .banner p{margin:2px 0 0;font-size:14px}
  .banner .key{margin-left:auto;display:flex;align-items:center;gap:8px}
  .banner .key small{opacity:.8}
  .btn{
    border:none; border-radius:10px; padding:10px 14px; font-weight:800; letter-spacing:.3px;
    box-shadow: 0 3px 0 #0000002a; cursor:pointer; transition:transform .1s ease, filter .15s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn-gold{background:linear-gradient(180deg,#ffd54f,#f6b93b); border:2px solid #c58f0a; color:#4b3000}
  .btn-green{background:linear-gradient(180deg,#53d769,#2bb24b); border:2px solid #1e7e34; color:white}
  .btn-red{background:linear-gradient(180deg,#ff8a80,#e74c3c); border:2px solid #922b21; color:white}
  .btn-brown{background:linear-gradient(180deg,#8d5a38,#6b3d1c); border:2px solid #45260f; color:#fff}
  .btn-grey{background:linear-gradient(180deg,#e0d5c4,#cdbfa9); border:2px solid #b09e84; color:#5b4633}

  /* Two column shell */
  .shell{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:920px){ .shell{grid-template-columns:1fr} }

  .panel{
    background: linear-gradient(180deg,#fff7eae6,#f3e6d2e6);
    border:3px solid var(--brown);
    border-radius:18px; padding:16px; position:relative; box-shadow:0 16px 40px #0000002a;
  }
  .panel h2{margin:0 0 12px;font-size:18px;font-weight:900;color:#4b2a16; display:flex; align-items:center; gap:8px}
  .divider{height:3px;background:linear-gradient(90deg,#f0c374,#e3b25c,transparent); border-radius:2px;margin:8px 0 12px}

  /* Control left */
  .timer{
    background:linear-gradient(180deg,#ffbd2f,#ff9f1a); color:#331c00;
    border:3px solid #b7770e; border-radius:14px; text-align:center; padding:20px; font-weight:900;
    font-size:36px; letter-spacing:.18em; box-shadow: inset 0 2px 0 #ffe8b6;
  }
  .status{
    margin-top:10px; border:2px solid #c6b8a0; border-radius:12px; padding:10px; text-align:center;
    font-weight:800; color:#4b2a16; background:#efe3cf;
  }
  .status.badge-running{background:#e2f8e9;border-color:#86d2a1}
  .status.badge-ended{background:#fff4c1;border-color:#dab33a}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .stack{display:grid;gap:12px;margin-top:12px}

  /* Right list */
  .crew{
    background:linear-gradient(180deg,#fff8ee,#f7eddc); border:2px solid #e0cda9; border-radius:14px;
    padding:12px; display:grid; grid-template-columns: 1fr auto; gap:10px; margin-bottom:12px;
  }
  .crew h3{margin:0 0 4px;font-size:16px}
  .code{color:#8b6b4d;font-weight:700;font-size:12px}
  .pill{padding:3px 8px;border-radius:999px;font-size:12px;font-weight:800;display:inline-flex;gap:6px;align-items:center}
  .pill-blue{background:#e9f2ff;border:1px solid #90caf9;color:#0d47a1}
  .pill-green{background:#e8f7ee;border:1px solid #9ad4ac;color:#155724}
  .pill-red{background:#ffe8e6;border:1px solid #ef9a9a;color:#7b1f1f}
  .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  select, label{font-weight:700}
  select{
    border:2px solid #d4c3a8; border-radius:10px; padding:8px 10px; background:#fffdf8; color:#4b2a16;
    min-width:120px;
  }
  .small-note{font-size:12px;color:#7c644e}

  /* Stats */
  .stats{max-width:1100px;margin:16px auto 0;display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  @media (max-width:880px){ .stats{grid-template-columns:repeat(2,1fr)} }
  .stat{
    background:linear-gradient(180deg,#fff7ec,#f5e7d0); border:3px solid #b58149; border-radius:16px;
    padding:16px; text-align:center; box-shadow: 0 10px 24px #00000022;
  }
  .stat b{display:block;font-size:30px;line-height:1.1}
  .stat span{opacity:.85;font-weight:800}
  .alert{background:#ffe3e3;border:2px solid #e57373;color:#7b1f1f;border-radius:12px;padding:10px;margin-top:10px;font-weight:800}
  .ok{background:#e8f5e9;border:2px solid #81c784;color:#1b5e20;border-radius:12px;padding:10px;margin-top:10px;font-weight:800}

  .muted{opacity:.7}
</style>
</head>
<body>

  <div class="banner">
    <div class="dot" aria-hidden="true"></div>
    <div>
      <h1>Command Centre</h1>
      <p>Keep it simple: launch the adventure, watch the clock, mark returns ‚Äî late returns auto-deduct based on the configured rate.</p>
    </div>
    <div class="key">
      <small>Admin key: <span id="keyState" class="muted">unset</span></small>
      <button id="setKeyBtn" class="btn btn-gold">Set / Change</button>
    </div>
  </div>

  <div class="shell">
    <!-- LEFT: controls -->
    <section class="panel" id="leftPanel">
      <h2>‚öì Adventure Control</h2>
      <div class="divider"></div>

      <div class="timer" id="timer">01 : 30 : 00</div>
      <div class="status" id="statusBadge">Not started</div>

      <div class="grid-2">
        <button class="btn btn-green" id="btnStart">üöÄ Launch</button>
        <button class="btn btn-grey" id="btnPause">‚è∏Ô∏è Pause</button>
      </div>
      <div class="grid-2">
        <button class="btn btn-red" id="btnStop">‚èπÔ∏è End</button>
        <button class="btn btn-brown" id="btnReset">üîÅ Reset</button>
      </div>

      <div class="stack">
        <button class="btn btn-gold" id="btnPublish" disabled>üèÜ Publish Final Results</button>
        <div id="leftMsg"></div>
      </div>
    </section>

    <!-- RIGHT: crews -->
    <section class="panel" id="rightPanel">
      <h2>üë• Crew Management</h2>
      <div class="divider"></div>
      <div id="crewList">
        <div class="muted small-note">Loading crews‚Ä¶</div>
      </div>
    </section>
  </div>

  <!-- Stats -->
  <div class="stats">
    <div class="stat">
      <b id="statTotal">0</b>
      <span>Total Crews</span>
    </div>
    <div class="stat">
      <b id="statActive">0</b>
      <span>Active</span>
    </div>
    <div class="stat">
      <b id="statReturned">0</b>
      <span>Returned</span>
    </div>
    <div class="stat">
      <b id="statPenalised">0</b>
      <span>Penalised</span>
    </div>
  </div>

<script>
(() => {
  // ---------- Config / helpers ----------
  const DEFAULT_EVENT = 'EVT-19-08-2025';
  const url = new URL(location.href);
  const EVENT_ID = url.searchParams.get('event') || DEFAULT_EVENT;

  // Functions that expect eventId *in the query string*
  const endpoints = {
    state:      (eid) => `/.netlify/functions/get_event_state?eventId=${encodeURIComponent(eid)}`,
    listTeams:  (eid) => `/.netlify/functions/admin_list_teams?eventId=${encodeURIComponent(eid)}`,
    startEvent: (eid) => `/.netlify/functions/admin_start_event?eventId=${encodeURIComponent(eid)}`,
    publish:    (eid) => `/.netlify/functions/admin_publish_final?eventId=${encodeURIComponent(eid)}`,
    // These accept body fields (teamCode etc.)
    checkinTeam:        `/.netlify/functions/admin_checkin_team`,
    toggleLock:         `/.netlify/functions/admin_toggle_lock_team`,
  };

  const els = {
    timer: document.getElementById('timer'),
    status: document.getElementById('statusBadge'),
    crewList: document.getElementById('crewList'),
    keyState: document.getElementById('keyState'),
    msg: document.getElementById('leftMsg'),

    start: document.getElementById('btnStart'),
    pause: document.getElementById('btnPause'),
    stop: document.getElementById('btnStop'),
    reset: document.getElementById('btnReset'),
    publish: document.getElementById('btnPublish'),
    setKey: document.getElementById('setKeyBtn'),

    statTotal: document.getElementById('statTotal'),
    statActive: document.getElementById('statActive'),
    statReturned: document.getElementById('statReturned'),
    statPenalised: document.getElementById('statPenalised'),
  };

  function getKey(){ return localStorage.getItem('tq_admin_key') || '' }
  function setKey(k){ k ? localStorage.setItem('tq_admin_key', k) : localStorage.removeItem('tq_admin_key'); updateKeyBadge(); }
  function updateKeyBadge(){ els.keyState.textContent = getKey() ? 'set' : 'unset' }

  function authHeaders(){
    const key = getKey();
    return key ? { 'x-tq-admin': key } : {};
  }
  async function jsonGet(url){
    const res = await fetch(url, { headers: authHeaders() });
    const txt = await res.text().catch(()=> '');
    let data = {};
    try{ data = txt ? JSON.parse(txt) : {} }catch{}
    if(!res.ok || data.success === false){ throw new Error(data.message || `HTTP ${res.status}`); }
    return data;
  }
  async function actionPost(url, body){
    const res = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...authHeaders() },
      body: JSON.stringify(body || {})
    });
    const txt = await res.text().catch(()=> '');
    let data = {};
    try{ data = txt ? JSON.parse(txt) : {} }catch{}
    if(!res.ok || data.success === false){ throw new Error(data.message || `HTTP ${res.status}: ${txt || res.statusText}`); }
    return data;
  }
  function ensureKey(){
    if(getKey()) return true;
    const val = prompt('Enter Admin Secret (used by requireAdmin):');
    if(!val) return false;
    setKey(val.trim());
    return true;
  }
  function setStatus(text, kind=''){ els.status.textContent = text; els.status.className = 'status ' + (kind || '') }
  function setMsg(html, ok=false){
    els.msg.innerHTML = html ? `<div class="${ok?'ok':'alert'}">${html}</div>` : '';
  }

  // ---------- Data loading ----------
  let refreshTimer = null;
  async function loadAll(){
    setMsg('');
    try{
      const state = await jsonGet(endpoints.state(EVENT_ID));
      // state fields expected:
      // { success, status: 'start'|'stop'|..., startTime, durationMinutes, resultsPublished, teams / leaderboard }
      const st = (state.status || state.competitionStatus || '').toString().toLowerCase();
      const running = (st === 'start' || st === 'running');
      const stopped = (st === 'stop' || st === 'stopped');
      const published = (state.resultsPublished === true || state.resultsPublished === 'yes');

      // Timer
      let display = '01 : 30 : 00';
      if(state.startTime && state.durationMinutes){
        const end = new Date(state.startTime).getTime() + (state.durationMinutes*60*1000);
        const now = Date.now();
        let diff = Math.max(0, Math.floor((end-now)/1000));
        const h = String(Math.floor(diff/3600)).padStart(2,'0');
        const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
        const s = String(diff%60).padStart(2,'0');
        display = `${h} : ${m} : ${s}`;
      }
      els.timer.textContent = display;

      // Status badge + buttons
      if(published){
        setStatus('Final results published', 'badge-ended');
        els.publish.disabled = true;
        els.start.disabled = true; els.pause.disabled = true; els.stop.disabled = true;
      }else if(running){
        setStatus('Adventure in progress', 'badge-running');
        els.start.disabled = true; els.pause.disabled = false; els.stop.disabled = false; els.publish.disabled = false;
      }else if(stopped){
        setStatus('Adventure paused / ended', 'badge-ended');
        els.start.disabled = false; els.pause.disabled = true; els.stop.disabled = true; els.publish.disabled = false;
      }else{
        setStatus('Not started');
        els.start.disabled = false; els.pause.disabled = true; els.stop.disabled = true; els.publish.disabled = true;
      }

      // Teams
      const listResp = await jsonGet(endpoints.listTeams(EVENT_ID));
      const teams = listResp.teams || [];
      drawTeams(teams);

      // Stats
      const total = teams.length;
      const returned = teams.filter(t => !!t.returnedAt || t.status === 'returned' || t.status === 'late').length;
      const penalised = teams.filter(t => (t.penalty||0) > 0).length;
      const active = Math.max(0, total - returned);

      els.statTotal.textContent = total;
      els.statReturned.textContent = returned;
      els.statActive.textContent = active;
      els.statPenalised.textContent = penalised;

    }catch(e){
      setMsg(`Failed to load current status: ${e.message}`, false);
    }
  }

  function drawTeams(teams){
    if(!teams || !teams.length){
      els.crewList.innerHTML = `<div class="muted small-note">No crews found for <b>${EVENT_ID}</b>.</div>`;
      return;
    }
    els.crewList.innerHTML = '';
    teams.forEach(t => {
      const wrap = document.createElement('div');
      wrap.className = 'crew';

      const left = document.createElement('div');
      left.innerHTML = `
        <h3>${escapeHtml(t.teamName || t.teamCode || 'Crew')}</h3>
        <div class="small-note code">${escapeHtml(t.teamCode || '')}</div>
        <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
          <span class="pill ${t.returnedAt ? 'pill-green' : 'pill-blue'}">${t.returnedAt?'Returned':'Active'}</span>
          <span class="pill ${t.locked ? 'pill-red' : 'pill-blue'}">${t.locked?'Locked':'Unlocked'}</span>
        </div>
      `;

      const right = document.createElement('div');
      right.className = 'controls';
      right.innerHTML = `
        <select>
          <option value="active" ${!t.returnedAt?'selected':''}>Active</option>
          <option value="returned" ${t.returnedAt?'selected':''}>Returned</option>
        </select>
        <label><input type="checkbox" ${t.locked?'checked':''}/> Lock doubloons</label>
        <button class="btn btn-gold">APPLY</button>
      `;

      const select = right.querySelector('select');
      const lockCb = right.querySelector('input[type="checkbox"]');
      const applyBtn = right.querySelector('button');

      applyBtn.addEventListener('click', async () => {
        if(!ensureKey()) return;
        try{
          // Update status (check-in) first
          const status = select.value;
          await actionPost(endpoints.checkinTeam, {
            eventId: EVENT_ID,
            teamCode: t.teamCode,
            status
          });
          // Toggle lock if changed
          await actionPost(endpoints.toggleLock, {
            eventId: EVENT_ID,
            teamCode: t.teamCode,
            lock: !!lockCb.checked
          });
          await loadAll();
          setMsg(`‚úÖ Updated ${t.teamCode}`, true);
        }catch(e){
          setMsg(`Failed to update ${t.teamCode}: ${e.message}`, false);
        }
      });

      wrap.appendChild(left); wrap.appendChild(right);
      els.crewList.appendChild(wrap);
    });
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

  // ---------- Controls ----------
  els.setKey.addEventListener('click', () => {
    const val = prompt('Enter Admin Secret (used by requireAdmin):', getKey());
    if(val===null) return;
    setKey(val.trim());
    loadAll();
  });

  els.start.addEventListener('click', async () => {
    if(!ensureKey()) return;
    try{ await actionPost(endpoints.startEvent(EVENT_ID), { action:'start' }); await loadAll(); }
    catch(e){ setMsg(`Launch failed: ${e.message}`, false); }
  });
  els.pause.addEventListener('click', async () => {
    if(!ensureKey()) return;
    try{ await actionPost(endpoints.startEvent(EVENT_ID), { action:'stop' }); await loadAll(); }
    catch(e){ setMsg(`Pause failed: ${e.message}`, false); }
  });
  els.stop.addEventListener('click', async () => {
    if(!ensureKey()) return;
    try{ await actionPost(endpoints.startEvent(EVENT_ID), { action:'stop' }); await loadAll(); }
    catch(e){ setMsg(`End failed: ${e.message}`, false); }
  });
  els.reset.addEventListener('click', async () => {
    if(!ensureKey()) return;
    if(!confirm('Reset competition? This prepares for a new adventure.')) return;
    try{ await actionPost(endpoints.startEvent(EVENT_ID), { action:'reset' }); await loadAll(); }
    catch(e){ setMsg(`Reset failed: ${e.message}`, false); }
  });
  els.publish.addEventListener('click', async () => {
    if(!ensureKey()) return;
    if(!confirm('Publish final results and unlock the gallery?')) return;
    try{ await actionPost(endpoints.publish(EVENT_ID), {}); await loadAll(); }
    catch(e){ setMsg(`Publish failed: ${e.message}`, false); }
  });

  // ---------- Init ----------
  updateKeyBadge();
  loadAll();
  // auto-refresh every 30s
  setInterval(loadAll, 30000);
})();
</script>
</body>
</html>
