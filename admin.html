<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeamQuest ‚Ä¢ Command Centre</title>
  <style>
    :root{
      --bg:#e79754; --panel:#f7efe7; --card:#fff6ec; --ink:#3b2d16;
      --accent:#1594d2; --success:#2fbf71; --warn:#f5a623; --danger:#e5564f;
      --muted:#d8c7b7; --shadow:0 6px 18px rgba(0,0,0,.12)
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-rounded, "Segoe UI", system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg,#cd7e3f 0%, #e79754 40%, #d88948 100%);
      color:var(--ink);
    }
    .wrap{max-width:1180px; margin:24px auto; padding:0 16px}
    .row{display:grid; grid-template-columns: 420px 1fr; gap:20px}
    .header{
      display:flex; align-items:center; gap:16px; background:var(--panel);
      border-radius:16px; padding:16px 18px; box-shadow:var(--shadow)
    }
    .header .badge{
      width:46px; height:46px; border-radius:10px; background:#e9d8c7; display:grid; place-items:center;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.6), inset 0 -2px 0 rgba(0,0,0,.06)
    }
    .header h1{margin:0; line-height:1.1}
    .header small{display:block; color:#6d553b}

    .panel{background:var(--panel); border-radius:18px; box-shadow:var(--shadow); padding:16px}
    .section-title{font-weight:700; display:flex; align-items:center; gap:8px; color:#2c1d10; margin:4px 0 12px}
    .timer{
      background:linear-gradient(180deg,#f9b23d 0%, #f59a27 100%); border-radius:16px;
      padding:26px 12px; text-align:center; color:#2c1d10; font-weight:800; font-size:46px; letter-spacing:.16em
    }
    .status{margin-top:10px; background:#f0e5d9; border-radius:12px; padding:10px 12px; display:flex; justify-content:center}
    .pill{padding:6px 12px; border-radius:999px; font-size:13px; font-weight:700; display:inline-block}
    .pill.running{background:#e6fbf1; color:#106a3e; border:1px solid #b8efcf}
    .pill.paused{background:#fff6e9; color:#7a5a13; border:1px solid #f1d093}
    .pill.ended{background:#fdeeee; color:#8b1f1f; border:1px solid #f3b3b3}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    button{
      appearance:none; border:0; border-radius:12px; padding:12px 14px; font-weight:800; font-size:15px; cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.08), inset 0 -2px 0 rgba(0,0,0,.08)
    }
    .btn{background:#eaf8ff; color:#0a4c68; border:1px solid #bfe8ff; display:flex; align-items:center; justify-content:center; gap:8px}
    .btn.pause{background:#fff6e9; border-color:#f3d49c; color:#6b4b0a}
    .btn.end{background:#ffe9e9; border-color:#f5b1b1; color:#7d2323}
    .btn.reset{background:#f7efe7; border-color:#dfd1c2; color:#4e3b25}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .stats{display:grid; grid-template-columns: repeat(3,1fr); gap:14px; margin-top:18px}
    .stat{background:var(--card); border:1px solid #ecdac7; border-radius:16px; text-align:center; padding:14px 12px; box-shadow:var(--shadow)}
    .stat h3{margin:0; font-size:28px}
    .teams{max-height:620px; overflow:auto; padding-right:6px}
    .team{background:#fffdf8; border:1px solid #ecdac7; border-radius:14px; padding:12px; margin-bottom:10px}
    .team .row1{display:flex; justify-content:space-between; gap:12px; align-items:center}
    .k{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tag{font-size:12px; font-weight:700; padding:4px 8px; border-radius:999px; border:1px solid #d7c8b6; background:#f9f4ee}
    .apply{padding:8px 10px; border-radius:10px; background:#fff3f6; border:1px solid #f3c4d6; font-weight:800}
    .help{
      background:var(--panel); border-left:4px solid #e3d3c2; padding:12px 14px; border-radius:10px; color:#5e4b35; margin-top:8px
    }
    @media (max-width: 980px){
      .row{grid-template-columns:1fr}
      .teams{max-height:unset}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="badge">üß≠</div>
      <div>
        <h1 style="margin:0">Command&nbsp;Centre</h1>
        <small>Keep it simple: launch the adventure, watch the clock, mark returns ‚Äî late returns auto-deduct at the configured rate.</small>
      </div>
    </div>

    <div class="row" style="margin-top:18px">
      <!-- LEFT: Adventure Control -->
      <section class="panel">
        <div class="section-title">‚öì Adventure Control</div>

        <div id="timer" class="timer">-- : -- : --</div>

        <div class="status"><span id="statusPill" class="pill">Checking‚Ä¶</span></div>

        <div class="grid2" style="margin-top:14px">
          <button id="btnStart" class="btn">üç≠ Launch</button>
          <button id="btnPause" class="btn pause">‚è∏ Pause</button>
          <button id="btnEnd" class="btn end">üü• End</button>
          <button id="btnReset" class="btn reset">üîÅ Reset</button>
        </div>

        <div class="stats">
          <div class="stat">
            <div style="font-size:13px; opacity:.8">Total Crews</div>
            <h3 id="statTotal">‚Äî</h3>
          </div>
          <div class="stat">
            <div style="font-size:13px; opacity:.8">Active</div>
            <h3 id="statActive">‚Äî</h3>
          </div>
          <div class="stat">
            <div style="font-size:13px; opacity:.8">Returned</div>
            <h3 id="statReturned">0</h3>
          </div>
        </div>

        <div class="help">
          Tip: The page auto-syncs with the Sheet every 3s. Reset sets the event back to ‚ÄúNot started.‚Äù
        </div>
      </section>

      <!-- RIGHT: Crew Management -->
      <section class="panel">
        <div class="section-title">üë• Crew Management</div>
        <div id="teams" class="teams"></div>
      </section>
    </div>
  </div>

  <script>
    // --------- Config / Helpers ----------
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event');
    if (!EVENT_ID) alert('Missing ?event=EVT-... in the URL');

    // Admin token: ?key=... or localStorage
    const ADMIN_KEY = qs.get('key') || localStorage.getItem('adminKey') || '';
    if (qs.get('key')) localStorage.setItem('adminKey', qs.get('key'));

    const endpoints = {
      state: '/.netlify/functions/get_event_state',
      start: '/.netlify/functions/admin_start_event', // start/pause/end/reset via action
      teams: '/.netlify/functions/admin_list_teams',
    };

    const el = {
      timer: document.getElementById('timer'),
      statusPill: document.getElementById('statusPill'),
      btnStart: document.getElementById('btnStart'),
      btnPause: document.getElementById('btnPause'),
      btnEnd: document.getElementById('btnEnd'),
      btnReset: document.getElementById('btnReset'),
      teams: document.getElementById('teams'),
      statTotal: document.getElementById('statTotal'),
      statActive: document.getElementById('statActive'),
      statReturned: document.getElementById('statReturned'),
    };

    const headers = () => {
      const h = {'Content-Type':'application/json'};
      if (ADMIN_KEY) h['Authorization'] = 'Bearer ' + ADMIN_KEY;
      return h;
    };

    const normState = (s='') => {
      const v = (s || '').toString().trim().toLowerCase();
      if (['running','started','start','active'].includes(v)) return 'running';
      if (['paused','pause'].includes(v)) return 'paused';
      if (['ended','end','stopped','complete','completed','finished'].includes(v)) return 'ended';
      if (['notstarted','idle','ready','pending',''].includes(v)) return 'notstarted';
      return 'unknown';
    };

    const fmt = (ms) => {
      if (ms < 0) ms = 0;
      const t = Math.floor(ms/1000);
      const hh = String(Math.floor(t/3600)).padStart(2,'0');
      const mm = String(Math.floor((t%3600)/60)).padStart(2,'0');
      const ss = String(t%60).padStart(2,'0');
      return `${hh} : ${mm} : ${ss}`;
    };

    // --------- Event Snapshot ----------
    let current = {
      state: 'unknown',
      startedAt: null,     // ISO
      endsAt: null,        // ISO
      durationSec: null,   // number
      remainingMs: 0,      // frozen when paused
      lastUpdateAt: 0,
      prevState: 'unknown',
    };
    let initialDurationSec = null;

    function setStatusPill(state){
      const s = normState(state);
      el.statusPill.className = 'pill ' + (s==='running'?'running':s==='paused'?'paused':s==='ended'?'ended':'');
      el.statusPill.textContent =
        s==='running' ? 'Running' :
        s==='paused'  ? 'Paused'  :
        s==='ended'   ? 'Ended'   : 'Not Started';
      el.btnStart.disabled = (s==='running' || s==='paused' || s==='ended');
      el.btnPause.disabled = !(s==='running');
      el.btnEnd.disabled   = (s==='ended' || s==='notstarted');
    }

    let rafId = null;
    function tick(){
      cancelAnimationFrame(rafId);
      const now = Date.now();
      let displayMs = 0;
      const s = normState(current.state);

      if (s === 'running' && current.startedAt && current.endsAt){
        displayMs = new Date(current.endsAt).getTime() - now;
        current.remainingMs = displayMs; // keep fresh fallback
      } else if (s === 'paused'){
        displayMs = Math.max(0, current.remainingMs || 0);
      } else if (s === 'ended'){
        displayMs = 0;
      } else {
        const dur = current.durationSec ?? initialDurationSec;
        if (dur != null) displayMs = dur * 1000;
      }
      el.timer.textContent = fmt(displayMs);
      rafId = requestAnimationFrame(tick);
    }

    // --------- API calls ----------
    async function fetchState({force=false}={}){
      const callAt = Date.now();
      const res = await fetch(`${endpoints.state}?eventId=${encodeURIComponent(EVENT_ID)}`, {headers: headers()});
      const data = await res.json().catch(()=>({}));
      if (!force && callAt < current.lastUpdateAt) return;

      const nextState = normState(
        data.state || (data.running ? 'running' : data.paused ? 'paused' : data.ended ? 'ended' : 'notstarted')
      );

      if (initialDurationSec == null && typeof data.durationSec === 'number') {
        initialDurationSec = data.durationSec;
      }

      let remainingMs = current.remainingMs;
      if (typeof data.remainingMs === 'number') {
        remainingMs = data.remainingMs;
      } else if (typeof data.remainingSec === 'number') {
        remainingMs = Math.max(0, Math.floor(data.remainingSec * 1000));
      } else if (nextState === 'running' && data.endsAt) {
        remainingMs = new Date(data.endsAt).getTime() - Date.now();
      }

      current = {
        ...current,
        prevState: current.state,
        state: nextState,
        startedAt: data.startedAt || data.startIso || current.startedAt,
        endsAt: data.endsAt || data.endIso || current.endsAt,
        durationSec: (data.durationSec ?? current.durationSec ?? initialDurationSec),
        remainingMs: Math.max(0, remainingMs),
        lastUpdateAt: callAt,
      };

      setStatusPill(nextState);
      tick();
    }

    async function postAction(action){
      // Optimistic UI to avoid flicker for pause/end/reset
      if (action === 'pause'){
        const ms = (current.endsAt ? new Date(current.endsAt).getTime() - Date.now() : current.remainingMs) || 0;
        current.remainingMs = Math.max(0, ms);
        current.state = 'paused';
        setStatusPill('paused');
        tick();
      }
      if (action === 'end'){
        current.remainingMs = 0;
        current.state = 'ended';
        setStatusPill('ended');
        tick();
      }
      if (action === 'reset'){
        const dur = current.durationSec ?? initialDurationSec ?? 0;
        current.startedAt = null;
        current.endsAt = null;
        current.remainingMs = dur * 1000;
        current.state = 'notstarted';
        setStatusPill('notstarted');
        tick();
      }

      const body = { eventId: EVENT_ID, action };
      const res = await fetch(endpoints.start, {
        method:'POST', headers: headers(), body: JSON.stringify(body)
      });
      const data = await res.json().catch(()=>({success:false}));
      if (!data.success) {
        alert(data.message || `Failed to ${action}.`);
        await fetchState({force:true});
        return;
      }
      await fetchState({force:true});
    }

    async function loadTeams(){
      const res = await fetch(`${endpoints.teams}?eventId=${encodeURIComponent(EVENT_ID)}`, {headers: headers()});
      const data = await res.json().catch(()=>({teams:[]}));
      const teams = Array.isArray(data.teams) ? data.teams : [];
      el.statTotal.textContent = teams.length || 0;
      el.statActive.textContent = teams.filter(t => !t.locked && t.active !== false).length || 0;

      el.teams.innerHTML = teams.map(t => {
        const name = (t.teamName || t.name || 'Unnamed crew');
        const code = t.teamCode || t.code || '';
        const badgeA = `<span class="tag">${(t.label || t.alias || code || 'TEAM')}</span>`;
        const badgeB = `<span class="tag">${t.locked ? 'Locked' : 'Unlocked'}</span>`;
        const badgeC = `<span class="tag">${t.active===false ? 'Inactive' : 'Active'}</span>`;
        return `
          <div class="team">
            <div class="row1">
              <div>
                <div style="font-weight:800">${name}</div>
                <div class="k">${badgeC}${badgeB}${badgeA}</div>
              </div>
              <button class="apply" data-team="${code}">APPLY</button>
            </div>
          </div>`;
      }).join('');
      document.querySelectorAll('.apply').forEach(b => b.addEventListener('click', () => {
        alert('Team-level admin actions coming soon.');
      }));
    }

    // --------- Wire UI ----------
    el.btnStart.addEventListener('click', () => postAction('start'));
    el.btnPause.addEventListener('click', () => postAction('pause'));
    el.btnEnd.addEventListener('click',   () => postAction('end'));
    el.btnReset.addEventListener('click', () => {
      const ok = confirm('Are you sure you want to reset the timer?\n\nThis will set the event to ‚ÄúNot started‚Äù, clear start/end times in the Sheet, and re-enable Launch.');
      if (!ok) return;
      postAction('reset');
    });

    // --------- Boot ----------
    (async function init(){
      await fetchState({force:true});
      await loadTeams();
      setInterval(fetchState, 3000);
    })();
  </script>
</body>
</html>
