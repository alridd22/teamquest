<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Terry‚Äôs Treasure Quest ‚Äî Command Centre</title>
<style>
  :root{
    --bg1:#b85d22; --bg2:#f4a261; --panel:#f3e6d6; --panel2:#efe0c8;
    --gold:#f6c33b; --gold-deep:#d9a21f; --brown:#8b4513; --brown-2:#6d3710;
    --accent:#ffd875; --ok:#2ecc71; --warn:#ffb037; --danger:#e76f51;
    --ink:#3d2411; --muted:#8a6b4b;
    --shadow:0 10px 25px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Ubuntu, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    background: radial-gradient(1200px 600px at 30% -10%, #ffdfb3 0%, transparent 60%) ,
                radial-gradient(1000px 600px at 90% 0%, #ffc78e 0%, transparent 60%),
                linear-gradient(135deg, var(--bg1), var(--bg2));
    color:var(--ink); min-height:100vh; padding:24px;
  }
  .topbar{
    max-width:1200px; margin:0 auto 18px; background:linear-gradient(145deg,#ffeaaf,#ffd36b);
    border:3px solid var(--gold-deep); border-radius:14px; padding:12px 16px; box-shadow:var(--shadow);
    display:flex; align-items:center; gap:14px;
  }
  .topbar .logo{width:42px;height:42px;border-radius:10px;border:3px solid var(--gold-deep);background:linear-gradient(135deg,#8b4513,#a15c23)}
  .topbar h1{margin:0;font-size:18px}
  .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:960px){ .wrap{grid-template-columns:1fr} }

  .panel{
    background:linear-gradient(145deg,var(--panel),var(--panel2));
    border:3px solid var(--brown); border-radius:16px; padding:16px; box-shadow:var(--shadow);
  }
  .panel h2{
    margin:0 0 10px; font-size:20px; font-weight:800; color:var(--brown);
    border-bottom:2px solid var(--gold); padding-bottom:8px; display:flex; align-items:center; gap:8px;
  }

  /* timer/status */
  .timer{
    background:linear-gradient(145deg,#ffc233,#ffb300);
    border:3px solid var(--gold-deep); border-radius:14px; padding:22px; text-align:center; font-weight:900;
    font-size:34px; letter-spacing:6px; color: #3b220f; text-shadow:0 2px 0 rgba(255,255,255,.35);
    margin-bottom:10px;
  }
  .status{
    background:#eee0ff; border:2px solid #c6a8ff; color:#4b2b8d;
    border-radius:12px; padding:12px; text-align:center; font-weight:700; margin-bottom:12px;
  }
  .status.running{ background:#d8ffdb; border-color:#78d38a; color:#0f6a22; }
  .status.paused{ background:#fff0cc; border-color:#ffc463; color:#8a5406; }
  .status.ended{ background:#fff6cc; border-color:#eecb4e; color:#7a5710; }

  /* buttons */
  .grid-btns{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }
  .btn{
    display:flex; align-items:center; justify-content:center; gap:8px; width:100%;
    border:3px solid var(--brown); border-radius:12px; padding:14px 10px; font-weight:800; cursor:pointer;
    background:linear-gradient(145deg,#ffffff,#fff2d8); color:var(--brown);
    box-shadow:0 4px 10px rgba(0,0,0,.12); transition:.15s transform,.15s box-shadow,.15s filter;
    text-transform:capitalize;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 7px 16px rgba(0,0,0,.18) }
  .btn:disabled{ opacity:.55; cursor:not-allowed; filter:grayscale(.3)}
  .btn--green{ background:linear-gradient(145deg,#50e48a,#22c55e); color:white; border-color:#1c8a47 }
  .btn--amber{ background:linear-gradient(145deg,#ffd48a,#ffb63a); color:#5f3806; border-color:#b2740a }
  .btn--red{ background:linear-gradient(145deg,#ff9b93,#e86052); color:white; border-color:#a9352a }
  .btn--brown{ background:linear-gradient(145deg,#9a5a24,#6f3a12); color:white; border-color:#3b1f0b }

  .btn-wide{ width:100%; margin-top:8px }

  /* crews */
  .crew-list{ display:flex; flex-direction:column; gap:12px; max-height:560px; overflow:auto; padding-right:8px }
  .crew{
    background:linear-gradient(145deg,#fff9eb,#fff3dc);
    border:2px solid #e4c17a; border-radius:12px; padding:12px 12px;
    display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px;
  }
  .crew h3{ margin:0 0 6px; font-size:16px; color:var(--brown) }
  .meta{ font-size:12px; color:var(--muted); }
  .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  select, input[type="checkbox"]{ accent-color: var(--gold-deep); }
  select{
    padding:8px 10px; border:2px solid #e0c48a; border-radius:10px; background:white; color:var(--ink); font-weight:700;
  }
  .badge{ border-radius:999px; padding:4px 10px; font-size:12px; font-weight:800; }
  .badge.blue{ background:#e7f2ff; color:#1563c1; border:1px solid #b7d2ff }
  .badge.gray{ background:#f0f1f4; color:#4c4f57; border:1px solid #dde0e6 }

  /* stats */
  .stats{ max-width:1200px; margin:18px auto 0; display:grid; grid-template-columns:repeat(4,1fr); gap:18px }
  @media (max-width:960px){ .stats{ grid-template-columns:repeat(2,1fr) } }
  .stat{
    background:linear-gradient(145deg,#fff4dd,#fff); border:3px solid var(--gold);
    border-radius:14px; padding:16px; text-align:center; box-shadow:var(--shadow)
  }
  .stat .n{ font-size:32px; font-weight:900; color:var(--brown) }

  /* flash/error */
  .flash{
    margin-top:10px; padding:12px 14px; border-radius:12px; font-weight:700; border:2px solid;
  }
  .flash.ok{ background:#eaffea; border-color:#85d789; color:#0d6f1f }
  .flash.err{ background:#ffe8e6; border-color:#ff9a90; color:#9f1f12 }
</style>
</head>
<body>
  <div class="topbar">
    <div class="logo"></div>
    <h1>Command Centre</h1>
    <div style="margin-left:auto;font-weight:700;color:#6b4b2a">Keep it simple: launch the adventure, watch the clock, mark returns ‚Äî late returns auto-deduct based on the configured rate.</div>
  </div>

  <div class="wrap">
    <!-- LEFT: Controls -->
    <section class="panel" id="leftPanel">
      <h2>‚öì Adventure Control</h2>
      <div class="timer" id="timerDisplay">01 : 30 : 00</div>
      <div class="status" id="statusText">Not started</div>

      <div class="grid-btns">
        <button id="btnLaunch" class="btn btn--green">üöÄ Launch</button>
        <button id="btnPause"  class="btn btn--amber" disabled>‚è∏Ô∏è Pause</button>
        <button id="btnEnd"    class="btn btn--red">‚èπÔ∏è End</button>
        <button id="btnReset"  class="btn btn--brown">üîÑ Reset</button>
      </div>

      <button id="btnPublish" class="btn btn--amber btn-wide">üèÜ Publish Final Results</button>

      <div id="flash" class="flash" style="display:none"></div>
    </section>

    <!-- RIGHT: Crew management -->
    <section class="panel">
      <h2>üë• Crew Management</h2>
      <div id="crewList" class="crew-list">
        <div class="flash" id="crewLoading">Loading crews‚Ä¶</div>
      </div>
    </section>
  </div>

  <div class="stats">
    <div class="stat"><div class="n" id="statTotal">0</div>Total Crews</div>
    <div class="stat"><div class="n" id="statActive">0</div>Active</div>
    <div class="stat"><div class="n" id="statReturned">0</div>Returned</div>
    <div class="stat"><div class="n" id="statPenalised">0</div>Penalised</div>
  </div>

<script>
/* ---------- helpers ---------- */
const qs = sel => document.querySelector(sel);
const qsa = sel => [...document.querySelectorAll(sel)];
const getEventIdFromURL = () => new URLSearchParams(location.search).get("event") || "EVT-19-08-2025";

function showFlash(msg, isErr=true){
  const el = qs("#flash");
  el.textContent = msg;
  el.className = "flash " + (isErr ? "err" : "ok");
  el.style.display = "block";
  clearTimeout(showFlash._t);
  showFlash._t = setTimeout(()=>{ el.style.display="none"; }, 5000);
}

async function fetchJSON(url, opts={}){
  const res  = await fetch(url, opts);
  const txt  = await res.text();
  let data;
  try{ data = JSON.parse(txt); }catch{ data = null; }
  if(!res.ok || (data && data.success === false)){
    const msg = (data && data.message) ? data.message : (`HTTP ${res.status} ${res.statusText}`);
    throw new Error(msg);
  }
  return data || {};
}

/* ---------- state + rendering ---------- */
let state = {
  running:false, paused:false, ended:false,
  resultsPublished:false, durationMinutes:90, startTime:null
};

function formatTimer(msLeft){
  if (msLeft < 0) msLeft = 0;
  const totalSec = Math.floor(msLeft/1000);
  const h = String(Math.floor(totalSec/3600)).padStart(2,'0');
  const m = String(Math.floor((totalSec%3600)/60)).padStart(2,'0');
  const s = String(totalSec%60).padStart(2,'0');
  return `${h} : ${m} : ${s}`;
}

function paintStatus(){
  const st = qs("#statusText");
  st.className = "status";
  if (state.resultsPublished){
    st.textContent = "Final results published";
    st.classList.add("ended");
  } else if (state.ended){
    st.textContent = "Adventure complete";
    st.classList.add("ended");
  } else if (state.running && !state.paused){
    st.textContent = "Adventure running";
    st.classList.add("running");
  } else if (state.paused){
    st.textContent = "Paused";
    st.classList.add("paused");
  } else {
    st.textContent = "Not started";
  }

  // buttons
  qs("#btnLaunch").disabled = state.running && !state.paused;
  qs("#btnPause").disabled  = !state.running || state.paused;
  qs("#btnEnd").disabled    = !state.running && !state.paused;
}

let timerTick = null;
function startLocalTimer(){
  clearInterval(timerTick);
  const disp = qs("#timerDisplay");
  if (!state.startTime || !state.durationMinutes){
    disp.textContent = "01 : 30 : 00";
    return;
  }
  timerTick = setInterval(()=>{
    const endAt = new Date(state.startTime).getTime() + (state.durationMinutes*60*1000);
    const left  = endAt - Date.now();
    disp.textContent = formatTimer(left);
  }, 1000);
}

function renderCrewList(teams){
  const root = qs("#crewList");
  root.innerHTML = "";
  if (!teams || teams.length === 0){
    root.innerHTML = `<div class="flash">No crews found for this event.</div>`;
    return;
  }

  teams.forEach(t=>{
    const code  = t.teamCode || "";
    const name  = t.teamName || code;
    const status= (t.status || (t.returnedAt ? "returned" : "active")).toLowerCase();
    const locked= !!t.locked;

    const row = document.createElement("div");
    row.className = "crew";
    row.innerHTML = `
      <div>
        <h3>${name}</h3>
        <div class="meta">${code}</div>
      </div>

      <div class="row">
        <span class="badge ${status==="active"?"blue":"gray"}">${status==="active"?"Active":"Returned"}</span>

        <select data-team="${code}">
          <option value="active"   ${status==="active"?"selected":""}>Active</option>
          <option value="returned" ${status!=="active"?"selected":""}>Returned</option>
        </select>

        <label class="row" style="gap:6px;">
          <input type="checkbox" data-lock="${code}" ${locked?"checked":""}/> Lock doubloons
        </label>

        <button class="btn btn--amber" data-apply="${code}">APPLY</button>

        <span class="badge ${locked?"gray":"blue"}">${locked?"Locked":"Unlocked"}</span>
      </div>
    `;
    root.appendChild(row);
  });

  // delegate ‚ÄúAPPLY‚Äù
  root.addEventListener("click", async (ev)=>{
    const btn = ev.target.closest("[data-apply]");
    if(!btn) return;
    const code = btn.getAttribute("data-apply");
    const sel  = root.querySelector(`select[data-team="${code}"]`);
    const chk  = root.querySelector(`input[data-lock="${code}"]`);
    const eventId = getEventIdFromURL();

    try{
      // lock/unlock first
      await fetchJSON("/.netlify/functions/admin_toggle_lock_team",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ eventId, teamCode: code, locked: !!chk.checked })
      });
      // status update
      await fetchJSON("/.netlify/functions/admin_checkin_team",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ eventId, teamCode: code, status: sel.value })
      });

      showFlash(`Updated ${code}`, false);
      refresh();

    }catch(err){
      showFlash(`Failed to update ${code}: ${err.message}`);
    }
  }, { once:true });
}

function paintStats(teams){
  const total = teams.length;
  const active = teams.filter(t => (t.status || (t.returnedAt? "returned":"active")) === "active").length;
  const returned = total - active;
  const penalised = teams.filter(t => (t.penalty || 0) > 0).length;

  qs("#statTotal").textContent = total;
  qs("#statActive").textContent = active;
  qs("#statReturned").textContent = returned;
  qs("#statPenalised").textContent = penalised;
}

/* ---------- data flow ---------- */
async function loadState(){
  const eventId = getEventIdFromURL();
  const data = await fetchJSON(`/.netlify/functions/get_event_state?eventId=${encodeURIComponent(eventId)}`);
  // normalise keys from your function
  state.running  = data.status === "start" || data.status === "running";
  state.paused   = data.status === "paused";
  state.ended    = data.status === "stop" || data.status === "stopped" || data.hasEnded;
  state.resultsPublished = !!data.resultsPublished;
  state.durationMinutes  = data.durationMinutes || 90;
  state.startTime        = data.startTime || null;

  paintStatus();
  startLocalTimer();
}

async function loadTeams(){
  const eventId = getEventIdFromURL();
  const data = await fetchJSON(`/.netlify/functions/admin_list_teams?eventId=${encodeURIComponent(eventId)}`);
  const teams = data.teams || [];
  renderCrewList(teams);
  paintStats(teams);
}

async function refresh(){
  try{
    await Promise.all([loadState(), loadTeams()]);
  }catch(err){
    showFlash("Failed to load current status: " + err.message);
  }
}

/* ---------- actions ---------- */
qs("#btnLaunch").addEventListener("click", async ()=>{
  try{
    const eventId = getEventIdFromURL();
    await fetchJSON("/.netlify/functions/admin_start_event",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ eventId, action:"start" })
    });
    showFlash("Adventure launched!", false);
    refresh();
  }catch(err){ showFlash("Failed to launch: " + err.message); }
});

qs("#btnPause").addEventListener("click", async ()=>{
  try{
    const eventId = getEventIdFromURL();
    await fetchJSON("/.netlify/functions/admin_start_event",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ eventId, action:"pause" })
    });
    showFlash("Adventure paused.", false);
    refresh();
  }catch(err){ showFlash("Failed to pause: " + err.message); }
});

qs("#btnEnd").addEventListener("click", async ()=>{
  if(!confirm("End the adventure for all crews?")) return;
  try{
    const eventId = getEventIdFromURL();
    await fetchJSON("/.netlify/functions/admin_start_event",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ eventId, action:"stop" })
    });
    showFlash("Adventure ended.", false);
    refresh();
  }catch(err){ showFlash("Failed to end: " + err.message); }
});

qs("#btnReset").addEventListener("click", async ()=>{
  if(!confirm("Reset the event and prepare for a new adventure?")) return;
  try{
    const eventId = getEventIdFromURL();
    await fetchJSON("/.netlify/functions/admin_start_event",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ eventId, action:"reset" })
    });
    showFlash("Event reset.", false);
    refresh();
  }catch(err){ showFlash("Failed to reset: " + err.message); }
});

qs("#btnPublish").addEventListener("click", async ()=>{
  if(!confirm("Publish final results and unlock the gallery for all crews?")) return;
  try{
    const eventId = getEventIdFromURL();
    await fetchJSON("/.netlify/functions/admin_publish_final",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ eventId })
    });
    showFlash("Final results published.", false);
    refresh();
  }catch(err){ showFlash("Failed to publish: " + err.message); }
});

/* ---------- boot ---------- */
refresh();
setInterval(refresh, 30000); // auto-refresh every 30s
</script>
</body>
</html>
