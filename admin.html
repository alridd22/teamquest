<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TeamQuest ‚Äì Command Centre</title>
<link rel="icon" href="/favicon.ico" />
<style>
  :root{
    --bg:#d9803a;
    --bg2:#eaa165;
    --card:#f6ecd9;
    --ink:#3e2a1a;
    --gold:#ffc83d;
    --amber:#ffb423;
    --line:#d9a35b;
    --ok:#27ae60;
    --warn:#ff8c00;
    --bad:#e74c3c;
    --muted:#a07956;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background: radial-gradient(1200px 800px at 20% 10%, var(--bg2), var(--bg));
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
  }
  .shell{max-width:1200px; margin:24px auto; padding:0 16px;}
  .top{
    background:linear-gradient(180deg,#ffdd8b,#ffd16a);
    border:3px solid var(--line); border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.18);
    padding:12px 16px; display:flex; align-items:center; gap:14px;
  }
  .top-logo{width:44px; height:44px; border-radius:10px; background:#8b5a2b; border:3px solid var(--line);}
  .top-title{font-weight:800; font-size:18px}
  .top-sub{color:#6b4a2e; font-weight:600}

  .grid{display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:18px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,#fff7ea,#f4e6cf);
    border:3px solid var(--line); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.16);
    padding:16px;
  }
  .card h2{margin:0 0 12px; font-size:18px; display:flex; align-items:center; gap:10px}
  .rule{height:1px; background:linear-gradient(90deg,transparent,var(--line),transparent); margin:10px 0}

  /* Adventure left */
  .timer{
    background:linear-gradient(180deg,#ffc83d,#ffaf2f); border:3px solid var(--line); border-radius:14px;
    text-align:center; font-weight:900; letter-spacing:.12em; font-size:40px; padding:22px 12px; color:#3b250f;
  }
  .status{
    margin-top:10px; background:#efe5d4; border:2px solid var(--line); border-radius:10px; padding:10px;
    text-align:center; font-weight:800; color:#5c3b22;
  }
  .pill{display:inline-block; padding:6px 12px; border-radius:999px; font-weight:800; color:white; font-size:12px}
  .pill.idle{background:#9aa0a6}
  .pill.running{background:var(--ok)}
  .pill.paused{background:var(--warn)}
  .pill.ended{background:var(--bad)}

  .btnrow{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
  .btn{appearance:none; border:none; border-radius:12px; padding:14px 12px; font-weight:900; cursor:pointer;
       border:3px solid var(--line); box-shadow:0 6px 18px rgba(0,0,0,.1)}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .btn.launch{background:linear-gradient(180deg,#37d67a,#1ebc5d); color:white}
  .btn.pause {background:linear-gradient(180deg,#ffd36b,#ffae31); color:#4b2f12}
  .btn.end   {background:linear-gradient(180deg,#ff7d6b,#f0533f); color:white}
  .btn.reset {background:linear-gradient(180deg,#8b5a2b,#6e451f); color:#ffe0ae}

  .alert{margin-top:12px; background:#ffe5e5; border:2px solid #ff9fa1; color:#8a2327; padding:10px 12px; border-radius:10px; font-weight:800; display:none}

  /* Crew right */
  .crew-list{display:flex; flex-direction:column; gap:12px; max-height:560px; overflow:auto; padding-right:4px}
  .crew{
    background:#fffaf0; border:2px solid var(--line); border-radius:12px; padding:12px; display:grid; gap:8px;
    grid-template-columns: 1fr auto;
  }
  .crew h3{margin:0; font-size:16px}
  .crew small{color:#735236; font-weight:700}
  .badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef0f3; color:#5a6572; font-weight:800; font-size:12px}
  .krow{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .apply{background:linear-gradient(180deg,#ffc83d,#ffaf2f); border:2px solid var(--line); border-radius:10px; font-weight:900; padding:8px 12px; cursor:pointer}

  /* Stats bar */
  .stats{display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin:18px 0}
  .stat{
    background:linear-gradient(180deg,#fff7ea,#f4e6cf);
    border:3px solid var(--line); border-radius:14px; text-align:center; padding:16px; box-shadow:0 10px 28px rgba(0,0,0,.15)
  }
  .stat .n{font-size:26px; font-weight:900}
  .stat .l{color:#7a5639; font-weight:800}
</style>
</head>
<body>
  <div class="shell">
    <div class="top">
      <div class="top-logo"></div>
      <div class="top-title">Command Centre</div>
      <div class="top-sub">Keep it simple: launch the adventure, watch the clock, mark returns ‚Äî late returns auto-deduct based on the configured rate.</div>
    </div>

    <div class="grid">
      <!-- LEFT: Adventure control -->
      <section class="card" id="leftCard">
        <h2>‚öì Adventure Control</h2>
        <div class="timer" id="timerDisplay">01 : 30 : 00</div>
        <div class="status">
          <span id="timerStatus" class="pill idle">Not started</span>
        </div>

        <div class="btnrow">
          <button id="startBtn" class="btn launch">üöÄ Launch</button>
          <button id="pauseBtn" class="btn pause" disabled>‚è∏Ô∏è Pause</button>
          <button id="stopBtn" class="btn end" disabled>‚èπÔ∏è End</button>
          <button id="resetBtn" class="btn reset">üîÅ Reset (UI only)</button>
        </div>

        <div class="alert" id="leftAlert"></div>
      </section>

      <!-- RIGHT: Crew management -->
      <section class="card">
        <h2>üë• Crew Management</h2>
        <div class="rule"></div>
        <div id="crewsList" class="crew-list">
          <div class="crew" style="grid-template-columns:1fr;">
            <div><strong>Loading crews‚Ä¶</strong></div>
          </div>
        </div>
      </section>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div class="n" id="totalCrews">0</div>
        <div class="l">Total Crews</div>
      </div>
      <div class="stat">
        <div class="n" id="activeCrews">0</div>
        <div class="l">Active</div>
      </div>
      <div class="stat">
        <div class="n" id="returnedCrews">0</div>
        <div class="l">Returned</div>
      </div>
      <div class="stat">
        <div class="n" id="penalisedCrews">0</div>
        <div class="l">Penalised</div>
      </div>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
let ui = {
  eventId: new URLSearchParams(location.search).get('event') || 'EVT-19-08-2025',
  tickTimer: null,
  els: {}
};

/* ========= HELPERS ========= */
function $(sel){ return document.querySelector(sel); }
function setText(el, txt){ if(el) el.textContent = txt; }
function showAlert(msg){ const a=ui.els.leftAlert; if(!a) return; a.style.display='block'; a.textContent=msg; setTimeout(()=>a.style.display='none', 4500); }

/* ========= NORMALIZER (handles old & new shapes) ========= */
function normalizeEventState(data) {
  const raw = (data?.state || data?.competitionStatus || data?.status || '').toLowerCase();
  const running = raw === 'running' || raw === 'start' || raw === 'started';
  const paused  = raw === 'paused';
  const ended   = raw === 'ended' || raw === 'stop' || raw === 'stopped';
  const notStarted = !running && !paused && !ended;

  const startIso    = data?.startedAtIso || data?.startTime || null;
  const durationSec = Number(data?.durationSec ?? (data?.durationMinutes ? data.durationMinutes * 60 : data?.duration) ?? 0);
  const penaltyPerMin = Number(data?.penaltyPerMin ?? data?.penaltyRate ?? 0);
  const published   = Boolean(data?.resultsPublished || data?.publishedAtIso);

  return { running, paused, ended, notStarted, startIso, durationSec, penaltyPerMin, published };
}

/* ========= RENDER ========= */
function renderFromState(norm) {
  const pill = ui.els.timerStatus;
  if (norm.running){ pill.className='pill running'; setText(pill,'Running'); }
  else if (norm.paused){ pill.className='pill paused'; setText(pill,'Paused'); }
  else if (norm.ended){ pill.className='pill ended'; setText(pill,'Ended'); }
  else { pill.className='pill idle'; setText(pill,'Not started'); }

  // Buttons
  ui.els.startBtn.disabled = norm.running || norm.paused || norm.ended;
  ui.els.pauseBtn.disabled = !norm.running;
  ui.els.stopBtn.disabled  = !(norm.running || norm.paused);

  // Timer
  startOrStopTick(norm);
}

function startOrStopTick(norm){
  const display = ui.els.timer;
  if (ui.tickTimer){ clearInterval(ui.tickTimer); ui.tickTimer = null; }
  if (!norm.startIso || !norm.durationSec){ setText(display,'01 : 30 : 00'); return; }

  const startMs = Date.parse(norm.startIso);
  const endMs   = startMs + norm.durationSec * 1000;

  function tick(){
    const now = Date.now();
    const remain = endMs - now;
    const sign = remain >= 0 ? '' : '+';
    const t = Math.abs(remain);
    const h = Math.floor(t / 3_600_000);
    const m = Math.floor((t % 3_600_000) / 60_000);
    const s = Math.floor((t % 60_000) / 1000);
    setText(display, `${sign}${String(h).padStart(2,'0')} : ${String(m).padStart(2,'0')} : ${String(s).padStart(2,'0')}`);
  }
  tick();
  ui.tickTimer = setInterval(tick, 1000);
}

/* ========= LOAD EVENT STATE ========= */
async function refreshStatus(silent=false){
  try{
    const res = await fetch(`/.netlify/functions/get_event_state?eventId=${encodeURIComponent(ui.eventId)}`, { cache:'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const norm = normalizeEventState(data);
    renderFromState(norm);
    if (!silent) console.debug('State:', data, '‚Üí', norm);
  }catch(err){
    console.error('Failed to load current status:', err);
    if(!silent) showAlert('Failed to load current status.');
  }
}

/* ========= CREWS ========= */
async function loadCrews(){
  const list = ui.els.crewsList;
  list.innerHTML = `<div class="crew" style="grid-template-columns:1fr;"><div><strong>Loading crews‚Ä¶</strong></div></div>`;
  try{
    const res = await fetch(`/.netlify/functions/admin_list_teams?eventId=${encodeURIComponent(ui.eventId)}`, { cache:'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const teams = data?.teams || [];
    // Stats
    setText($('#totalCrews'), teams.length);
    setText($('#activeCrews'), teams.filter(t => (t.status||'active')==='active').length);
    setText($('#returnedCrews'), teams.filter(t => (t.status||'')==='returned' || (t.status||'')==='late').length);
    setText($('#penalisedCrews'), teams.filter(t => Number(t.penalty||0) > 0).length);

    if(!teams.length){
      list.innerHTML = `<div class="crew" style="grid-template-columns:1fr;"><div><strong>No crews yet.</strong></div></div>`;
      return;
    }

    list.innerHTML = '';
    teams.forEach(team => {
      const status = (team.status || 'active');
      const penal  = Number(team.penalty || 0);
      const locked = team.locked ? 'Locked' : 'Unlocked';

      const row = document.createElement('div');
      row.className = 'crew';
      row.innerHTML = `
        <div>
          <h3>${team.teamName || 'Unnamed crew'}</h3>
          <small>${team.teamCode || ''}</small>
          <div class="krow" style="margin-top:6px">
            <span class="badge">${status[0].toUpperCase()+status.slice(1)}</span>
            <span class="badge">${locked}</span>
            ${penal>0 ? `<span class="badge" style="background:#ffe2e0;color:#8a2327;">Penalty: -${penal}</span>`:''}
          </div>
        </div>
        <div class="krow">
          <button class="apply" data-code="${team.teamCode}">APPLY</button>
        </div>
      `;
      list.appendChild(row);
    });
  }catch(e){
    console.error('Failed to load crews:', e);
    list.innerHTML = `<div class="crew" style="grid-template-columns:1fr;">
      <div><strong style="color:#8a2327">Failed to load crew list.</strong></div></div>`;
  }
}

/* ========= ACTIONS ========= */
async function callStart(){
  ui.els.startBtn.disabled = true; // snappy feedback
  try{
    const res = await fetch('/.netlify/functions/admin_start_event', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ eventId: ui.eventId })
    });
    const data = await res.json();
    if(!res.ok || data?.success === false) throw new Error(data?.message || `HTTP ${res.status}`);
    setTimeout(() => refreshStatus(), 500); // allow Sheets write
  }catch(e){
    console.error('Launch failed:', e);
    ui.els.startBtn.disabled = false;
    showAlert(`Failed to launch: ${e.message}`);
  }
}

async function callPause(){
  try{
    const res = await fetch('/.netlify/functions/admin_start_event', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ eventId: ui.eventId, action:'pause' })
    });
    const data = await res.json();
    if(!res.ok || data?.success === false) throw new Error(data?.message || `HTTP ${res.status}`);
    setTimeout(() => refreshStatus(), 300);
  }catch(e){
    console.error('Pause failed:', e);
    showAlert(`Failed to pause: ${e.message}`);
  }
}

async function callEnd(){
  try{
    const res = await fetch('/.netlify/functions/admin_start_event', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ eventId: ui.eventId, action:'stop' })
    });
    const data = await res.json();
    if(!res.ok || data?.success === false) throw new Error(data?.message || `HTTP ${res.status}`);
    setTimeout(() => refreshStatus(), 300);
  }catch(e){
    console.error('End failed:', e);
    showAlert(`Failed to end: ${e.message}`);
  }
}

/* ========= BOOT ========= */
document.addEventListener('DOMContentLoaded', () => {
  ui.els = {
    timer: $('#timerDisplay'),
    timerStatus: $('#timerStatus'),
    startBtn: $('#startBtn'),
    pauseBtn: $('#pauseBtn'),
    stopBtn:  $('#stopBtn'),
    resetBtn: $('#resetBtn'),
    leftAlert: $('#leftAlert'),
    crewsList: $('#crewsList')
  };

  ui.els.startBtn.addEventListener('click', callStart);
  ui.els.pauseBtn.addEventListener('click', callPause);
  ui.els.stopBtn.addEventListener('click', callEnd);
  ui.els.resetBtn.addEventListener('click', () => { if (ui.tickTimer) { clearInterval(ui.tickTimer); ui.tickTimer = null; } setText(ui.els.timer, '01 : 30 : 00'); });

  // Initial loads + periodic refresh to keep in sync
  refreshStatus(true);
  loadCrews();
  setInterval(() => refreshStatus(true), 10000); // state poll
  setInterval(() => loadCrews(), 30000);         // crew list poll
});
</script>
</body>
</html>
