<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Terry‚Äôs Treasure Quest ‚Äî Command Centre</title>
  <style>
    :root{
      --brown:#8B4513;--brown-2:#7a3e11;--gold:#DAA520;--gold-2:#FFD700;--sand:#F5E6D3;--sand-2:#E8D7C3;
      --ink:#2C1810;--ink-2:#3E2723;--green:#1fbf5b;--red:#e46a6a;--amber:#f0b43a
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      color:var(--ink-2);
      background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%) fixed;
      min-height:100vh;
      padding:18px;
    }
    .bar{
      background:linear-gradient(145deg,#F5E6D3,#F0E1CB);
      border:3px solid var(--gold);
      border-radius:16px;
      padding:14px 16px;
      box-shadow:0 8px 22px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.4);
      display:flex;align-items:center;gap:14px;justify-content:space-between;max-width:1200px;margin:0 auto 18px;
    }
    .bar .left{display:flex;gap:12px;align-items:center}
    .pill{
      background:linear-gradient(135deg,#FFEB99,#FFD36E);
      border:2px solid var(--gold);
      border-radius:12px;padding:10px 14px;color:var(--ink-2);box-shadow:inset 0 1px 0 rgba(255,255,255,.5)
    }
    .admin-btn{
      background:linear-gradient(135deg,#FFDB77,#FFC44D);
      border:3px solid var(--gold);
      border-radius:12px;
      font-weight:700;color:var(--ink-2);
      padding:10px 14px;cursor:pointer
    }
    .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:960px){.wrap{grid-template-columns:1fr}}
    .panel{
      background:linear-gradient(145deg,var(--sand),var(--sand-2));
      border:3px solid var(--brown);
      border-radius:16px;padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.35)
    }
    .panel h2{
      margin:0 0 10px;
      font-size:1.1rem;color:var(--ink);
      border-bottom:3px solid var(--gold);padding-bottom:8px
    }
    .timer{
      background:linear-gradient(135deg,#ffc21f,#ffb114);
      border:3px solid var(--gold);
      border-radius:14px;
      color:#3b250c;font-weight:900;letter-spacing:.12em;text-align:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:2.1rem;padding:22px 8px;margin-bottom:10px
    }
    .status{
      background:#efe6ff;border:2px solid #b9a7ff;color:#3a2f66;
      border-radius:12px;padding:12px;text-align:center;font-weight:700;margin-bottom:14px
    }
    .btnrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .btn{border:3px solid var(--brown);border-radius:12px;padding:12px;cursor:pointer;font-weight:800}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn--launch{background:linear-gradient(135deg,#22cc66,#18b357);color:#fff}
    .btn--pause{background:linear-gradient(135deg,#ffe09a,#ffd077);color:#532f04}
    .btn--end{background:linear-gradient(135deg,#f59b9b,#e46a6a);color:#5a1212}
    .btn--reset{background:linear-gradient(135deg,#8b5a3c,#6b3e25);color:#fff}
    .btn--publish{background:linear-gradient(135deg,#ffd95e,#ffc52a);color:#4b2d00;border-color:var(--gold);width:100%;margin-bottom:12px}
    .flash{background:#ffe6e6;border:2px solid #ff8686;border-radius:12px;padding:12px;color:#7a0000;font-weight:700}
    /* right */
    .crewlist{display:grid;gap:12px;max-height:580px;overflow:auto}
    .card{
      background:linear-gradient(135deg,#FFF8DC,#F5E6D3);
      border:2px solid var(--gold);border-radius:12px;padding:12px
    }
    .card-top{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:8px}
    .badge{font-size:.8rem;padding:6px 10px;border-radius:999px;font-weight:800}
    .badge--active{background:#e8f6ff;border:1px solid #a6d8ff;color:#10507d}
    .badge--locked{background:#fff0f0;border:1px solid #ffc3c3;color:#7f1620}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,input[type="checkbox"]{transform:translateY(1px)}
    /* stats */
    .stats{max-width:1200px;margin:18px auto 0;display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media (max-width:900px){.stats{grid-template-columns:repeat(2,1fr)}}
    .stat{
      background:linear-gradient(145deg,var(--sand),var(--sand-2));
      border:3px solid var(--brown);border-radius:16px;padding:16px;text-align:center;
      box-shadow:0 10px 24px rgba(0,0,0,.2)
    }
    .stat .n{font-size:1.8rem;font-weight:900;color:var(--ink)}
    .stat .l{font-size:.95rem;color:#7b553d;font-weight:800;margin-top:6px}
  </style>
</head>
<body>
  <!-- Header / key -->
  <div class="bar">
    <div class="left">
      <div style="width:42px;height:42px;border-radius:10px;border:3px solid var(--gold);background:linear-gradient(135deg,#8B4513,#A0522D)"></div>
      <div class="pill">
        <div style="font-weight:800">Command Centre</div>
        <div style="font-size:.9rem">Keep it simple: launch the adventure, watch the clock, mark returns ‚Äî late returns auto-deduct based on the configured rate.</div>
      </div>
    </div>
    <div class="left" style="gap:10px">
      <div id="keyState" class="pill">Admin key: <b>unset</b></div>
      <button id="setKeyBtn" class="admin-btn">Set / Change</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Left: control -->
    <section class="panel" id="left">
      <h2>‚öì Adventure Control</h2>
      <div id="timer" class="timer">01 : 30 : 00</div>
      <div id="status" class="status">Not started</div>

      <div class="btnrow">
        <button class="btn btn--launch" id="btnLaunch">üöÄ Launch</button>
        <button class="btn btn--pause" id="btnPause">‚è∏Ô∏è Pause</button>
        <button class="btn btn--end" id="btnEnd">‚èπÔ∏è End</button>
        <button class="btn btn--reset" id="btnReset">üîÑ Reset</button>
      </div>

      <button class="btn btn--publish" id="btnPublish">üèÜ Publish Final Results</button>
      <div id="flash" class="flash" style="display:none"></div>
    </section>

    <!-- Right: crews -->
    <section class="panel">
      <h2>üë• Crew Management</h2>
      <div id="crewList" class="crewlist"><div class="pill">Loading crews...</div></div>
    </section>
  </div>

  <div class="stats">
    <div class="stat"><div id="statTotal" class="n">0</div><div class="l">Total Crews</div></div>
    <div class="stat"><div id="statActive" class="n">0</div><div class="l">Active</div></div>
    <div class="stat"><div id="statReturned" class="n">0</div><div class="l">Returned</div></div>
    <div class="stat"><div id="statPenalised" class="n">0</div><div class="l">Penalised</div></div>
  </div>

  <script>
    // ---------- Small utilities ----------
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const ADMIN_KEY_STORAGE = "tq_admin_secret";
    const getEventIdFromURL = () => new URLSearchParams(location.search).get("event") || "EVT-19-08-2025";

    function setKeyUI(isSet){ qs("#keyState").innerHTML = 'Admin key: <b>'+(isSet?'set':'unset')+'</b>'; }
    function ensureKey(onCancel){
      let key = localStorage.getItem(ADMIN_KEY_STORAGE);
      if(!key){
        // Auto-prompt on first load if missing
        key = window.prompt("Enter Admin Secret (same as Netlify env TQ_ADMIN_SECRET):","");
        if(!key){
          onCancel && onCancel();
          return null;
        }
        localStorage.setItem(ADMIN_KEY_STORAGE, key);
      }
      setKeyUI(!!key);
      return key;
    }
    function changeKey(){
      const current = localStorage.getItem(ADMIN_KEY_STORAGE) || "";
      const next = window.prompt("Enter Admin Secret (same as Netlify env TQ_ADMIN_SECRET):", current);
      if(next===null) return;
      if(next.trim()===""){ localStorage.removeItem(ADMIN_KEY_STORAGE); setKeyUI(false); return; }
      localStorage.setItem(ADMIN_KEY_STORAGE, next.trim());
      setKeyUI(true);
      // Immediately refresh data when key changes
      boot();
    }

    async function fetchAdmin(path, options = {}){
      const key = ensureKey();
      if(!key) throw new Error("Admin key not set");
      const headers = Object.assign({}, options.headers || {}, { "x-tq-admin": key });
      const res = await fetch(path, { ...options, headers });
      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`${res.status} ‚Äî ${t || res.statusText}`);
      }
      return res.json();
    }

    // ---------- UI helpers ----------
    function showFlash(msg, isError=true){
      const el = qs("#flash");
      el.style.display = "block";
      el.textContent = msg;
      el.style.background = isError ? "#ffe6e6" : "#e9ffe9";
      el.style.borderColor = isError ? "#ff8686" : "#7bd97b";
      setTimeout(()=>{ el.style.display = "none"; }, 4000);
    }
    const fmt = (s)=> {
      s = Math.max(0, s|0);
      const h = String(Math.floor(s/3600)).padStart(2,"0");
      const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const sec = String(s%60).padStart(2,"0");
      return `${h} : ${m} : ${sec}`;
    };

    // ---------- Render crews ----------
    function renderCrews(teams){
      const root = qs("#crewList");
      if(!teams || teams.length===0){
        root.innerHTML = '<div class="pill">No crews yet.</div>'; 
        qs("#statTotal").textContent = "0";
        qs("#statActive").textContent = "0";
        qs("#statReturned").textContent = "0";
        qs("#statPenalised").textContent = "0";
        return;
      }
      const total = teams.length;
      const active = teams.filter(t => (t.status||"active")==="active").length;
      const returned = teams.filter(t => (t.status||"") === "returned" || (t.status||"")==="late").length;
      const penalised = teams.filter(t => (t.penalty||0) > 0).length;
      qs("#statTotal").textContent = total;
      qs("#statActive").textContent = active;
      qs("#statReturned").textContent = returned;
      qs("#statPenalised").textContent = penalised;

      root.innerHTML = "";
      teams.forEach(t=>{
        const div = document.createElement("div");
        div.className = "card";
        const isLate = (t.status||"")==="late";
        div.innerHTML = `
          <div class="card-top">
            <div style="font-weight:900">${t.teamName || t.teamCode}</div>
            <div class="row">
              <span class="badge badge--active">${isLate? "Returned (late)":"Active"}</span>
              <span class="badge ${t.locked? "badge--locked": "badge--active"}">${t.locked? "Locked":"Unlocked"}</span>
            </div>
          </div>
          <div class="row">
            <select data-team="${t.teamCode}">
              <option value="active" ${ (t.status||"active")==="active"?"selected":""}>Active</option>
              <option value="returned" ${ (t.status||"")==="returned"?"selected":""}>Returned</option>
            </select>
            <label class="row" style="gap:6px"><input type="checkbox" data-lock="${t.teamCode}" ${t.locked?"checked":""}/> Lock doubloons</label>
            <button class="admin-btn" data-apply="${t.teamCode}">APPLY</button>
          </div>
        `;
        root.appendChild(div);
      });

      // Bind per-card actions
      root.addEventListener("click", async (ev)=>{
        const btn = ev.target.closest("[data-apply]");
        if(!btn) return;
        const code = btn.getAttribute("data-apply");
        const sel = root.querySelector(`select[data-team="${code}"]`);
        const lock = root.querySelector(`input[data-lock="${code}"]`);
        try{
          await fetchAdmin("/.netlify/functions/admin_toggle_lock_team",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ teamCode: code, locked: !!lock.checked })
          });
          await fetchAdmin("/.netlify/functions/admin_checkin_team",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ teamCode: code, status: sel.value })
          });
          showFlash(`Updated ${code}`, false);
          await refresh();
        }catch(e){ showFlash(`Failed to update ${code}: ${e.message}`); }
      }, { once:true }); // re-bound on each render
    }

    // ---------- Loaders ----------
    async function refresh(){
      const eventId = getEventIdFromURL();
      // competition state (status/timer/results)
      try{
        const st = await fetchAdmin(`/.netlify/functions/get_event_state?eventId=${encodeURIComponent(eventId)}`);
        const status = (st.status || "not started").toLowerCase();
        qs("#status").textContent = status.replace(/\b\w/g,m=>m.toUpperCase());
        const remaining = st.secondsRemaining ?? (st.durationSeconds ?? 5400);
        qs("#timer").textContent = fmt(remaining);
        // publish button enable
        qs("#btnPublish").disabled = !!st.resultsPublished;
      }catch(e){
        qs("#status").textContent = "Failed to load current status: " + e.message.replace(/^[0-9]+ ‚Äî /,'');
      }

      // crew list
      try{
        const data = await fetchAdmin(`/.netlify/functions/admin_list_teams?eventId=${encodeURIComponent(eventId)}`);
        renderCrews(data.teams || []);
      }catch(e){
        qs("#crewList").innerHTML = `<div class="flash">Failed to load crew list: ${e.message}</div>`;
        qs("#statTotal").textContent = "0";
        qs("#statActive").textContent = "0";
        qs("#statReturned").textContent = "0";
        qs("#statPenalised").textContent = "0";
      }
    }

    // ---------- Control button handlers ----------
    function bindControls(){
      qs("#setKeyBtn").addEventListener("click", changeKey);

      qs("#btnLaunch").addEventListener("click", async ()=>{
        try{
          await fetchAdmin("/.netlify/functions/admin_start_event", { method:"POST" });
          showFlash("Adventure launched!", false);
          refresh();
        }catch(e){ showFlash("Failed to launch: " + e.message); }
      });

      qs("#btnPause").addEventListener("click", async ()=>{
        try{
          await fetchAdmin("/.netlify/functions/admin_start_event", {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ action:"pause" })
          });
          showFlash("Adventure paused.", false);
          refresh();
        }catch(e){ showFlash("Failed to pause: " + e.message); }
      });

      qs("#btnEnd").addEventListener("click", async ()=>{
        if(!confirm("End the adventure for all crews?")) return;
        try{
          await fetchAdmin("/.netlify/functions/admin_start_event", {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ action:"stop" })
          });
          showFlash("Adventure ended.", false);
          refresh();
        }catch(e){ showFlash("Failed to end: " + e.message); }
      });

      qs("#btnReset").addEventListener("click", async ()=>{
        if(!confirm("Reset the event (timer & state) and prepare for a new adventure?")) return;
        try{
          await fetchAdmin("/.netlify/functions/admin_start_event", {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ action:"reset" })
          });
          showFlash("Event reset.", false);
          refresh();
        }catch(e){ showFlash("Failed to reset: " + e.message); }
      });

      qs("#btnPublish").addEventListener("click", async ()=>{
        if(!confirm("Publish final results and unlock gallery for everyone?")) return;
        try{
          await fetchAdmin("/.netlify/functions/admin_publish_final", { method:"POST" });
          showFlash("Final results published.", false);
          refresh();
        }catch(e){ showFlash("Failed to publish: " + e.message); }
      });
    }

    // ---------- Boot ----------
    async function boot(){
      // Force admin key on first load if missing
      ensureKey(()=>{
        showFlash("Admin key is required to use the Command Centre.");
      });
      bindControls();
      await refresh();
      // refresh every 30s
      if(window.__tqInt) clearInterval(window.__tqInt);
      window.__tqInt = setInterval(refresh, 30000);
    }

    document.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>
