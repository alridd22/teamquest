<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Terry's Treasure Hunt — Command Centre</title>
  <style>
    /* ---------- Top bar (logo only) ---------- */
    .treasure-nav{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:1000;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;height:70px;padding:0 20px}
    .nav-container{max-width:1200px;margin:0 auto;display:flex;justify-content:center;align-items:center;height:100%}
    .nav-logo{text-decoration:none;transition:.3s;display:flex;align-items:center}
    .nav-logo:hover{transform:scale(1.05)}
    .nav-logo img{height:45px;width:auto;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5));transition:.3s}
    .nav-logo:hover img{filter:drop-shadow(2px 2px 8px rgba(255,215,0,.6))}
    @media (max-width:768px){.treasure-nav{height:90px}.nav-logo img{height:65px}}

    /* ---------- Base ---------- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;color:#3E2723;padding:20px 20px 40px;padding-top:90px;position:relative}
    @media (max-width:768px){body{padding:10px;padding-top:110px}}
    body::before{content:'';position:fixed;inset:0;background:
      radial-gradient(circle at 20% 20%,rgba(255,215,0,.1) 0%,transparent 50%),
      radial-gradient(circle at 80% 80%,rgba(255,140,0,.1) 0%,transparent 50%),
      url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,215,0,0.3)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,140,0,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(218,165,32,0.2)"/></svg>');pointer-events:none;z-index:0}

    .header{text-align:center;margin-bottom:30px;position:relative;z-index:1}
    .logo{font-size:2.5em;margin-bottom:8px;filter:drop-shadow(2px 2px 4px rgba(139,69,19,.3));animation:gentle-sway 3s ease-in-out infinite}
    @keyframes gentle-sway{0%,100%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}}
    h1{font-size:2.2em;font-weight:700;margin-bottom:8px;color:#2C1810;text-shadow:4px 4px 8px rgba(255,255,255,.9),2px 2px 4px rgba(255,255,255,.7),1px 1px 2px rgba(0,0,0,.9),-1px -1px 2px rgba(255,255,255,.6);line-height:1.1}
    .subtitle{color:#1A0E08;font-size:1.1em;font-weight:700;line-height:1.3;text-shadow:3px 3px 6px rgba(255,255,255,.8),1px 1px 2px rgba(255,255,255,.6),1px 1px 3px rgba(0,0,0,.8),-1px -1px 1px rgba(255,255,255,.5)}
    @media (max-width:768px){h1{font-size:1.6em}.subtitle{font-size:1em}}

    .terry-greeting{display:flex;align-items:flex-start;gap:15px;margin:20px auto 30px;background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-radius:15px;padding:20px;border:3px solid #DAA520;box-shadow:0 5px 15px rgba(139,69,19,.2);max-width:900px;position:relative;z-index:1}
    .terry-character img{width:100px;height:100px;border-radius:12px;border:3px solid #DAA520;box-shadow:0 4px 12px rgba(139,69,19,.3);object-fit:cover;background:linear-gradient(135deg,#8B4513,#A0522D);display:block}
    .terry-speech{flex:1;position:relative}
    .terry-speech::before{content:'';position:absolute;left:-12px;top:15px;border-style:solid;border-width:12px 12px 12px 0;border-color:transparent #FFD700 transparent transparent}
    .terry-note{background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);color:#8B4513;padding:18px;border-radius:12px;border:2px solid #DAA520;font-weight:500;line-height:1.5;box-shadow:0 5px 15px rgba(255,215,0,.3);font-size:.95em}

    .admin-container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:20px;position:relative;z-index:1}
    @media (max-width:1200px){.admin-container{grid-template-columns:1fr}}
    .control-panel,.crews-panel{background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border-radius:20px;padding:25px;box-shadow:0 20px 40px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.3);border:3px solid #8B4513;position:relative;overflow:hidden}
    .control-panel::before,.crews-panel::before{content:'';position:absolute;left:0;right:0;top:0;height:6px;background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}
    .control-panel::after,.crews-panel::after{content:'';position:absolute;top:12px;left:12px;right:12px;bottom:12px;border:2px solid #DAA520;border-radius:15px;pointer-events:none}

    .section-title{font-size:1.4em;margin-bottom:20px;color:#8B4513;border-bottom:3px solid #DAA520;padding-bottom:8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,.1)}

    .adventure-control{text-align:center;margin-bottom:25px}
    .timer-display{font-size:2.5em;font-weight:700;font-family:'Courier New',monospace;color:#8B4513;text-shadow:2px 2px 4px rgba(0,0,0,.3);margin-bottom:15px;padding:15px;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border-radius:12px;border:3px solid #DAA520;box-shadow:0 5px 15px rgba(255,215,0,.3);transition:.2s}
    .timer-penalty{background:linear-gradient(135deg,#DC143C 0%,#B22222 100%);color:#fff;animation:pulse-penalty 1s ease-in-out infinite;border-color:#8B0000}
    @keyframes pulse-penalty{0%,100%{transform:scale(1);box-shadow:0 5px 15px rgba(220,20,60,.4)}50%{transform:scale(1.02);box-shadow:0 8px 25px rgba(220,20,60,.6)}}

    .penalty-warning{background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);border:3px solid #DC143C;border-radius:12px;padding:15px;margin:12px 0;text-align:center;color:#8B0000;font-weight:700;box-shadow:0 5px 15px rgba(220,20,60,.3);display:none}
    .penalty-warning.show{display:block;animation:warning-pulse 2s ease-in-out infinite}
    @keyframes warning-pulse{0%,100%{opacity:1}50%{opacity:.8}}
    .adventure-status{font-size:1.1em;margin-bottom:20px;padding:12px;border-radius:10px;font-weight:600;border:2px solid}
    .status-stopped{background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);border-color:#DC143C;color:#8B0000}
    .status-running{background:linear-gradient(135deg,#98FB98 0%,#90EE90 100%);border-color:#32CD32;color:#006400}
    .status-paused{background:linear-gradient(135deg,#FFE4B5 0%,#DEB887 100%);border-color:#FF8C00;color:#8B4513}
    .status-ended{background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);border-color:#DAA520;color:#8B4513}
    .status-not-started{background:linear-gradient(135deg,#E6E6FA 0%,#D8BFD8 100%);border-color:#9370DB;color:#4B0082}

    .control-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:25px}
    .btn{padding:15px 20px;border:none;border-radius:10px;font-size:1em;font-weight:700;cursor:pointer;transition:.2s;text-transform:uppercase;letter-spacing:1px;border:3px solid #8B4513;text-shadow:1px 1px 2px rgba(0,0,0,.2);position:relative;overflow:hidden}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}
    .btn:hover::before{left:100%}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,.3)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none;background:#6c757d!important;color:#fff!important}
    .btn-start{background:linear-gradient(135deg,#32CD32,#228B22);color:#fff}
    .btn-pause{background:linear-gradient(135deg,#FFD700,#FF8C00);color:#8B4513}
    .btn-stop{background:linear-gradient(135deg,#DC143C,#B22222);color:#fff}
    .btn-reset{background:linear-gradient(135deg,#A0522D,#8B4513);color:#fff}
    .btn-publish{background:linear-gradient(135deg,#FFD700,#FFA500);color:#8B4513;font-size:1.1em;padding:18px 25px;border:4px solid #DAA520;grid-column:1/-1}

    .results-management{background:linear-gradient(135deg,#FFFACD 0%,#F0E68C 100%);border:3px solid #DAA520;border-radius:12px;padding:20px;margin-bottom:20px}
    .results-status{padding:12px;border-radius:8px;margin-bottom:12px;font-weight:600;text-align:center}
    .results-unpublished{background:linear-gradient(135deg,#FFE4B5 0%,#DEB887 100%);border:2px solid #FF8C00;color:#8B4513}
    .results-published{background:linear-gradient(135deg,#98FB98 0%,#90EE90 100%);border:2px solid #32CD32;color:#006400}
    .publish-warning{background:linear-gradient(135deg,#FFCCCB 0%,#FFA07A 100%);border:2px solid #DC143C;border-radius:8px;padding:12px;margin-bottom:12px;color:#8B0000;font-weight:600}

    .crews-grid{display:grid;gap:12px;max-height:600px;overflow-y:auto}
    .crew-card{background:linear-gradient(135deg,#FFF8DC 0%,#F5E6D3 100%);border-radius:12px;padding:15px;border:2px solid #DAA520;transition:.2s;box-shadow:0 4px 12px rgba(139,69,19,.1)}
    .crew-card:hover{background:linear-gradient(135deg,#FFE4B5 0%,#DEB887 100%);transform:translateY(-2px);box-shadow:0 6px 16px rgba(139,69,19,.2)}
    .crew-card.late{background:linear-gradient(135deg,#FFCCCB 0%,#FFA0B4 100%);border:3px solid #DC143C}
    .crew-card.returned{background:linear-gradient(135deg,#98FB98 0%,#90EE90 100%);border:3px solid #32CD32}
    .crew-card.penalized{border-left:6px solid #DC143C;background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%)}
    .crew-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:10px}
    .crew-name{font-size:1.2em;font-weight:700;color:#8B4513;display:flex;align-items:center;gap:8px;line-height:1.2;word-break:break-word}
    .crew-status-badge{padding:3px 6px;border-radius:10px;font-size:.6em;font-weight:700;text-transform:uppercase;white-space:nowrap}
    .status-active{background:#3498db;color:#fff}
    .status-returned{background:#27ae60;color:#fff}
    .status-late{background:#e74c3c;color:#fff;animation:badge 1.5s ease-in-out infinite}
    @keyframes badge{0%,100%{opacity:1}50%{opacity:.7}}
    .crew-doubloons{font-size:1.3em;color:#DAA520;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,.1);display:flex;flex-direction:column;align-items:flex-end}
    .crew-doubloons.penalized{color:#DC143C}
    .original-score{font-size:.6em;color:#999;text-decoration:line-through;margin-bottom:2px}

    .penalty-info{background:linear-gradient(135deg,#FFCCCB 0%,#FFA0B4 100%);border:2px solid #DC143C;border-radius:6px;padding:8px;margin:8px 0;font-size:.8em;color:#8B0000;font-weight:600;display:flex;align-items:center;gap:6px}
    .crew-controls{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center;margin-bottom:12px}
    .status-select{padding:8px 12px;border-radius:8px;border:2px solid #DAA520;background:linear-gradient(145deg,#fff 0%,#FFF8DC 100%);color:#8B4513;font-size:.85em;font-weight:600}
    .status-select.late{border-color:#DC143C;background:linear-gradient(145deg,#FFCCCB 0%,#FFA0B4 100%);color:#8B0000}
    .return-checkbox{display:flex;align-items:center;gap:6px;font-size:.8em;color:#8B4513;font-weight:500}

    .penalty-override{background:linear-gradient(135deg,#FFE4B5 0%,#DEB887 100%);border:2px solid #FF8C00;border-radius:8px;padding:12px;margin:8px 0;display:none;font-size:.9em}
    .penalty-override.show{display:block}
    .penalty-input{padding:6px 10px;border:2px solid #DAA520;border-radius:6px;background:#fff;color:#8B4513;font-weight:700;width:70px;text-align:center;font-size:.9em}
    .penalty-apply-btn{background:linear-gradient(135deg,#FF8C00,#FF7700);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:700;font-size:.8em}
    .penalty-apply-btn:hover{background:linear-gradient(135deg,#FF7700,#FF6600);transform:translateY(-1px)}

    .stats-overview{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin:30px auto 0;max-width:1400px}
    .stat-card{background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border-radius:12px;padding:20px;text-align:center;border:3px solid #8B4513;box-shadow:0 5px 15px rgba(139,69,19,.2);position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;left:0;right:0;top:0;height:4px;background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}
    .stat-number{font-size:1.8em;font-weight:700;color:#8B4513;text-shadow:1px 1px 2px rgba(0,0,0,.1)}
    .stat-label{font-size:.9em;color:#A0522D;margin-top:6px;font-weight:600}

    .loading{text-align:center;opacity:.8;padding:20px;color:#8B4513;font-weight:600}
    .success-message,.error-message{padding:15px;border-radius:10px;margin:15px 0;text-align:center;font-weight:600;border:2px solid}
    .success-message{background:linear-gradient(135deg,#98FB98 0%,#90EE90 100%);border-color:#32CD32;color:#006400}
    .error-message{background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);border-color:#DC143C;color:#8B0000}
  </style>
</head>
<body>
  <!-- Header -->
  <nav class="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo">
        <img src="/Team Quest Logo-01.png" alt="TeamQuest Logo" />
      </a>
    </div>
  </nav>

  <div class="header">
    <div class="logo">🏴‍☠️</div>
    <h1>Command Centre</h1>
    <p class="subtitle">Start • Pause • End • Publish • Manage Crews</p>
  </div>

  <div class="terry-greeting">
    <div class="terry-character">
      <img src="/terry-clock.png" alt="Captain Terry" />
    </div>
    <div class="terry-speech">
      <div class="terry-note">
        Keep it simple: launch the adventure, watch the clock, mark returns — late returns auto-deduct based on the configured rate.
      </div>
    </div>
  </div>

  <div class="admin-container">
    <!-- Left: controls -->
    <div class="control-panel">
      <h2 class="section-title">⚓ Adventure Control</h2>

      <div class="adventure-control">
        <div class="timer-display" id="timerDisplay">--:--:--</div>

        <div class="penalty-warning" id="penaltyWarning">
          ⚠️ Late Return Penalties Active!<br />
          <span class="penalty-rate" id="penaltyRate">Current penalty: 0 minutes = 0 doubloons</span>
        </div>

        <div class="adventure-status status-stopped" id="timerStatus">Not Started</div>

        <div class="control-buttons">
          <button class="btn btn-start" id="startBtn" onclick="startAdventure()">🚀 Launch</button>
          <button class="btn btn-pause" id="pauseBtn" onclick="pauseAdventure()" disabled>⏸️ Pause</button>
          <button class="btn btn-stop" id="stopBtn" onclick="stopAdventure()" disabled>⏹️ End</button>
          <button class="btn btn-reset" id="resetBtn" onclick="resetTimer()">🔄 Reset</button>
          <button class="btn btn-publish" id="publishBtn" onclick="publishResults()" disabled>🏆 Publish Final Results</button>
        </div>
      </div>

      <div class="results-management" id="resultsManagement">
        <h3>🏆 Final Results</h3>
        <div class="results-status results-unpublished" id="resultsStatus">🔒 Results not published</div>
        <div class="publish-warning" id="publishWarning" style="display:none;">
          Publishing reveals the leaderboard and unlocks the gallery for everyone.
        </div>
      </div>

      <div class="crews-panel emergency-controls" style="background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%);border-color:#DC143C;">
        <h3>🚨 Emergency</h3>
        <button class="btn btn-stop" onclick="emergencyStop()" style="width:100%;margin-top:12px;">⚠️ Emergency Stop</button>
      </div>

      <div class="activity-summary">
        <h3>🗺️ Activity Overview</h3>
        <div class="activity-grid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px;">
          <div class="activity-item"><div>Registration</div><div id="regCount">-</div></div>
          <div class="activity-item"><div>Treasure Map</div><div id="clueCount">-</div></div>
          <div class="activity-item"><div>Quiz</div><div id="quizCount">-</div></div>
          <div class="activity-item"><div>Kindness</div><div id="kindnessCount">-</div></div>
          <div class="activity-item"><div>Limerick</div><div id="limerickCount">-</div></div>
        </div>
      </div>
    </div>

    <!-- Right: crews -->
    <div class="crews-panel">
      <h2 class="section-title">👥 Crew Management</h2>

      <div id="loading" class="loading">🔍 Loading crews…</div>

      <div id="crewsContent" style="display:none;">
        <div class="crews-grid" id="crewsGrid"></div>
      </div>

      <div id="messages"></div>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-overview">
    <div class="stat-card"><div class="stat-number" id="totalCrews">-</div><div class="stat-label">Total Crews</div></div>
    <div class="stat-card"><div class="stat-number" id="activeCrews">-</div><div class="stat-label">Active</div></div>
    <div class="stat-card"><div class="stat-number" id="returnedCrews">-</div><div class="stat-label">Returned</div></div>
    <div class="stat-card"><div class="stat-number" id="penalizedCrews">-</div><div class="stat-label">Penalised</div></div>
  </div>

  <!-- Simple confirm modal -->
  <div id="confirmationModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border:3px solid #8B4513;border-radius:20px;padding:25px;max-width:500px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,.3);margin:15px;">
      <div style="text-align:center;">
        <h3 id="confirmTitle" style="color:#8B4513;margin-bottom:15px;font-size:1.3em;"></h3>
        <div id="confirmMessage" style="color:#8B4513;margin-bottom:20px;line-height:1.5;"></div>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
          <button onclick="cancelReturn()" class="btn" style="background:linear-gradient(135deg,#A0522D,#8B4513);color:#fff;padding:10px 16px;">Cancel</button>
          <button onclick="confirmReturn()" class="btn" style="background:linear-gradient(135deg,#32CD32,#228B22);color:#fff;padding:10px 16px;">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       Endpoint aliases (match your deployed functions)
       ========================= */
    const API = {
      state: '/.netlify/functions/get_leaderboard_function',
      leaderboard: '/.netlify/functions/get_leaderboard_function',
      control: '/.netlify/functions/start_competition_function'
    };

    /* =========================
       Global state
       ========================= */
    let adventureState = {
      backendStatus: null,
      isRunning: false,
      isPaused: false,
      timeRemaining: 90 * 60,
      startTime: null,
      crews: [],
      resultsPublished: false,
      competitionData: null,
      hasEnded: false,
      penaltyMode: false,
      penaltyMinutes: 0,
      allTeamsReturned: false
    };
    let timerInterval = null;
    let dataRefreshInterval = null;

    /* =========================
       Boot
       ========================= */
    document.addEventListener('DOMContentLoaded', () => {
      loadCurrentState();
      dataRefreshInterval = setInterval(loadCurrentState, 30000);
    });
    window.addEventListener('beforeunload', () => {
      if (timerInterval) clearInterval(timerInterval);
      if (dataRefreshInterval) clearInterval(dataRefreshInterval);
    });

    /* =========================
       Helpers
       ========================= */
    function showMessage(text, type) {
      const messagesContainer = document.getElementById('messages');
      const el = document.createElement('div');
      el.className = type === 'error' ? 'error-message' : 'success-message';
      el.textContent = text;
      messagesContainer.appendChild(el);
      setTimeout(() => { if (messagesContainer.contains(el)) messagesContainer.removeChild(el); }, 5000);
    }
    function formatTime(seconds) {
      if (seconds <= 0) return "QUEST COMPLETE!";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    /* =========================
       Fetch state & sync UI
       ========================= */
    async function loadCurrentState() {
      try {
        const r = await fetch(API.state);
        const data = await r.json();
        if (!r.ok || data.success === false) throw new Error(data.error || 'Failed to load state');

        // map fields from your leaderboard function
        adventureState.backendStatus = (data.competitionStatus || data.status || '').toString().toLowerCase();
        adventureState.resultsPublished = data.resultsPublished === true || data.resultsPublished === 'yes';
        adventureState.crews = data.teams || data.leaderboard || [];
        adventureState.competitionData = data;

        syncWithBackendState(data);
        updateTimerDisplay();
        updateButtonStates();
        updateResultsManagement();
        renderCrews(adventureState.crews);
        updateStatistics(adventureState.crews);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('crewsContent').style.display = 'block';
      } catch (e) {
        console.error(e);
        showMessage('Failed to load current status: ' + e.message, 'error');
      }
    }

    function syncWithBackendState(data) {
      const backendStatus = (data.competitionStatus || data.status || '').toString().toLowerCase().trim();
      const startIso = data.startTime || data.competitionStartTime || null;
      const durMin = Number(data.durationMinutes || data.competitionDuration || 90);

      if (!backendStatus && !startIso) {
        // Uninitialized
        adventureState.isRunning = false;
        adventureState.isPaused = false;
        adventureState.hasEnded = false;
        adventureState.timeRemaining = 90 * 60;
        adventureState.penaltyMode = false;
        adventureState.penaltyMinutes = 0;
        adventureState.allTeamsReturned = false;
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      } else if (backendStatus === 'start' || backendStatus === 'running') {
        adventureState.isRunning = true;
        adventureState.isPaused = false;
        adventureState.hasEnded = false;

        if (startIso && durMin) {
          const endMs = new Date(startIso).getTime() + durMin * 60000;
          const now = Date.now();
          const left = Math.max(0, Math.floor((endMs - now) / 1000));
          adventureState.timeRemaining = left;
          if (left <= 0) {
            adventureState.penaltyMode = true;
            adventureState.penaltyMinutes = Math.ceil((now - endMs) / 60000);
          } else {
            adventureState.penaltyMode = false;
            adventureState.penaltyMinutes = 0;
          }
          if (!timerInterval) startTimer();
        }
      } else if (backendStatus === 'stop' || backendStatus === 'stopped') {
        adventureState.isRunning = false;
        adventureState.isPaused = false;
        adventureState.hasEnded = true;
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      } else {
        adventureState.isRunning = false;
        adventureState.isPaused = false;
        adventureState.hasEnded = false;
        adventureState.timeRemaining = 90 * 60;
        adventureState.penaltyMode = false;
        adventureState.penaltyMinutes = 0;
        adventureState.allTeamsReturned = false;
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      }

      // all teams returned?
      const activeTeams = adventureState.crews.filter(c => (c.status || 'active') === 'active');
      adventureState.allTeamsReturned = activeTeams.length === 0 && adventureState.crews.length > 0;

      if (adventureState.allTeamsReturned && adventureState.penaltyMode && timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const display = document.getElementById('timerDisplay');
      const status = document.getElementById('timerStatus');
      const penaltyWarning = document.getElementById('penaltyWarning');
      const penaltyRate = document.getElementById('penaltyRate');

      if (adventureState.penaltyMode && adventureState.isRunning) {
        const secs = adventureState.penaltyMinutes * 60;
        const h = Math.floor(secs / 3600), m = Math.floor((secs % 3600) / 60), s = secs % 60;
        display.textContent = `+${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        display.className = 'timer-display timer-penalty';
        penaltyWarning.classList.add('show');
        penaltyRate.textContent = `Current penalty: ${adventureState.penaltyMinutes} minutes = ${adventureState.penaltyMinutes * 3} doubloons`;

        if (adventureState.allTeamsReturned) {
          status.innerHTML = '🏁 All Crews Returned';
          status.className = 'adventure-status status-ended';
        } else {
          status.innerHTML = '⚠️ Penalty Phase';
          status.className = 'adventure-status status-stopped';
        }
      } else {
        display.textContent = formatTime(adventureState.timeRemaining);
        display.className = 'timer-display';
        penaltyWarning.classList.remove('show');

        if (adventureState.resultsPublished) {
          status.innerHTML = '🏆 Final Results Published';
          status.className = 'adventure-status status-ended';
        } else if (adventureState.hasEnded) {
          status.innerHTML = '🏁 Adventure Complete';
          status.className = 'adventure-status status-ended';
        } else if (adventureState.isRunning && !adventureState.isPaused) {
          status.innerHTML = '🏴‍☠️ Adventure Running';
          status.className = 'adventure-status status-running';
        } else if (adventureState.isPaused) {
          status.innerHTML = '⏸️ Paused';
          status.className = 'adventure-status status-paused';
        } else {
          status.innerHTML = 'Not Started';
          status.className = 'adventure-status status-not-started';
        }
      }

      if (adventureState.timeRemaining <= 300 && adventureState.isRunning && !adventureState.penaltyMode) {
        display.style.color = '#DC143C';
      } else if (adventureState.timeRemaining <= 900 && adventureState.isRunning && !adventureState.penaltyMode) {
        display.style.color = '#FF8C00';
      } else {
        display.style.color = '#8B4513';
      }
    }

    function updateButtonStates() {
      const startBtn = document.getElementById('startBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const stopBtn = document.getElementById('stopBtn');
      const resetBtn = document.getElementById('resetBtn');

      if (adventureState.resultsPublished) {
        startBtn.disabled = true; startBtn.innerHTML = '🏆 Published';
        pauseBtn.disabled = true; stopBtn.disabled = true; resetBtn.disabled = false;
      } else if (adventureState.hasEnded || adventureState.allTeamsReturned) {
        startBtn.disabled = true; startBtn.innerHTML = '🔒 Ended';
        pauseBtn.disabled = true; stopBtn.disabled = true; stopBtn.innerHTML = '✅ Ended';
        resetBtn.disabled = false;
      } else if (adventureState.isRunning && !adventureState.isPaused) {
        startBtn.disabled = true; startBtn.innerHTML = '✅ Running';
        pauseBtn.disabled = false; stopBtn.disabled = false; stopBtn.innerHTML = '⏹️ End';
        resetBtn.disabled = true;
      } else if (adventureState.isPaused) {
        startBtn.disabled = false; startBtn.innerHTML = '▶️ Resume';
        pauseBtn.disabled = true; stopBtn.disabled = false; resetBtn.disabled = true;
      } else {
        startBtn.disabled = false; startBtn.innerHTML = '🚀 Launch';
        pauseBtn.disabled = true; stopBtn.disabled = true; resetBtn.disabled = false;
      }
    }

    function updateResultsManagement() {
      const resultsStatus = document.getElementById('resultsStatus');
      const publishBtn = document.getElementById('publishBtn');
      const publishWarning = document.getElementById('publishWarning');

      if (adventureState.resultsPublished) {
        resultsStatus.innerHTML = '🏆 Results Published';
        resultsStatus.className = 'results-status results-published';
        publishBtn.disabled = true;
        publishWarning.style.display = 'none';
      } else {
        resultsStatus.innerHTML = '🔒 Results Not Published';
        resultsStatus.className = 'results-status results-unpublished';
        const canPublish =
          adventureState.hasEnded ||
          adventureState.allTeamsReturned ||
          adventureState.timeRemaining <= 0;
        publishBtn.disabled = !canPublish;
        publishWarning.style.display = canPublish ? 'block' : 'none';
      }
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (adventureState.isRunning && !adventureState.isPaused) {
          if (adventureState.timeRemaining > 0) {
            adventureState.timeRemaining--;
            if (adventureState.timeRemaining <= 0) {
              adventureState.penaltyMode = true;
              adventureState.penaltyMinutes = 1;
              showMessage('⚠️ Time expired. Penalties active.', 'error');
            }
          } else if (adventureState.penaltyMode && !adventureState.allTeamsReturned) {
            const startMs = new Date(adventureState.competitionData.startTime).getTime();
            const endMs = startMs + (adventureState.competitionData.durationMinutes * 60000);
            adventureState.penaltyMinutes = Math.ceil((Date.now() - endMs) / 60000);
          }
          updateTimerDisplay();
          updateResultsManagement();
        }
      }, 1000);
    }

    /* =========================
       Crew list
       ========================= */
    function renderCrews(crews) {
      const container = document.getElementById('crewsGrid');
      container.innerHTML = '';

      crews.forEach(crew => {
        const totalScore = crew.totalScore || crew.total || 0;
        const teamCode = crew.teamCode || crew.code || '';
        const teamName = crew.teamName || crew.name || 'Unknown Crew';
        const status = crew.status || 'active';
        const locked = crew.locked || false;
        const penalty = crew.penalty || 0;
        const penaltyMinutes = crew.penaltyMinutes || 0;
        const adjusted = Math.max(0, totalScore - penalty);

        let classes = 'crew-card';
        if (status === 'late') classes += ' late';
        if (status === 'returned') classes += ' returned';
        if (penalty > 0) classes += ' penalized';

        const badgeClass = penalty > 0 ? 'status-late' : (status === 'returned' ? 'status-returned' : 'status-active');
        const badge = `<span class="crew-status-badge ${badgeClass}">${status === 'active' ? 'Active' : 'Returned'}</span>`;

        let penaltyHtml = '';
        if (penalty > 0) {
          penaltyHtml = `
            <div class="penalty-info">
              ⚠️ <strong>Late Penalty:</strong> -${penalty} (${penaltyMinutes}m late)
              <br><small>Original: ${totalScore} → Adjusted: ${adjusted}</small>
            </div>`;
        }

        const scoreHtml = penalty > 0
          ? `<div class="crew-doubloons penalized"><div class="original-score">${totalScore}</div>${adjusted} 🪙</div>`
          : `<div class="crew-doubloons">${totalScore} 🪙</div>`;

        const overrideHtml = (penalty > 0 && adventureState.isRunning)
          ? `<div class="penalty-override show" id="penalty-override-${teamCode}">
              <h4>Manual Penalty Override</h4>
              <div class="penalty-controls">
                <label>Penalty:</label>
                <input type="number" class="penalty-input" id="penalty-input-${teamCode}" value="${penalty}" min="0" max="999" step="3">
                <span>doubloons</span>
                <button class="penalty-apply-btn" onclick="applyManualPenalty('${teamCode}')">Apply</button>
              </div>
            </div>` : '';

        const card = document.createElement('div');
        card.className = classes;
        card.innerHTML = `
          <div class="crew-header">
            <div class="crew-name">${teamName} ${badge}</div>
            ${scoreHtml}
          </div>
          ${penaltyHtml}
          <div class="crew-controls">
            <select class="status-select ${penalty > 0 ? 'late' : ''}"
              onchange="handleStatusChange('${teamCode}', this.value, ${totalScore}, ${penalty})"
              ${!adventureState.isRunning ? 'disabled' : ''}>
              <option value="active" ${status === 'active' ? 'selected' : ''}>🏴‍☠️ Active</option>
              <option value="returned" ${status !== 'active' ? 'selected' : ''}>⚓ Returned</option>
            </select>
            <label class="return-checkbox">
              <input type="checkbox" ${locked ? 'checked' : ''} onchange="toggleCrewLock('${teamCode}', this.checked)" ${!adventureState.isRunning ? 'disabled' : ''}>
              🔒 Lock Doubloons
            </label>
          </div>
          ${overrideHtml}
          <div style="margin-top:12px;font-size:.8em;color:#8B4513;font-weight:500;">
            ${teamCode} | Reg: ${crew.registration || 0} | Map: ${crew.clueHunt || 0} | Quiz: ${crew.quiz || 0}
          </div>
        `;
        container.appendChild(card);
      });
    }

    function updateStatistics(crews) {
      const total = crews.length;
      const active = crews.filter(c => (c.status || 'active') === 'active').length;
      const returned = crews.filter(c => ['returned','late'].includes(c.status || 'active')).length;
      const penalised = crews.filter(c => (c.penalty || 0) > 0).length;

      document.getElementById('totalCrews').textContent = total;
      document.getElementById('activeCrews').textContent = active;
      document.getElementById('returnedCrews').textContent = returned;
      document.getElementById('penalizedCrews').textContent = penalised;

      document.getElementById('regCount').textContent = crews.filter(c => (c.registration || 0) > 0).length;
      document.getElementById('clueCount').textContent = crews.filter(c => (c.clueHunt || 0) > 0).length;
      document.getElementById('quizCount').textContent = crews.filter(c => (c.quiz || 0) > 0).length;
      document.getElementById('kindnessCount').textContent = crews.filter(c => (c.kindness || 0) > 0).length;
      document.getElementById('limerickCount').textContent = crews.filter(c => (c.limerick || 0) > 0).length;
    }

    /* =========================
       Status changes / controls
       ========================= */
    let pendingStatusChange = null;

    function handleStatusChange(teamCode, newStatus, currentScore, currentPenalty) {
      if (newStatus === 'returned') {
        showReturnConfirmation(teamCode, currentScore, currentPenalty);
      } else {
        updateCrewStatus(teamCode, newStatus);
      }
    }

    function showReturnConfirmation(teamCode, currentScore, currentPenalty) {
      const team = adventureState.crews.find(c => (c.teamCode || c.code) === teamCode);
      const teamName = team ? (team.teamName || team.name) : teamCode;

      let penalty = currentPenalty || 0;
      let isLate = false;
      if (adventureState.penaltyMode && adventureState.penaltyMinutes > 0) {
        penalty = adventureState.penaltyMinutes * 3;
        isLate = true;
      }
      const adjusted = Math.max(0, currentScore - penalty);

      pendingStatusChange = { teamCode, teamName, status:'returned', originalScore: currentScore, penalty, adjustedScore: adjusted, isLateReturn: isLate };

      const title = document.getElementById('confirmTitle');
      const msg = document.getElementById('confirmMessage');

      if (isLate) {
        title.textContent = '⚠️ Confirm Late Team Return';
        msg.innerHTML = `Original: <strong>${currentScore}</strong><br>Penalty: <strong>-${penalty}</strong><br>Final: <strong>${adjusted}</strong><br><br><em>Doubloons will be frozen.</em>`;
      } else {
        title.textContent = 'Confirm Team Return';
        msg.innerHTML = `Final score: <strong>${currentScore}</strong><br><br><em>Doubloons will be frozen.</em>`;
      }

      document.getElementById('confirmationModal').style.display = 'flex';
    }
    function confirmReturn() {
      if (!pendingStatusChange) return;
      const { teamCode, status, penalty } = pendingStatusChange;
      document.getElementById('confirmationModal').style.display = 'none';
      updateCrewStatus(teamCode, status, penalty);
      pendingStatusChange = null;
    }
    function cancelReturn() {
      document.getElementById('confirmationModal').style.display = 'none';
      pendingStatusChange = null;
      loadCurrentState();
    }

    async function updateCrewStatus(teamCode, newStatus, customPenalty = null) {
      try {
        let penalty = 0;
        let finalStatus = newStatus;
        if (newStatus === 'returned' && adventureState.penaltyMode && adventureState.penaltyMinutes > 0) {
          penalty = customPenalty != null ? customPenalty : adventureState.penaltyMinutes * 3;
          finalStatus = 'late';
        }

        const r = await fetch(API.control, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'update_team_status',
            teamCode,
            status: finalStatus,
            penalty,
            returnTime: new Date().toISOString(),
            penaltyMinutes: adventureState.penaltyMinutes || 0
          })
        });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || 'Update failed');

        await loadCurrentState();
        if (penalty > 0) showMessage(`${teamCode} returned late. -${penalty} applied.`, 'error');
        else showMessage(`${teamCode} returned. Doubloons frozen.`, 'success');
      } catch (e) {
        console.error(e);
        showMessage('Failed to update crew: ' + e.message, 'error');
      }
    }

    async function applyManualPenalty(teamCode) {
      const input = document.getElementById(`penalty-input-${teamCode}`);
      const customPenalty = parseInt(input.value) || 0;
      try {
        const r = await fetch(API.control, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'update_team_status',
            teamCode,
            status: customPenalty > 0 ? 'late' : 'returned',
            penalty: customPenalty,
            returnTime: new Date().toISOString(),
            penaltyMinutes: Math.ceil(customPenalty / 3)
          })
        });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || 'Penalty update failed');
        await loadCurrentState();
        showMessage(`Manual penalty applied to ${teamCode}: -${customPenalty}`, 'success');
      } catch (e) {
        console.error(e);
        showMessage('Failed to apply manual penalty: ' + e.message, 'error');
      }
    }

    function toggleCrewLock(teamCode, isLocked) {
      // Visual only in this UI; locking of score is handled by status/return in backend.
      showMessage(`Crew ${teamCode} ${isLocked ? 'locked' : 'unlocked'}.`, 'success');
    }

    /* =========================
       Control actions
       ========================= */
    async function startAdventure() {
      try {
        const r = await fetch(API.control, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'start' })
        });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || 'Start failed');
        showMessage('🚀 Adventure launched!', 'success');
        setTimeout(loadCurrentState, 800);
      } catch (e) {
        console.error(e);
        showMessage('Failed to launch: ' + e.message, 'error');
      }
    }

    async function pauseAdventure() {
      try {
        const r = await fetch(API.control, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'stop' })
        });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || 'Pause failed');
        showMessage('⏸️ Adventure paused.', 'success');
        setTimeout(loadCurrentState, 500);
      } catch (e) {
        console.error(e);
        showMessage('Failed to pause: ' + e.message, 'error');
      }
    }

    async function stopAdventure() {
      try {
        const r = await fetch(API.control, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'stop' })
        });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || 'Stop failed');
        showMessage('⚓ Adventure ended.', 'success');
        setTimeout(loadCurrentState, 500);
      } catch (e) {
        console.error(e);
        showMessage('Failed to end: ' + e.message, 'error');
      }
    }

    async function resetTimer() {
      if (!confirm('Reset competition and prepare for a new adventure?')) return;
      try {
        const r = await fetch(API.control, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'reset' })
        });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || 'Reset failed');
        showMessage('🔄 Timer reset.', 'success');
        setTimeout(loadCurrentState, 500);
      } catch (e) {
        console.error(e);
        showMessage('Failed to reset: ' + e.message, 'error');
      }
    }

    async function publishResults() {
      if (!confirm('Publish final results and unlock gallery?')) return;
      try {
        const r = await fetch(API.control, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'publish_results' })
        });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || 'Publish failed');
        showMessage('🏆 Results published!', 'success');
        setTimeout(loadCurrentState, 800);
      } catch (e) {
        console.error(e);
        showMessage('Failed to publish: ' + e.message, 'error');
      }
    }

    function emergencyStop() {
      if (!confirm('Emergency stop the entire treasure hunt?')) return;
      stopAdventure();
      showMessage('🚨 EMERGENCY STOP activated.', 'error');
    }
  </script>
</body>
</html>
