<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terry‚Äôs Treasure Hunt ‚Äì Command Centre</title>
  <style>
    :root{
      --brown:#8B4513;--brown-2:#6c2f0e;--gold:#DAA520;--gold-2:#FFD700;--sand:#F5E6D3;--sand-2:#E8D7C3;--ink:#2C1810;
      --ok:#27ae60;--warn:#ff8c00;--stop:#dc143c;--muted:#b7a99a;
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,#8B4513 0%,#D2691E 35%,#F4A460 100%); color:#3E2723; min-height:100vh}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    .brand{display:flex;justify-content:center;margin-bottom:14px}
    .brand img{height:40px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.5))}
    .note{display:flex;gap:14px;align-items:center;background:linear-gradient(135deg,#ffdb74,#ffc63f);
      border:3px solid var(--gold); border-radius:14px; padding:14px 16px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .note .thumb{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#8B4513,#A0522D);border:3px solid var(--gold)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{background:linear-gradient(145deg,var(--sand),var(--sand-2)); border:3px solid var(--brown);
      border-radius:16px; box-shadow:0 14px 28px rgba(0,0,0,.25); overflow:hidden}
    .panel h2{margin:0;padding:12px 16px;font-size:1.05rem;border-bottom:2px solid rgba(0,0,0,.08);
      background:linear-gradient(135deg,#fff8dc,#f6e7cf)}
    .timer{background:linear-gradient(135deg,#ffc21d,#ffad00); margin:14px; padding:18px; border-radius:12px;
      text-align:center; font:700 34px/1.1 ui-monospace,Consolas,Menlo,monospace; border:3px solid var(--gold)}
    .status{margin:0 14px 14px; padding:12px; border-radius:10px; text-align:center; font-weight:700; border:2px solid}
    .status.stopped{background:#ffe0ea;border-color:#dc143c;color:#8b0000}
    .status.running{background:#e5ffe7;border-color:#27ae60;color:#0c6b2a}
    .status.ready{background:#efe8ff;border-color:#7a5afd;color:#2b1c6e}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:0 14px 14px}
    .btn{padding:14px 16px;border-radius:12px;border:3px solid var(--brown);font-weight:800;text-transform:uppercase;
      letter-spacing:.5px;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.15); display:flex;justify-content:center;gap:8px}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.start{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff}
    .btn.pause{background:linear-gradient(135deg,#ffd166,#ffb703)}
    .btn.stop{background:linear-gradient(135deg,#ff6b6b,#dc143c);color:#fff}
    .btn.reset{background:linear-gradient(135deg,#8B4513,#5a3212);color:#fff}
    .btn.publish{grid-column:1/-1;background:linear-gradient(135deg,#ffd700,#f7c52a);border-color:#b8860b}
    .badge{display:inline-flex;gap:8px;align-items:center;background:#fff3cd;border:2px solid #b8860b;border-radius:10px;padding:8px 12px;margin:10px 14px;font-weight:700}
    /* crews list */
    .crew-wrap{padding:14px}
    .msg{background:#ffe6e8;border:2px solid #dc143c;color:#8b0000;border-radius:10px;padding:12px;font-weight:700}
    .crew{border:2px solid var(--gold); background:linear-gradient(135deg,#fff8dc,#f7ecd2); border-radius:12px; padding:12px; margin:10px 0}
    .crew .row{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .crew .name{font-weight:900;color:var(--brown);font-size:1.05rem}
    .crew .right{display:flex;gap:8px;align-items:center}
    .pill{padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:800}
    .pill.green{background:#27ae60;color:#fff}
    .pill.red{background:#dc143c;color:#fff}
    .small{font-size:.85rem;color:#5a432f}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    select,input[type="number"]{padding:8px 10px;border:2px solid var(--gold);border-radius:10px;background:#fff}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:16px 0}
    @media (max-width:900px){.stats{grid-template-columns:repeat(2,1fr)}}
    .card{background:linear-gradient(145deg,var(--sand),var(--sand-2)); border:3px solid var(--brown);
      border-radius:14px; padding:18px; text-align:center; box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .card .n{font-size:28px;font-weight:900;color:var(--brown)}
    .keybox{margin-left:auto}
    .keybox button{padding:8px 10px;border-radius:10px;border:2px solid var(--gold);background:#fff8dc;font-weight:800;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="/Team Quest Logo-01.png" alt="TeamQuest" />
    </div>

    <div class="note">
      <div class="thumb"></div>
      <div>
        <div style="font-weight:900;margin-bottom:4px">Command Centre</div>
        <div>Keep it simple: launch the adventure, watch the clock, mark returns ‚Äî late returns auto-deduct based on the configured rate.</div>
      </div>
      <div class="keybox">
        <div class="small" id="keyState">Admin key: <strong>unknown</strong></div>
        <div style="text-align:right;margin-top:6px">
          <button id="setKeyBtn">Set / Change</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Controls -->
      <div class="panel">
        <h2>‚öì Adventure Control</h2>
        <div class="timer" id="timerText">01:30:00</div>
        <div class="status ready" id="statusText">Not started</div>

        <div class="controls">
          <button class="btn start"  id="btnStart">üöÄ Launch</button>
          <button class="btn pause"  id="btnPause" disabled>‚è∏Ô∏è Pause</button>
          <button class="btn stop"   id="btnStop"  disabled>‚èπÔ∏è End</button>
          <button class="btn reset"  id="btnReset">üîÑ Reset</button>
          <button class="btn publish" id="btnPublish" disabled>üèÜ Publish Final Results</button>
        </div>

        <div class="badge">üîí <span id="resultsState">Results not published</span></div>
      </div>

      <!-- RIGHT: Crews -->
      <div class="panel">
        <h2>üë• Crew Management</h2>
        <div class="crew-wrap" id="crewWrap">
          <div class="small">üîç Loading crews‚Ä¶</div>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="card"><div class="n" id="statTotal">0</div><div>Total Crews</div></div>
      <div class="card"><div class="n" id="statActive">0</div><div>Active</div></div>
      <div class="card"><div class="n" id="statReturned">0</div><div>Returned</div></div>
      <div class="card"><div class="n" id="statPenalised">0</div><div>Penalised</div></div>
    </div>
  </div>

  <script>
    // ===== Config / helpers =====
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event') || 'EVT-19-08-2025';
    const LS_KEY = 'tq_admin_secret';

    const endpoints = {
      state:           (eventId) => `/.netlify/functions/get_event_state?eventId=${encodeURIComponent(eventId)}`,
      listTeams:       (eventId) => `/.netlify/functions/admin_list_teams?eventId=${encodeURIComponent(eventId)}`,
      startEvent:      `/.netlify/functions/admin_start_event`,
      checkinTeam:     `/.netlify/functions/admin_checkin_team`,
      toggleLock:      `/.netlify/functions/admin_toggle_lock_team`,
      publish:         `/.netlify/functions/admin_publish_final`,
    };

    function adminKey() { return localStorage.getItem(LS_KEY) || ''; }
    function setAdminKey(key){ localStorage.setItem(LS_KEY, key); paintKeyState(); }
    function ensureKey(){
      if (!adminKey()) {
        const k = prompt('Enter Admin Secret (used by requireAdmin):') || '';
        if (k) setAdminKey(k);
      }
    }
    function authHeaders(){
      return { 'x-tq-admin': adminKey() };   // <‚Äî this matches requireAdmin(event)
    }
    function paintKeyState(){
      const el = document.getElementById('keyState');
      el.innerHTML = `Admin key: <strong>${adminKey() ? 'set' : 'not set'}</strong>`;
    }

    document.getElementById('setKeyBtn').addEventListener('click', () => {
      const v = prompt('Enter Admin Secret (used by requireAdmin):', adminKey() || '');
      if (v !== null) setAdminKey(v.trim());
      loadAll(); // try again with new key
    });

    // ===== UI elements =====
    const timerEl   = document.getElementById('timerText');
    const statusEl  = document.getElementById('statusText');
    const resultsEl = document.getElementById('resultsState');
    const crewWrap  = document.getElementById('crewWrap');

    const btnStart   = document.getElementById('btnStart');
    const btnPause   = document.getElementById('btnPause');
    const btnStop    = document.getElementById('btnStop');
    const btnReset   = document.getElementById('btnReset');
    const btnPublish = document.getElementById('btnPublish');

    // Stats
    const statTotal      = document.getElementById('statTotal');
    const statActive     = document.getElementById('statActive');
    const statReturned   = document.getElementById('statReturned');
    const statPenalised  = document.getElementById('statPenalised');

    // ===== Data refresh =====
    async function loadState(){
      try{
        const res = await fetch(endpoints.state(EVENT_ID), { headers: authHeaders() });
        if (!res.ok) throw new Error(`${res.status}`);
        const data = await res.json(); // { success, ... }
        if (!data.success) throw new Error(data.message || 'state error');

        // paint timer/status/results
        // expected fields: startTime, durationMinutes, competitionStatus, resultsPublished
        const st = data.startTime ? new Date(data.startTime) : null;
        const durMs = (data.durationMinutes || 90) * 60 * 1000;
        const status = (data.competitionStatus || 'not_started').toLowerCase();
        const resultsPublished = !!data.resultsPublished;

        if (st){
          const end = new Date(st.getTime() + durMs);
          updateTimer(end, status);
        } else {
          timerEl.textContent = '01:30:00';
        }

        // status pill
        statusEl.className = 'status ' + (status==='start' || status==='running' ? 'running' :
                           status==='stop' || status==='stopped' ? 'stopped' : 'ready');
        statusEl.textContent =
          status==='running' || status==='start' ? 'Adventure in progress' :
          status==='stopped' || status==='stop' ? 'Ended' : 'Not started';

        // results
        resultsEl.textContent = resultsPublished ? 'Results published' : 'Results not published';
        btnPublish.disabled = resultsPublished;

        // buttons
        btnStart.disabled = status==='running' || resultsPublished;
        btnPause.disabled = !(status==='running');
        btnStop.disabled  = !(status==='running');
        btnReset.disabled = status==='running';

      }catch(e){
        console.error('loadState', e);
        statusEl.className='status stopped';
        statusEl.textContent='Status unavailable';
      }
    }

    function updateTimer(endTime, status){
      if (!endTime || (status!=='running' && status!=='start')) { timerEl.textContent = '01:30:00'; return; }
      const tick = () => {
        const now = new Date();
        let ms = endTime - now;
        const sign = ms < 0 ? '-' : '';
        ms = Math.abs(ms);
        const h = String(Math.floor(ms / 36e5)).padStart(2,'0');
        const m = String(Math.floor((ms%36e5)/6e4)).padStart(2,'0');
        const s = String(Math.floor((ms%6e4)/1e3)).padStart(2,'0');
        timerEl.textContent = (sign==='' ? '' : '+') + `${h}:${m}:${s}`;
      };
      tick();
      clearInterval(window.__tqTimer);
      window.__tqTimer = setInterval(tick, 1000);
    }

    async function loadCrews(){
      try{
        const res = await fetch(endpoints.listTeams(EVENT_ID), { headers: authHeaders() });
        if (!res.ok){
          const body = await res.text().catch(()=> '');
          throw new Error(`Failed to load crew list: ${res.status} ‚Äî ${body||''}`);
        }
        const data = await res.json(); // { success:true, teams:[...] }
        const teams = (data.teams || []).map(t => ({
          teamCode: t.teamCode,
          teamName: t.teamName || t.teamCode,
          locked: !!t.locked,
          returnedAt: t.returnedAt || null
        }));

        renderCrews(teams);
        paintStats(teams);
      }catch(e){
        console.error(e);
        crewWrap.innerHTML = `<div class="msg">${e.message || 'Failed to load crew list'}</div>`;
        paintStats([]);
      }
    }

    function renderCrews(teams){
      if (!teams.length){
        crewWrap.innerHTML = `<div class="small">No crews yet.</div>`;
        return;
      }
      crewWrap.innerHTML = teams.map(t => {
        const statusPill = t.returnedAt
          ? `<span class="pill green">Returned</span>`
          : `<span class="pill" style="background:#3498db;color:#fff">Active</span>`;
        const lockPill = t.locked
          ? `<span class="pill red">Locked</span>`
          : `<span class="pill" style="background:#e3e1da">Unlocked</span>`;
        return `
          <div class="crew" data-code="${t.teamCode}">
            <div class="row">
              <div class="name">${escapeHtml(t.teamName)}</div>
              <div class="right">${statusPill}${lockPill}</div>
            </div>
            <div class="small">${t.teamCode} ${t.returnedAt ? `‚Ä¢ Returned: ${new Date(t.returnedAt).toLocaleTimeString()}`:''}</div>
            <div class="toolbar">
              <select class="statusSel">
                <option value="active" ${!t.returnedAt?'selected':''}>Active</option>
                <option value="returned" ${t.returnedAt?'selected':''}>Returned</option>
              </select>
              <label class="small">
                <input type="checkbox" class="lockChk" ${t.locked?'checked':''}/> Lock doubloons
              </label>
              <button class="btn reset smallBtn applyBtn" style="padding:8px 12px">Apply</button>
            </div>
          </div>`;
      }).join('');

      // bind actions
      crewWrap.querySelectorAll('.crew').forEach(card => {
        const code = card.dataset.code;
        const sel  = card.querySelector('.statusSel');
        const lock = card.querySelector('.lockChk');
        const apply= card.querySelector('.applyBtn');

        apply.addEventListener('click', async () => {
          try {
            // lock toggle first (independent)
            await fetch(endpoints.toggleLock, {
              method:'POST',
              headers: { 'Content-Type':'application/json', ...authHeaders() },
              body: JSON.stringify({ eventId: EVENT_ID, teamCode: code, locked: !!lock.checked })
            });

            // status update
            const statusVal = sel.value; // 'active' | 'returned'
            await fetch(endpoints.checkinTeam, {
              method:'POST',
              headers: { 'Content-Type':'application/json', ...authHeaders() },
              body: JSON.stringify({
                eventId: EVENT_ID,
                teamCode: code,
                status: statusVal,
                returnTime: statusVal==='returned' ? new Date().toISOString() : null
              })
            });
            await loadCrews();
          } catch(err){
            alert('Failed to update team: ' + (err?.message || err));
          }
        });
      });
    }

    function paintStats(teams){
      statTotal.textContent = teams.length;
      const returned = teams.filter(t=>!!t.returnedAt).length;
      const active = teams.length - returned;
      statActive.textContent = active;
      statReturned.textContent = returned;
      // penalised is not in this list call; set to 0 for now
      statPenalised.textContent = 0;
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

    // ===== Actions =====
    btnStart.addEventListener('click', async ()=>{
      ensureKey();
      await actionPost(endpoints.startEvent, { action:'start', eventId: EVENT_ID });
      await loadAll();
    });
    btnPause.addEventListener('click', async ()=>{
      await actionPost(endpoints.startEvent, { action:'stop', eventId: EVENT_ID });
      await loadAll();
    });
    btnStop.addEventListener('click', async ()=>{
      await actionPost(endpoints.startEvent, { action:'stop', eventId: EVENT_ID });
      await loadAll();
    });
    btnReset.addEventListener('click', async ()=>{
      if(!confirm('Reset competition?')) return;
      await actionPost(endpoints.startEvent, { action:'reset', eventId: EVENT_ID });
      await loadAll();
    });
    btnPublish.addEventListener('click', async ()=>{
      if(!confirm('Publish final results?')) return;
      await actionPost(endpoints.publish, { eventId: EVENT_ID });
      await loadAll();
    });

    async function actionPost(url, body){
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', ...authHeaders() },
        body: JSON.stringify(body || {})
      });
      if (!res.ok){
        const t = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status}: ${t || res.statusText}`);
      }
      return res.json().catch(()=> ({}));
    }

    async function loadAll(){
      paintKeyState();
      await Promise.all([ loadState(), loadCrews() ]);
    }

    // boot
    (async function init(){
      paintKeyState();
      if (!adminKey()){
        // gentle prompt on first load
        setTimeout(()=>ensureKey(), 100);
      }
      await loadAll();
      // poll periodically
      clearInterval(window.__tqPoll);
      window.__tqPoll = setInterval(loadAll, 30000);
    })();
  </script>
</body>
</html>
