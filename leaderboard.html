<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TeamQuest ‚Äî Leaderboard</title>
  <style>
    /* ‚Äî‚Äî‚Äî NAV ‚Äî‚Äî‚Äî */
    .nav{position:fixed;inset:auto 0 0 0;top:0;height:72px;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:10}
    .nav .wrap{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:18px;height:100%;padding:0 16px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    .brand img{height:48px;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5))}
    .links{display:flex;gap:10px;margin-left:auto}
    .links a{color:#F5DEB3;text-decoration:none;font-weight:700;padding:10px 14px;border-radius:10px;background:rgba(101,67,33,.35);border:2px solid rgba(218,165,32,.4)}
    .links a:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff;border-color:#DAA520}

    /* ‚Äî‚Äî‚Äî PAGE ‚Äî‚Äî‚Äî */
    :root{--card:#f6eee0;--ink:#432;--gold:#DAA520;--soft:#ffe9c7}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Tahoma,Arial,sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;padding:100px 16px 24px;color:var(--ink)}
    .shell{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:3px solid #8B4513;border-radius:22px;padding:18px 18px 8px;box-shadow:0 16px 32px rgba(0,0,0,.18)}
    .card h1{margin:6px 0 6px;text-align:center;font-size:32px}
    .sub{margin:0 0 12px;text-align:center;color:#7a5737}
    .toolbar{display:flex;align-items:center;gap:12px;justify-content:center;flex-wrap:wrap;margin:6px 0 16px}
    .chip{display:inline-flex;align-items:center;gap:8px;font-weight:800;border:2px dashed var(--gold);background:#fff3d9;border-radius:999px;padding:8px 14px}
    .ghost{opacity:.6}
    .btn{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:2px solid #8B4513;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .note{background:linear-gradient(135deg,#FFF8DC,#F5E6D3);border:2px solid var(--gold);border-left:6px solid #FF8C00;border-radius:12px;padding:14px;margin:10px 0;font-weight:700;text-align:center}
    .hidden{display:none !important}
    .muted{color:#7a5737;font-weight:600}
    .last-upd{margin:12px 2px 18px}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:6px}
    thead th{position:sticky;top:0;background:var(--soft);border-top:2px solid var(--gold);border-bottom:2px solid var(--gold);padding:10px 8px;font-size:14px}
    tbody td{padding:10px 8px;border-bottom:1px solid #e8d7c3}
    tbody tr:nth-child(odd){background:#fffdf8}
    .rank{font-weight:900;text-align:center;width:70px}
    .team{font-weight:800}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .total{background:linear-gradient(180deg,#fff,#ffefd8)}
    @media (max-width:760px){.links{display:none}}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="wrap">
      <a class="brand" href="https://theteamquest.netlify.app/">
        <img src="/Team Quest Logo-01.png" alt="TeamQuest">
      </a>
      <div class="links">
        <a href="https://theteamquest.netlify.app/clue_hunt_challenge">üíé Treasure Hunt</a>
        <a href="https://theteamquest.netlify.app/scavenger_hunt">üîç Scavenger</a>
        <a href="https://theteamquest.netlify.app/quiz_challenge">‚è∞ Timed Quiz</a>
        <a href="https://theteamquest.netlify.app/kindness_challenge_page">‚ù§Ô∏è Kindness</a>
        <a href="https://theteamquest.netlify.app/limerick_challenge_page">üìù Limerick</a>
        <a href="https://theteamquest.netlify.app/teamquest_gallery">üì∏ Gallery</a>
      </div>
    </div>
  </nav>

  <main class="shell">
    <section class="card">
      <h1>TeamQuest Leaderboard</h1>
      <p class="sub">Live standings with activity breakdown</p>

      <div class="toolbar">
        <div id="statusChip" class="chip">Checking event‚Ä¶</div>
        <div id="countChip" class="chip ghost hidden">‚è≥ <span id="countLabel">Time remaining</span>: <span id="countdown">‚Äî:‚Äî</span></div>
        <button class="btn" id="refreshBtn">üîÑ Refresh</button>
      </div>

      <div id="hideNotice" class="note hidden">‚è≥ Final 15 minutes ‚Äî live scores are hidden. Keep playing! The countdown above shows time left.</div>
      <div id="postEventNotice" class="note hidden">üï∞ Event complete ‚Äî final results will appear once the host publishes them.</div>

      <div id="tableWrap">
        <table id="board" aria-live="polite"></table>
      </div>

      <div class="last-upd muted" id="lastUpd">Last updated ‚Äî</div>
    </section>
  </main>

  <script>
    /* =============== Inputs & helpers =============== */
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event') || qs.get('eventId') || '';

    function fmtTime(ts){ return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
    function toInt(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function pick(obj, keys){
      for(const k of keys){
        if (obj && Object.prototype.hasOwnProperty.call(obj,k)) return obj[k];
        const hit = Object.keys(obj||{}).find(x=>x.toLowerCase()===String(k).toLowerCase());
        if(hit) return obj[hit];
      }
      return undefined;
    }
    async function callFn(path, payload){
      const res = await fetch(`/.netlify/functions/${path}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload || {})
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok || data.success === false) throw new Error(data.message || `Request failed (${res.status})`);
      return data;
    }

    /* =============== Event state (safe POST) =============== */
    const statusChip = document.getElementById('statusChip');
    const countChip  = document.getElementById('countChip');
    const countdownEl= document.getElementById('countdown');
    const countLabel = document.getElementById('countLabel');
    const hideNotice = document.getElementById('hideNotice');
    const postEvent  = document.getElementById('postEventNotice');

    let countdownTimer = null;
    let eventMeta = {state:'UNKNOWN', nowMs:Date.now(), endMs:null, remaining:null};

    function parseEventMeta(data){
      const state   = String(pick(data,['state','status'])||'UNKNOWN');
      const nowMs   = Date.parse(pick(data,['now','serverTime','serverNow'])||new Date());
      const endStr  = pick(data,['endAt','endTime','endsAt']);
      const startStr= pick(data,['startAt','startTime','startsAt']);
      const endMs   = endStr ? Date.parse(endStr) : null;
      const remaining = pick(data,['remainingSeconds','secondsRemaining','remaining']);
      const rem = (remaining==null && endMs) ? Math.max(0, Math.round((endMs - nowMs)/1000)) : toInt(remaining);
      return {state, nowMs, endMs, startMs: startStr?Date.parse(startStr):null, remaining: isNaN(rem)?null:rem};
    }
    function updateStatusUI(){
      const s = eventMeta.state, rem = eventMeta.remaining;
      statusChip.textContent =
        s==='NOT_STARTED' ? 'Event not started' :
        s==='RUNNING'     ? 'Event running' :
        s==='PAUSED'      ? 'Event paused' :
        s==='ENDED'       ? 'Event ended' :
        s==='PUBLISHED'   ? 'Results published' : 'Event status unknown';

      if(typeof rem === 'number'){
        countChip.classList.remove('hidden');
        if(countdownTimer) clearInterval(countdownTimer);
        const anchor = Date.now();
        countdownTimer = setInterval(()=> {
          const elapsed = Math.round((Date.now() - anchor)/1000);
          const left = Math.max(0, rem - elapsed);
          const m = String(Math.floor(left/60)).padStart(2,'0');
          const s2= String(left%60).padStart(2,'0');
          countdownEl.textContent = `${m}:${s2}`;
        }, 1000);
      }else{
        countChip.classList.add('hidden');
        if(countdownTimer) clearInterval(countdownTimer);
      }

      const hide = (s==='RUNNING' && typeof rem==='number' && rem<=15*60 && rem>0);
      hideNotice.classList.toggle('hidden', !hide);
      postEvent.classList.toggle('hidden', !( (typeof rem==='number' && rem===0) || s==='ENDED' ));
      countLabel.textContent = s==='RUNNING' ? 'Time remaining' : (s==='NOT_STARTED' ? 'Starts in' : 'Time');
    }
    async function getEventStateSafe(){
      if(!EVENT_ID) return {state:'UNKNOWN'};
      try{
        const data = await callFn('get_event_state',{eventId:EVENT_ID});
        eventMeta = parseEventMeta(data);
        updateStatusUI();
        return eventMeta;
      }catch{
        statusChip.textContent = 'Showing latest scores (event unknown)';
        countChip.classList.add('hidden');
        return {state:'UNKNOWN'};
      }
    }

    /* =============== Leaderboard with robust breakdown =============== */
    const board = document.getElementById('board');
    const lastUpd = document.getElementById('lastUpd');

    const ALIAS = {
      kind:'kindness', kind_act:'kindness', kindness:'kindness',
      poem:'limerick', verse:'limerick', limerick:'limerick',
      scav:'scavenger', scavenger:'scavenger', scavenger_hunt:'scavenger',
      clue:'cluehunt', clues:'cluehunt', cluehunt:'cluehunt', hunt:'cluehunt',
      quiz:'quiz', quizscore:'quiz'
    };
    const LABEL = {
      kindness:'‚ù§Ô∏è Kindness',
      limerick:'üìù Limerick',
      scavenger:'üîç Scavenger',
      cluehunt:'üíé Clue Hunt',
      quiz:'‚è∞ Quiz'
    };
    function normaliseKey(k){
      const key = String(k||'').toLowerCase().replace(/[\s\-]/g,'');
      return ALIAS[key] || key;
    }
    function titleFor(key){
      if(LABEL[key]) return LABEL[key];
      // Title Case for unknown keys
      return key.replace(/[_\-]/g,' ').replace(/\b\w/g,m=>m.toUpperCase());
    }
    function extractBreakdown(row){
      const add = (bag,k,v)=>{ if(k==null) return; const kk = normaliseKey(k); const val = toInt(v); bag[kk] = (bag[kk]||0) + (Number.isFinite(val)?val:0); };
      const parts = {};

      // 1) nested object under common names
      const obj = pick(row, ['breakdown','components','byActivity','activityBreakdown','parts','scores']);
      if(obj && typeof obj==='object' && !Array.isArray(obj)){
        Object.entries(obj).forEach(([k,v])=> add(parts,k,v));
      }

      // 2) array shapes like [{activity:'kindness', score:25}, {type:'quiz', points:10}]
      const arr = pick(row,['activityScores','activities','scoresArray','activity_points']);
      if(Array.isArray(arr)){
        arr.forEach(it=> add(parts, (it.activity||it.type||it.name||it.key), (it.score||it.points||it.value)));
      }

      // 3) tolerant top-level fallbacks
      Object.keys(row||{}).forEach(k=>{
        if(['team','teamname','teamcode','name','code','total','score','points'].includes(k.toLowerCase())) return;
        const kk = normaliseKey(k);
        if(['kindness','limerick','scavenger','cluehunt','quiz'].includes(kk)){
          add(parts, kk, row[k]);
        }
      });

      return parts;
    }

    function normaliseTeams(raw){
      const rows = raw?.teams || raw?.leaderboard || raw?.rows || [];
      return rows.map(item=>{
        const name = pick(item,['teamName','name']) || '';
        const code = pick(item,['teamCode','code','teamId']) || '';
        const parts = extractBreakdown(item);
        let total = toInt(pick(item,['total','score','points']));
        if(!total){
          total = Object.values(parts).reduce((a,b)=>a+toInt(b),0);
        }
        return {name, code, parts, total};
      });
    }

    function computeColumnKeys(teams){
      const set = new Set();
      teams.forEach(t => Object.keys(t.parts).forEach(k => set.add(k)));
      // stable preferred order, then any extras alphabetically
      const preferred = ['kindness','limerick','scavenger','cluehunt','quiz'];
      const extras = [...set].filter(k=>!preferred.includes(k)).sort();
      const keys = preferred.filter(k=>set.has(k)).concat(extras);
      return keys;
    }

    function renderTable(teams){
      if(!Array.isArray(teams) || !teams.length){
        board.innerHTML = '<tbody><tr><td class="muted">No teams yet.</td></tr></tbody>';
        return;
      }
      teams.sort((a,b)=> b.total - a.total || (a.name||a.code).localeCompare(b.name||b.code));

      const cols = computeColumnKeys(teams);

      let thead = `<thead><tr>
        <th class="rank">#</th>
        <th>Team</th>
        ${cols.map(k=>`<th class="num">${titleFor(k)}</th>`).join('')}
        <th class="num total">üèÜ Total</th>
      </tr></thead>`;

      const rows = teams.map((t,i)=>`
        <tr>
          <td class="rank">${i+1}</td>
          <td class="team">${t.name || t.code}</td>
          ${cols.map(k=>`<td class="num">${toInt(t.parts[k]||0)}</td>`).join('')}
          <td class="num total"><strong>${t.total}</strong></td>
        </tr>`).join('');

      board.innerHTML = thead + `<tbody>${rows}</tbody>`;
    }

    async function loadLeaderboard(){
      try{
        const data = await callFn('get_leaderboard', { eventId: EVENT_ID });
        const teams = normaliseTeams(data);
        renderTable(teams);
        document.getElementById('lastUpd').textContent = `Last updated ‚Äî ${fmtTime(Date.now())}`;
      }catch(e){
        console.error('Leaderboard load failed', e);
        board.innerHTML = `<tbody><tr><td class="muted">Couldn‚Äôt load leaderboard.</td></tr></tbody>`;
      }
    }

    /* =============== Visibility rules (15-minute hide) =============== */
    function applyVisibility(){
      const s = eventMeta.state;
      const rem = eventMeta.remaining;
      const hide = (s==='RUNNING' && typeof rem === 'number' && rem <= 15*60 && rem > 0);

      document.getElementById('tableWrap').classList.toggle('hidden', hide);
      hideNotice.classList.toggle('hidden', !hide);

      const finished = (typeof rem === 'number' && rem === 0) || s==='ENDED';
      postEvent.classList.toggle('hidden', !(finished && s!=='PUBLISHED'));

      if(s==='PUBLISHED'){
        hideNotice.classList.add('hidden');
        document.getElementById('tableWrap').classList.remove('hidden');
        postEvent.classList.add('hidden');
      }
    }

    /* =============== Init / refresh =============== */
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.addEventListener('click', async ()=>{
      refreshBtn.disabled = true;
      try{
        await getEventStateSafe();
        await loadLeaderboard();
        applyVisibility();
      }finally{
        refreshBtn.disabled = false;
      }
    });

    // gentle auto-refresh each minute
    setInterval(async ()=>{
      await getEventStateSafe();
      await loadLeaderboard();
      applyVisibility();
    }, 60000);

    (async function init(){
      statusChip.textContent = 'Checking event‚Ä¶';
      await getEventStateSafe();
      await loadLeaderboard();
      applyVisibility();
    })();
  </script>
</body>
</html>
