<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TeamQuest Leaderboard</title>
  <style>
    :root{
      --bg:#d9731e; --panel:#efe5d7; --ink:#653c17;
      --gold:#d6a21c; --gold-2:#ffd36b; --accent:#ffb24b;
      --row:#f9f2e9; --row-alt:#f3ebdf;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 50% -80px, #f6b16a 0, #e58838 40%, #c86b1a 75%, #a85615 100%), var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1100px;margin:48px auto;padding:0 16px}
    .card{
      background:var(--panel); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:28px;
    }
    h1{margin:0 0 6px;font-size:32px;letter-spacing:.3px}
    .sub{margin:0 0 18px;color:#7a5128}
    .chips{display:flex;gap:12px;align-items:center;margin:8px 0 18px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px; font-weight:700;
      background:linear-gradient(180deg,#fff7e3,#ffe9b9);
      border:2px dashed var(--gold);
      color:#52300f;
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      padding:10px 14px; border-radius:12px; border:2px solid var(--gold);
      background:linear-gradient(180deg,#ffe09f,#ffc66a);
      font-weight:800; color:#4b2a0d;
    }
    .banner{
      margin:8px 0 16px; padding:10px 14px; border-radius:10px;
      border:2px solid var(--gold);
      background:linear-gradient(180deg,#fff7e3,#ffefc6);
      display:none; font-weight:700;
    }
    .banner.info{background:linear-gradient(180deg,#f3f1ff,#e7e3ff)}
    .table{
      width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
      border-radius:12px; border:1px solid #e6d7be; background:#fff;
    }
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg,#fff7e3,#ffefc6);
      font-weight:800; text-align:left; padding:12px 10px; border-bottom:1px solid #eadcc4;
    }
    tbody td{padding:12px 10px; border-bottom:1px solid #f1e8db}
    tbody tr:nth-child(odd){background:var(--row)}
    tbody tr:nth-child(even){background:var(--row-alt)}
    .col-r{text-align:right}
    .muted{color:#7a5128}
    .rank{width:48px;text-align:right;font-variant-numeric:tabular-nums}
    .team{min-width:240px;font-weight:700}
    .center{display:flex;justify-content:center;padding:28px 6px}
    .foot{margin-top:12px;color:#876039}
    @media (max-width:740px){
      .team{min-width:unset}
      thead th:nth-child(3), tbody td:nth-child(3),
      thead th:nth-child(4), tbody td:nth-child(4){display:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>TeamQuest Leaderboard</h1>
      <p class="sub">Live standings with activity breakdown</p>

      <div class="chips">
        <div id="stateChip" class="chip">Checking event‚Ä¶</div>
        <div id="clockChip" class="chip">Time remaining: 00:00</div>
        <button id="refreshBtn" class="btn" type="button">üîÑ Refresh</button>
      </div>

      <div id="hideBanner" class="banner">üîí Scores hidden for the final push. Keep going!</div>
      <div id="endBanner" class="banner info">‚ö†Ô∏è Event complete ‚Äî final results will appear once the host publishes them.</div>

      <table class="table" aria-live="polite">
        <thead>
          <tr>
            <th class="rank">#</th>
            <th class="team">Team</th>
            <th class="col-r">Kindness</th>
            <th class="col-r">Limerick</th>
            <th class="col-r">Scavenger</th>
            <th class="col-r">Quiz</th>
            <th class="col-r">Total</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td class="center" colspan="7">Loading‚Ä¶</td></tr>
        </tbody>
      </table>

      <div class="foot">
        Last updated ‚Äî <span id="updated">‚Äî:‚Äî:‚Äî</span>
      </div>
    </div>
  </div>

  <!-- ===== Robust leaderboard script ===== -->
  <script>
    // ------- Query & els -------
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get("event") || qs.get("eventId") || "";

    const stateChip = document.getElementById("stateChip");
    const clockChip = document.getElementById("clockChip");
    const hideBanner = document.getElementById("hideBanner");
    const endBanner  = document.getElementById("endBanner");
    const rowsEl     = document.getElementById("rows");
    const updatedEl  = document.getElementById("updated");
    const refreshBtn = document.getElementById("refreshBtn");

    // ------- Helpers -------
    const nowIsoClock = () => new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    const pad = n => String(n).padStart(2, "0");
    function fmtMs(ms){
      if (!Number.isFinite(ms) || ms < 0) return "00:00";
      const sec = Math.floor(ms / 1000);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return h > 0 ? `${pad(h)}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
    }
    async function postJSON(path, body){
      const res = await fetch(path, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body || {})
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data.message || data.error || `HTTP ${res.status}`);
      return data;
    }

    // ------- Event state -------
    async function getEventState(){
      try{
        const data = await postJSON("/.netlify/functions/get_event_state", { eventId: EVENT_ID });
        let remainingMs = Number.isFinite(data.remainingMs) ? data.remainingMs : undefined;
        if (remainingMs === undefined && data.endsAt){
          const endTs = typeof data.endsAt === "number" ? data.endsAt : Date.parse(data.endsAt);
          if (Number.isFinite(endTs)) remainingMs = Math.max(0, endTs - Date.now());
        }
        return { state: data.state || "RUNNING", remainingMs };
      }catch(e){
        console.warn("get_event_state failed:", e);
        return { state:"RUNNING", remainingMs: undefined };
      }
    }

    // ------- Normalisation -------
    function pickScore(src, keys, fallback = 0){
      for (const k of keys){
        if (src && src[k] != null && !isNaN(+src[k])) return Number(src[k]);
      }
      return fallback;
    }

    function unwrap(obj){
      // many functions wrap their payload under "data" or "result"
      return obj?.data ?? obj?.result ?? obj;
    }

    function extractArray(obj){
      // accept many top-level keys
      return (
        (Array.isArray(obj?.leaderboard) && obj.leaderboard) ||
        (Array.isArray(obj?.teams)       && obj.teams)       ||
        (Array.isArray(obj?.rows)        && obj.rows)        ||
        (Array.isArray(obj?.standings)   && obj.standings)   ||
        (Array.isArray(obj?.scoreboard)  && obj.scoreboard)  ||
        (Array.isArray(obj?.items)       && obj.items)       ||
        (Array.isArray(obj)              && obj)             ||
        []
      );
    }

    function normaliseLeaderboard(rawIn){
      const raw = unwrap(rawIn);
      const arr = extractArray(raw);

      const out = arr.map(t =>{
        const name = t.teamName || t.name || t.team || t.Team || t.team_display || "";
        const br   = t.breakdown || t.scores || t.activities || t.parts || {};

        const kindness  = pickScore(t, ["kindness","kindnessScore","Kindness","score_kindness"], pickScore(br, ["kindness"], 0));
        const limerick  = pickScore(t, ["limerick","limerickScore","Limerick","score_limerick"], pickScore(br, ["limerick"], 0));
        const scavenger = pickScore(t, ["scavenger","scavengerScore","Scavenger","score_scavenger","hunt","scav"], pickScore(br, ["scavenger","hunt","scav"], 0));
        const quiz      = pickScore(t, ["quiz","quizScore","Quiz","score_quiz"], pickScore(br, ["quiz"], 0));
        const total     = Number.isFinite(+t.total) ? +t.total : kindness + limerick + scavenger + quiz;

        return { teamName: name, kindness, limerick, scavenger, quiz, total };
      });

      // If we still got nothing, but a "teams" list exists as strings, render that as zero scores
      if (!out.length && Array.isArray(raw?.teams) && raw.teams.every(x => typeof x === "string")){
        return raw.teams.map((name) => ({ teamName:name, kindness:0, limerick:0, scavenger:0, quiz:0, total:0 }));
      }

      return out.filter(t => t.teamName).sort((a,b)=> b.total - a.total);
    }

    async function getLeaderboard(){
      try{
        const data = await postJSON("/.netlify/functions/get_leaderboard", { eventId: EVENT_ID });
        const norm = normaliseLeaderboard(data);
        if (!norm.length) console.debug("POST /get_leaderboard returned no rows. Raw:", data);
        return norm;
      }catch(e){
        console.warn("POST get_leaderboard failed, trying GET:", e?.message || e);
      }
      try{
        const res = await fetch(`/.netlify/functions/get_leaderboard?eventId=${encodeURIComponent(EVENT_ID)}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
        const norm = normaliseLeaderboard(data);
        if (!norm.length) console.debug("GET /get_leaderboard returned no rows. Raw:", data);
        return norm;
      }catch(e2){
        console.error("GET get_leaderboard failed:", e2);
        return [];
      }
    }

    // ------- Render -------
    function setStateChip(state){
      const label = (
        state === "RUNNING"     ? "Running" :
        state === "NOT_STARTED" ? "Not started" :
        state === "PAUSED"      ? "Paused" :
        state === "ENDED"       ? "Completed" :
        state === "PUBLISHED"   ? "Results published" :
        state || "Unknown"
      );
      stateChip.textContent = label;
    }

    function drawRows(teams, hideScores){
      rowsEl.innerHTML = "";
      if (!teams.length){
        rowsEl.innerHTML = `<tr><td class="center" colspan="7">No teams yet.</td></tr>`;
        return;
      }
      teams.forEach((t, i) => {
        const k = hideScores ? "‚Äî" : t.kindness;
        const l = hideScores ? "‚Äî" : t.limerick;
        const s = hideScores ? "‚Äî" : t.scavenger;
        const q = hideScores ? "‚Äî" : t.quiz;
        const tot = hideScores ? "‚Äî" : t.total;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="rank">${i+1}</td>
          <td class="team">${t.teamName}</td>
          <td class="col-r">${k}</td>
          <td class="col-r">${l}</td>
          <td class="col-r">${s}</td>
          <td class="col-r">${q}</td>
          <td class="col-r"><strong>${tot}</strong></td>
        `;
        rowsEl.appendChild(tr);
      });
    }

    // ------- Orchestration -------
    let tickTimer = null;

    async function refresh(){
      const { state, remainingMs } = await getEventState();
      setStateChip(state);

      let msLeft = Number.isFinite(remainingMs) ? remainingMs : undefined;
      const updateClock = () => {
        if (!Number.isFinite(msLeft)) {
          clockChip.textContent = "Time remaining: 00:00";
          return;
        }
        clockChip.textContent = `Time remaining: ${fmtMs(msLeft)}`;
        msLeft -= 1000;
        if (msLeft < 0) msLeft = 0;
      };
      updateClock();
      if (tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(updateClock, 1000);

      const teams = await getLeaderboard();

      const fifteenMin = 15 * 60 * 1000;
      const hideScores = (state === "RUNNING") && Number.isFinite(msLeft) && (msLeft <= fifteenMin);
      hideBanner.style.display = hideScores ? "block" : "none";
      endBanner.style.display  = (state === "ENDED") ? "block" : "none";

      const actuallyHide = (state === "RUNNING") ? hideScores : false;

      drawRows(teams, actuallyHide);
      updatedEl.textContent = nowIsoClock();
    }

    refreshBtn.addEventListener("click", refresh);

    (async () => {
      if (!EVENT_ID){
        stateChip.textContent = "Missing event id (?event=...)";
        rowsEl.innerHTML = `<tr><td class="center" colspan="7">Add <strong>?event=YOUR_EVENT_ID</strong> to the URL.</td></tr>`;
        return;
      }
      await refresh();
    })();
  </script>
</body>
</html>
