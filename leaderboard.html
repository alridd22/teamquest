<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TeamQuest Leaderboard</title>
<style>
  :root{
    --bg:#e07d35;--panel:#f3e9dd;--brown:#8b4513;--gold:#daa520;--text:#3b2a17;
    --chip:#fff3cd;--chip-br:#e3c76b;--row:#fbf6ef;--row-alt:#f2eadf;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#c96624,#e07d35 40%,#eea76c)}
  .bar{background:#6e3b16;color:#f9e7ca;border-bottom:3px solid var(--gold);box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .logo{height:42px;vertical-align:middle}
  .card{background:var(--panel);border-radius:18px;padding:24px;box-shadow:0 14px 28px rgba(0,0,0,.2);border:3px solid var(--brown);margin:28px auto}
  h1{margin:8px 0 12px;font-weight:800;color:var(--brown);text-align:center}
  .subtitle{text-align:center;color:#7a4b24;margin-bottom:18px}
  .chips{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:14px}
  .chip{background:var(--chip);border:2px dashed var(--chip-br);padding:10px 14px;border-radius:14px;font-weight:700;color:#704417}
  .btn{background:linear-gradient(135deg,#ffc04d,#ff9d23);border:2px solid #8b4513;border-radius:12px;padding:10px 16px;font-weight:800;color:#5a2d01;cursor:pointer}
  .banner{background:#fff4dc;border:2px solid var(--gold);border-radius:10px;padding:10px 12px;margin:8px auto;color:#6a4b1d}
  .table{width:100%;border-collapse:collapse;margin-top:10px;border-radius:12px;overflow:hidden}
  th,td{padding:12px 10px}
  th{background:#f9edd9;color:#6a4218;border-bottom:2px solid #e2c792;text-align:left}
  tbody tr:nth-child(odd){background:var(--row)}
  tbody tr:nth-child(even){background:var(--row-alt)}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .muted{opacity:.65}
  .footer{margin-top:10px;color:#6a4b1d}
</style>
</head>
<body>
  <div class="bar">
    <div class="wrap">
      <img src="/Team Quest Logo-01.png" class="logo" alt="TeamQuest">
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1>TeamQuest Leaderboard</h1>
      <div class="subtitle">Live standings with activity breakdown</div>

      <div class="chips">
        <div id="stateChip" class="chip">Checking eventâ€¦</div>
        <div id="clockChip" class="chip">Time remaining: â€”</div>
        <button id="refreshBtn" class="btn">ðŸ”„ Refresh</button>
      </div>

      <div id="banner" class="banner" style="display:none"></div>

      <div id="tableArea"></div>

      <div class="footer muted" id="updated"></div>
    </div>
  </div>

<script>
/* ---------- query flags ---------- */
const qs=new URLSearchParams(location.search);
const EVENT_ID=qs.get('event')||qs.get('eventId')||'';
const FORCE_SHOW=['1','true','show','yes'].includes((qs.get('show')||'').toLowerCase());
const INCLUDE_ALL=['1','true','yes'].includes((qs.get('all')||'').toLowerCase()); // ignore event filter (debug)

/* ---------- tiny helpers ---------- */
const $=(id)=>document.getElementById(id);
const pad=(n)=>String(n).padStart(2,'0');
const fmtTime=(d)=>new Date(d).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});

async function call(path, body){
  const res=await fetch(`/.netlify/functions/${path}`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body||{})
  });
  const j=await res.json().catch(()=>({}));
  if(!res.ok){ throw new Error(j.message||`HTTP ${res.status}`); }
  return j;
}

/* ---------- event state & countdown (robust) ---------- */
async function getEventState(){
  let d={};
  try{ d=await call('get_event_state',{eventId:EVENT_ID}); }
  catch{
    try{ const r=await fetch(`/.netlify/functions/get_event_state?eventId=${encodeURIComponent(EVENT_ID)}`); d=await r.json(); }
    catch{}
  }
  const src = d?.data || d || {};

  const state = src.state || src.status || 'UNKNOWN';
  const now   = src.now || src.serverNow || src.currentTime || Date.now();

  // Try several end fields
  let endsAt = src.endsAt || src.endAt || src.deadline || src.eventEnd || src.endTime || src.eventEndsAt || src.end || null;
  let endMs  = endsAt ? new Date(endsAt).getTime() : null;

  // Or derive from remaining*
  if(!endMs){
    const remMs = (src.remainingMs ?? (src.remainingSeconds!=null ? src.remainingSeconds*1000 : null) ?? (src.remainingMinutes!=null ? src.remainingMinutes*60000 : null));
    if(remMs!=null) endMs = new Date(now).getTime() + Number(remMs||0);
  }

  const published = !!(src.published || src.isPublished || src.resultsPublished);
  return { state, now, endsAt: endMs ? new Date(endMs).toISOString() : null, published };
}

function paintState(state){
  const pretty=(state||'UNKNOWN').replace(/_/g,' ').toLowerCase().replace(/(^|\s)\S/g,m=>m.toUpperCase());
  $('stateChip').textContent = pretty;
}
function paintCountdown(now, endsAt){
  if(!endsAt){ $('clockChip').textContent='Time remaining: â€”'; return; }
  const ms=Math.max(0, new Date(endsAt)-new Date(now));
  const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000);
  $('clockChip').textContent = `Time remaining: ${pad(m)}:${pad(s)}`;
}

/* ---------- leaderboard ingestion ---------- */
function titleCase(x){return (x||'').toLowerCase().replace(/\b\w/g,m=>m.toUpperCase());}

function get(r, ...keys){
  for(const k of keys){
    if(r==null) break;
    if(Object.prototype.hasOwnProperty.call(r,k)) return r[k];
  }
  return undefined;
}

function aggregateFromRows(rows){
  const map=new Map();
  const activities=new Set();

  for(const r of rows){
    const act = (get(r,'Activity','activity','type','kind')||'').toString().toLowerCase();
    const code= (get(r,'Team Code','teamCode','team_code','code')||'').toString();
    const name= (get(r,'Team Name','teamName','team_name','name')||'').toString() || code;

    // event filtering
    let eventId = get(r,'Event Id','eventId','event_id') || '';
    const sid   = (get(r,'SubmissionID','submissionId','Submission Id','idempotency','Idempotency','id')||'').toString();
    if(!eventId && sid.includes('|')){ const p=sid.split('|'); if(p.length>=2) eventId=p[1]; }
    if(!INCLUDE_ALL && EVENT_ID && eventId && eventId!==EVENT_ID) continue;

    if(!code || !act) continue;

    const score=Number(get(r,'Score','score')||0)||0;
    activities.add(act);

    if(!map.has(code)) map.set(code,{code, name, totals:{}, total:0});
    const t=map.get(code);
    t.totals[act]=(t.totals[act]||0)+score;
    t.total+=score;
  }

  return {
    teams:[...map.values()].sort((a,b)=>b.total-a.total),
    activities:[...activities].sort()
  };
}

function normalizeTeams(teams){
  const activities=new Set();
  const out=(teams||[]).map(t=>{
    const code=t.teamCode||t.code||'';
    const name=t.teamName||t.name||code;
    const breakdown=t.breakdown||t.totals||{};
    Object.keys(breakdown).forEach(a=>activities.add(a));
    return {code,name,totals:breakdown,total:Number(t.total||0)||0};
  }).sort((a,b)=>b.total-a.total);
  return {teams:out, activities:[...activities].sort()};
}

async function fetchLeaderboard(){
  let d=null;

  // GET first
  try{
    const r=await fetch(`/.netlify/functions/get_leaderboard?eventId=${encodeURIComponent(EVENT_ID)}`);
    d=await r.json();
  }catch{}

  // try POST if GET failed
  if(!d){
    try{ d=await call('get_leaderboard',{eventId:EVENT_ID}); }catch{}
  }

  const root = d?.data || d || {};

  if(Array.isArray(root.teams) && root.teams.length) return normalizeTeams(root.teams);
  if(Array.isArray(root.leaderboard) && root.leaderboard.length) return normalizeTeams(root.leaderboard);

  let rows = root.rows || root.scores || root.submissions || root.table || [];
  if(!Array.isArray(rows) || !rows.length){
    // sometimes another nesting
    const alt = root.sheet || root.payload || {};
    rows = alt.rows || alt.scores || rows;
  }
  if(Array.isArray(rows) && rows.length) return aggregateFromRows(rows);

  return {teams:[], activities:[]};
}

/* ---------- render ---------- */
function renderTable(model, hide){
  const host=$('tableArea');
  if(hide){ host.innerHTML=''; return; }

  const acts=model.activities.length ? model.activities : ['kindness','limerick','scavenger','quiz'];
  const thActs=acts.map(a=>`<th class="num">${titleCase(a)}</th>`).join('');
  const rows=model.teams.map((t,i)=>{
    const cols=acts.map(a=>`<td class="num">${t.totals[a]??0}</td>`).join('');
    return `<tr>
      <td class="num">${i+1}</td>
      <td>${t.name||t.code}</td>
      ${cols}
      <td class="num"><strong>${t.total}</strong></td>
    </tr>`;
  }).join('') || `<tr><td colspan="${acts.length+3}" class="muted">No teams yet.</td></tr>`;

  host.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th class="num">#</th>
          <th>Team</th>
          ${thActs}
          <th class="num">Total</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

/* ---------- page ---------- */
async function load(){
  $('updated').textContent='';
  $('banner').style.display='none';

  const stateInfo = await getEventState();
  const {state, now, endsAt, published}=stateInfo;
  paintState(state); paintCountdown(now, endsAt);

  const last15 = endsAt ? (new Date(endsAt)-new Date(now) <= 15*60*1000 && new Date(endsAt)>new Date(now)) : false;
  let hideReason = null;
  if(state==='ENDED' && !published) hideReason='ENDED';
  else if(state==='RUNNING' && last15) hideReason='LAST15';
  if(FORCE_SHOW) hideReason=null;

  const model = await fetchLeaderboard();

  if(hideReason==='LAST15'){
    $('banner').textContent='Scores hidden for the final push â€” keep going! Final totals will appear at the end.';
    $('banner').style.display='block';
  }else if(hideReason==='ENDED'){
    $('banner').textContent='Event complete â€” final results will appear once the host publishes them.';
    $('banner').style.display='block';
  }

  renderTable(model, !!hideReason);
  $('updated').textContent='Last updated â€” '+fmtTime(Date.now());
}

$('refreshBtn').addEventListener('click', load);
load();
</script>
</body>
</html>
