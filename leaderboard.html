<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Terry's Treasure Quest - Live Leaderboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:linear-gradient(135deg,#d4691a,#f4a261);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }
    .treasure-container{
      background:linear-gradient(145deg,#f5e6d3,#e8d5b8);border-radius:25px;border:5px solid #8b4513;
      box-shadow:0 15px 35px rgba(0,0,0,.3);padding:30px;max-width:900px;width:100%;position:relative;overflow:hidden
    }
    .treasure-container::before{
      content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
      background:radial-gradient(circle,rgba(255,215,0,.1) 0%,transparent 70%);
      animation:shimmer 3s ease-in-out infinite
    }
    @keyframes shimmer{0%,100%{transform:rotate(0)}50%{transform:rotate(180deg)}}
    .header{text-align:center;margin-bottom:20px;position:relative;z-index:1}
    .trophy{font-size:48px;margin-bottom:10px;animation:bounce 2s infinite}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
    .title{font-size:2.2em;color:#8b4513;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.3);font-weight:bold}
    .subtitle{font-size:1.05em;color:#a0522d;margin-bottom:12px}
    .timer-display{
      background:linear-gradient(145deg,#ff8c00,#ffa500);color:#fff;padding:10px 20px;border-radius:25px;
      font-size:1.1em;font-weight:bold;text-align:center;margin:10px auto 0;max-width:360px;
      box-shadow:0 5px 15px rgba(0,0,0,.2);border:3px solid #8b4513;transition:all .3s ease
    }
    .timer-display.penalty{background:linear-gradient(145deg,#dc143c,#b22222);animation:penalty-pulse 1s ease-in-out infinite;border-color:#8b0000}
    .timer-display.paused{background:linear-gradient(145deg,#b9b9b9,#9e9e9e);border-color:#6b6b6b}
    .timer-display.final{background:linear-gradient(145deg,#3bb273,#2f9a60);border-color:#267c4e}
    @keyframes penalty-pulse{0%,100%{box-shadow:0 5px 15px rgba(220,20,60,.4);transform:scale(1)}50%{box-shadow:0 8px 25px rgba(220,20,60,.7);transform:scale(1.02)}}
    .penalty-warning{
      background:linear-gradient(145deg,#ffb6c1,#ffa0b4);border:3px solid #dc143c;color:#8b0000;padding:12px 18px;border-radius:20px;
      font-size:1em;font-weight:700;text-align:center;margin:14px auto 0;max-width:520px;box-shadow:0 8px 25px rgba(220,20,60,.3);
      display:none
    }
    .penalty-warning.show{display:block}
    .final-banner{
      background:linear-gradient(145deg,#ffd700,#ffed4e);color:#8b4513;padding:14px 18px;border-radius:15px;border:3px solid #daa520;
      font-weight:800;text-align:center;margin:14px 0 0;box-shadow:0 8px 25px rgba(255,215,0,.35);display:none
    }
    .leaderboard-container{
      background:#fff;border-radius:15px;padding:16px;margin:16px 0 10px;border:2px solid #d2691e;position:relative;z-index:1
    }
    .team-entry{
      display:flex;align-items:center;padding:16px;margin:10px 0;background:linear-gradient(145deg,#fff8dc,#f5f5dc);
      border-radius:16px;border:2px solid #daa520;box-shadow:0 4px 12px rgba(0,0,0,.08);transition:transform .3s, box-shadow .3s;position:relative
    }
    .team-entry:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.12)}
    .team-entry.penalized{background:linear-gradient(145deg,#ffeaea,#ffe0e0);border:2px solid #ff6b6b;border-left:6px solid #dc143c}
    .rank{font-size:1.8em;font-weight:900;color:#8b4513;margin-right:16px;min-width:45px;text-align:center}
    .rank.first{color:#ffd700;text-shadow:2px 2px 4px rgba(0,0,0,.4);font-size:2.1em}
    .team-info{flex:1;margin-right:10px}
    .team-name{font-size:1.35em;font-weight:900;color:#8b4513;margin-bottom:6px;display:flex;gap:10px;align-items:center;line-height:1.3}
    .team-status-badge{padding:4px 10px;border-radius:18px;font-size:.7em;font-weight:700;letter-spacing:.4px;color:#fff}
    .status-returned{background:#27ae60}.status-late{background:#e74c3c}
    .total-score{font-size:1.4em;font-weight:800;color:#8b4513;background:linear-gradient(145deg,#ffd700,#ffed4e);
      padding:10px 16px;border-radius:18px;border:3px solid #b8860b;box-shadow:0 4px 12px rgba(0,0,0,.15);min-width:110px;text-align:center}
    .total-score.penalized{background:linear-gradient(145deg,#ffb3ba,#ff9999);border-color:#dc143c;color:#8b0000}
    .original-score{font-size:.65em;color:#999;text-decoration:line-through;margin-bottom:2px;opacity:.8}
    .penalty-deduction{font-size:.65em;color:#dc143c;font-weight:800;margin-bottom:2px}
    .status-bar{text-align:center;margin-top:10px;padding:10px;background:rgba(255,255,255,.85);border-radius:15px;font-size:.9em;color:#8b4513;font-weight:700}
    @media (max-width:768px){
      .treasure-container{padding:18px;margin:8px}.title{font-size:1.9em}.team-entry{flex-direction:column;align-items:stretch;gap:8px}
      .rank{min-width:auto;align-self:flex-start;margin-bottom:4px}.team-name{font-size:1.2em}.total-score{align-self:center}
    }
  </style>
</head>
<body>
  <div class="treasure-container" id="treasureContainer">
    <div class="header">
      <div class="trophy">üèÜ</div>
      <h1 class="title" id="pageTitle">Terry's Treasure Leaderboard</h1>
      <p class="subtitle" id="pageSubtitle">Live standings</p>

      <div class="timer-display" id="timerDisplay">
        <span id="timerIcon">‚è∞</span> <span id="timer">Loading‚Ä¶</span>
      </div>

      <div class="penalty-warning" id="penaltyWarning">‚ö†Ô∏è Late penalties are active</div>
      <div class="final-banner" id="finalBanner">üèÅ Adventure complete ‚Äî final results</div>
    </div>

    <div class="leaderboard-container">
      <div id="leaderboard">
        <div style="text-align:center; padding:18px; color:#8b4513;">Loading leaderboard‚Ä¶</div>
      </div>
    </div>

    <div class="status-bar" id="statusBar">
      <span class="auto-refresh-icon">üîÑ</span>
      Auto-refreshing‚Ä¶ Last updated: <span id="lastUpdated">‚Äî</span>
    </div>
  </div>

  <script>
    // Accept ?event=... or ?eventId=...
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event') || qs.get('eventId') || '';

    let refreshInterval = null;
    let refreshMs = 20000;
    let timerInterval = null;
    let endsAt = null;
    let penaltyPerMin = 0;
    let state = 'NOT_STARTED'; // NOT_STARTED | RUNNING | PAUSED | ENDED | PUBLISHED

    const $ = (sel) => document.querySelector(sel);

    function fmtTime(ms){
      const sign = ms < 0 ? '+' : '';
      const t = Math.abs(ms);
      const h = Math.floor(t/3_600_000);
      const m = Math.floor((t%3_600_000)/60_000);
      const s = Math.floor((t%60_000)/1000);
      return `${sign}${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    function prettyClock(d=new Date()){
      return d.toTimeString().split(' ')[0];
    }

    function setTimerUI(){
      const tEl = $('#timer');
      const card = $('#timerDisplay');
      const icon = $('#timerIcon');

      card.classList.remove('penalty','paused','final');

      // ‚úÖ NEW: Final states show "Finished" regardless of EndsAt
      if (state === 'ENDED' || state === 'PUBLISHED') {
        tEl.textContent = 'Finished';
        icon.textContent = 'üèÅ';
        card.classList.add('final');
        $('#penaltyWarning').classList.remove('show');
        return;
      }

      if (state === 'PAUSED') {
        tEl.textContent = 'Paused';
        icon.textContent = '‚è∏';
        card.classList.add('paused');
        $('#penaltyWarning').classList.remove('show');
        return;
      }

      if (!endsAt) {
        tEl.textContent = 'Waiting to start';
        icon.textContent = '‚è∞';
        return;
      }

      const now = Date.now();
      const diff = new Date(endsAt).getTime() - now;

      if (diff >= 0) {
        tEl.textContent = `Time remaining: ${fmtTime(diff)}`;
        icon.textContent = '‚è∞';
      } else {
        // Overtime during RUNNING
        tEl.textContent = `Overtime: ${fmtTime(diff)}`;
        icon.textContent = '‚è±';
        if (penaltyPerMin > 0 && state === 'RUNNING') {
          card.classList.add('penalty');
          $('#penaltyWarning').classList.add('show');
        } else {
          $('#penaltyWarning').classList.remove('show');
        }
      }
    }

    function normalizeState(s=''){
      const v = String(s||'').trim().toUpperCase();
      if (['RUNNING','STARTED','ACTIVE'].includes(v)) return 'RUNNING';
      if (['PAUSED','PAUSE'].includes(v)) return 'PAUSED';
      if (['PUBLISHED'].includes(v)) return 'PUBLISHED';
      if (['ENDED','END','STOPPED','STOP','COMPLETE','COMPLETED','FINISHED'].includes(v)) return 'ENDED';
      if (['NOT_STARTED','NOTSTARTED','READY','PENDING','DRAFT',''].includes(v)) return 'NOT_STARTED';
      return 'NOT_STARTED';
    }

    async function fetchEventState(){
      const url = EVENT_ID ? `/.netlify/functions/get_event_state?eventId=${encodeURIComponent(EVENT_ID)}`
                           : '/.netlify/functions/get_event_state';
      const r = await fetch(url);
      const j = await r.json();
      if (!r.ok || j.success === false) throw new Error(j.message || 'Event state error');

      state = normalizeState(j.state || j.State);
      endsAt = j.endsAt || j['EndsAt (ISO)'] || null;
      penaltyPerMin = Number(j.penaltyPerMin ?? j['PenaltyPerMin'] ?? 0);

      // Title / banner
      const title = $('#pageTitle');
      const subtitle = $('#pageSubtitle');
      const banner = $('#finalBanner');

      if (state === 'RUNNING') {
        title.textContent = "Terry's Treasure Leaderboard";
        subtitle.textContent = "Live standings";
        banner.style.display = 'none';
        refreshMs = 10000;
      } else if (state === 'PAUSED') {
        title.textContent = "Terry's Treasure Leaderboard";
        subtitle.textContent = "Paused";
        banner.style.display = 'none';
        refreshMs = 20000;
      } else if (state === 'ENDED' || state === 'PUBLISHED') {
        title.textContent = "üèÜ Final Treasure Results";
        subtitle.textContent = "Adventure complete ‚Äî final standings";
        banner.style.display = 'block';
        refreshMs = 60000;
      } else {
        title.textContent = "Terry's Treasure Leaderboard";
        subtitle.textContent = "Waiting to start";
        banner.style.display = 'none';
        refreshMs = 20000;
      }

      if (!timerInterval) timerInterval = setInterval(setTimerUI, 1000);
      setTimerUI();
    }

    function pickNumber(...vals){
      for (const v of vals){
        const n = Number(v);
        if (Number.isFinite(n)) return n;
      }
      return 0;
    }

    function renderLeaderboard(rows){
      const box = $('#leaderboard');
      if (!Array.isArray(rows) || rows.length === 0) {
        box.innerHTML = `<div style="text-align:center; padding:18px; color:#8b4513;">No crews yet.</div>`;
        return;
      }

      // Map rows into a consistent shape
      const mapped = rows.map((t) => {
        const teamName  = t.teamName || t.name || t.team || t.teamCode || 'Crew';
        const penalty   = pickNumber(t.penaltyApplied, t.penalty, t.latePenalty, t.penaltyDeduction);
        const adjusted  = Number.isFinite(Number(t.adjustedScore)) ? Number(t.adjustedScore)
                          : Number.isFinite(Number(t.score))       ? Number(t.score)
                          : pickNumber(t.totalScore, t.originalScore, t.baseScore) - penalty;
        const baseScore = Number.isFinite(Number(t.totalScore)) ? Number(t.totalScore)
                          : Number.isFinite(Number(t.originalScore)) ? Number(t.originalScore)
                          : adjusted + penalty;

        const returnedAt = t.returnedAt || t.ReturnedAt || t['ReturnedAt (ISO)'] || '';
        const lateMins = pickNumber(t.lateMins, t.LateMins);
        return { teamName, adjusted, penalty, baseScore, returnedAt, lateMins };
      });

      // Sort: adjusted desc, then team name
      mapped.sort((a,b)=> (b.adjusted - a.adjusted) || a.teamName.localeCompare(b.teamName));

      // Ties: equal rank numbers if scores equal
      let html = '';
      let lastScore = null, lastRank = 0;
      mapped.forEach((t, i) => {
        const sameAsPrev = lastScore !== null && t.adjusted === lastScore;
        const rank = sameAsPrev ? lastRank : i + 1;
        lastScore = t.adjusted; lastRank = rank;

        const rankClass = rank===1 ? 'first' : '';
        const entryClass = t.penalty>0 ? 'team-entry penalized' : 'team-entry';
        const returned = !!t.returnedAt;
        const isLateNow = !returned && endsAt && (Date.now() > new Date(endsAt).getTime()) && state === 'RUNNING';
        const statusBadge = returned
          ? `<span class="team-status-badge status-returned">Returned</span>`
          : (isLateNow ? `<span class="team-status-badge status-late">Late</span>` : '');

        const scoreBlock = t.penalty>0
          ? `<div class="total-score penalized">
               <div class="original-score">${t.baseScore}</div>
               <div class="penalty-deduction">-${t.penalty}</div>
               ${t.adjusted}
             </div>`
          : `<div class="total-score">${t.adjusted}</div>`;

        html += `
          <div class="${entryClass}">
            <div class="rank ${rankClass}">${rank}</div>
            <div class="team-info">
              <div class="team-name">${t.teamName} ${statusBadge}</div>
            </div>
            ${scoreBlock}
          </div>
        `;
      });

      box.innerHTML = html;
    }

    async function fetchLeaderboard(){
      const base = '/.netlify/functions/get_leaderboard';
      const url = EVENT_ID ? `${base}?eventId=${encodeURIComponent(EVENT_ID)}` : base;
      const r = await fetch(url);
      const j = await r.json().catch(()=> ({}));
      if (!r.ok || j.success === false) throw new Error(j.message || 'Leaderboard error');
      const rows = j.rows || j.data || [];
      renderLeaderboard(rows);
      const lu = j.lastUpdated || new Date().toISOString();
      $('#lastUpdated').textContent = lu.slice(11,19);
    }

    async function refreshAll(){
      await fetchEventState();
      await fetchLeaderboard();
    }

    function startAutoRefresh(){
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(async () => {
        try{
          await refreshAll();
          // Stop when final/published (keeps page stable for displays)
          if (state === 'ENDED' || state === 'PUBLISHED') {
            clearInterval(refreshInterval);
            refreshInterval = null;
            $('#statusBar').innerHTML = `üèÅ Final results published | Last updated: <span id="lastUpdated">${prettyClock(new Date())}</span>`;
          }
        } catch(e){
          console.error(e);
        }
      }, refreshMs);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try{
        await refreshAll();
        startAutoRefresh();
      }catch(e){
        console.error(e);
        $('#leaderboard').innerHTML = `
          <div class="error-container" style="background:#ffe6e6;border:2px solid #ff6b6b;border-radius:10px;padding:15px;margin:10px 0;color:#d63031;text-align:center;">
            ‚ùå ${e.message || 'Error loading data'}
            <button class="retry-btn" onclick="location.reload()" style="background:#ff8c00;color:#fff;border:none;padding:8px 16px;border-radius:16px;cursor:pointer;font-weight:700;margin-left:10px;">Retry</button>
          </div>
        `;
      }
    });

    window.addEventListener('beforeunload', () => {
      if (refreshInterval) clearInterval(refreshInterval);
      if (timerInterval) clearInterval(timerInterval);
    });
  </script>
</body>
</html>
