<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeamQuest Leaderboard</title>
  <style>
    :root{
      --bg:#F3EADB; --card:#F7F0E5; --brown:#8B4513; --gold:#DAA520; --gold2:#FFB347;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);color:#3a2a17;}
    .leaderboard-card{max-width:1050px;margin:42px auto;background:var(--card);
      border:3px solid var(--brown);border-radius:18px;box-shadow:0 14px 28px rgba(0,0,0,.18);
      padding:26px 24px 22px;}
    .leaderboard-title{color:var(--brown);font-weight:800;font-size:2.1rem;margin:0 0 6px;}
    .leaderboard-sub{color:#7b522a;font-weight:600;margin:0 0 18px;}
    .cluster{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border:2px dashed var(--gold);
      border-radius:14px;background:#fff7e3;font-weight:800;color:#6a3f16;user-select:none;}
    .badge .dot{width:10px;height:10px;border-radius:999px;background:#2ecc71;
      box-shadow:0 0 0 3px rgba(46,204,113,.25);display:inline-block;}
    .badge.time .dot{background:#ffd166;box-shadow:0 0 0 3px rgba(255,209,102,.25);}
    .btn-refresh{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:12px;
      border:2px solid var(--brown);background:linear-gradient(135deg,var(--gold2),var(--gold));
      color:#fff;font-weight:800;cursor:pointer;transition:transform .08s ease,filter .08s ease;}
    .btn-refresh:hover{filter:brightness(1.03);transform:translateY(-1px);}
    .banner{margin:14px 0 10px;padding:12px 14px;background:#fff7e3;border:2px solid var(--gold);
      border-radius:10px;color:#6a3f16;font-weight:700;display:none;}
    .banner.show{display:block}
    table.leaderboard{width:100%;border-collapse:separate;border-spacing:0;background:#fff;
      border:2px solid #e7d8c4;border-radius:12px;overflow:hidden;}
    .leaderboard thead th{background:linear-gradient(180deg,#fff8ea,#fdeac7);color:#6a3f16;
      font-weight:800;padding:14px 12px;text-align:left;border-bottom:2px solid #eddcc4;white-space:nowrap;}
    .leaderboard tbody td{padding:14px 12px;color:#4a3a26;}
    .leaderboard tbody tr:nth-child(even){background:#fffaf2;}
    .leaderboard tbody tr:hover{background:#fff4df;}
    .leaderboard td.rank{width:52px;color:#7a5a34;font-weight:800;}
    .leaderboard tbody td:nth-child(n+3){text-align:right;font-variant-numeric:tabular-nums;}
    .empty{padding:18px 12px;color:#7b522a;font-weight:600;}
    .updated{margin-top:12px;color:#7b522a;font-weight:600;}
  </style>
</head>
<body>
  <main class="leaderboard-card" aria-live="polite">
    <h1 class="leaderboard-title">TeamQuest Leaderboard</h1>
    <p class="leaderboard-sub">Live standings with activity breakdown</p>

    <div class="cluster">
      <span class="badge" id="statusBadge"><span class="dot" aria-hidden="true"></span><span id="statusText">Running</span></span>
      <span class="badge time"><span class="dot" aria-hidden="true"></span>Time remaining: <span id="timeLeft">00:00</span></span>
      <button class="btn-refresh" id="refreshBtn">üîÑ Refresh</button>
    </div>

    <div class="banner" id="hideBanner">üîí Scores hidden for the final push. Keep going!</div>
    <div class="banner" id="endedBanner">‚ö†Ô∏è Event complete ‚Äî final results will appear once the host publishes them.</div>

    <table class="leaderboard" id="board" role="table" aria-describedby="statusText">
      <thead>
        <tr>
          <th>#</th>
          <th>Team</th>
          <th>Kindness</th>
          <th>Limerick</th>
          <th>Scavenger</th>
          <th>Clue Hunt</th> <!-- NEW -->
          <th>Quiz</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td class="empty" colspan="8">Loading‚Ä¶</td></tr> <!-- updated colspan -->
      </tbody>
    </table>

    <div class="updated" id="lastUpdated">Last updated ‚Äî --:--:--</div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event') || qs.get('eventId') || '';

    const rowsEl = document.getElementById('rows');
    const timeEl = document.getElementById('timeLeft');
    const statusText = document.getElementById('statusText');
    const statusBadge = document.getElementById('statusBadge');
    const hideBanner = document.getElementById('hideBanner');
    const endedBanner = document.getElementById('endedBanner');
    const lastUpdated = document.getElementById('lastUpdated');
    const refreshBtn = document.getElementById('refreshBtn');

    let countdownTimer = null;

    function fmtTime(ms){
      if(ms == null) return '00:00';
      ms = Math.max(0, ms);
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return (h>0? String(h).padStart(2,'0')+':':'') +
             String(m).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
    }
    function nowLocalTime(){
      const d = new Date();
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }
    function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

    function extractMeta(data){
      const meta = data?.event || data || {};
      const state = (data?.state || meta.state || 'RUNNING').toUpperCase();
      const endsAtIso = meta.endsAt || meta.endAt || meta.ends || null;
      const serverNowIso = meta.now || data?.now || null;
      let remainingMs = null;
      if(data?.timeRemainingMs != null) remainingMs = num(data.timeRemainingMs);
      else if(data?.timeRemainingSec != null) remainingMs = num(data.timeRemainingSec)*1000;
      else if(meta.timeRemainingSec != null) remainingMs = num(meta.timeRemainingSec)*1000;
      else if(endsAtIso){
        const now = serverNowIso ? new Date(serverNowIso) : new Date();
        remainingMs = new Date(endsAtIso) - now;
      }
      return { state, remainingMs };
    }

    function setStatus(state){
      const pretty = (state==='RUNNING'?'Running': state==='PAUSED'?'Paused'
                      : state==='PUBLISHED'?'Published' : 'Ended');
      statusText.textContent = pretty;
      statusBadge.querySelector('.dot').style.background =
        (state==='RUNNING') ? '#2ecc71' : (state==='PAUSED' ? '#ffd166' : '#ff6b6b');
    }

    function setCountdown(ms){
      if(countdownTimer) clearInterval(countdownTimer);
      if(ms == null){ timeEl.textContent = '00:00'; return; }
      let remaining = ms;
      timeEl.textContent = fmtTime(remaining);
      countdownTimer = setInterval(()=>{
        remaining -= 1000;
        if(remaining <= 0){ timeEl.textContent = '00:00'; clearInterval(countdownTimer); }
        else timeEl.textContent = fmtTime(remaining);
      },1000);
    }

    function renderRows(list){
      if(!Array.isArray(list) || list.length===0){
        rowsEl.innerHTML = `<tr><td class="empty" colspan="8">No teams yet.</td></tr>`;
        return;
      }
      rowsEl.innerHTML = list.map((t,i)=>{
        const k = num(t.kindness ?? t.scores?.kindness ?? t.activities?.kindness);
        const l = num(t.limerick ?? t.scores?.limerick ?? t.activities?.limerick);
        const s = num(t.scavenger ?? t.scores?.scavenger ?? t.activities?.scavenger);
        const c = num(t.cluehunt ?? t.scores?.cluehunt ?? t.activities?.cluehunt); // NEW
        const q = num(t.quiz ?? t.scores?.quiz ?? t.activities?.quiz);
        const total = num(t.total ?? (k+l+s+c+q));
        const name = t.teamName || t.name || t.team || t.teamCode || '‚Äî';
        return `
          <tr>
            <td class="rank">${i+1}</td>
            <td>${name}</td>
            <td>${k}</td>
            <td>${l}</td>
            <td>${s}</td>
            <td>${c}</td>
            <td>${q}</td>
            <td>${total}</td>
          </tr>`;
      }).join('');
    }

    async function loadBoard(){
      const url = EVENT_ID
        ? `/.netlify/functions/get_leaderboard?eventId=${encodeURIComponent(EVENT_ID)}`
        : '/.netlify/functions/get_leaderboard';

      try{
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const { state, remainingMs } = extractMeta(data);
        setStatus(state);
        setCountdown(remainingMs);

        const hideForFinalPush = state === 'RUNNING' && remainingMs != null && remainingMs > 0 && remainingMs <= 15*60*1000;
        hideBanner.classList.toggle('show', hideForFinalPush);
        endedBanner.classList.toggle('show', (state !== 'RUNNING' && state !== 'PUBLISHED') || (remainingMs != null && remainingMs <=0));

        if(hideForFinalPush || (state !== 'RUNNING' && state !== 'PUBLISHED')){
          rowsEl.innerHTML = `<tr><td class="empty" colspan="8">${hideForFinalPush ? 'Scores are hidden until the finish.' : 'Scores will appear once results are published.'}</td></tr>`;
        }else{
          const list = data.leaderboard || data.rows || data.teams || [];
          renderRows(list);
        }

        lastUpdated.textContent = `Last updated ‚Äî ${nowLocalTime()}`;
      }catch(err){
        console.error('Leaderboard load failed:', err);
        rowsEl.innerHTML = `<tr><td class="empty" colspan="8">Couldn‚Äôt load leaderboard. Please try again.</td></tr>`;
        lastUpdated.textContent = `Last updated ‚Äî ${nowLocalTime()}`;
      }
    }

    refreshBtn.addEventListener('click', loadBoard);
    document.addEventListener('visibilitychange', () => { if(!document.hidden) loadBoard(); });

    loadBoard();
    setInterval(loadBoard, 60_000);
  </script>
</body>
</html>
