<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TeamQuest ‚Äî Leaderboard</title>
  <style>
    /* ‚Äî‚Äî‚Äî NAV ‚Äî‚Äî‚Äî */
    .nav{position:fixed;inset:auto 0 0 0;top:0;height:72px;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:10}
    .nav .wrap{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:18px;height:100%;padding:0 16px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    .brand img{height:48px;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5))}
    .links{display:flex;gap:10px;margin-left:auto}
    .links a{color:#F5DEB3;text-decoration:none;font-weight:700;padding:10px 14px;border-radius:10px;background:rgba(101,67,33,.35);border:2px solid rgba(218,165,32,.4)}
    .links a:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff;border-color:#DAA520}

    /* ‚Äî‚Äî‚Äî PAGE ‚Äî‚Äî‚Äî */
    :root{--card:#f6eee0;--ink:#432;--gold:#DAA520;--soft:#ffe9c7}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Tahoma,Arial,sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;padding:100px 16px 24px;color:var(--ink)}
    .shell{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:3px solid #8B4513;border-radius:22px;padding:18px 18px 8px;box-shadow:0 16px 32px rgba(0,0,0,.18)}
    .card h1{margin:6px 0 6px;text-align:center;font-size:32px}
    .sub{margin:0 0 12px;text-align:center;color:#7a5737}
    .toolbar{display:flex;align-items:center;gap:12px;justify-content:center;flex-wrap:wrap;margin:6px 0 16px}
    .chip{display:inline-flex;align-items:center;gap:8px;font-weight:800;border:2px dashed var(--gold);background:#fff3d9;border-radius:999px;padding:8px 14px}
    .ghost{opacity:.6}
    .btn{background:linear-gradient(135deg,#FF8C00,#DAA520);color:#fff;border:2px solid #8B4513;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .right{margin-left:auto}
    .muted{color:#7a5737;font-weight:600}
    .note{background:linear-gradient(135deg,#FFF8DC,#F5E6D3);border:2px solid var(--gold);border-left:6px solid #FF8C00;border-radius:12px;padding:14px;margin:10px 0;font-weight:700;text-align:center}
    .hidden{display:none !important}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:6px}
    thead th{position:sticky;top:0;background:var(--soft);border-top:2px solid var(--gold);border-bottom:2px solid var(--gold);padding:10px 8px;font-size:14px}
    tbody td{padding:10px 8px;border-bottom:1px solid #e8d7c3}
    tbody tr:nth-child(odd){background:#fffdf8}
    .rank{font-weight:900;text-align:center;width:70px}
    .team{font-weight:800}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .total{background:linear-gradient(180deg,#fff,#ffefd8)}
    .last-upd{margin:12px 2px 18px}
    .countdown{font-weight:900;color:#8B4513}
    @media (max-width:760px){
      .links{display:none}
      thead th:nth-child(3),tbody td:nth-child(3){display:none} /* hide one minor column on small screens */
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="wrap">
      <a class="brand" href="https://theteamquest.netlify.app/">
        <img src="/Team Quest Logo-01.png" alt="TeamQuest">
      </a>
      <div class="links">
        <a href="https://theteamquest.netlify.app/clue_hunt_challenge">üíé Treasure Hunt</a>
        <a href="https://theteamquest.netlify.app/scavenger_hunt">üîç Scavenger</a>
        <a href="https://theteamquest.netlify.app/quiz_challenge">‚è∞ Timed Quiz</a>
        <a href="https://theteamquest.netlify.app/kindness_challenge_page">‚ù§Ô∏è Kindness</a>
        <a href="https://theteamquest.netlify.app/limerick_challenge_page">üìù Limerick</a>
        <a href="https://theteamquest.netlify.app/teamquest_gallery">üì∏ Gallery</a>
      </div>
    </div>
  </nav>

  <main class="shell">
    <section class="card">
      <h1>TeamQuest Leaderboard</h1>
      <p class="sub">Live standings with activity breakdown</p>

      <div class="toolbar">
        <div id="statusChip" class="chip">Checking event‚Ä¶</div>
        <div id="countChip" class="chip ghost hidden">‚è≥ <span id="countLabel">Time remaining</span>: <span id="countdown">‚Äî:‚Äî</span></div>
        <button class="btn" id="refreshBtn">üîÑ Refresh</button>
      </div>

      <div id="hideNotice" class="note hidden">‚è≥ Final 15 minutes ‚Äî live scores are hidden. Keep playing! The countdown above shows time left.</div>
      <div id="postEventNotice" class="note hidden">üï∞ Event complete ‚Äî final results will appear once the host publishes them.</div>

      <div id="tableWrap" class="table">
        <table id="board" aria-live="polite"></table>
      </div>

      <div class="last-upd muted" id="lastUpd">Last updated ‚Äî</div>
    </section>
  </main>

  <script>
    /* =============== Inputs & helpers =============== */
    const qs = new URLSearchParams(location.search);
    const EVENT_ID = qs.get('event') || qs.get('eventId') || '';

    function fmtTime(ts){
      const d = new Date(ts);
      return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }
    function nowTs(){ return Date.now(); }
    function toInt(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function pick(obj, keys){
      for(const k of keys){
        if (obj && Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
        // also allow case-insensitive
        const found = Object.keys(obj||{}).find(x=>x.toLowerCase()===String(k).toLowerCase());
        if(found) return obj[found];
      }
      return undefined;
    }

    async function callFn(path, payload){
      const res = await fetch(`/.netlify/functions/${path}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload || {})
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok || data.success === false) throw new Error(data.message || `Request failed (${res.status})`);
      return data;
    }

    /* =============== Event state (safe POST) =============== */
    const statusChip = document.getElementById('statusChip');
    const countChip  = document.getElementById('countChip');
    const countdownEl= document.getElementById('countdown');
    const countLabel = document.getElementById('countLabel');
    const hideNotice = document.getElementById('hideNotice');
    const postEvent  = document.getElementById('postEventNotice');

    let countdownTimer = null;
    let eventMeta = {state:'UNKNOWN', endMs:null, remaining: null};

    function parseEventMeta(data){
      const state = String(pick(data,['state','status'])||'UNKNOWN');
      const nowMs = Date.parse(pick(data,['now','serverTime','serverNow'])||new Date());
      const endStr = pick(data,['endAt','endTime','endsAt']);
      const startStr = pick(data,['startAt','startTime','startsAt']);
      const endMs = endStr ? Date.parse(endStr) : null;
      const startMs = startStr ? Date.parse(startStr) : null;
      let remaining = pick(data,['remainingSeconds','secondsRemaining','remaining']);
      if(remaining == null && endMs) remaining = Math.max(0, Math.round((endMs - nowMs)/1000));
      return {state, nowMs, endMs, startMs, remaining};
    }

    function updateStatusUI(){
      const s = eventMeta.state;
      const rem = eventMeta.remaining;

      // status label
      let label = '';
      if(s==='NOT_STARTED') label = 'Event not started';
      else if(s==='RUNNING') label = 'Event running';
      else if(s==='PAUSED') label = 'Event paused';
      else if(s==='ENDED') label = 'Event ended';
      else if(s==='PUBLISHED') label = 'Results published';
      else label = 'Event status unknown';
      statusChip.textContent = label;

      // countdown
      if(typeof rem === 'number'){
        countChip.classList.remove('hidden');
        tickCountdown(); // draw immediately
        if(countdownTimer) clearInterval(countdownTimer);
        countdownTimer = setInterval(tickCountdown, 1000);
      }else{
        countChip.classList.add('hidden');
        if(countdownTimer) clearInterval(countdownTimer);
      }

      // hide/show notices
      const hideNow = (s==='RUNNING' && typeof rem === 'number' && rem <= 15*60 && rem > 0);
      hideNotice.classList.toggle('hidden', !hideNow);
      postEvent.classList.toggle('hidden', !(s==='ENDED' || (s!=='PUBLISHED' && rem===0)));

      // count label text
      countLabel.textContent = s==='RUNNING' ? 'Time remaining' :
                               s==='NOT_STARTED' ? 'Starts in' : 'Time';
    }

    function tickCountdown(){
      if(typeof eventMeta.remaining !== 'number') return;
      const rem = Math.max(0, eventMeta.remaining - Math.round((nowTs() - eventMeta.nowMs)/1000));
      const m = Math.floor(rem/60).toString().padStart(2,'0');
      const s = Math.floor(rem%60).toString().padStart(2,'0');
      countdownEl.textContent = `${m}:${s}`;
    }

    async function getEventStateSafe(){
      if(!EVENT_ID) return {state:'UNKNOWN'};
      try{
        const data = await callFn('get_event_state',{eventId:EVENT_ID});
        eventMeta = parseEventMeta(data);
        updateStatusUI();
        return eventMeta;
      }catch(e){
        console.warn('Event-state check failed:', e.message);
        statusChip.textContent = 'Showing latest scores (event unknown)';
        countChip.classList.add('hidden');
        return {state:'UNKNOWN'};
      }
    }

    /* =============== Leaderboard =============== */
    const board = document.getElementById('board');
    const lastUpd = document.getElementById('lastUpd');

    function normaliseTeams(raw){
      const rows = raw?.teams || raw?.leaderboard || raw?.rows || [];
      return rows.map(t=>{
        const name = pick(t,['teamName','name']) || '';
        const code = pick(t,['teamCode','code','teamId']) || '';
        // scores
        const kindness = toInt(pick(t,['kindness','kind','kind_act','kindActs','kindnessScore']));
        const limerick = toInt(pick(t,['limerick','verse','poem','limerickScore']));
        const scav     = toInt(pick(t,['scavenger','scav','scavenger_hunt','scavengerScore']));
        const clues    = toInt(pick(t,['cluehunt','clue_hunt','clues','hunt','clueScore']));
        const quiz     = toInt(pick(t,['quiz','quizScore']));
        let total      = toInt(pick(t,['total','score','points']));
        if(!total) total = kindness + limerick + scav + clues + quiz;
        return {name, code, kindness, limerick, scav, clues, quiz, total};
      });
    }

    function detectColumns(teams){
      // Only show columns that have any value > 0 (but always show Total)
      const cols = [
        {key:'kindness', label:'‚ù§Ô∏è Kindness'},
        {key:'limerick', label:'üìù Limerick'},
        {key:'scav',     label:'üîç Scavenger'},
        {key:'clues',    label:'üíé Clue Hunt'},
        {key:'quiz',     label:'‚è∞ Quiz'},
      ];
      return cols.filter(c => teams.some(t => t[c.key] !== 0));
    }

    function renderTable(teams){
      if(!Array.isArray(teams) || !teams.length){
        board.innerHTML = '<tbody><tr><td class="muted">No teams yet.</td></tr></tbody>';
        return;
      }
      teams.sort((a,b)=> b.total - a.total || a.name.localeCompare(b.name));
      const cols = detectColumns(teams);

      let thead = `<thead><tr>
        <th class="rank">#</th>
        <th>Team</th>
        ${cols.map(c=>`<th class="num">${c.label}</th>`).join('')}
        <th class="num total">üèÜ Total</th>
      </tr></thead>`;

      let rows = teams.map((t,i)=>`
        <tr>
          <td class="rank">${i+1}</td>
          <td class="team">${t.name || t.code}</td>
          ${cols.map(c=>`<td class="num">${t[c.key]}</td>`).join('')}
          <td class="num total"><strong>${t.total}</strong></td>
        </tr>`).join('');

      board.innerHTML = thead + `<tbody>${rows}</tbody>`;
    }

    async function loadLeaderboard(){
      try{
        const data = await callFn('get_leaderboard', { eventId: EVENT_ID });
        const teams = normaliseTeams(data);
        renderTable(teams);
        lastUpd.textContent = `Last updated ‚Äî ${fmtTime(Date.now())}`;
      }catch(e){
        console.error('Leaderboard load failed', e);
        board.innerHTML = `<tbody><tr><td class="muted">Couldn‚Äôt load leaderboard.</td></tr></tbody>`;
      }
    }

    /* =============== Visibility rules (15-minute hide) =============== */
    function applyVisibility(){
      const s = eventMeta.state;
      const rem = eventMeta.remaining;
      const hide = (s==='RUNNING' && typeof rem === 'number' && rem <= 15*60 && rem > 0);

      document.getElementById('tableWrap').classList.toggle('hidden', hide);
      hideNotice.classList.toggle('hidden', !hide);

      // After time runs out, keep table hidden and show ‚Äúawaiting publication‚Äù
      const finished = (typeof rem === 'number' && rem === 0) || s==='ENDED';
      postEvent.classList.toggle('hidden', !(finished && s!=='PUBLISHED'));

      // If results published, show table (assumes backend returns finals/locked totals)
      if(s==='PUBLISHED'){
        hideNotice.classList.add('hidden');
        document.getElementById('tableWrap').classList.remove('hidden');
        postEvent.classList.add('hidden');
      }
    }

    /* =============== Init / refresh =============== */
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.addEventListener('click', async ()=>{
      refreshBtn.disabled = true;
      try{
        await getEventStateSafe();
        await loadLeaderboard();
        applyVisibility();
      }finally{
        refreshBtn.disabled = false;
      }
    });

    // auto-refresh every 60s (gentle)
    setInterval(async ()=>{
      await getEventStateSafe();
      await loadLeaderboard();
      applyVisibility();
    }, 60000);

    (async function init(){
      statusChip.textContent = 'Checking event‚Ä¶';
      await getEventStateSafe();
      await loadLeaderboard();
      applyVisibility();
    })();
  </script>
</body>
</html>
