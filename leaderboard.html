<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamQuest ‚Äì Leaderboard</title>
  <style>
    /* ‚Äî‚Äî‚Äî‚Äî‚Äî NAV ‚Äî‚Äî‚Äî‚Äî‚Äî */
    .treasure-nav{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#8B4513 0%,#654321 50%,#8B4513 100%);border-bottom:3px solid #DAA520;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:1000;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;height:80px}
    .nav-container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 20px;height:100%}
    .nav-logo{text-decoration:none;transition:.3s;display:flex;align-items:center}
    .nav-logo:hover{transform:scale(1.05)}
    .nav-logo img{height:50px;width:auto;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5));transition:.3s}
    .nav-logo:hover img{filter:drop-shadow(2px 2px 8px rgba(255,215,0,.6))}
    .nav-menu{display:flex;list-style:none;margin:0;padding:0;gap:30px}
    .nav-item{position:relative}
    .nav-link{color:#F5DEB3;text-decoration:none;font-size:1rem;font-weight:bold;padding:12px 18px;border-radius:8px;transition:.3s;display:block;text-shadow:1px 1px 2px rgba(0,0,0,.7);background:rgba(101,67,33,.3);border:2px solid rgba(218,165,32,.4);white-space:nowrap}
    .nav-link:hover{background:linear-gradient(135deg,#DAA520,#FF8C00);color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(218,165,32,.4);border-color:#DAA520}
    .nav-toggle{display:none;background:none;border:none;color:#DAA520;font-size:1.8rem;cursor:pointer}
    @media (max-width:768px){
      .treasure-nav{height:120px}
      .nav-container{justify-content:center;position:relative}
      .nav-logo{position:absolute;left:50%;transform:translateX(-50%)}
      .nav-logo img{height:85px!important}
      .nav-toggle{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:block}
      .nav-menu{position:fixed;top:120px;left:-100%;width:100%;height:calc(100vh - 120px);background:linear-gradient(135deg,#8B4513 0%,#654321 100%);flex-direction:column;align-items:center;padding-top:30px;gap:20px;transition:left .3s;overflow-y:auto}
      .nav-menu.active{left:0}
      .nav-link{font-size:1.1rem;padding:15px 25px;width:280px;text-align:center;background:linear-gradient(135deg,rgba(101,67,33,.8),rgba(139,69,19,.6));border:2px solid #DAA520;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.3)}
    }

    /* ‚Äî‚Äî‚Äî‚Äî‚Äî PAGE ‚Äî‚Äî‚Äî‚Äî‚Äî */
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#8B4513 0%,#D2691E 30%,#F4A460 100%);min-height:100vh;padding:20px;padding-top:100px}
    .container{max-width:1100px;margin:0 auto;background:linear-gradient(145deg,#F5E6D3 0%,#E8D7C3 100%);border:3px solid #8B4513;border-radius:24px;box-shadow:0 20px 40px rgba(0,0,0,.2);padding:22px;position:relative}
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#FFD700,#FF8C00,#DAA520,#FFD700)}
    h1{margin:6px 0 4px;color:#8B4513;font-weight:800;text-align:center}
    .subtitle{text-align:center;color:#A0522D;margin-bottom:10px;font-weight:600}

    .status{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:8px 0 16px}
    .pill{padding:8px 12px;border-radius:999px;border:2px solid #DAA520;background:#FFF8DC;color:#654321;font-weight:700}
    .pill.warn{border-color:#FF8C00}
    .pill.ok{border-color:#32CD32}
    .pill.err{border-color:#8B0000}

    .countdown{font-size:1.1rem;font-weight:800;color:#8B4513;text-align:center;margin:2px 0 10px}
    .hint{font-size:.95rem;color:#654321;text-align:center;margin-bottom:8px}

    .hidden-banner{background:linear-gradient(135deg,#FFE4B5,#F0C27B);border:2px solid #DAA520;border-left:6px solid #FF8C00;border-radius:12px;padding:12px;margin:10px 0;color:#654321;font-weight:700;text-align:center;display:none}

    .board-outer{background:#fff9ee;border:2px solid #DAA520;border-radius:16px;overflow:auto;/* horizontal scroll on small screens */}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:720px}
    thead th{position:sticky;top:0;background:linear-gradient(135deg,#FFDE9E,#FFD27A);border-bottom:2px solid #DAA520;color:#8B4513;font-weight:800;text-align:left;padding:10px 12px}
    tbody td{padding:10px 12px;border-bottom:1px dashed rgba(139,69,19,.25);vertical-align:middle}
    .col-rank{width:70px;text-align:center;font-weight:800}
    .col-team{min-width:220px;font-weight:700;color:#4a341b}
    .col-total,.col-score{width:110px;text-align:right;font-weight:900}
    .muted{color:#8B4513;opacity:.6}
    .hidden-scores td.col-rank,.hidden-scores td.col-total,.hidden-scores td.col-score{color:transparent;text-shadow:0 0 10px rgba(139,69,19,.25)}
    .penalty{color:#8B0000;font-weight:900}
    .bonus{color:#2f5a14;font-weight:900}

    .footer-bar{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:#654321}
    .mini{font-size:.9rem}
    .btn{background:#8B4513;color:#fff;border:2px solid #DAA520;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn:hover{background:#A0522D}
    .msg{margin-top:10px;padding:12px;border-radius:12px;border:2px solid;display:none;text-align:center;font-weight:700}
    .msg.error{background:#ffd8dd;border-color:#b30024;color:#6b0015}
    .msg.info{background:#e6ffe6;border-color:#32CD32;color:#064b06}

    .spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(0,0,0,.15);border-top-color:#8B4513;border-radius:50%;animation:spin .8s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:560px){
      .col-rank{width:56px}
      .col-total,.col-score{width:90px}
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo" aria-label="TeamQuest Home">
        <img src="/Team Quest Logo-01.png" alt="TeamQuest Logo">
      </a>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/clue_hunt_challenge">üíé The Treasure Hunt</a></li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/scavenger_hunt">üîç The Scavenger Hunt</a></li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/quiz_challenge">‚è∞ The Timed Quiz</a></li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/kindness_challenge_page">‚ù§Ô∏è Kindness</a></li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/limerick_challenge_page">üìù Limerick</a></li>
        <li class="nav-item"><a class="nav-link" href="https://theteamquest.netlify.app/teamquest_gallery">üì∏ Gallery</a></li>
      </ul>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle menu">‚ò∞</button>
    </div>
  </nav>

  <div class="container">
    <h1>TeamQuest Leaderboard</h1>
    <p class="subtitle">Live standings with activity breakdown</p>

    <div class="status" aria-live="polite">
      <div class="pill" id="statePill">Checking event‚Ä¶ <span class="spinner" aria-hidden="true"></span></div>
      <div class="pill" id="phasePill" style="display:none"></div>
    </div>

    <div class="countdown" id="countdown" aria-live="polite"></div>
    <div class="hint" id="hint"></div>
    <div id="hiddenBanner" class="hidden-banner">‚è≥ Scores are hidden for the final 15 minutes. Keep pushing!</div>

    <div class="board-outer" id="boardOuter" aria-live="polite" aria-busy="true" style="display:none;">
      <table id="boardTable" aria-describedby="countdown">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="msg error" id="errorBox"></div>
    <div class="footer-bar">
      <div class="mini" id="updatedAt">Last updated ‚Äî</div>
      <button class="btn" id="refreshBtn">üîÑ Refresh</button>
    </div>
  </div>

  <script>
    /* ===== URL / TOKEN ===== */
    const qs = new URLSearchParams(location.search);
    const EVENT_ID   = qs.get('event') || qs.get('eventId') || '';
    const TEAM_TOKEN = localStorage.getItem('teamToken') || '';

    /* ===== Fetch helper ===== */
    async function callFn(path, payload){
      const res = await fetch(`/.netlify/functions/${path}`,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          ...(TEAM_TOKEN ? {'Authorization':`Bearer ${TEAM_TOKEN}`} : {})
        },
        body: JSON.stringify(payload || {})
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || data.success === false) throw new Error(data.message || `Request failed (${res.status})`);
      return data;
    }

    /* ===== Elements ===== */
    const navToggle   = document.getElementById('nav-toggle');
    const navMenu     = document.getElementById('nav-menu');
    const statePill   = document.getElementById('statePill');
    const phasePill   = document.getElementById('phasePill');
    const countdownEl = document.getElementById('countdown');
    const hintEl      = document.getElementById('hint');
    const hiddenBanner= document.getElementById('hiddenBanner');
    const boardOuter  = document.getElementById('boardOuter');
    const theadEl     = document.getElementById('thead');
    const tbodyEl     = document.getElementById('tbody');
    const errorBox    = document.getElementById('errorBox');
    const updatedAt   = document.getElementById('updatedAt');
    const refreshBtn  = document.getElementById('refreshBtn');

    navToggle?.addEventListener('click', ()=>{
      navMenu.classList.toggle('active');
      navToggle.textContent = navMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
    });

    /* ===== Timing / state ===== */
    const FIFTEEN_MIN_MS = 15 * 60 * 1000;
    let countdownTimer = null;
    let endsAtMs = null;
    let serverNowMs = null;
    let clientAtFetchMs = null;
    let lastState = 'UNKNOWN';
    let hideScores = false; // computed each tick

    function nowMs(){
      if(serverNowMs && clientAtFetchMs){
        const drift = Date.now() - clientAtFetchMs;
        return serverNowMs + drift;
      }
      return Date.now();
    }
    function fmtTime(ms){
      const t = Math.max(0, ms);
      const s = Math.floor(t/1000)%60;
      const m = Math.floor(t/60000)%60;
      const h = Math.floor(t/3600000);
      const pad = n => String(n).padStart(2,'0');
      return h>0 ? `${h}:${pad(m)}:${pad(s)}` : `${m}:${pad(s)}`;
    }
    function tryParseTs(obj){
      const fields = ['endsAt','endAt','endTime','end','end_ts','endTimestamp','endISO'];
      for(const k of fields){
        if(!obj || !obj[k]) continue;
        const v = obj[k];
        if(typeof v === 'number') return v;
        const ms = Date.parse(v);
        if(!isNaN(ms)) return ms;
      }
      return null;
    }

    function setStatePill(text, cls=''){ statePill.textContent=text; statePill.className=`pill ${cls}`; }
    function setPhasePill(text, cls=''){ phasePill.textContent=text; phasePill.className=`pill ${cls}`; phasePill.style.display = text ? 'inline-block':'none'; }
    function setError(msg){ errorBox.textContent=msg; errorBox.className='msg error'; errorBox.style.display='block'; }
    function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }

    function updateCountdown(){
      if(!endsAtMs){ countdownEl.textContent=''; hiddenBanner.style.display='none'; return; }
      const left = endsAtMs - nowMs();

      // Hide scores in last 15 minutes while RUNNING
      hideScores = lastState === 'RUNNING' && left > 0 && left <= FIFTEEN_MIN_MS;

      if(left <= 0){
        countdownEl.textContent = '‚è±Ô∏è Time‚Äôs up.';
      } else {
        countdownEl.textContent = `‚è±Ô∏è Time left: ${fmtTime(left)}`;
      }
      hiddenBanner.style.display = hideScores ? 'block' : 'none';

      // When ENDED (and not yet PUBLISHED), keep scores hidden and hint
      if(lastState === 'ENDED'){
        hideScores = true;
      }

      // Update phase pill / hint
      if(lastState === 'RUNNING'){
        if(hideScores){
          setPhasePill('Final 15 ‚Äî scores hidden', 'warn');
          hintEl.textContent = 'Keep going! Scores reappear when time runs out and results are published.';
        }else{
          setPhasePill('Live scores visible', 'ok');
          hintEl.textContent = 'Live updates while the event is running.';
        }
      } else if(lastState === 'ENDED'){
        setPhasePill('Event finished', 'warn');
        hintEl.textContent = 'Waiting for results to be published‚Ä¶';
      } else if(lastState === 'PUBLISHED'){
        setPhasePill('Final results', 'ok');
        hintEl.textContent = 'Official final standings.';
      } else if(lastState === 'PAUSED'){
        setPhasePill('Paused', 'warn');
        hintEl.textContent = 'Scores may lag while the event is paused.';
      } else if(lastState === 'NOT_STARTED'){
        setPhasePill('Not started', 'warn');
        hintEl.textContent = 'Scores will appear once the event begins.';
      }

      // Apply CSS class for hiding numbers
      tbodyEl.parentElement.classList.toggle('hidden-scores', hideScores && lastState !== 'PUBLISHED');
    }

    /* ===== Leaderboard extraction with breakdown ===== */
    const SYN = {
      clues:      ['clues','clue','cluehunt','clueHunt','treasureHunt','clue_score','clueScore'],
      quiz:       ['quiz','quizScore','trivia','timedQuiz','quiz_points','quizPoints'],
      scavenger:  ['scavenger','scavengerHunt','scav','scavengerScore','scav_points','scavPoints'],
      kindness:   ['kindness','kindnessScore','heart','heartTreasure','kindness_points'],
      limerick:   ['limerick','limerickScore','poem','verse','limerick_points'],
      bonus:      ['bonus','bonuses','bonusPoints','bonus_points'],
      penalties:  ['penalties','penalty','deductions','penaltyPoints','penalty_points','penaltyScore']
    };

    function lowerKeyMap(obj){
      const map = {};
      for(const k in obj){ map[k.toLowerCase()] = obj[k]; }
      return map;
    }
    function getValBySyn(obj, synArr){
      const m = lowerKeyMap(obj || {});
      for(const s of synArr){
        const v = m[s.toLowerCase()];
        const n = Number(v);
        if(Number.isFinite(n)) return n;
      }
      return 0;
    }

    function extractRows(data){
      const list = Array.isArray(data?.leaderboard) ? data.leaderboard
                 : Array.isArray(data?.teams) ? data.teams
                 : [];
      return list.map(r=>{
        const total = Number(r.finalScore ?? r.total ?? r.score ?? r.points ?? 0) || 0;
        return {
          teamName: r.teamName || r.name || '',
          teamCode: r.teamCode || r.code || '',
          total,
          raw: r
        };
      });
    }

    function detectColumns(rows){
      // Decide which breakdown columns to show by presence across any row
      const defs = [
        {id:'clues',     label:'Clues',      syn:SYN.clues,      cls:'col-score'},
        {id:'quiz',      label:'Quiz',       syn:SYN.quiz,       cls:'col-score'},
        {id:'scavenger', label:'Scavenger',  syn:SYN.scavenger,  cls:'col-score'},
        {id:'kindness',  label:'Kindness',   syn:SYN.kindness,   cls:'col-score'},
        {id:'limerick',  label:'Limerick',   syn:SYN.limerick,   cls:'col-score'},
        {id:'bonus',     label:'Bonus',      syn:SYN.bonus,      cls:'col-score bonus'},
        {id:'penalties', label:'Penalties',  syn:SYN.penalties,  cls:'col-score penalty'}
      ];
      return defs.filter(d => rows.some(r => getValBySyn(r.raw, d.syn) !== 0));
    }

    function buildHeader(cols){
      const ths = [
        `<th class="col-rank">Rank</th>`,
        `<th class="col-team">Team</th>`,
        `<th class="col-total">Total</th>`,
        ...cols.map(c=>`<th class="${c.cls}">${c.label}</th>`)
      ].join('');
      theadEl.innerHTML = `<tr>${ths}</tr>`;
    }

    function renderBody(rows, cols, hide){
      tbodyEl.innerHTML = '';
      if(!rows.length){
        tbodyEl.innerHTML = `<tr><td class="col-rank">‚Äî</td><td class="col-team muted">No teams yet</td><td class="col-total">‚Äî</td>${cols.map(()=>'<td class="col-score">‚Äî</td>').join('')}</tr>`;
        return;
      }

      let list = [...rows];
      if(hide){
        // Alphabetical during hidden period to avoid leaking rank
        list.sort((a,b)=> (a.teamName||'').localeCompare(b.teamName||''));
      } else {
        list.sort((a,b)=> (b.total - a.total
