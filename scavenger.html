<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TeamQuest ¬∑ Scavenger Hunt</title>
<style>
  :root{
    --brown:#6f4426; --brown-d:#53321c; --tan:#f5e6d3; --tan-2:#ead7c0;
    --gold:#daa520; --gold-2:#ffb648; --error:#8b0000; --ok:#0b6b2e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
    background:linear-gradient(135deg,#8b5a2b,#a1642f 40%,#f4a460);
    color:#2a1a10
  }

  /* Nav */
  .nav{
    position:fixed;inset:0 0 auto 0;height:64px;z-index:50;
    background:linear-gradient(135deg,#8b4513,#5d361d);border-bottom:3px solid var(--gold);
    display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.35)
  }
  .nav-inner{width:100%;max-width:1200px;display:flex;align-items:center;gap:16px;padding:0 16px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
  .brand img{height:40px;width:auto;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.6))}
  .links{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
  .nav a{
    color:#f5e6d3;text-decoration:none;font-weight:700;font-size:14px;padding:8px 12px;
    border:2px solid rgba(218,165,32,.5);border-radius:10px;background:rgba(255,255,255,.06)
  }
  .nav a:hover{background:linear-gradient(135deg,#daa520,#ff8c00);color:#fff;border-color:#daa520}
  .nav .active{background:linear-gradient(135deg,#d2a146,#b78020);color:#fff;border-color:#daa520}

  /* Shell */
  .page{max-width:980px;margin:96px auto 24px;padding:16px}
  .card{
    background:linear-gradient(145deg,var(--tan),var(--tan-2));border:3px solid var(--brown);
    border-radius:18px;padding:18px;box-shadow:0 18px 36px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.35);
    position:relative
  }
  .card:before{
    content:"";position:absolute;left:12px;right:12px;top:12px;bottom:12px;
    border:2px solid #daa520;border-radius:14px;pointer-events:none
  }

  /* Buttons */
  .btn{
    appearance:none;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800;
    display:inline-flex;align-items:center;gap:8px
  }
  .btn:active{transform:translateY(1px)}
  .btn-gold{background:linear-gradient(135deg,var(--gold-2),#daa520);color:#301c0e;border:3px solid #53321c}
  .btn-ghost{background:transparent;border:2px solid #daa520;color:#5a3b1f}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* Forms */
  .row{display:grid;gap:12px}
  .grid-2{grid-template-columns:1fr 1fr}
  @media (max-width:780px){.grid-2{grid-template-columns:1fr}}
  label{font-weight:700;color:#6b3f23;margin-bottom:4px;display:block}
  input,select{
    width:100%;padding:12px;border-radius:12px;border:3px solid #daa520;background:#fff;font-size:15px;font-family:inherit
  }

  .crew-strip{
    background:linear-gradient(135deg,#8b4513,#a0522d);color:#fff;padding:12px 14px;border:2px solid #daa520;
    border-radius:12px;font-weight:800;margin-bottom:10px;display:none
  }

  .alert{display:none;padding:12px 14px;border-radius:12px;border:3px solid;font-weight:700;text-align:center}
  .alert-ok{background:#e7f7ea;color:#0b6b2e;border-color:#2f9a4a}
  .alert-err{background:#ffe4e7;color:#8b0000;border-color:#b20a20}

  .quick{background:#fffdf6;border:2px dashed #daa520;border-radius:12px;padding:10px 12px;margin:8px 0 12px}
  .checks{display:grid;grid-template-columns:1fr;gap:8px}
  .checks label{
    border:2px dashed #daa520;border-radius:12px;padding:10px;background:#fff;display:flex;align-items:center;gap:10px;
    cursor:pointer;user-select:none
  }
  .checks input{width:auto}
  .checks label.done{opacity:.55;filter:grayscale(.3);background:#f6f1e5}
  .checks label.done .tag{margin-left:auto;font-size:12px;border:2px dashed #daa520;border-radius:999px;padding:2px 8px;background:#fff}

  .uploader{border:4px dashed #daa520;border-radius:16px;padding:16px;text-align:center;background:#fffef7}
  .uploader.has-file{border-style:solid;background:#f2ffef;border-color:#2f9a4a}

  .dimmed{opacity:.5;pointer-events:none}
  .footer-note{font-size:12px;opacity:.8;text-align:center;margin-top:8px}
</style>
</head>
<body>
<nav class="nav">
  <div class="nav-inner">
    <a class="brand" href="/"><img src="/Team Quest Logo-01.png" alt="TeamQuest"></a>
    <div class="links">
      <a href="https://theteamquest.netlify.app/clue_hunt">Treasure Hunt</a>
      <a class="active" href="#">Scavenger</a>
      <a href="https://theteamquest.netlify.app/quiz">Timed Quiz</a>
      <a href="https://theteamquest.netlify.app/kindness">Kindness</a>
      <a href="https://theteamquest.netlify.app/limerick">Limerick</a>
      <a href="https://theteamquest.netlify.app/leaderboard">Leaderboard</a>
      <a href="https://theteamquest.netlify.app/gallery">Gallery</a>
    </div>
  </div>
</nav>

<main class="page">
  <section class="card">
    <!-- Sign-in -->
    <form id="loginForm" class="row" autocomplete="off">
      <div class="row grid-2">
        <div>
          <label for="teamSelect">Crew</label>
          <select id="teamSelect" required><option value="">Loading crews‚Ä¶</option></select>
        </div>
        <div>
          <label for="pin">4-digit PIN</label>
          <input id="pin" type="text" inputmode="numeric" pattern="[0-9]{4}" minlength="4" maxlength="4" placeholder="1234" required />
          <div style="font-size:12px;color:#6b3f23">Exactly 4 digits</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-gold" type="submit">üîì Sign in</button>
        <button class="btn btn-ghost" type="button" id="refreshCrewsBtn">‚ü≥ Reload crews</button>
      </div>
      <div id="loginAlert" class="alert"></div>
    </form>

    <div id="crewStrip" class="crew-strip"></div>

    <!-- Quick rules -->
    <div class="quick" id="quickRules" style="display:none">
      <strong>Quick rules</strong>
      <ul style="margin:8px 0 0 16px;padding:0">
        <li>Upload 1 photo per submit.</li>
        <li>Tick what it is. Boom. üè¥‚Äç‚ò†Ô∏è</li>
      </ul>
    </div>

    <!-- Scavenger form -->
    <form id="scavForm" class="row" style="display:none">
      <div class="uploader" id="uploaderBox">
        <p id="uploadText">üì∏ Add your photo</p>
        <input type="file" id="file" accept="image/*" style="display:none" />
        <button type="button" class="btn btn-gold" id="pickBtn">Upload photo</button>
        <div style="font-size:12px;color:#6b3f23">Required ‚Ä¢ JPEG/PNG/WebP ‚Ä¢ Max ~20MB</div>
      </div>

      <div>
        <label>Pick what applies</label>
        <div class="checks" id="checks"></div>
      </div>

      <button type="submit" class="btn btn-gold" id="submitBtn">üöÄ Submit find</button>
      <div class="footer-note" id="busyNote" style="display:none">Submitting‚Ä¶ hold tight ‚ö°</div>
      <div id="formAlert" class="alert"></div>
    </form>
  </section>
</main>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const eventId = (qs.get('eventId') || qs.get('event') || '').trim();
  const el = id => document.getElementById(id);

  // UI refs
  const loginForm = el('loginForm'), loginAlert = el('loginAlert'), refreshCrewsBtn = el('refreshCrewsBtn');
  const teamSelect = el('teamSelect'), pinInput = el('pin');
  const crewStrip = el('crewStrip'), quickRules = el('quickRules');
  const scavForm = el('scavForm'), formAlert = el('formAlert'), submitBtn = el('submitBtn'), busyNote = el('busyNote');
  const pickBtn = el('pickBtn'), fileInput = el('file'), uploaderBox = el('uploaderBox'), uploadText = el('uploadText');
  const checks = el('checks');

  const STORAGE_TEAM  = keyFor('team');        // tq_<event>_team  -> {code,name}
  const STORAGE_TOKEN = keyFor('token');       // tq_<event>_token
  const DONE_KEY = code => `tq_${eventId}_done_${code}`; // submitted item ids per team

  let TEAMS = [];
  let signedTeam = null;

  // Stable IDs + labels
  const ITEMS = [
    { id:'british_coin_2023', title:'Any British coin dated 2023' },
    { id:'paperclip',         title:'A Paperclip' },
    { id:'snail_shell',       title:'A Snail Shell' },
    { id:'feather',           title:'A Feather' },
    { id:'elastic_band',      title:'An Elastic Band' },
    { id:'golf_tee',          title:'A Golf Tee' }
  ];

  init();

  async function init(){
    wireUI();
    renderItems();           // first paint (no team yet ‚Üí no locks)
    await loadCrews();
    hydrateFromStorage();    // set signedTeam if remembered
    renderItems();           // re-render with possible locks
    if (signedTeam) await syncLocksFromServer(); // cross-device sync on load
    maybeShowForm();
  }

  function wireUI(){
    refreshCrewsBtn.addEventListener('click', loadCrews);
    loginForm.addEventListener('submit', onSignIn);
    pickBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', onFilePicked);
    scavForm.addEventListener('submit', onSubmit);
  }

  // ---------- Render items with team locks ----------
  function getDoneSet(){
    if(!signedTeam) return new Set();
    try { return new Set(JSON.parse(localStorage.getItem(DONE_KEY(signedTeam.code)) || '[]')); }
    catch { return new Set(); }
  }
  function saveDoneSet(set){
    if(!signedTeam) return;
    localStorage.setItem(DONE_KEY(signedTeam.code), JSON.stringify([...set]));
  }

  function renderItems(){
    const done = getDoneSet();
    checks.innerHTML = "";
    ITEMS.forEach((it)=>{
      const row = document.createElement('label');
      const isDone = done.has(it.id);
      row.className = isDone ? 'done' : '';
      row.innerHTML = `<input type="checkbox" ${isDone?'disabled':''} value="${escapeHtml(it.title)}" data-id="${it.id}">
                       <span>${escapeHtml(it.title)}</span>
                       ${isDone?'<span class="tag">Submitted</span>':''}`;
      checks.appendChild(row);
    });
  }

  // ---------- Crews ----------
  async function loadCrews(){
    teamSelect.innerHTML = `<option value="">Loading crews‚Ä¶</option>`;
    try{
      const url = `/.netlify/functions/get_leaderboard?eventId=${encodeURIComponent(eventId)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const list = Array.isArray(data.teams) ? data.teams : Array.isArray(data.leaderboard) ? data.leaderboard : null;
      if(!list) throw new Error('No crews array');
      TEAMS = list.filter(t=>t && t.teamCode && t.teamName).map(t=>({teamCode:String(t.teamCode), teamName:String(t.teamName)}))
                  .sort((a,b)=>a.teamName.localeCompare(b.teamName));
      teamSelect.innerHTML = `<option value="">Select crew‚Ä¶</option>` + TEAMS.map(t=>`<option value="${escapeHtml(t.teamCode)}">${escapeHtml(t.teamName)}</option>`).join('');
      showLoginInfo('');
    }catch(e){
      TEAMS = [];
      teamSelect.innerHTML = `<option value="">‚Äî</option>`;
      showLoginError("Couldn't load crews. Refresh and try again.");
    }
  }

  // ---------- Sign-in ----------
  async function onSignIn(ev){
    ev.preventDefault(); clearLoginAlert();
    const teamCode = teamSelect.value.trim();
    const pin = (pinInput.value||'').trim();
    if(!teamCode) return showLoginError('Pick your crew first.');
    if(!/^\d{4}$/.test(pin)) return showLoginError('Enter a 4-digit PIN.');
    try{
      const res = await fetch('/.netlify/functions/verify_team_pin_function', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ eventId, teamCode, pin })
      });
      if(res.status===404 || res.status>=500) return showLoginError('Sign-in service unavailable. Try again later.');
      if(!res.ok) return showLoginError('Sign-in failed. Try again.');
      const json = await res.json();
      if(json.success && json.valid===false) return showLoginError("PIN doesn‚Äôt match this crew.");
      if(!json.success) return showLoginError('Sign-in failed. Try again.');

      const t = TEAMS.find(x=>x.teamCode===teamCode);
      signedTeam = { code: teamCode, name: t ? t.teamName : 'Crew' };
      if(json.token) localStorage.setItem(STORAGE_TOKEN, json.token);
      localStorage.setItem(STORAGE_TEAM, JSON.stringify(signedTeam));
      showCrewStrip(); showForm();
      await syncLocksFromServer(); // cross-device sync on sign-in
      renderItems(); // refresh locks for this team
    }catch(e){ showLoginError('Sign-in service unavailable. Try again later.'); }
  }

  function hydrateFromStorage(){
    try{
      const raw = localStorage.getItem(STORAGE_TEAM);
      if(raw){
        const t = JSON.parse(raw);
        if(t && t.code && t.name){ signedTeam = { code:t.code, name:t.name }; showCrewStrip(); }
      }
    }catch{}
  }
  function maybeShowForm(){ if(signedTeam) showForm(); else loginForm.style.display='grid'; }
  function showCrewStrip(){ crewStrip.style.display='block'; crewStrip.textContent = `Crew: ${signedTeam.name}`; }
  function showForm(){ loginForm.style.display='none'; quickRules.style.display='block'; scavForm.style.display='grid'; }

  // ---------- Cross-device lock sync ----------
  async function syncLocksFromServer(){
    if(!signedTeam) return;
    try{
      const headers = { 'Content-Type':'application/json' };
      const tok = localStorage.getItem(STORAGE_TOKEN);
      if(tok) headers['Authorization'] = `Bearer ${tok}`;

      const res = await fetch('/.netlify/functions/get_scavenger_submissions_function', {
        method:'POST', headers, body: JSON.stringify({ eventId, teamCode: signedTeam.code })
      });
      if(!res.ok) return; // silent if unavailable
      const data = await res.json();

      const union = getDoneSet();
      if (Array.isArray(data?.submissions)) {
        data.submissions.forEach(s=>{
          if (s.itemId) union.add(String(s.itemId));
          if (Array.isArray(s.items)) {
            s.items.forEach(lbl=>{
              const m = ITEMS.find(it=>it.title===lbl);
              if (m) union.add(m.id);
            });
          }
        });
      }
      if (Array.isArray(data?.itemIds)) data.itemIds.forEach(id=>union.add(String(id)));

      saveDoneSet(union);
      renderItems();
    }catch(_){ /* ignore */ }
  }

  // ---------- Uploadcare ----------
  function onFilePicked(){
    const f = fileInput.files && fileInput.files[0];
    if(!f){ uploaderBox.classList.remove('has-file'); uploadText.textContent='üì∏ Add your photo'; return; }
    const ok = ['image/jpeg','image/jpg','image/png','image/webp'];
    if(!ok.includes(f.type)) return toast(formAlert,'Use JPEG/PNG/WebP.',false);
    if(f.size>20*1024*1024) return toast(formAlert,'Image too large (max ~20MB).',false);
    uploaderBox.classList.add('has-file'); uploadText.textContent = `‚úÖ ${f.name}`;
  }
  async function uploadToUploadcare(file){
    const form = new FormData();
    form.append('UPLOADCARE_PUB_KEY','e060d7b73e9b8e15de28');
    form.append('file', file);
    const res = await fetch('https://upload.uploadcare.com/base/', { method:'POST', body:form });
    if(!res.ok) throw new Error(`Upload failed (${res.status})`);
    const j = await res.json();
    if(!j.file) throw new Error('No file id');
    return `https://ucarecdn.com/${j.file}/`;
  }

  // ---------- Submit (checks event state silently) ----------
  async function onSubmit(ev){
    ev.preventDefault(); clearFormAlert();
    if(!signedTeam) return toast(formAlert,'Sign in first.',false);

    // Live event-state check (no banner)
    try{
      const r = await fetch('/.netlify/functions/get_event_state', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ eventId })
      });
      const j = await r.json().catch(()=>({}));
      const st = (j && j.state || '').toUpperCase();
      if(st !== 'RUNNING') return toast(formAlert,'Submissions are closed right now.',false);
    }catch{ /* if unknown, continue to try submit */ }

    const file = fileInput.files && fileInput.files[0];
    if(!file) return toast(formAlert,'Add a photo.',false);

    const checked = Array.from(checks.querySelectorAll('input[type=checkbox]:checked'));
    if(checked.length<1) return toast(formAlert,'Tick at least one item.',false);

    const title = checked[0].value;
    const itemDef = ITEMS.find(x=>x.title===title) || ITEMS[0];

    const done = getDoneSet();
    if(done.has(itemDef.id)) return toast(formAlert,'That one is already submitted for this crew.',false);

    const description = buildAutoDescription(checked.map(c=>c.value));

    disableForm(true);
    try{
      const photoUrl = await uploadToUploadcare(file);

      const payload = {
        // legacy fields
        teamCode: signedTeam.code,
        teamName: signedTeam.name,
        itemId: itemDef.id,
        itemTitle: itemDef.title,
        itemDescription: description,
        maxPoints: 15,
        photoUrl,
        // new fields
        eventId,
        items: checked.map(c=>c.value),
        description
      };

      const headers = { 'Content-Type':'application/json' };
      const token = localStorage.getItem(STORAGE_TOKEN);
      if(token) headers['Authorization'] = `Bearer ${token}`;

      const res = await fetch('/.netlify/functions/submit_scavenger_function', {
        method:'POST', headers, body: JSON.stringify(payload)
      });

      const text = await res.text();
      let msg = text;
      try{ const j = JSON.parse(text); msg = j.message || JSON.stringify(j); if(j.success) msg=''; }catch{}
      if(!res.ok) throw new Error(`HTTP ${res.status}${msg?` (${msg})`:''}`);

      done.add(itemDef.id);
      saveDoneSet(done);
      renderItems();
      toast(formAlert,"üéâ Submitted! Terry‚Äôs tallymaster is reviewing. Check the leaderboard in a few minutes to see your doubloons.",true);
      lockAfterSuccess();
      syncLocksFromServer();
    }catch(e){
      console.error('Submit error:', e);
      toast(formAlert, `Submission failed. ${e.message||''}`.trim(), false);
      disableForm(false);
    }
  }

  function buildAutoDescription(labels){
    let s = `Find: ${labels.join(', ')}`;
    if(s.length < 20) s += ' ‚Äî TeamQuest scavenger';
    return s;
  }

  function lockAfterSuccess(){
    uploaderBox.classList.add('dimmed');
    document.querySelectorAll('#scavForm input, #scavForm button').forEach(n=>n.disabled = true);
  }
  function disableForm(v){
    busyNote.style.display = v ? 'block' : 'none';
    submitBtn.disabled = v;
    document.querySelectorAll('#scavForm input, #scavForm button').forEach(n=>{ if(n!==submitBtn) n.disabled = v; });
  }

  // helpers
  function keyFor(kind){ return `tq_${eventId}_${kind}`; }
  function toast(node,msg,ok){ node.className=`alert ${ok?'alert-ok':'alert-err'}`; node.textContent=msg; node.style.display='block'; }
  function clearLoginAlert(){ loginAlert.style.display='none'; }
  function clearFormAlert(){ formAlert.style.display='none'; }
  function showLoginError(msg){ loginAlert.className='alert alert-err'; loginAlert.textContent=msg; loginAlert.style.display='block'; }
  function showLoginInfo(msg){ if(!msg){ loginAlert.style.display='none'; return; } loginAlert.className='alert alert-ok'; loginAlert.textContent=msg; loginAlert.style.display='block'; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
})();
</script>
</body>
</html>
