<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>TeamQuest ‚Äì The Scavenger Hunt</title>

<link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet"/>

<style>
  :root{
    --bg:url("/TQ%20Web%20extended%20background-100.jpg");
    --ink:#2E2114; --ink-soft:#6A5A47;
    --parchment:#F7EED8; --parchment-2:#F3E6CF;
    --gold:#F0C433; --gold-deep:#A7711F;
    --ok:#1F6E38; --okbg:#CFF2DA; --err:#B42318;
    --radius-card:22px; --radius-input:16px;
    --shadow-card:0 18px 40px rgba(0,0,0,.35);
    --gutter:22px; --nav-h:64px; --hero-h:260px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); font-family:"Handlee", ui-rounded, "Segoe UI", system-ui, -apple-system, sans-serif;
    background: linear-gradient(180deg, rgba(0,0,0,.24), rgba(0,0,0,.45)), var(--bg);
    background-size:cover; background-position:top center; background-attachment:fixed;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    padding-top:var(--nav-h);
  }

  /* NAV */
  .treasure-nav{position:fixed; inset:0 0 auto 0; height:var(--nav-h); z-index:1000;
    backdrop-filter:saturate(120%) blur(6px);
    background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
    border-bottom:1px solid rgba(255,255,255,.18);
  }
  .nav-container{height:100%; max-width:1000px; margin:0 auto; padding:0 12px;
    display:flex; align-items:center; justify-content:space-between}
  .nav-logo img{height:40px; width:auto; display:block; filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}
  .nav-toggle{background:none;border:none;color:#F7EED8;font-size:1.6rem;cursor:pointer}
  .nav-menu{
    position:fixed; top:var(--nav-h); left:-100%; width:100%; height:calc(100vh - var(--nav-h));
    background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,.6));
    display:flex; flex-direction:column; align-items:center; gap:14px; padding:18px 14px; transition:left .25s;
  }
  .nav-menu.active{left:0}
  .nav-link,.dropdown-link{
    display:block; width:92%; max-width:360px; text-align:center; text-decoration:none;
    color:#F7EED8; font-weight:900; padding:12px 14px; border-radius:14px;
    background:rgba(247,238,216,.18); border:1px solid rgba(255,255,255,.25);
  }
  .nav-link:hover,.dropdown-link:hover{background:rgba(247,238,216,.28)}

  /* HERO */
  .hero{min-height:var(--hero-h); display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
    padding:24px var(--gutter) 20px; text-align:center}
  .brand-logo{width:min(240px,68vw); height:auto; margin-bottom:10px;
    filter: drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 10px 24px rgba(0,0,0,.35))}
  .hero-title{font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight:900; font-size:22px; color:#F7EED8; text-shadow:0 2px 6px rgba(0,0,0,.6)}

  /* STACK / CARDS */
  .stack{ padding:0 var(--gutter) 28px; }
  .card{ background:var(--parchment); border-radius:var(--radius-card); box-shadow:var(--shadow-card);
    padding:18px 16px; border:1px solid rgba(0,0,0,.06); margin:0 auto 18px; width:100%; max-width:980px }
  .card h2{ margin:0 0 10px; text-align:center;
    font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; font-weight:900; font-size:24px; color:var(--ink)}

  /* Sign-in */
  .auth-card{ background:var(--parchment-2); border-radius:16px; border:1px solid rgba(0,0,0,.08); padding:16px; }
  .auth-grid{ display:grid; grid-template-columns:1fr 150px; gap:10px }
  @media (max-width:560px){ .auth-grid{ grid-template-columns:1fr } }
  label{ display:block; margin:0 6px 6px; font-size:18px; font-weight:800; color:var(--ink) }
  select,input[type="text"]{
    width:100%; padding:14px 12px; border-radius:16px; border:3px solid var(--gold);
    background:#fff; color:var(--ink); font-size:18px;
  }
  .small-btn{ background:linear-gradient(90deg,#FDBA2D,#F0C433); color:#442812; font-weight:900; font-size:16px;
    border-radius:12px; border:3px solid #A7711F; padding:10px 14px; cursor:pointer; box-shadow:0 8px 18px rgba(0,0,0,.2) }

  /* Messages */
  .alert{display:none; padding:12px 14px; border-radius:12px; border:3px solid; font-weight:800; text-align:center; margin-top:10px}
  .alert-ok{display:block; background:var(--okbg); border-color:var(--ok); color:#064b06}
  .alert-err{display:block; background:linear-gradient(135deg,#FFB6C1 0%,#FFA0B4 100%); border-color:#DC143C; color:#8B0000}

  /* Uploader + checks */
  .uploader{border:4px dashed var(--gold); border-radius:16px; padding:16px; text-align:center; background:#FFF9EA}
  .uploader.has-file{border-style:solid; background:#EAF8EF; border-color:#2f9a4a}
  .checks{display:grid; grid-template-columns:1fr; gap:8px}
  .checks label{border:2px dashed var(--gold); border-radius:12px; padding:10px; background:#fff;
    display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; font-weight:800; color:var(--ink)}
  .checks label.done{opacity:.55; filter:grayscale(.3); background:#f6f1e5}
  .checks label.done .tag{margin-left:auto; font-size:12px; border:2px dashed var(--gold); border-radius:999px; padding:2px 8px; background:#fff}

  .submit-btn{ width:100%; background:linear-gradient(90deg,#FDBA2D,#F0C433); color:#442812; font-weight:900; font-size:18px;
    border-radius:16px; border:3px solid #A7711F; padding:16px; cursor:pointer; margin-top:6px; box-shadow:0 10px 22px rgba(0,0,0,.25) }
  .submit-btn:disabled{opacity:.6; cursor:not-allowed}
  .muted{font-size:12px; color:#6A5A47}
</style>
</head>
<body>
  <!-- NAV -->
  <nav class="treasure-nav" id="treasure-nav">
    <div class="nav-container">
      <a href="https://theteamquest.netlify.app/" class="nav-logo" aria-label="TeamQuest Home">
        <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest Logo">
      </a>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle menu">‚ò∞</button>
    </div>
    <ul class="nav-menu" id="nav-menu" role="menu">
      <!-- Exclude current page (Scavenger) -->
      <li><a href="https://theteamquest.netlify.app/clue_hunt" class="nav-link" role="menuitem">üíé The Treasure Hunt</a></li>
      <li><a href="https://theteamquest.netlify.app/quiz" class="nav-link" role="menuitem">‚è∞ The Timed Quiz</a></li>
      <li><a href="https://theteamquest.netlify.app/limerick" class="nav-link" role="menuitem">üìù The Limerick Challenge</a></li>
      <li><a href="/kindness" class="nav-link" role="menuitem">üíñ Kindness</a></li>
      <li><a href="https://theteamquest.netlify.app/leaderboard" class="dropdown-link" role="menuitem">üèÜ The Leaderboard</a></li>
      <li><a href="https://theteamquest.netlify.app/gallery" class="dropdown-link" role="menuitem">üì∏ The Gallery</a></li>
    </ul>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <img src="/Team%20Quest%20Logo-01.png" alt="TeamQuest" class="brand-logo" width="640" height="480">
    <div class="hero-title">The Scavenger Hunt</div>
  </header>

  <main class="stack">
    <!-- Sign in -->
    <section class="card auth-card" aria-live="polite">
      <h2>Sign in</h2>
      <div class="auth-grid">
        <div>
          <label for="teamSelect">Choose your crew</label>
          <select id="teamSelect">
            <option value="">Loading crews‚Ä¶</option>
          </select>
        </div>
        <div>
          <label for="pin">Crew PIN</label>
          <input id="pin" type="text" inputmode="numeric" pattern="[0-9]{4}" minlength="4" maxlength="4" placeholder="1234"/>
          <div class="muted">Exactly 4 digits</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <button id="signinBtn" class="small-btn">üîì Sign in</button>
        <button id="refreshCrewsBtn" class="small-btn" style="background:#fff;border-color:#F0C433">‚ü≥ Reload crews</button>
      </div>
      <div id="loginAlert" class="alert"></div>
    </section>

    <!-- Team chip -->
    <section class="card" id="signedCard" style="display:none">
      <div class="team-info" id="crewStrip" style="display:flex;align-items:center;justify-content:center;background:#D7C39B;color:var(--ink);border:3px dashed rgba(0,0,0,.6);border-radius:14px;padding:10px 14px;font-weight:900">
        Crew: ‚Äî
      </div>
      <div class="muted" style="margin-top:8px">Upload one photo per submit, tick what it is, done. üè¥‚Äç‚ò†Ô∏è</div>
    </section>

    <!-- Submit -->
    <section class="card" id="formCard" style="display:none">
      <div class="uploader" id="uploaderBox">
        <p id="uploadText">üì∏ Add your photo</p>
        <input type="file" id="file" accept="image/*" style="display:none"/>
        <button type="button" class="small-btn" id="pickBtn">Upload photo</button>
        <div class="muted">JPEG/PNG/WebP ‚Ä¢ Max ~20MB</div>
      </div>

      <div style="margin-top:12px">
        <label>Pick what applies</label>
        <div class="checks" id="checks"></div>
      </div>

      <button class="submit-btn" id="submitBtn">üöÄ Submit find</button>
      <div id="formAlert" class="alert" style="margin-top:10px"></div>
    </section>
  </main>

  <script>
    // --- Nav toggle
    const navToggle = document.getElementById('nav-toggle');
    const navMenu   = document.getElementById('nav-menu');
    navToggle?.addEventListener('click', ()=> {
      navMenu.classList.toggle('active');
      navToggle.textContent = navMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
    });
    document.querySelectorAll('.nav-link, .dropdown-link').forEach(a=>{
      a.addEventListener('click', ()=>{ navMenu.classList.remove('active'); navToggle.textContent='‚ò∞'; });
    });

    // --- Core
    (function(){
      const qs = new URLSearchParams(location.search);
      const eventId = (qs.get('eventId') || qs.get('event') || '').trim();
      const el = id => document.getElementById(id);

      // UI refs
      const loginAlert = el('loginAlert'), refreshCrewsBtn = el('refreshCrewsBtn');
      const teamSelect = el('teamSelect'), pinInput = el('pin'), signinBtn = el('signinBtn');
      const signedCard = el('signedCard'), crewStrip = el('crewStrip');
      const formCard = el('formCard'), formAlert = el('formAlert'), submitBtn = el('submitBtn');
      const pickBtn = el('pickBtn'), fileInput = el('file'), uploaderBox = el('uploaderBox'), uploadText = el('uploadText');
      const checks = el('checks');

      const STORAGE_TEAM  = keyFor('team');
      const STORAGE_TOKEN = keyFor('token');
      const DONE_KEY = code => `tq_${eventId}_done_${code}`;
      let TEAMS = [], signedTeam = null;

      // Items
      const ITEMS = [
        { id:'british_coin_2023', title:'Any British coin dated 2023' },
        { id:'paperclip',         title:'A Paperclip' },
        { id:'snail_shell',       title:'A Snail Shell' },
        { id:'feather',           title:'A Feather' },
        { id:'elastic_band',      title:'An Elastic Band' },
        { id:'golf_tee',          title:'A Golf Tee' }
      ];

      // Boot
      wireUI();
      renderItems();
      loadCrews();
      hydrateFromStorage();
      maybeShowForm();

      function wireUI(){
        refreshCrewsBtn.addEventListener('click', loadCrews);
        signinBtn.addEventListener('click', onSignIn);
        pickBtn.addEventListener('click', ()=> fileInput.click());
        fileInput.addEventListener('change', onFilePicked);
        submitBtn.addEventListener('click', onSubmit);
      }

      // Teams
      async function loadCrews(){
        teamSelect.innerHTML = '<option value="">Loading crews‚Ä¶</option>';
        try{
          const url = '/.netlify/functions/get_leaderboard?eventId=' + encodeURIComponent(eventId);
          const res = await fetch(url);
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          const list = Array.isArray(data.teams) ? data.teams : Array.isArray(data.leaderboard) ? data.leaderboard : [];
          TEAMS = list.filter(t=>t && t.teamCode && t.teamName)
                      .map(t=>({teamCode:String(t.teamCode), teamName:String(t.teamName)}))
                      .sort((a,b)=>a.teamName.localeCompare(b.teamName));
          teamSelect.innerHTML = '<option value="">Choose your crew‚Ä¶</option>' +
            TEAMS.map(t=>`<option value="${escapeHtml(t.teamCode)}">${escapeHtml(t.teamName)}</option>`).join('');
          showLoginInfo('');
        }catch(e){
          TEAMS = [];
          teamSelect.innerHTML = '<option value="">‚Äî</option>';
          showLoginError('Couldn‚Äôt load crews. Refresh and try again.');
        }
      }

      async function onSignIn(){
        clearLoginAlert();
        const teamCode = teamSelect.value.trim();
        const pin = (pinInput.value||'').trim();
        if(!teamCode) return showLoginError('Pick your crew first.');
        if(!/^\d{4}$/.test(pin)) return showLoginError('Enter a 4-digit PIN.');
        try{
          const res = await fetch('/.netlify/functions/verify_team_pin_function', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ eventId, teamCode, pin })
          });
          if(res.status===404 || res.status>=500) return showLoginError('Sign-in service unavailable.');
          if(!res.ok) return showLoginError('Sign-in failed. Try again.');
          const json = await res.json();
          if(json.success && json.valid===false) return showLoginError('PIN doesn‚Äôt match this crew.');
          if(!json.success) return showLoginError('Sign-in failed. Try again.');

          const t = TEAMS.find(x=>x.teamCode===teamCode);
          signedTeam = { code: teamCode, name: t ? t.teamName : 'Crew' };
          if(json.token) localStorage.setItem(STORAGE_TOKEN, json.token);
          localStorage.setItem(STORAGE_TEAM, JSON.stringify(signedTeam));

          crewStrip.textContent = 'Crew: ' + signedTeam.name;
          signedCard.style.display = 'block';
          formCard.style.display = 'block';
          await syncLocksFromServer();
          renderItems();
        }catch(e){ showLoginError('Sign-in service unavailable. Try again later.'); }
      }

      function hydrateFromStorage(){
        try{ const raw = localStorage.getItem(STORAGE_TEAM);
          if(raw){ const t = JSON.parse(raw); if(t && t.code && t.name){ signedTeam = { code:t.code, name:t.name }; crewStrip.textContent = 'Crew: ' + t.name; signedCard.style.display='block'; } }
        }catch{}
      }
      function maybeShowForm(){ if(signedTeam){ formCard.style.display='block'; } }

      // Locks
      function getDoneSet(){ if(!signedTeam) return new Set(); try{ return new Set(JSON.parse(localStorage.getItem(DONE_KEY(signedTeam.code)) || '[]')); }catch{ return new Set(); } }
      function saveDoneSet(set){ if(!signedTeam) return; localStorage.setItem(DONE_KEY(signedTeam.code), JSON.stringify([...set])); }

      async function syncLocksFromServer(){
        if(!signedTeam) return;
        try{
          const headers = { 'Content-Type':'application/json' };
          const tok = localStorage.getItem(STORAGE_TOKEN); if(tok) headers['Authorization'] = `Bearer ${tok}`;
          const res = await fetch('/.netlify/functions/get_scavenger_submissions_function', {
            method:'POST', headers, body: JSON.stringify({ eventId, teamCode: signedTeam.code })
          });
          if(!res.ok) return;
          const data = await res.json();
          const union = getDoneSet();
          if (Array.isArray(data?.submissions)) {
            data.submissions.forEach(s=>{ if (s.itemId) union.add(String(s.itemId)); if(Array.isArray(s.items)){ s.items.forEach(lbl=>{ const m = ITEMS.find(it=>it.title===lbl); if(m) union.add(m.id); }); } });
          }
          if (Array.isArray(data?.itemIds)) data.itemIds.forEach(id=>union.add(String(id)));
          saveDoneSet(union); renderItems();
        }catch{}
      }

      // UI render
      function renderItems(){
        const done = getDoneSet();
        checks.innerHTML = "";
        ITEMS.forEach(it=>{
          const isDone = done.has(it.id);
          const row = document.createElement('label');
          row.className = isDone ? 'done' : '';
          row.innerHTML = `<input type="checkbox" ${isDone?'disabled':''} value="${escapeHtml(it.title)}" data-id="${it.id}">
                           <span>${escapeHtml(it.title)}</span>${isDone?'<span class="tag">Submitted</span>':''}`;
          checks.appendChild(row);
        });
      }

      // Upload
      function onFilePicked(){
        const f = fileInput.files && fileInput.files[0];
        if(!f){ uploaderBox.classList.remove('has-file'); uploadText.textContent='üì∏ Add your photo'; return; }
        const ok = ['image/jpeg','image/jpg','image/png','image/webp'];
        if(!ok.includes(f.type)) return toast(formAlert,'Use JPEG/PNG/WebP.',false);
        if(f.size>20*1024*1024) return toast(formAlert,'Image too large (max ~20MB).',false);
        uploaderBox.classList.add('has-file'); uploadText.textContent = `‚úÖ ${f.name}`;
      }
      async function uploadToUploadcare(file){
        const form = new FormData();
        form.append('UPLOADCARE_PUB_KEY','e060d7b73e9b8e15de28');
        form.append('file', file);
        const res = await fetch('https://upload.uploadcare.com/base/', { method:'POST', body:form });
        if(!res.ok) throw new Error(`Upload failed (${res.status})`);
        const j = await res.json(); if(!j.file) throw new Error('No file id');
        return `https://ucarecdn.com/${j.file}/`;
      }

      // Submit
      async function onSubmit(){
        clearFormAlert();
        if(!signedTeam) return toast(formAlert,'Sign in first.',false);

        const file = fileInput.files && fileInput.files[0];
        if(!file) return toast(formAlert,'Add a photo.',false);

        const checked = Array.from(checks.querySelectorAll('input[type=checkbox]:checked'));
        if(checked.length<1) return toast(formAlert,'Tick at least one item.',false);

        const title = checked[0].value;
        const itemDef = ITEMS.find(x=>x.title===title) || ITEMS[0];

        const done = getDoneSet();
        if(done.has(itemDef.id)) return toast(formAlert,'That one is already submitted for this crew.',false);

        const description = buildAutoDescription(checked.map(c=>c.value));
        submitBtn.disabled = true;

        try{
          const photoUrl = await uploadToUploadcare(file);
          const payload = {
            teamCode: signedTeam.code, teamName: signedTeam.name,
            itemId: itemDef.id, itemTitle: itemDef.title, itemDescription: description, maxPoints: 15, photoUrl,
            eventId, items: checked.map(c=>c.value), description
          };
          const headers = { 'Content-Type':'application/json' };
          const token = localStorage.getItem(STORAGE_TOKEN); if(token) headers['Authorization'] = `Bearer ${token}`;
          const res = await fetch('/.netlify/functions/submit_scavenger_function', { method:'POST', headers, body: JSON.stringify(payload) });
          const text = await res.text(); let ok = res.ok;
          try{ const j = JSON.parse(text); ok = ok && (j.success!==false); }catch{}
          if(!ok) throw new Error(text || 'Submission failed.');

          done.add(itemDef.id); saveDoneSet(done); renderItems();
          toast(formAlert, "üéâ Submitted! Terry‚Äôs tallymaster is reviewing. Check the leaderboard soon.", true);
          document.querySelectorAll('#formCard input, #formCard button').forEach(n=>n.disabled = true);
        }catch(e){
          toast(formAlert, `Submission failed. ${e.message||''}`.trim(), false);
          submitBtn.disabled = false;
        }
      }

      // Helpers
      function buildAutoDescription(labels){ let s = `Find: ${labels.join(', ')}`; if(s.length<20) s+=' ‚Äî TeamQuest scavenger'; return s; }
      function toast(node,msg,ok){ node.className='alert ' + (ok?'alert-ok':'alert-err'); node.textContent=msg; node.style.display='block'; }
      function clearLoginAlert(){ loginAlert.style.display='none'; }
      function showLoginError(msg){ loginAlert.className='alert alert-err'; loginAlert.textContent=msg; loginAlert.style.display='block'; }
      function showLoginInfo(msg){ if(!msg){ loginAlert.style.display='none'; return; } loginAlert.className='alert alert-ok'; loginAlert.textContent=msg; loginAlert.style.display='block'; }
      function clearFormAlert(){ formAlert.style.display='none'; }
      function keyFor(kind){ return `tq_${eventId}_${kind}`; }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    })();
  </script>
</body>
</html>
